{% extends "base.html" %}
{% block title %}Detalhes do Agendamento{% endblock %}

{% block content %}
<div class="container mt-4">
  <!-- BREADCRUMB -->
  <nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{{ url_for('dashboard_routes.dashboard') }}"><i class="bi bi-house"></i> Dashboard</a></li>
      <li class="breadcrumb-item"><a href="{{ url_for('dashboard_routes.dashboard_agendamentos') }}">Agendamentos</a></li>
      <li class="breadcrumb-item"><a href="{{ url_for('agendamento_routes.listar_agendamentos') }}">Lista</a></li>
      <li class="breadcrumb-item active" aria-current="page">Agendamento #{{ agendamento.id }}</li>
    </ol>
  </nav>

  <!-- CABE√áALHO -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="mb-1">
        <i class="bi bi-calendar-event me-2"></i>
        Detalhes do Agendamento #{{ agendamento.id }}
      </h2>
      <p class="text-muted mb-0">
        Status: 
        {% set status_badges = {
          'pendente': 'warning',
          'confirmado': 'success',
          'cancelado': 'danger',
          'realizado': 'primary'
        } %}
        {% set status_badge = status_badges.get(agendamento.status, 'secondary') %}
        <span class="badge bg-{{ status_badge }}">{{ agendamento.status|capitalize }}</span>
      </p>
    </div>
    <div class="d-flex gap-2">
      <a href="{{ url_for('agendamento_routes.listar_agendamentos') }}" class="btn btn-outline-info">
        <i class="bi bi-list-ul me-2"></i>Ver Lista
      </a>
      <a href="{{ url_for('dashboard_routes.dashboard_agendamentos') }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left me-2"></i>Voltar
      </a>
    </div>
  </div>

  <div class="row mb-3">
    <div class="col-md-6 col-lg-4">
      <p><strong>Evento:</strong> 
        {{ agendamento.horario.evento.nome if agendamento.horario and agendamento.horario.evento else '‚Äî' }}
      </p>
      <p><strong>Data:</strong>
        {{ agendamento.horario.data.strftime('%d/%m/%Y') if agendamento.horario and agendamento.horario.data else '‚Äî' }}
      </p>
      <p><strong>Hor√°rio:</strong>
        {% if agendamento.horario %}
          {{ agendamento.horario.horario_inicio }} - {{ agendamento.horario.horario_fim }}
        {% else %}
          ‚Äî
        {% endif %}
      </p>
      <p><strong>Quantidade de Alunos:</strong> {{ agendamento.quantidade_alunos }}</p>
      <p><strong>Escola / Institui√ß√£o:</strong> {{ agendamento.escola_nome }}</p>
      <p><strong>C√≥digo INEP (se houver):</strong> {{ agendamento.escola_codigo_inep or '‚Äî' }}</p>
      <p><strong>Turma:</strong> {{ agendamento.turma }}</p>
      <p><strong>N√≠vel de Ensino:</strong> {{ agendamento.nivel_ensino }}</p>
      <p><strong>Status do Agendamento:</strong> {{ agendamento.status }}</p>

      {% set email = agendamento.professor.email if agendamento.professor and agendamento.professor.email else agendamento.responsavel_email %}
      {% if email %}
        <p><strong>E-mail:</strong> {{ email }}</p>
      {% endif %}

      {% if agendamento.responsavel_whatsapp %}
        {% set whatsapp_display = agendamento.responsavel_whatsapp %}
        {% set whatsapp_number = agendamento.responsavel_whatsapp
          |replace('(', '')
          |replace(')', '')
          |replace('-', '')
          |replace(' ', '')
          |replace('+', '') %}
        <p>
          <strong>WhatsApp:</strong>
          <a href="https://api.whatsapp.com/send?phone={{ whatsapp_number }}" target="_blank" rel="noopener">
            {{ whatsapp_display }}
          </a>
        </p>
      {% endif %}

      {% if agendamento.salas_selecionadas %}
        <p><strong>Salas Selecionadas:</strong> {{ agendamento.salas_selecionadas }}</p>
      {% endif %}
      
      <hr>
      <!-- Bot√£o de Cancelar, chamando a rota cancelar_agendamento -->
      {% if agendamento.status != 'cancelado' and agendamento.status != 'realizado' %}
        <form method="POST" action="{{ url_for('agendamento_routes.cancelar_agendamento', agendamento_id=agendamento.id) }}">
          <button class="btn btn-danger">
            <i class="bi bi-x-octagon"></i> Cancelar Agendamento
          </button>
        </form>
      {% else %}
        <div class="alert alert-warning">
          <strong>Observa√ß√£o:</strong> Este agendamento j√° est√° {{ agendamento.status }}.
        </div>
      {% endif %}
    </div>

    <!-- Exibir lista de alunos -->
    <div class="col-md-6 col-lg-8">
      <h5>Lista de Alunos</h5>
      {% if agendamento.alunos %}
        <ul class="list-group">
          {% for aluno in agendamento.alunos %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <div>
                {{ aluno.nome }} 
                {% if aluno.cpf %} (CPF: {{ aluno.cpf }}) {% endif %}
                {% if aluno.necessidade_especial %}
                  <br><small class="text-info"><i class="bi bi-universal-access"></i> PCD/Neurodivergente</small>
                {% endif %}
              </div>
              <span class="badge bg-{{ 'success' if aluno.presente else 'secondary' }}">
                {{ 'Presente' if aluno.presente else 'Ausente' }}
              </span>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p>Nenhum aluno cadastrado neste agendamento.</p>
      {% endif %}
      
      <!-- Se√ß√£o de Alunos com Necessidades Especiais -->
      {% if alunos_pcd %}
        <div class="mt-4">
          <h5 class="text-primary">
            <i class="bi bi-universal-access"></i> 
            Alunos com Necessidades Especiais ({{ alunos_pcd|length }})
          </h5>
          <div class="accordion" id="accordionPCD">
            {% for aluno, necessidade in alunos_pcd %}
              <div class="accordion-item">
                <h2 class="accordion-header" id="heading{{ loop.index }}">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                          data-bs-target="#collapse{{ loop.index }}" aria-expanded="false" 
                          aria-controls="collapse{{ loop.index }}">
                    <div class="d-flex align-items-center">
                      <div class="me-3">
                        {% if necessidade.tipo == 'pcd_fisica' %}
                          ü¶Ω
                        {% elif necessidade.tipo == 'pcd_visual' %}
                          üëÅÔ∏è
                        {% elif necessidade.tipo == 'pcd_auditiva' %}
                          üëÇ
                        {% elif necessidade.tipo == 'pcd_intelectual' %}
                          üß†
                        {% elif necessidade.tipo == 'neurodivergente_autismo' %}
                          üß©
                        {% elif necessidade.tipo == 'neurodivergente_tdah' %}
                          ‚ö°
                        {% elif necessidade.tipo == 'neurodivergente_dislexia' %}
                          üìñ
                        {% elif necessidade.tipo == 'neurodivergente_outros' %}
                          üåü
                        {% else %}
                          ‚ÑπÔ∏è
                        {% endif %}
                      </div>
                      <div>
                        <strong>{{ aluno.nome }}</strong>
                        <br><small class="text-muted">{{ necessidade.get_tipo_display() }}</small>
                      </div>
                    </div>
                  </button>
                </h2>
                <div id="collapse{{ loop.index }}" class="accordion-collapse collapse" 
                     aria-labelledby="heading{{ loop.index }}" data-bs-parent="#accordionPCD">
                  <div class="accordion-body">
                    <div class="row">
                      <div class="col-md-6">
                        <p><strong>Tipo:</strong> {{ necessidade.get_tipo_display() }}</p>
                        <p><strong>Descri√ß√£o:</strong></p>
                        <p class="text-muted">{{ necessidade.descricao }}</p>
                      </div>
                      <div class="col-md-6">
                        {% if aluno.materiais_apoio.count() > 0 %}
                          <p><strong>Materiais de Apoio Solicitados:</strong></p>
                          <ul class="list-unstyled">
                            {% for material in aluno.materiais_apoio %}
                              <li><i class="bi bi-check-circle text-success"></i> {{ material.nome }}</li>
                            {% endfor %}
                          </ul>
                        {% else %}
                          <p class="text-muted">Nenhum material de apoio espec√≠fico solicitado.</p>
                        {% endif %}
                      </div>
                    </div>
                    <div class="alert alert-info mt-3">
                      <small><i class="bi bi-info-circle"></i> 
                        <strong>Lembre-se:</strong> Este aluno requer aten√ß√£o especial durante a visita. 
                        Certifique-se de que os monitores estejam cientes das necessidades espec√≠ficas.
                      </small>
                    </div>
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
      {% endif %}
    </div>
  </div>

  <!-- Se√ß√£o de Check-in -->
  <div class="mt-4">
    <div class="row">
      <div class="col-md-6">
        <div class="card">
          <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-check-circle"></i> Check-in</h5>
          </div>
          <div class="card-body">
            {% if agendamento.checkin_realizado %}
              <div class="alert alert-success">
                <i class="bi bi-check-circle-fill"></i> 
                <strong>Check-in realizado!</strong>
                {% if agendamento.data_checkin %}
                  <br><small>Em: {{ agendamento.data_checkin.strftime('%d/%m/%Y √†s %H:%M') }}</small>
                {% endif %}
              </div>
            {% else %}
              <p class="text-muted mb-3">O check-in ainda n√£o foi realizado para este agendamento.</p>
              
              <!-- Bot√£o de Check-in Manual -->
              {% if current_user.id == agendamento.professor_id or current_user.id == agendamento.horario.evento.cliente_id or current_user.tipo in ['participante', 'admin'] %}
                <form method="POST" action="{{ url_for('agendamento_routes.checkin_manual_agendamento', agendamento_id=agendamento.id) }}" 
                      onsubmit="return confirm('Confirma a realiza√ß√£o do check-in para este agendamento?')">
                  <button type="submit" class="btn btn-success btn-lg w-100 mb-3">
                    <i class="bi bi-check-circle"></i> Realizar Check-in Manual
                  </button>
                </form>
              {% endif %}
              
              <div class="text-center">
                <small class="text-muted">ou</small>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
      
      <div class="col-md-6">
        <div class="card">
          <div class="card-header bg-info text-white">
            <h5 class="mb-0"><i class="bi bi-qrcode"></i> QR Code para Check-in</h5>
          </div>
          <div class="card-body text-center">
            <p class="text-muted mb-3">Escaneie este c√≥digo para realizar check-in via QR Code:</p>
            <div class="d-inline-block p-3 bg-light border rounded">
              <img src="{{ url_for('agendamento_routes.qrcode_agendamento', agendamento_id=agendamento.id) }}" 
                   alt="QR Code do Agendamento" 
                   class="img-fluid" 
                   style="max-width: 200px; width: 100%;">
            </div>
            <div class="mt-3">
              <small class="text-muted">
                <i class="bi bi-info-circle"></i> 
                Apresente este c√≥digo no local da visita
              </small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
