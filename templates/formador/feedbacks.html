{% extends "base.html" %}
{% block title %}Meus Feedbacks{% endblock %}

{% block content %}
<div class="container mt-5">
  <h2 class="text-center mb-4">Feedbacks das Minhas Oficinas</h2>
  
  {% if oficinas %}
    {% for oficina in oficinas %}
      <div class="card mb-4">
        <div class="card-header">
          <h4 class="mb-0">{{ oficina.titulo }}</h4>
          {% if oficina.data_inicio %}
            <small class="text-muted">Data: {{ oficina.data_inicio.strftime('%d/%m/%Y') }}</small>
          {% endif %}
        </div>
        <div class="card-body">
          {% set feedbacks_oficina = oficina.feedbacks %}
          {% if feedbacks_oficina %}
            <!-- Estatísticas da oficina -->
            {% set total_count = feedbacks_oficina|length %}
            {% set total_avg = (feedbacks_oficina|sum(attribute='rating') / total_count) if total_count > 0 else 0 %}
            
            {% set feedbacks_usuarios = feedbacks_oficina|selectattr('usuario_id')|list %}
            {% set count_usuarios = feedbacks_usuarios|length %}
            {% set avg_usuarios = (feedbacks_usuarios|sum(attribute='rating') / count_usuarios) if count_usuarios > 0 else 0 %}
            
            {% set feedbacks_ministrantes = feedbacks_oficina|selectattr('ministrante_id')|list %}
            {% set count_ministrantes = feedbacks_ministrantes|length %}
            {% set avg_ministrantes = (feedbacks_ministrantes|sum(attribute='rating') / count_ministrantes) if count_ministrantes > 0 else 0 %}
            
            <div class="mb-3">
              <!-- Feedbacks Totais -->
              {% set full_stars_total = total_avg|float|round(0, 'floor')|int %}
              {% set empty_stars_total = 5 - full_stars_total %}
              <p class="mb-2">
                <strong>Total de feedbacks:</strong> {{ total_count }} - Média: {{ "%.2f"|format(total_avg) }} 
                {% for i in range(full_stars_total) %}
                  <span class="text-warning">&#9733;</span>
                {% endfor %}
                {% for i in range(empty_stars_total) %}
                  <span class="text-muted">&#9733;</span>
                {% endfor %}
              </p>
            
              <!-- Feedbacks de Usuários -->
              {% if count_usuarios > 0 %}
                {% set full_stars_usuarios = avg_usuarios|float|round(0, 'floor')|int %}
                {% set empty_stars_usuarios = 5 - full_stars_usuarios %}
                <p class="mb-2">
                  <strong>Feedbacks de usuários:</strong> {{ count_usuarios }} - Média: {{ "%.2f"|format(avg_usuarios) }} 
                  {% for i in range(full_stars_usuarios) %}
                    <span class="text-warning">&#9733;</span>
                  {% endfor %}
                  {% for i in range(empty_stars_usuarios) %}
                    <span class="text-muted">&#9733;</span>
                  {% endfor %}
                </p>
              {% endif %}
            
              <!-- Feedbacks de Ministrantes -->
              {% if count_ministrantes > 0 %}
                {% set full_stars_ministrantes = avg_ministrantes|float|round(0, 'floor')|int %}
                {% set empty_stars_ministrantes = 5 - full_stars_ministrantes %}
                <p class="mb-2">
                  <strong>Feedbacks de ministrantes:</strong> {{ count_ministrantes }} - Média: {{ "%.2f"|format(avg_ministrantes) }} 
                  {% for i in range(full_stars_ministrantes) %}
                    <span class="text-warning">&#9733;</span>
                  {% endfor %}
                  {% for i in range(empty_stars_ministrantes) %}
                    <span class="text-muted">&#9733;</span>
                  {% endfor %}
                </p>
              {% endif %}
            </div>
            
            <!-- Tabela de feedbacks -->
            <div class="table-responsive">
              <table class="table table-striped table-sm">
                <thead>
                  <tr>
                    <th>Nome</th>
                    <th>Tipo</th>
                    <th>Avaliação</th>
                    <th>Comentário</th>
                    <th>Data</th>
                  </tr>
                </thead>
                <tbody>
                  {% for fb in feedbacks_oficina %}
                  <tr>
                    <td>
                      {% if fb.usuario %}
                        {{ fb.usuario.nome }}
                      {% elif fb.ministrante %}
                        {{ fb.ministrante.nome }}
                      {% else %}
                        Desconhecido
                      {% endif %}
                    </td>
                    <td>
                      {% if fb.usuario %}
                        <span class="badge badge-primary">Usuário</span>
                      {% elif fb.ministrante %}
                        <span class="badge badge-info">Ministrante</span>
                      {% else %}
                        <span class="badge badge-secondary">Desconhecido</span>
                      {% endif %}
                    </td>
                    <td>
                      {% for i in range(1,6) %}
                        {% if i <= fb.rating %}
                          <span class="text-warning">&#9733;</span>
                        {% else %}
                          <span class="text-muted">&#9733;</span>
                        {% endif %}
                      {% endfor %}
                    </td>
                    <td>
                      {% if fb.comentario %}
                        {{ fb.comentario[:100] }}{% if fb.comentario|length > 100 %}...{% endif %}
                      {% else %}
                        <em class="text-muted">Sem comentário</em>
                      {% endif %}
                    </td>
                    <td>{{ fb.created_at.strftime('%d/%m/%Y %H:%M') if fb.created_at else 'N/A' }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            
            <!-- Link para ver detalhes completos -->
            <div class="text-center mt-3">
              <a href="{{ url_for('feedback_routes.feedback_oficina', oficina_id=oficina.id) }}" class="btn btn-outline-primary btn-sm">
                Ver Detalhes Completos
              </a>
            </div>
          {% else %}
            <div class="text-center py-4">
              <i class="fas fa-comment-slash fa-2x text-muted mb-2"></i>
              <p class="text-muted mb-0">Nenhum feedback recebido para esta oficina ainda.</p>
            </div>
          {% endif %}
        </div>
      </div>
    {% endfor %}
  {% else %}
    <div class="text-center py-5">
      <i class="fas fa-chalkboard-teacher fa-3x text-muted mb-3"></i>
      <h5 class="text-muted">Nenhuma oficina encontrada</h5>
      <p class="text-muted">Você ainda não possui oficinas vinculadas ao seu perfil.</p>
      <a href="{{ url_for('formador_routes.dashboard_formador') }}" class="btn btn-primary">
        Voltar ao Dashboard
      </a>
    </div>
  {% endif %}
  
  <!-- Botão para voltar -->
  {% if oficinas %}
    <div class="text-center mt-4">
      <a href="{{ url_for('formador_routes.dashboard_formador') }}" class="btn btn-secondary">
        <i class="fas fa-arrow-left me-1"></i> Voltar ao Dashboard
      </a>
    </div>
  {% endif %}
</div>
{% endblock %}