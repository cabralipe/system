{% extends "base.html" %}
{% block title %}Processo de Revisores{% endblock %}

{% block styles %}
{{ super() }}
<style>
.config-card {
  border: none;
  box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
  border-radius: 0.5rem;
}
.step-indicator {
  background: linear-gradient(45deg, #007bff, #0056b3);
  color: white;
  width: 2rem;
  height: 2rem;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
}
.form-section {
  border-left: 3px solid #007bff;
  padding-left: 1rem;
}
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
  <!-- Breadcrumbs -->
  <nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
      <li class="breadcrumb-item">
        <a href="{{ url_for('revisor_routes.list_processes') }}">
          <i class="bi bi-house me-1"></i>
          Processos de Revisores
        </a>
      </li>
      <li class="breadcrumb-item active" aria-current="page">
        {% if is_new %}
          <i class="bi bi-plus-circle me-1"></i>
          Criar Novo Processo
        {% else %}
          <i class="bi bi-pencil me-1"></i>
          Editar: {{ processo.nome or 'Processo' }}
        {% endif %}
      </li>
    </ol>
  </nav>

  <div class="row">
    <div class="col-12">
      <div class="d-flex align-items-center justify-content-between mb-4">
        <div class="d-flex align-items-center">
          <div class="step-indicator me-3">
            {% if is_new %}
              <i class="bi bi-plus"></i>
            {% else %}
              <i class="bi bi-pencil"></i>
            {% endif %}
          </div>
          <div>
            <h1 class="h3 mb-0">
              {% if is_new %}
                Criar Novo Processo de Revisores
              {% else %}
                Editar Processo de Revisores
              {% endif %}
            </h1>
            <p class="text-muted mb-0">
              {% if is_new %}
                Configure um novo processo seletivo para revisores
              {% else %}
                Modifique as configurações do processo "{{ processo.nome or 'Sem nome' }}"
              {% endif %}
            </p>
          </div>
        </div>
        {% if processo and processo.id %}
        <form
          method="post"
          action="{{ url_for('revisor_routes.delete_process', process_id=processo.id) }}"
          onsubmit="return confirm('Excluir processo?');"
        >
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button type="submit" class="btn btn-danger btn-sm">
            <i class="bi bi-trash"></i> Excluir
          </button>
        </form>
        {% endif %}
      </div>
    </div>
  </div>

  <form method="post" id="configForm" novalidate 
        {% if is_new %}action="{{ url_for('revisor_routes.create_process') }}"{% endif %}>
    <!-- Informações do Processo -->
    <div class="card config-card mb-4">
      <div class="card-header bg-light">
        <h5 class="card-title mb-0">
          <i class="bi bi-info-circle me-2"></i>
          Informações do Processo
        </h5>
      </div>
      <div class="card-body">

        <div class="row mb-3">
          <div class="col-md-6 mb-3 mb-md-0">
            <label class="form-label fw-semibold">Nome do Processo</label>
            <input type="text" class="form-control" name="nome" value="{{ processo.nome if processo else '' }}" required>
            <div class="invalid-feedback">Por favor, informe o nome do processo.</div>
          </div>
          <div class="col-md-6">
            <label class="form-label fw-semibold">Status</label>
            {% set pstatus = processo.status if processo else '' %}
            <select class="form-select" name="status" required>
              <option value="">Selecione...</option>
              <option value="aberto" {% if pstatus == 'aberto' or pstatus == 'Aberto' %}selected{% endif %}>Aberto</option>
              <option value="pendente" {% if pstatus == 'pendente' or pstatus == 'Pendente' %}selected{% endif %}>Pendente</option>
              <option value="encerrado" {% if pstatus == 'encerrado' or pstatus == 'Encerrado' %}selected{% endif %}>Encerrado</option>
            </select>
            <div class="invalid-feedback">Por favor, selecione o status.</div>
          </div>

        </div>
        <div class="mb-3">
          <label class="form-label fw-semibold">Descrição</label>
          <textarea class="form-control" name="descricao" rows="3">{{ processo.descricao if processo else '' }}</textarea>
        </div>

      </div>
    </div>

    <!-- Configurações Básicas -->
    <div class="card config-card mb-4">
      <div class="card-header bg-light">
        <h5 class="card-title mb-0">
          <i class="bi bi-calendar-event me-2"></i>
          Período de Disponibilidade
        </h5>
      </div>
      <div class="card-body">

        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label fw-semibold">
              <i class="bi bi-calendar-plus me-1"></i>
              Data de Início
            </label>
            <input type="date" class="form-control" name="availability_start" 
                   value="{{ processo.availability_start.strftime('%Y-%m-%d') if processo and processo.availability_start else '' }}"
                   required>
            <div class="invalid-feedback">
              Por favor, selecione a data de início.
            </div>
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label fw-semibold">
              <i class="bi bi-calendar-x me-1"></i>
              Data de Término
            </label>
            <input type="date" class="form-control" name="availability_end" 
                   value="{{ processo.availability_end.strftime('%Y-%m-%d') if processo and processo.availability_end else '' }}"
                   required>
            <div class="invalid-feedback">
              Por favor, selecione a data de término.
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Configurações de Visibilidade -->
    <div class="card config-card mb-4">
      <div class="card-header bg-light">
        <h5 class="card-title mb-0">
          <i class="bi bi-eye me-2"></i>
          Configurações de Visibilidade
        </h5>
      </div>
      <div class="card-body">
        <div class="form-check form-switch">
          <input type="checkbox" class="form-check-input" id="exibir_para_participantes" 
                 name="exibir_para_participantes" {% if processo and processo.exibir_para_participantes %}checked{% endif %}>
          <label class="form-check-label fw-semibold" for="exibir_para_participantes">
            <i class="bi bi-people me-1"></i>
            Exibir processo para participantes
          </label>
          <div class="form-text">
            Quando ativado, o processo seletivo ficará visível na página de seleção de eventos.
          </div>
        </div>
      </div>
    </div>
    <!-- Configurações de Formulário e Eventos -->
    <div class="card config-card mb-4">
      <div class="card-header bg-light">
        <h5 class="card-title mb-0">
          <i class="bi bi-file-earmark-text me-2"></i>
          Formulário e Eventos
        </h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label fw-semibold">
              <i class="bi bi-clipboard-data me-1"></i>
              Formulário de Candidatura
            </label>
            <select class="form-select" name="formulario_id">
              <option value="">Selecione um formulário...</option>
              {% for f in formularios %}
              <option value="{{ f.id }}" {% if processo and f.id == processo.formulario_id %}selected{% endif %}>{{ f.nome }}</option>
              {% endfor %}
            </select>
            <div class="invalid-feedback">
              Por favor, selecione um formulário.
            </div>
            {% if not formularios %}
            <div class="form-text text-warning">
              <i class="bi bi-exclamation-triangle me-1"></i>
              Nenhum formulário disponível. <a href="#" class="text-primary">Criar novo formulário</a>
            </div>
            {% endif %}
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label fw-semibold">
              <i class="bi bi-calendar-event me-1"></i>
              Eventos Vinculados <small class="text-muted">(opcional)</small>
            </label>
            <select class="form-select" name="eventos_ids" multiple size="4">
              {% for ev in eventos %}
              <option value="{{ ev.id }}" {% if ev.id in selected_event_ids %}selected{% endif %}>{{ ev.nome }}</option>
              {% endfor %}
            </select>
            <div class="form-text">
              Mantenha Ctrl pressionado para selecionar múltiplos eventos.
            </div>
            {% if not eventos %}
            <div class="form-text">
              Nenhum evento disponível.
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
    <!-- Configuração de Etapas -->
    <div class="card config-card mb-4">
      <div class="card-header bg-light">
        <h5 class="card-title mb-0">
          <i class="bi bi-list-ol me-2"></i>
          Etapas do Processo
        </h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-4 mb-3">
            <label class="form-label fw-semibold">
              <i class="bi bi-hash me-1"></i>
              Número de Etapas
            </label>
            <input type="number" class="form-control" name="num_etapas" 
                   value="{{ processo.num_etapas if processo and processo.num_etapas else 1 }}" 
                   min="1" max="10" required id="numEtapas">
            <div class="invalid-feedback">
              Por favor, informe o número de etapas (1-10).
            </div>
          </div>
        </div>
        
        <div class="form-section mt-3">
          <h6 class="fw-semibold mb-3">
            <i class="bi bi-pencil me-1"></i>
            Nomes das Etapas
          </h6>
          <div id="etapasContainer">
            {% set total = processo.num_etapas if processo and processo.num_etapas else 1 %}
            {% for i in range(total) %}
            <div class="input-group mb-2 etapa-input">
              <span class="input-group-text">
                <i class="bi bi-arrow-right"></i>
                Etapa {{ i + 1 }}
              </span>
              <input type="text" class="form-control" name="stage_name" 
                     value="{{ etapas[i].nome if etapas|length > i else '' }}"
                     placeholder="Nome da etapa {{ i + 1 }}" required>
              <div class="invalid-feedback">
                Por favor, informe o nome da etapa.
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>

    <!-- Botões de Ação -->
    <div class="card config-card">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h6 class="mb-1">Finalizar Configuração</h6>
            <small class="text-muted">Revise todas as informações antes de salvar</small>
          </div>
          <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary">
              <i class="bi bi-check-lg me-2"></i>
              {% if is_new %}
                Criar Processo
              {% else %}
                Salvar Alterações
              {% endif %}
            </button>
            <a href="{{ url_for('revisor_routes.list_processes') }}" class="btn btn-outline-secondary">
              <i class="bi bi-arrow-left me-2"></i>
              Voltar à Lista
            </a>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
// Validação do formulário
(function() {
  'use strict';
  
  // Validação de datas
  const startDate = document.querySelector('input[name="availability_start"]');
  const endDate = document.querySelector('input[name="availability_end"]');
  
  function validateDates() {
    if (startDate.value && endDate.value) {
      if (new Date(startDate.value) >= new Date(endDate.value)) {
        endDate.setCustomValidity('A data de término deve ser posterior à data de início');
      } else {
        endDate.setCustomValidity('');
      }
    }
  }
  
  startDate.addEventListener('change', validateDates);
  endDate.addEventListener('change', validateDates);
  
  // Gerenciamento dinâmico de etapas
  const numEtapasInput = document.getElementById('numEtapas');
  const etapasContainer = document.getElementById('etapasContainer');
  
  numEtapasInput.addEventListener('change', function() {
    const numEtapas = parseInt(this.value) || 1;
    const currentEtapas = etapasContainer.querySelectorAll('.etapa-input');
    
    // Remove etapas extras
    for (let i = numEtapas; i < currentEtapas.length; i++) {
      currentEtapas[i].remove();
    }
    
    // Adiciona novas etapas se necessário
    for (let i = currentEtapas.length; i < numEtapas; i++) {
      const etapaDiv = document.createElement('div');
      etapaDiv.className = 'input-group mb-2 etapa-input';
      etapaDiv.innerHTML = `
        <span class="input-group-text">
          <i class="bi bi-arrow-right"></i>
          Etapa ${i + 1}
        </span>
        <input type="text" class="form-control" name="stage_name" 
               placeholder="Nome da etapa ${i + 1}" required>
        <div class="invalid-feedback">
          Por favor, informe o nome da etapa.
        </div>
      `;
      etapasContainer.appendChild(etapaDiv);
    }
  });
  

  
  // Validação do formulário
  const form = document.getElementById('configForm');
  form.addEventListener('submit', function(event) {
    if (!form.checkValidity()) {
      event.preventDefault();
      event.stopPropagation();
    }
    form.classList.add('was-validated');
  });
})();
</script>
{% endblock %}
