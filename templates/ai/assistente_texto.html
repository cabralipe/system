{% extends "base.html" %}

{% block title %}Assistente de Texto com IA{% endblock %}

{% block styles %}
{{ super() }}
<style>
  .ai-page-container {
    background: #f8f9fa;
    min-height: 100vh;
    padding-top: 2rem;
  }

  .ai-header {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-color-light) 100%);
    color: white;
    padding: 2rem;
    border-radius: var(--border-radius-lg);
    margin-bottom: 2rem;
    box-shadow: var(--shadow-md);
  }

  .ai-header h1 {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
  }

  .ai-header p {
    font-size: 1.1rem;
    opacity: 0.9;
    margin: 0;
  }

  .ai-status-card {
    background: white;
    border-radius: var(--border-radius-lg);
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: var(--shadow-sm);
    border: 1px solid #e9ecef;
  }

  .ai-status-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 0;
    border-bottom: 1px solid #f1f3f4;
  }

  .ai-status-item:last-child {
    border-bottom: none;
  }

  .ai-status-label {
    font-weight: 600;
    color: var(--text-dark);
  }

  .ai-status-value {
    font-size: 0.875rem;
    font-weight: 500;
  }

  .ai-status-value.available {
    color: var(--success-color);
  }

  .ai-status-value.unavailable {
    color: var(--danger-color);
  }

  .ai-workspace {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
    margin-bottom: 2rem;
  }

  .ai-panel {
    background: white;
    border-radius: var(--border-radius-lg);
    padding: 2rem;
    box-shadow: var(--shadow-sm);
    border: 1px solid #e9ecef;
    transition: var(--transition-normal);
  }

  .ai-panel:hover {
    box-shadow: var(--shadow-md);
    transform: translateY(-2px);
  }

  .ai-panel h3 {
    color: var(--text-dark);
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    border-bottom: 2px solid #f1f3f4;
    padding-bottom: 0.75rem;
  }

  .ai-form-group {
    margin-bottom: 1.5rem;
  }

  .ai-form-label {
    display: block;
    font-weight: 600;
    color: var(--text-dark);
    margin-bottom: 0.5rem;
    font-size: 0.875rem;
  }

  .ai-form-input,
  .ai-form-textarea,
  .ai-form-select {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 2px solid #e9ecef;
    border-radius: var(--border-radius);
    font-size: 1rem;
    transition: var(--transition-fast);
    background: #f8f9fa;
  }

  .ai-form-input:focus,
  .ai-form-textarea:focus,
  .ai-form-select:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(42, 45, 114, 0.1);
    background: white;
  }

  .ai-form-textarea {
    min-height: 6rem;
    resize: vertical;
  }

  .ai-btn {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-color-light) 100%);
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: var(--border-radius);
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition-normal);
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 1rem;
    box-shadow: var(--shadow-xs);
  }

  .ai-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-sm);
  }

  .ai-btn:disabled {
    background: #6c757d;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }

  .ai-btn.secondary {
    background: white;
    color: var(--text-dark);
    border: 2px solid #e9ecef;
  }

  .ai-btn.secondary:hover {
    background: #f8f9fa;
    border-color: var(--primary-color);
  }

  .ai-result {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: var(--border-radius);
    padding: 1.5rem;
    margin-top: 1.5rem;
    min-height: 8rem;
  }

  .ai-result h4 {
    color: var(--text-dark);
    margin-bottom: 1rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .ai-result-text {
    background: white;
    border: 1px solid #e9ecef;
    border-radius: var(--border-radius);
    padding: 1rem;
    font-family: 'Poppins', sans-serif;
    font-size: 0.95rem;
    line-height: 1.6;
    white-space: pre-wrap;
    word-wrap: break-word;
    color: var(--text-dark);
    min-height: 4rem;
  }

  .ai-templates {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1rem;
    margin-top: 1.5rem;
  }

  .ai-template-card {
    background: white;
    border: 1px solid #e9ecef;
    border-radius: var(--border-radius);
    padding: 1.25rem;
    cursor: pointer;
    transition: var(--transition-normal);
    box-shadow: var(--shadow-xs);
  }

  .ai-template-card:hover {
    border-color: var(--primary-color);
    box-shadow: var(--shadow-sm);
    transform: translateY(-2px);
  }

  .ai-template-title {
    font-weight: 600;
    color: var(--text-dark);
    margin-bottom: 0.5rem;
    font-size: 1rem;
  }

  .ai-template-desc {
    font-size: 0.875rem;
    color: var(--text-muted);
    margin-bottom: 0.75rem;
    line-height: 1.4;
  }

  .ai-template-vars {
    font-size: 0.75rem;
    color: var(--primary-color);
    background: rgba(42, 45, 114, 0.1);
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    display: inline-block;
    font-weight: 500;
  }

  .ai-loading {
    display: none;
    text-align: center;
    padding: 2rem;
    background: white;
    border-radius: var(--border-radius-lg);
    box-shadow: var(--shadow-sm);
  }

  .ai-loading.show {
    display: block;
  }

  .ai-spinner {
    width: 2.5rem;
    height: 2.5rem;
    border: 3px solid #f1f3f4;
    border-top: 3px solid var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 1rem;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .ai-alert {
    padding: 1rem 1.25rem;
    border-radius: var(--border-radius);
    margin-bottom: 1.5rem;
    display: none;
    font-weight: 500;
  }

  .ai-alert.success {
    background: rgba(40, 167, 69, 0.1);
    border: 1px solid rgba(40, 167, 69, 0.2);
    color: #155724;
  }

  .ai-alert.error {
    background: rgba(220, 53, 69, 0.1);
    border: 1px solid rgba(220, 53, 69, 0.2);
    color: #721c24;
  }

  .ai-alert.warning {
    background: rgba(255, 193, 7, 0.1);
    border: 1px solid rgba(255, 193, 7, 0.2);
    color: #856404;
  }

  @media (max-width: 768px) {
    .ai-workspace {
      grid-template-columns: 1fr;
      gap: 1rem;
    }
    
    .ai-header h1 {
      font-size: 2rem;
    }
    
    .ai-panel {
      padding: 1.5rem;
    }
    
    .ai-templates {
      grid-template-columns: 1fr;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="ai-page-container">
  <div class="container">
    <!-- Header -->
    <div class="ai-header">
      <h1><i class="bi bi-robot me-3"></i>Assistente de Texto com IA</h1>
      <p>Gere e melhore textos para certificados e declarações usando inteligência artificial</p>
                </div>

    <!-- Alertas -->
    <div class="ai-alert" id="alertContainer"></div>

    <!-- Status dos Serviços -->
    <div class="ai-status-card">
      <h5 class="mb-3"><i class="bi bi-activity me-2"></i>Status dos Serviços</h5>
      <div id="aiStatus">
        <div class="text-center py-3">
          <div class="ai-spinner"></div>
          <p class="text-muted mb-0">Verificando serviços de IA...</p>
        </div>
      </div>
                                        </div>

    <!-- Workspace Principal -->
    <div class="ai-workspace">
      <!-- Painel de Geração -->
      <div class="ai-panel">
        <h3><i class="bi bi-magic"></i> Gerar Texto</h3>
        
        <form id="aiForm">
          {{ csrf_token() }}
          <div class="ai-form-group">
            <label class="ai-form-label">Tipo de Evento</label>
            <select class="ai-form-select" id="tipoEvento" required>
              <option value="">Selecione o tipo</option>
                                                        <option value="workshop">Workshop</option>
                                                        <option value="curso">Curso</option>
                                                        <option value="palestra">Palestra</option>
                                                        <option value="seminario">Seminário</option>
                                                        <option value="congresso">Congresso</option>
              <option value="oficina">Oficina</option>
                                                        <option value="treinamento">Treinamento</option>
                                                    </select>
                                                </div>
                                                
          <div class="ai-form-group">
            <label class="ai-form-label">Nome do Evento</label>
            <input type="text" class="ai-form-input" id="nomeEvento" placeholder="Ex: Workshop de Python" required>
                                                </div>
                                                
          <div class="ai-form-group">
            <label class="ai-form-label">Contexto Adicional (opcional)</label>
            <textarea class="ai-form-textarea" id="contexto" placeholder="Ex: Focado em desenvolvimento web, com duração de 40 horas, incluindo projetos práticos..."></textarea>
                                                </div>
                                                
          <button type="submit" class="ai-btn" id="gerarBtn">
            <i class="bi bi-magic"></i> Gerar Texto
                                                </button>
                                            </form>

        <!-- Resultado -->
        <div class="ai-result" id="resultado" style="display: none;">
          <h4><i class="bi bi-file-text"></i> Texto Gerado</h4>
          <div class="ai-result-text" id="textoGerado"></div>
          <div class="mt-3">
            <button class="ai-btn secondary me-2" onclick="copiarTexto()">
              <i class="bi bi-copy"></i> Copiar
                                                </button>
            <button class="ai-btn secondary" onclick="melhorarTexto()">
              <i class="bi bi-pencil"></i> Melhorar
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
      <!-- Painel de Melhoria -->
      <div class="ai-panel">
        <h3><i class="bi bi-tools"></i> Melhorar Texto</h3>
        
        <form id="melhorarForm">
          {{ csrf_token() }}
          <div class="ai-form-group">
            <label class="ai-form-label">Texto Original</label>
            <textarea class="ai-form-textarea" id="textoOriginal" placeholder="Cole aqui o texto que deseja melhorar..."></textarea>
                                            </div>
                                            
          <div class="ai-form-group">
            <label class="ai-form-label">Objetivo da Melhoria</label>
            <select class="ai-form-select" id="objetivo">
              <option value="melhorar">Melhorar Qualidade</option>
              <option value="formalizar">Tornar Mais Formal</option>
              <option value="simplificar">Simplificar</option>
            </select>
                                    </div>
                                    
          <button type="submit" class="ai-btn" id="melhorarBtn">
            <i class="bi bi-wand"></i> Melhorar Texto
                                                    </button>
        </form>

        <!-- Resultado da Melhoria -->
        <div class="ai-result" id="resultadoMelhoria" style="display: none;">
          <h4><i class="bi bi-check-circle"></i> Texto Melhorado</h4>
          <div class="ai-result-text" id="textoMelhorado"></div>
          <div class="mt-3">
            <button class="ai-btn secondary" onclick="copiarTextoMelhorado()">
              <i class="bi bi-copy"></i> Copiar
                </button>
            </div>
        </div>
    </div>
</div>

    <!-- Templates Sugeridos -->
    <div class="ai-panel">
      <h3><i class="bi bi-collection"></i> Templates Sugeridos</h3>
      <div class="ai-templates" id="templatesContainer">
        <!-- Templates serão carregados via JavaScript -->
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="ai-loading" id="loadingOverlay">
  <div class="ai-spinner"></div>
  <p id="loadingText">Processando...</p>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
class AIAssistant {
  constructor() {
    this.currentText = '';
    this.setupEventListeners();
    this.loadStatus();
    this.loadTemplates();
  }

  setupEventListeners() {
    document.getElementById('aiForm').addEventListener('submit', (e) => {
      e.preventDefault();
      this.gerarTexto();
    });

    document.getElementById('melhorarForm').addEventListener('submit', (e) => {
      e.preventDefault();
      this.melhorarTexto();
    });
  }

  async loadStatus() {
    try {
      const response = await fetch('/ai/status');
      const data = await response.json();
      this.displayStatus(data.status);
    } catch (error) {
      console.error('Erro ao carregar status:', error);
      this.displayStatusError();
    }
  }

  displayStatus(status) {
    const statusContainer = document.getElementById('aiStatus');
    statusContainer.innerHTML = `
      <div class="ai-status-item">
        <span class="ai-status-label">Hugging Face</span>
        <span class="ai-status-value ${status.huggingface.disponivel ? 'available' : 'unavailable'}">
          ${status.huggingface.disponivel ? 'Disponível' : 'Indisponível'}
        </span>
      </div>
      <div class="ai-status-item">
        <span class="ai-status-label">TGI</span>
        <span class="ai-status-value ${status.tgi.disponivel ? 'available' : 'unavailable'}">
          ${status.tgi.disponivel ? 'Disponível' : 'Indisponível'}
        </span>
      </div>
      <div class="ai-status-item">
        <span class="ai-status-label">Fallback</span>
        <span class="ai-status-value available">Sempre Disponível</span>
      </div>
    `;
  }

  displayStatusError() {
    const statusContainer = document.getElementById('aiStatus');
    statusContainer.innerHTML = `
      <div class="ai-status-item">
        <span class="ai-status-label">Status</span>
        <span class="ai-status-value unavailable">Erro ao verificar</span>
      </div>
    `;
  }

  async loadTemplates() {
    try {
      const response = await fetch('/ai/templates-sugeridos');
      const data = await response.json();
      this.displayTemplates(data.templates);
    } catch (error) {
      console.error('Erro ao carregar templates:', error);
    }
  }

  displayTemplates(templates) {
    const container = document.getElementById('templatesContainer');
    container.innerHTML = '';

    Object.entries(templates).forEach(([key, template]) => {
      const card = document.createElement('div');
      card.className = 'ai-template-card';
      card.onclick = () => this.usarTemplate(template);
      
      card.innerHTML = `
        <div class="ai-template-title">${template.titulo}</div>
        <div class="ai-template-desc">${template.texto}</div>
        <div class="ai-template-vars">${template.variaveis_recomendadas.join(', ')}</div>
      `;
      
      container.appendChild(card);
    });
  }

  usarTemplate(template) {
    document.getElementById('textoOriginal').value = template.texto;
    this.currentText = template.texto;
  }

  async gerarTexto() {
    const tipoEvento = document.getElementById('tipoEvento').value;
    const nomeEvento = document.getElementById('nomeEvento').value;
    const contexto = document.getElementById('contexto').value;

    if (!tipoEvento || !nomeEvento) {
      this.showAlert('Por favor, preencha o tipo e nome do evento.', 'warning');
        return;
    }
    
    this.showLoading('Gerando texto...');
    
    try {
      const csrfToken = document.querySelector('input[name="csrf_token"]').value;
      const response = await fetch('/ai/gerar-texto-certificado', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            tipo_evento: tipoEvento,
            nome_evento: nomeEvento,
            contexto: contexto
        })
      });

      const data = await response.json();
      this.hideLoading();

      if (data.success) {
        this.currentText = data.texto;
        document.getElementById('textoGerado').textContent = data.texto;
        document.getElementById('resultado').style.display = 'block';
        this.showAlert('Texto gerado com sucesso!', 'success');
            } else {
        this.showAlert('Erro: ' + data.message, 'error');
      }
    } catch (error) {
      this.hideLoading();
      console.error('Erro:', error);
      this.showAlert('Erro ao gerar texto. Tente novamente.', 'error');
    }
  }

  async melhorarTexto() {
    const textoOriginal = document.getElementById('textoOriginal').value;
    const objetivo = document.getElementById('objetivo').value;

    if (!textoOriginal.trim()) {
      this.showAlert('Por favor, insira um texto para melhorar.', 'warning');
        return;
    }
    
    this.showLoading('Melhorando texto...');
    
    try {
      const csrfToken = document.querySelector('input[name="csrf_token"]').value;
      const response = await fetch('/ai/melhorar-texto', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            texto_original: textoOriginal,
            objetivo: objetivo
        })
      });

      const data = await response.json();
      this.hideLoading();

      if (data.success) {
        document.getElementById('textoMelhorado').textContent = data.texto_melhorado;
        document.getElementById('resultadoMelhoria').style.display = 'block';
        this.showAlert('Texto melhorado com sucesso!', 'success');
            } else {
        this.showAlert('Erro: ' + data.message, 'error');
      }
    } catch (error) {
      this.hideLoading();
      console.error('Erro:', error);
      this.showAlert('Erro ao melhorar texto. Tente novamente.', 'error');
    }
  }

  showLoading(text = 'Processando...') {
    document.getElementById('loadingText').textContent = text;
    document.getElementById('loadingOverlay').classList.add('show');
  }

  hideLoading() {
    document.getElementById('loadingOverlay').classList.remove('show');
  }

  showAlert(message, type) {
    const alertContainer = document.getElementById('alertContainer');
    alertContainer.className = `ai-alert ${type}`;
    alertContainer.textContent = message;
    alertContainer.style.display = 'block';
    
    setTimeout(() => {
      alertContainer.style.display = 'none';
    }, 5000);
  }
}

// Funções globais para os botões
function copiarTexto() {
  const texto = document.getElementById('textoGerado').textContent;
  navigator.clipboard.writeText(texto).then(() => {
    // Mostrar feedback visual
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="bi bi-check"></i> Copiado!';
    btn.classList.add('btn-success');
    setTimeout(() => {
        btn.innerHTML = originalText;
        btn.classList.remove('btn-success');
    }, 2000);
  });
}

function copiarTextoMelhorado() {
  const texto = document.getElementById('textoMelhorado').textContent;
  navigator.clipboard.writeText(texto).then(() => {
    // Mostrar feedback visual
    const btn = event.target;
        const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="bi bi-check"></i> Copiado!';
        btn.classList.add('btn-success');
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.classList.remove('btn-success');
    }, 2000);
  });
}

function melhorarTexto() {
  if (assistant.currentText) {
    document.getElementById('textoOriginal').value = assistant.currentText;
    document.getElementById('melhorarForm').scrollIntoView({ behavior: 'smooth' });
  }
}

// Inicializar quando a página carregar
let assistant;
document.addEventListener('DOMContentLoaded', function() {
  assistant = new AIAssistant();
});
</script>
{% endblock %}