{% extends "base.html" %}

{% block title %}Configurações de IA{% endblock %}

{% block styles %}
{{ super() }}
<style>
  .config-page-container {
    background: #f8f9fa;
    min-height: 100vh;
    padding-top: 2rem;
  }

  .config-header {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-color-light) 100%);
    color: white;
    padding: 2rem;
    border-radius: var(--border-radius-lg);
    margin-bottom: 2rem;
    box-shadow: var(--shadow-md);
  }

  .config-header h1 {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
  }

  .config-header p {
    font-size: 1.1rem;
    opacity: 0.9;
    margin: 0;
  }

  .config-card {
    background: white;
    border-radius: var(--border-radius-lg);
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: var(--shadow-sm);
    border: 1px solid #e9ecef;
    transition: var(--transition-normal);
  }

  .config-card:hover {
    box-shadow: var(--shadow-md);
    transform: translateY(-2px);
  }

  .config-card h3 {
    color: var(--text-dark);
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    border-bottom: 2px solid #f1f3f4;
    padding-bottom: 0.75rem;
  }

  .config-form-group {
    margin-bottom: 1.5rem;
  }

  .config-form-label {
    display: block;
    font-weight: 600;
    color: var(--text-dark);
    margin-bottom: 0.5rem;
    font-size: 0.875rem;
  }

  .config-form-input,
  .config-form-select,
  .config-form-textarea {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 2px solid #e9ecef;
    border-radius: var(--border-radius);
    font-size: 1rem;
    transition: var(--transition-fast);
    background: #f8f9fa;
  }

  .config-form-input:focus,
  .config-form-select:focus,
  .config-form-textarea:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(42, 45, 114, 0.1);
    background: white;
  }

  .config-form-textarea {
    min-height: 6rem;
    resize: vertical;
  }

  .config-btn {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-color-light) 100%);
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: var(--border-radius);
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition-normal);
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 1rem;
    box-shadow: var(--shadow-xs);
  }

  .config-btn:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-sm);
  }

  .config-btn:disabled {
    background: #6c757d;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
  }

  .config-btn.secondary {
    background: white;
    color: var(--text-dark);
    border: 2px solid #e9ecef;
  }

  .config-btn.secondary:hover {
    background: #f8f9fa;
    border-color: var(--primary-color);
  }

  .config-btn.danger {
    background: var(--danger-color);
  }

  .config-btn.danger:hover {
    background: #c82333;
  }

  .config-status {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: var(--border-radius);
    padding: 1.5rem;
    margin-bottom: 1.5rem;
  }

  .config-status-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 0;
    border-bottom: 1px solid #f1f3f4;
  }

  .config-status-item:last-child {
    border-bottom: none;
  }

  .config-status-label {
    font-weight: 600;
    color: var(--text-dark);
    font-size: 0.875rem;
  }

  .config-status-value {
    font-size: 0.875rem;
    font-weight: 500;
  }

  .config-status-value.available {
    color: var(--success-color);
    font-weight: 600;
  }

  .config-status-value.unavailable {
    color: var(--danger-color);
    font-weight: 600;
  }

  .config-help {
    background: rgba(23, 162, 184, 0.1);
    border: 1px solid rgba(23, 162, 184, 0.2);
    border-radius: var(--border-radius);
    padding: 1.25rem;
    margin-bottom: 1.5rem;
  }

  .config-help h4 {
    color: var(--info-color);
    margin-bottom: 0.75rem;
    font-weight: 600;
    font-size: 1rem;
  }

  .config-help p {
    color: var(--text-muted);
    font-size: 0.875rem;
    margin: 0;
    line-height: 1.5;
  }

  .config-help a {
    color: var(--info-color);
    text-decoration: none;
    font-weight: 500;
  }

  .config-help a:hover {
    text-decoration: underline;
  }

  .config-test {
    background: #f8f9fa;
    border-radius: var(--border-radius);
    padding: 1.25rem;
    margin-top: 1.5rem;
    border: 1px solid #e9ecef;
  }

  .config-test h4 {
    color: var(--text-dark);
    margin-bottom: 1rem;
    font-weight: 600;
    font-size: 1rem;
  }

  .config-test-result {
    background: white;
    border: 1px solid #e9ecef;
    border-radius: var(--border-radius);
    padding: 1rem;
    font-family: 'Poppins', sans-serif;
    font-size: 0.875rem;
    white-space: pre-wrap;
    word-wrap: break-word;
    max-height: 200px;
    overflow-y: auto;
    color: var(--text-dark);
    margin-top: 0.75rem;
  }

  .config-alert {
    padding: 1rem 1.25rem;
    border-radius: var(--border-radius);
    margin-bottom: 1.5rem;
    display: none;
    font-weight: 500;
  }

  .config-alert.success {
    background: rgba(40, 167, 69, 0.1);
    border: 1px solid rgba(40, 167, 69, 0.2);
    color: #155724;
  }

  .config-alert.error {
    background: rgba(220, 53, 69, 0.1);
    border: 1px solid rgba(220, 53, 69, 0.2);
    color: #721c24;
  }

  .config-alert.warning {
    background: rgba(255, 193, 7, 0.1);
    border: 1px solid rgba(255, 193, 7, 0.2);
    color: #856404;
  }

  .config-actions {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .config-checkbox {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1rem;
  }

  .config-checkbox input[type="checkbox"] {
    width: auto;
    margin: 0;
  }

  .config-checkbox label {
    margin: 0;
    font-weight: 500;
    color: var(--text-dark);
  }

  .config-small-text {
    font-size: 0.75rem;
    color: var(--text-muted);
    margin-top: 0.25rem;
  }

  @media (max-width: 768px) {
    .config-header h1 {
      font-size: 2rem;
    }
    
    .config-card {
      padding: 1.5rem;
    }
    
    .config-actions {
      flex-direction: column;
    }
    
    .config-actions .config-btn {
      width: 100%;
      justify-content: center;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="config-page-container">
  <div class="container">
    <!-- Header -->
    <div class="config-header">
      <h1><i class="bi bi-gear-fill me-3"></i>Configurações de IA</h1>
      <p>Configure os serviços de inteligência artificial para geração de texto</p>
    </div>

    <!-- Alertas -->
    <div class="config-alert" id="alertContainer"></div>

    <!-- Status Atual -->
    <div class="config-card">
      <h3><i class="bi bi-activity"></i> Status dos Serviços</h3>
      <div class="config-status" id="statusContainer">
        <div class="text-center py-3">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Carregando...</span>
          </div>
          <p class="text-muted mb-0 mt-2">Verificando serviços...</p>
        </div>
      </div>
    </div>

    <!-- Configurações do Hugging Face -->
    <div class="config-card">
      <h3><i class="bi bi-cloud"></i> Hugging Face</h3>
      
      <div class="config-help">
        <h4>Como obter a API Key:</h4>
        <p>1. Acesse <a href="https://huggingface.co/settings/tokens" target="_blank">huggingface.co/settings/tokens</a><br>
        2. Crie um novo token com permissões de leitura<br>
        3. Cole o token no campo abaixo</p>
      </div>

      <form id="hfConfigForm">
        {{ csrf_token() }}
        <div class="config-form-group">
          <label class="config-form-label">API Key</label>
          <input type="password" class="config-form-input" id="hfApiKey" placeholder="hf_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx">
        </div>

        <div class="config-form-group">
          <label class="config-form-label">Modelo</label>
          <select class="config-form-select" id="hfModel">
            <option value="microsoft/DialoGPT-medium">DialoGPT Medium</option>
            <option value="microsoft/DialoGPT-large">DialoGPT Large</option>
            <option value="gpt2">GPT-2</option>
            <option value="distilgpt2">DistilGPT-2</option>
            <option value="neuralmind/bert-base-portuguese-cased">BERT Português</option>
          </select>
        </div>

        <button type="submit" class="config-btn">
          <i class="bi bi-save"></i> Salvar Configurações
        </button>
      </form>

      <div class="config-test" id="hfTest" style="display: none;">
        <h4><i class="bi bi-play-circle"></i> Teste de Conectividade</h4>
        <button class="config-btn secondary" onclick="testarHuggingFace()">
          <i class="bi bi-play"></i> Testar Conexão
        </button>
        <div class="config-test-result" id="hfTestResult"></div>
      </div>
    </div>

    <!-- Configurações do TGI -->
    <div class="config-card">
      <h3><i class="bi bi-lightning"></i> Text Generation Inference (TGI)</h3>
      
      <div class="config-help">
        <h4>Configuração do TGI:</h4>
        <p>Para usar TGI, você precisa ter um servidor TGI rodando. Consulte a <a href="https://huggingface.co/docs/text-generation-inference" target="_blank">documentação oficial</a> para instalação.</p>
      </div>

      <form id="tgiConfigForm">
        {{ csrf_token() }}
        <div class="config-checkbox">
          <input type="checkbox" id="useTgi">
          <label for="useTgi">Usar TGI</label>
        </div>

        <div class="config-form-group">
          <label class="config-form-label">Endpoint do TGI</label>
          <input type="url" class="config-form-input" id="tgiEndpoint" placeholder="http://localhost:3000" disabled>
        </div>

        <button type="submit" class="config-btn">
          <i class="bi bi-save"></i> Salvar Configurações
        </button>
      </form>

      <div class="config-test" id="tgiTest" style="display: none;">
        <h4><i class="bi bi-play-circle"></i> Teste de Conectividade</h4>
        <button class="config-btn secondary" onclick="testarTGI()">
          <i class="bi bi-play"></i> Testar Conexão
        </button>
        <div class="config-test-result" id="tgiTestResult"></div>
      </div>
    </div>

    <!-- Configurações Avançadas -->
    <div class="config-card">
      <h3><i class="bi bi-sliders"></i> Configurações Avançadas</h3>

      <form id="advancedConfigForm">
        {{ csrf_token() }}
        <div class="config-form-group">
          <label class="config-form-label">Timeout das Requisições (segundos)</label>
          <input type="number" class="config-form-input" id="requestTimeout" value="30" min="5" max="120">
        </div>

        <div class="config-form-group">
          <label class="config-form-label">Número Máximo de Tentativas</label>
          <input type="number" class="config-form-input" id="maxRetries" value="3" min="1" max="10">
        </div>

        <div class="config-checkbox">
          <input type="checkbox" id="enableFallback" checked>
          <label for="enableFallback">Usar Templates de Fallback</label>
        </div>
        <div class="config-small-text">Quando os serviços de IA não estiverem disponíveis</div>

        <button type="submit" class="config-btn">
          <i class="bi bi-save"></i> Salvar Configurações
        </button>
      </form>
    </div>

    <!-- Ações -->
    <div class="config-card">
      <h3><i class="bi bi-tools"></i> Ações</h3>
      
      <div class="config-actions">
        <button class="config-btn secondary" onclick="recarregarStatus()">
          <i class="bi bi-arrow-clockwise"></i> Recarregar Status
        </button>
        
        <button class="config-btn secondary" onclick="testarTodos()">
          <i class="bi bi-play-circle"></i> Testar Todos os Serviços
        </button>
        
        <button class="config-btn danger" onclick="resetarConfiguracoes()">
          <i class="bi bi-trash"></i> Resetar Configurações
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
class AIConfigManager {
  constructor() {
    this.setupEventListeners();
    this.loadStatus();
    this.loadConfig();
  }

  setupEventListeners() {
    document.getElementById('hfConfigForm').addEventListener('submit', (e) => {
      e.preventDefault();
      this.salvarConfigHF();
    });

    document.getElementById('tgiConfigForm').addEventListener('submit', (e) => {
      e.preventDefault();
      this.salvarConfigTGI();
    });

    document.getElementById('advancedConfigForm').addEventListener('submit', (e) => {
      e.preventDefault();
      this.salvarConfigAvancada();
    });

    document.getElementById('useTgi').addEventListener('change', (e) => {
      document.getElementById('tgiEndpoint').disabled = !e.target.checked;
    });
  }

  async loadStatus() {
    try {
      const response = await fetch('/ai/status');
      const data = await response.json();
      this.displayStatus(data.status);
    } catch (error) {
      console.error('Erro ao carregar status:', error);
      this.displayStatusError();
    }
  }

  displayStatus(status) {
    const container = document.getElementById('statusContainer');
    container.innerHTML = `
      <div class="config-status-item">
        <span class="config-status-label">Hugging Face</span>
        <span class="config-status-value ${status.huggingface.disponivel ? 'available' : 'unavailable'}">
          ${status.huggingface.disponivel ? 'Disponível' : 'Indisponível'}
        </span>
      </div>
      <div class="config-status-item">
        <span class="config-status-label">TGI</span>
        <span class="config-status-value ${status.tgi.disponivel ? 'available' : 'unavailable'}">
          ${status.tgi.disponivel ? 'Disponível' : 'Indisponível'}
        </span>
      </div>
      <div class="config-status-item">
        <span class="config-status-label">Fallback</span>
        <span class="config-status-value available">Sempre Disponível</span>
      </div>
    `;
  }

  displayStatusError() {
    const container = document.getElementById('statusContainer');
    container.innerHTML = `
      <div class="config-status-item">
        <span class="config-status-label">Status</span>
        <span class="config-status-value unavailable">Erro ao verificar</span>
      </div>
    `;
  }

  async loadConfig() {
    // Carregar configurações salvas (implementar conforme necessário)
    // Por enquanto, usar valores padrão
  }

  async salvarConfigHF() {
    const apiKey = document.getElementById('hfApiKey').value;
    const model = document.getElementById('hfModel').value;

    if (!apiKey.trim()) {
      this.showAlert('Por favor, insira a API Key do Hugging Face.', 'warning');
      return;
    }

    try {
      const csrfToken = document.querySelector('input[name="csrf_token"]').value;
      const response = await fetch('/ai/configuracoes', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
          tipo: 'huggingface',
          api_key: apiKey,
          model: model
        })
      });

      const data = await response.json();
      
      if (data.success) {
        this.showAlert('Configurações do Hugging Face salvas com sucesso!', 'success');
        document.getElementById('hfTest').style.display = 'block';
        this.loadStatus();
      } else {
        this.showAlert('Erro ao salvar configurações: ' + data.message, 'error');
      }
    } catch (error) {
      console.error('Erro:', error);
      this.showAlert('Erro ao salvar configurações.', 'error');
    }
  }

  async salvarConfigTGI() {
    const useTgi = document.getElementById('useTgi').checked;
    const endpoint = document.getElementById('tgiEndpoint').value;

    if (useTgi && !endpoint.trim()) {
      this.showAlert('Por favor, insira o endpoint do TGI.', 'warning');
      return;
    }

    try {
      const csrfToken = document.querySelector('input[name="csrf_token"]').value;
      const response = await fetch('/ai/configuracoes', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
          tipo: 'tgi',
          use_tgi: useTgi,
          endpoint: endpoint
        })
      });

      const data = await response.json();
      
      if (data.success) {
        this.showAlert('Configurações do TGI salvas com sucesso!', 'success');
        if (useTgi) {
          document.getElementById('tgiTest').style.display = 'block';
        }
        this.loadStatus();
      } else {
        this.showAlert('Erro ao salvar configurações: ' + data.message, 'error');
      }
    } catch (error) {
      console.error('Erro:', error);
      this.showAlert('Erro ao salvar configurações.', 'error');
    }
  }

  async salvarConfigAvancada() {
    const timeout = document.getElementById('requestTimeout').value;
    const retries = document.getElementById('maxRetries').value;
    const fallback = document.getElementById('enableFallback').checked;

    try {
      const csrfToken = document.querySelector('input[name="csrf_token"]').value;
      const response = await fetch('/ai/configuracoes', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
          tipo: 'advanced',
          timeout: parseInt(timeout),
          retries: parseInt(retries),
          fallback: fallback
        })
      });

      const data = await response.json();
      
      if (data.success) {
        this.showAlert('Configurações avançadas salvas com sucesso!', 'success');
      } else {
        this.showAlert('Erro ao salvar configurações: ' + data.message, 'error');
      }
    } catch (error) {
      console.error('Erro:', error);
      this.showAlert('Erro ao salvar configurações.', 'error');
    }
  }

  showAlert(message, type) {
    const alertContainer = document.getElementById('alertContainer');
    alertContainer.className = `config-alert ${type}`;
    alertContainer.textContent = message;
    alertContainer.style.display = 'block';
    
    setTimeout(() => {
      alertContainer.style.display = 'none';
    }, 5000);
  }
}

// Funções globais
async function testarHuggingFace() {
  const result = document.getElementById('hfTestResult');
  result.textContent = 'Testando conexão...';
  
  try {
    const csrfToken = document.querySelector('input[name="csrf_token"]').value;
    const response = await fetch('/ai/testar-huggingface', {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrfToken
      }
    });
    const data = await response.json();
    result.textContent = JSON.stringify(data, null, 2);
  } catch (error) {
    result.textContent = 'Erro: ' + error.message;
  }
}

async function testarTGI() {
  const result = document.getElementById('tgiTestResult');
  result.textContent = 'Testando conexão...';
  
  try {
    const csrfToken = document.querySelector('input[name="csrf_token"]').value;
    const response = await fetch('/ai/testar-tgi', {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrfToken
      }
    });
    const data = await response.json();
    result.textContent = JSON.stringify(data, null, 2);
  } catch (error) {
    result.textContent = 'Erro: ' + error.message;
  }
}

async function testarTodos() {
  await testarHuggingFace();
  await testarTGI();
}

function recarregarStatus() {
  if (window.configManager) {
    window.configManager.loadStatus();
  }
}

function resetarConfiguracoes() {
  if (confirm('Tem certeza que deseja resetar todas as configurações de IA?')) {
    // Implementar reset
    alert('Funcionalidade de reset será implementada em breve.');
  }
}

// Inicializar quando a página carregar
let configManager;
document.addEventListener('DOMContentLoaded', function() {
  configManager = new AIConfigManager();
  window.configManager = configManager;
});
</script>
{% endblock %}