{% extends "base.html" %}
{% block title %}Configurações de Submissão{% endblock %}

{% block content %}
<div class="container py-4">
  <h1 class="h3 mb-4"><i class="bi bi-journal-text me-2"></i>Submissões e Revisão</h1>
  <div class="card border-info border-top border-4 shadow-sm mb-4">
    <div class="card-header bg-info text-white">
      <div class="d-flex align-items-center">
        <i class="bi bi-journal-text me-2 fs-5"></i>
        <h5 class="fw-bold mb-0">Submissões e Revisão</h5>
      </div>
    </div>
    <div class="card-body">
      <div class="config-item d-flex justify-content-between align-items-center p-3 border-bottom">
        <div>
          <h6 class="mb-0 fw-semibold d-flex align-items-center">
            <i class="bi bi-upload text-primary me-2"></i>
            Submissão de Trabalhos
          </h6>
          <p class="text-muted small mb-0">Permite que participantes submetam trabalhos</p>
        </div>
        <button type="button"
                id="btnToggleSubmissao"
                class="btn btn-padrao btn-toggle btn-{{ 'success' if config_cliente and config_cliente.habilitar_submissao_trabalhos else 'danger' }}"
                data-toggle-url="{{ url_for('config_cliente_routes.toggle_submissao_trabalhos_cliente') }}">
          <i class="bi bi-{{ 'check-circle-fill' if config_cliente and config_cliente.habilitar_submissao_trabalhos else 'x-circle-fill' }}"></i>
          {{ 'Ativo' if config_cliente and config_cliente.habilitar_submissao_trabalhos else 'Desativado' }}
        </button>
      </div>
      <div class="config-item d-flex justify-content-between align-items-center p-3 border-bottom">
        <div>
          <h6 class="mb-0 fw-semibold">Tipos de Arquivo Permitidos</h6>
        </div>
        <input type="text" id="inputAllowedFiles" class="form-control w-auto" value="{{ config_cliente.allowed_file_types }}" data-update-url="{{ url_for('config_cliente_routes.set_allowed_file_types') }}">
      </div>
      <div class="config-item d-flex justify-content-between align-items-center p-3 border-bottom">
        <div>
          <h6 class="mb-0 fw-semibold">Formulário de Submissão</h6>
        </div>
        <select id="selectFormularioSubmissao" class="form-select w-auto" data-update-url="{{ url_for('config_cliente_routes.set_formulario_submissao') }}">
          <option value="" {% if not config_cliente.formulario_submissao_id %}selected{% endif %}>Padrão</option>
          {% for formulario in formularios %}
          <option value="{{ formulario.id }}" {% if config_cliente.formulario_submissao_id == formulario.id %}selected{% endif %}>{{ formulario.nome }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="config-item d-flex justify-content-between align-items-center p-3 border-bottom">
        <div>
          <h6 class="mb-0 fw-semibold">Modelo de Revisão</h6>
        </div>
        <select id="selectReviewModel" class="form-select w-auto" data-update-url="{{ url_for('config_cliente_routes.set_review_model') }}">
          <option value="single" {% if config_cliente.review_model == 'single' %}selected{% endif %}>Single-blind</option>
          <option value="double" {% if config_cliente.review_model == 'double' %}selected{% endif %}>Double-blind</option>
        </select>
      </div>
        <div class="config-item p-3">
          <div class="row g-2 align-items-end">
          <div class="col">
            <label class="form-label mb-0">Mínimo Revisores</label>
            <input type="number" min="1" class="form-control" id="inputRevisoresMin" value="{{ config_cliente.num_revisores_min }}" data-update-url="{{ url_for('config_cliente_routes.set_num_revisores_min') }}">
          </div>
          <div class="col">
            <label class="form-label mb-0">Máximo Revisores</label>
            <input type="number" min="1" class="form-control" id="inputRevisoresMax" value="{{ config_cliente.num_revisores_max }}" data-update-url="{{ url_for('config_cliente_routes.set_num_revisores_max') }}">
          </div>
          <div class="col">
            <label class="form-label mb-0">Prazo (dias)</label>
            <input type="number" min="1" class="form-control" id="inputPrazoParecer" value="{{ config_cliente.prazo_parecer_dias }}" data-update-url="{{ url_for('config_cliente_routes.set_prazo_parecer_dias') }}">
          </div>
          <div class="col">
            <label class="form-label mb-0">Máx. Trab./Revisor</label>
            <input type="number" min="1" class="form-control" id="inputMaxTrabalhosRevisor" value="{{ config_cliente.max_trabalhos_por_revisor }}" data-update-url="{{ url_for('config_cliente_routes.set_max_trabalhos_revisor') }}">
          </div>
        </div>
        {% if eventos %}
        <div class="mt-3">
          <h6 class="mb-2 fw-semibold">Submissão por Evento</h6>
          {% for evento in eventos %}
          <div class="config-item d-flex justify-content-between align-items-center p-2 border-bottom">
            <span>{{ evento.nome }}</span>
            <button type="button"
                    class="btn btn-padrao btn-toggle btn-{{ 'success' if evento.submissao_aberta else 'danger' }}"
                    data-toggle-url="{{ url_for('config_cliente_routes.toggle_submissao_evento', evento_id=evento.id) }}"
                    data-label="{{ evento.nome }}">
              {{ 'Ativo' if evento.submissao_aberta else 'Desativado' }}
            </button>
          </div>
          {% endfor %}
        </div>
        <div class="mt-3">
          <h6 class="mb-2 fw-semibold">Configuração de Revisão por Evento</h6>
          <form id="formRevisaoConfig" class="row g-2 align-items-end">
            <div class="col">
              <label class="form-label mb-0">Evento</label>
              <select id="selectEventoRevisao" class="form-select">
                {% for evento in eventos %}
                <option value="{{ evento.id }}">{{ evento.nome }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col">
              <label class="form-label mb-0">Nº Revisores</label>
              <input type="number" min="1" class="form-control" id="inputNumeroRevisores">
            </div>
            <div class="col">
              <label class="form-label mb-0">Prazo Revisão</label>
              <input type="date" class="form-control" id="inputPrazoRevisao">
            </div>
            <div class="col">
              <label class="form-label mb-0">Modelo Blind</label>
              <select id="selectModeloBlind" class="form-select">
                <option value="single">Single-blind</option>
                <option value="double">Double-blind</option>
                <option value="open">Open review</option>
              </select>
            </div>
            <div class="col-12 col-sm-2">
              <button type="submit" class="btn btn-primary w-100 mt-2 mt-sm-0">Salvar</button>
            </div>
          </form>
        </div>
        {% endif %}
      </div>
    </div>
    </div>
  <div class="accordion mt-4" id="accordionDistribuicao">
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingDistribuicao">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDistribuicao" aria-expanded="false" aria-controls="collapseDistribuicao">
          Distribuição de Trabalhos
        </button>
      </h2>
      <div id="collapseDistribuicao" class="accordion-collapse collapse" aria-labelledby="headingDistribuicao" data-bs-parent="#accordionDistribuicao">
        <div class="accordion-body">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Título</th>
                <th>Localizador</th>
                <th>Autor</th>
                <th>Revisores</th>
              </tr>
            </thead>
            <tbody>
              {% for sub in submissions %}
              <tr>
                <td>{{ sub.title }}</td>
                <td>{{ sub.locator }}</td>
                <td>{{ sub.author.nome if sub.author else 'N/A' }}</td>
                <td>
                  <ul class="mb-0">
                    {% for rev in sub.reviews %}
                    <li>{{ rev.reviewer.nome if rev.reviewer else 'N/A' }} - {{ rev.access_code }}</li>
                    {% else %}
                    <li>Nenhum revisor atribuído</li>
                    {% endfor %}
                  </ul>
                  <button class="btn btn-sm btn-secondary mt-1 gerar-codigos" data-locator="{{ sub.locator }}">Gerar Códigos</button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>

          <div class="mt-5">
            <h4>Atribuir Revisores</h4>
            <div class="mb-3">
              <label for="submissionSelect" class="form-label">Submissão</label>
              <select id="submissionSelect" class="form-select">
                {% for sub in submissions %}
                <option value="{{ sub.id }}">{{ sub.title }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="mb-3">
              <label for="reviewerSelect" class="form-label">Revisores</label>
              <select id="reviewerSelect" class="form-select" multiple>
                {% for r in reviewers %}
                <option value="{{ r.id }}">{{ r.nome }}</option>
                {% endfor %}
              </select>
              <small class="form-text text-muted">
                Selecione entre {{ config_cliente.num_revisores_min if config_cliente else 1 }} e {{ config_cliente.num_revisores_max if config_cliente else 2 }} revisores.
              </small>
            </div>
            <button id="assignManual" class="btn btn-primary me-2">Atribuir Manualmente</button>
            <button id="assignAutomatic" class="btn btn-secondary me-2">Sorteio Automático</button>
            <div class="input-group mt-2" style="max-width: 300px;">
              <input type="number" id="eventoId" class="form-control" placeholder="ID do Evento" />
              <button id="autoArea" class="btn btn-info">Auto por Área</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  </div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/dashboard_cliente.js') }}"></script>
<script>
  window.URL_CONFIG_CLIENTE_ATUAL = "{{ url_for('config_cliente_routes.configuracao_cliente_atual') }}";
  const REVISAO_CONFIGS = {{ revisao_configs|tojson }};
  const formRevisao = document.getElementById('formRevisaoConfig');
  const selectEventoRevisao = document.getElementById('selectEventoRevisao');
  const inputNumeroRevisores = document.getElementById('inputNumeroRevisores');
  const inputPrazoRevisao = document.getElementById('inputPrazoRevisao');
  const selectModeloBlind = document.getElementById('selectModeloBlind');

  function carregarConfig(id) {
    const cfg = REVISAO_CONFIGS[id] || {};
    inputNumeroRevisores.value = cfg.numero_revisores || 2;
    inputPrazoRevisao.value = cfg.prazo_revisao ? cfg.prazo_revisao.split('T')[0] : '';
    selectModeloBlind.value = cfg.modelo_blind || 'single';
  }

  if (selectEventoRevisao) {
    carregarConfig(selectEventoRevisao.value);
    selectEventoRevisao.addEventListener('change', () => carregarConfig(selectEventoRevisao.value));
  }

  formRevisao?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const eventoId = selectEventoRevisao.value;
    const payload = {
      numero_revisores: parseInt(inputNumeroRevisores.value, 10),
      modelo_blind: selectModeloBlind.value,
    };
    if (inputPrazoRevisao.value) {
      payload.prazo_revisao = inputPrazoRevisao.value;
    }
    const resp = await fetch(`/revisao_config/${eventoId}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });
    if (resp.ok) {
      REVISAO_CONFIGS[eventoId] = payload;
      alert('Configuração de revisão atualizada');
    } else {
      alert('Erro ao salvar configuração');
    }
  });

  // ---------------- Distribuição de Trabalhos ----------------
  document.querySelectorAll('.gerar-codigos').forEach((btn) => {
    btn.addEventListener('click', () => {
      const loc = btn.dataset.locator;
      fetch(`/submissions/${loc}/codes`)
        .then((r) => r.json())
        .then((data) => {
          if (data.reviews) {
            alert(data.reviews.map((r) => r.access_code).join('\n'));
          }
        });
    });
  });

  const minRev = {{ config_cliente.num_revisores_min if config_cliente else 1 }};
  const maxRev = {{ config_cliente.num_revisores_max if config_cliente else 2 }};

  document.getElementById('assignManual')?.addEventListener('click', () => {
    const subId = document.getElementById('submissionSelect').value;
    const selected = Array.from(
      document.getElementById('reviewerSelect').selectedOptions
    ).map((o) => o.value);
    if (selected.length < minRev || selected.length > maxRev) {
      alert(`Selecione entre ${minRev} e ${maxRev} revisores.`);
      return;
    }
    const payload = {};
    payload[subId] = selected;
    fetch('/assign_reviews', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    })
      .then((r) => r.json())
      .then((data) => {
        if (data.success) {
          alert('Revisores atribuídos com sucesso');
          location.reload();
        } else {
          alert('Falha ao atribuir revisores');
        }
      });
  });

  document.getElementById('assignAutomatic')?.addEventListener('click', () => {
    fetch('/assign_by_filters', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ filters: {} }),
    })
      .then((r) => r.json())
      .then((data) => {
        if (data.success) {
          alert('Sorteio realizado');
          location.reload();
        } else {
          alert(data.message || 'Falha no sorteio');
        }
      });
  });

  document.getElementById('autoArea')?.addEventListener('click', () => {
    const eventoId = document.getElementById('eventoId').value;
    if (!eventoId) {
      alert('Informe o ID do evento');
      return;
    }
    fetch(`/auto_assign/${eventoId}`, { method: 'POST' })
      .then((r) => r.json())
      .then((data) => {
        if (data.success) {
          alert('Atribuições criadas');
          location.reload();
        } else {
          alert(data.message || 'Erro na atribuição automática');
        }
      });
  });
</script>
{% endblock %}
