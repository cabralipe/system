{% extends "base.html" %}

{% block title %}Liberar Declarações - {{ evento.nome }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Liberar Declarações - {{ evento.nome }}</h3>
                    <div class="card-tools">
                        <a href="{{ url_for('evento_routes.detalhes_evento', evento_id=evento.id) }}" class="btn btn-secondary btn-sm">
                            <i class="fas fa-arrow-left"></i> Voltar
                        </a>
                    </div>
                </div>
                
                <div class="card-body">
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <h5>Gerenciar Liberação de Declarações</h5>
                            <p class="text-muted">Libere ou bloqueie o acesso dos participantes às suas declarações.</p>
                        </div>
                    </div>
                    
                    {% if participantes %}
                    <form method="POST" action="{{ url_for('declaracao.liberar_participantes', evento_id=evento.id) }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Ação em Lote</label>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button" class="btn btn-success" id="liberarTodos">
                                            <i class="fas fa-unlock"></i> Liberar Selecionados
                                        </button>
                                        <button type="button" class="btn btn-warning" id="bloquearTodos">
                                            <i class="fas fa-lock"></i> Bloquear Selecionados
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Filtrar por Status</label>
                                    <select id="filtroStatus" class="form-control form-control-sm">
                                        <option value="">Todos</option>
                                        <option value="liberado">Liberados</option>
                                        <option value="bloqueado">Bloqueados</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="thead-light">
                                    <tr>
                                        <th width="50">
                                            <input type="checkbox" id="selectAll">
                                        </th>
                                        <th>Nome</th>
                                        <th>Email</th>
                                        <th>CPF</th>
                                        <th>Status Atual</th>
                                        <th>Última Atualização</th>
                                        <th width="150">Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for participante in participantes %}
                                    <tr class="participante-row" data-status="{{ 'liberado' if participante.declaracao_liberada else 'bloqueado' }}">
                                        <td>
                                            <input type="checkbox" name="participantes_selecionados" 
                                                   value="{{ participante.id }}" class="participante-checkbox">
                                        </td>
                                        <td>
                                            <strong>{{ participante.nome }}</strong>
                                        </td>
                                        <td>{{ participante.email }}</td>
                                        <td>{{ participante.cpf or '-' }}</td>
                                        <td>
                                            {% if participante.declaracao_liberada %}
                                            <span class="badge badge-success">
                                                <i class="fas fa-unlock"></i> Liberado
                                            </span>
                                            {% else %}
                                            <span class="badge badge-warning">
                                                <i class="fas fa-lock"></i> Bloqueado
                                            </span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if participante.data_liberacao %}
                                            {{ participante.data_liberacao.strftime('%d/%m/%Y %H:%M') }}
                                            {% else %}
                                            -
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm" role="group">
                                                {% if participante.declaracao_liberada %}
                                                <button type="button" class="btn btn-warning btn-sm" 
                                                        onclick="alterarStatus({{ participante.id }}, false)">
                                                    <i class="fas fa-lock"></i>
                                                </button>
                                                {% else %}
                                                <button type="button" class="btn btn-success btn-sm" 
                                                        onclick="alterarStatus({{ participante.id }}, true)">
                                                    <i class="fas fa-unlock"></i>
                                                </button>
                                                {% endif %}
                                                
                                                {% if participante.declaracao_liberada %}
                                                <a href="{{ url_for('declaracao.visualizar', participante_id=participante.id) }}" 
                                                   class="btn btn-info btn-sm" target="_blank">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <input type="hidden" name="acao" id="acaoInput">
                        <input type="hidden" name="participante_id" id="participanteIdInput">
                        <input type="hidden" name="status_liberacao" id="statusLiberacaoInput">
                        
                    </form>
                    
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-users fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">Nenhum participante encontrado</h5>
                        <p class="text-muted">Este evento ainda não possui participantes registrados.</p>
                        <a href="{{ url_for('evento_routes.detalhes_evento', evento_id=evento.id) }}" class="btn btn-primary">
                            <i class="fas fa-arrow-left"></i> Voltar ao Evento
                        </a>
                    </div>
                    {% endif %}
                </div>
                
                {% if participantes %}
                <div class="card-footer">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="alert alert-info mb-0">
                                <i class="fas fa-info-circle"></i>
                                <strong>Informação:</strong> Participantes com declarações liberadas podem acessar e baixar seus certificados.
                            </div>
                        </div>
                        <div class="col-md-4 text-right">
                            <span class="text-muted">
                                Total: {{ participantes|length }} participantes
                            </span>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const selectAll = document.getElementById('selectAll');
    const participanteCheckboxes = document.querySelectorAll('.participante-checkbox');
    const liberarTodosBtn = document.getElementById('liberarTodos');
    const bloquearTodosBtn = document.getElementById('bloquearTodos');
    const filtroStatus = document.getElementById('filtroStatus');
    const participanteRows = document.querySelectorAll('.participante-row');
    
    // Selecionar todos
    if (selectAll) {
        selectAll.addEventListener('change', function() {
            const visibleCheckboxes = Array.from(participanteCheckboxes).filter(cb => {
                return cb.closest('tr').style.display !== 'none';
            });
            
            visibleCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            
            updateBatchButtons();
        });
    }
    
    // Monitorar checkboxes individuais
    participanteCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            updateSelectAll();
            updateBatchButtons();
        });
    });
    
    // Filtro por status
    if (filtroStatus) {
        filtroStatus.addEventListener('change', function() {
            const filtro = this.value;
            
            participanteRows.forEach(row => {
                if (filtro === '' || row.dataset.status === filtro) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
            
            updateSelectAll();
            updateBatchButtons();
        });
    }
    
    // Ações em lote
    if (liberarTodosBtn) {
        liberarTodosBtn.addEventListener('click', function() {
            executarAcaoLote('liberar', true);
        });
    }
    
    if (bloquearTodosBtn) {
        bloquearTodosBtn.addEventListener('click', function() {
            executarAcaoLote('bloquear', false);
        });
    }
    
    function updateSelectAll() {
        const visibleCheckboxes = Array.from(participanteCheckboxes).filter(cb => {
            return cb.closest('tr').style.display !== 'none';
        });
        
        const checkedVisible = visibleCheckboxes.filter(cb => cb.checked);
        
        if (selectAll) {
            selectAll.checked = visibleCheckboxes.length > 0 && checkedVisible.length === visibleCheckboxes.length;
            selectAll.indeterminate = checkedVisible.length > 0 && checkedVisible.length < visibleCheckboxes.length;
        }
    }
    
    function updateBatchButtons() {
        const checkedBoxes = Array.from(participanteCheckboxes).filter(cb => cb.checked);
        const hasSelection = checkedBoxes.length > 0;
        
        if (liberarTodosBtn) liberarTodosBtn.disabled = !hasSelection;
        if (bloquearTodosBtn) bloquearTodosBtn.disabled = !hasSelection;
    }
    
    function executarAcaoLote(acao, status) {
        const checkedBoxes = Array.from(participanteCheckboxes).filter(cb => cb.checked);
        
        if (checkedBoxes.length === 0) {
            alert('Selecione pelo menos um participante.');
            return;
        }
        
        const participanteIds = checkedBoxes.map(cb => cb.value);
        const acaoTexto = acao === 'liberar' ? 'liberar' : 'bloquear';
        
        if (confirm(`Deseja ${acaoTexto} as declarações de ${participanteIds.length} participante(s)?`)) {
            // Criar formulário dinâmico para envio
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '{{ url_for("declaracao.liberar_participantes", evento_id=evento.id) }}';
            
            // CSRF Token
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrf_token';
            csrfInput.value = '{{ csrf_token() }}';
            form.appendChild(csrfInput);
            
            // Ação
            const acaoInput = document.createElement('input');
            acaoInput.type = 'hidden';
            acaoInput.name = 'acao';
            acaoInput.value = 'lote';
            form.appendChild(acaoInput);
            
            // Status
            const statusInput = document.createElement('input');
            statusInput.type = 'hidden';
            statusInput.name = 'status_liberacao';
            statusInput.value = status;
            form.appendChild(statusInput);
            
            // Participantes
            participanteIds.forEach(id => {
                const participanteInput = document.createElement('input');
                participanteInput.type = 'hidden';
                participanteInput.name = 'participantes_selecionados';
                participanteInput.value = id;
                form.appendChild(participanteInput);
            });
            
            document.body.appendChild(form);
            form.submit();
        }
    }
    
    // Inicializar estado dos botões
    updateBatchButtons();
});

function alterarStatus(participanteId, novoStatus) {
    const acaoTexto = novoStatus ? 'liberar' : 'bloquear';
    
    if (confirm(`Deseja ${acaoTexto} a declaração deste participante?`)) {
        // Criar formulário dinâmico
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ url_for("declaracao.liberar_participantes", evento_id=evento.id) }}';
        
        // CSRF Token
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrf_token';
        csrfInput.value = '{{ csrf_token() }}';
        form.appendChild(csrfInput);
        
        // Ação
        const acaoInput = document.createElement('input');
        acaoInput.type = 'hidden';
        acaoInput.name = 'acao';
        acaoInput.value = 'individual';
        form.appendChild(acaoInput);
        
        // Participante ID
        const participanteInput = document.createElement('input');
        participanteInput.type = 'hidden';
        participanteInput.name = 'participante_id';
        participanteInput.value = participanteId;
        form.appendChild(participanteInput);
        
        // Status
        const statusInput = document.createElement('input');
        statusInput.type = 'hidden';
        statusInput.name = 'status_liberacao';
        statusInput.value = novoStatus;
        form.appendChild(statusInput);
        
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
{% endblock %}