{% extends "base.html" %}

{% block title %}Meus Trabalhos{% endblock %}

{% block styles %}
{{ super() }}
<style>
    .reviewer-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.5rem 0;
        border-bottom: 1px solid #e5e7eb;
        gap: 1rem;
    }

    .reviewer-item:last-child {
        border-bottom: none;
    }

    .reviewer-name {
        font-size: 1.05rem;
        font-weight: 600;
    }

    .reviewer-meta {
        font-size: 0.85rem;
        color: #64748b;
    }

    .manual-filter-card {
        background-color: #f8fafc;
    }

    .manual-filter-card .form-label {
        font-weight: 600;
        font-size: 0.9rem;
    }

    .manual-filter-card .badge {
        font-size: 0.75rem;
    }

    .manual-filter-card small {
        font-size: 0.8rem;
        color: #64748b;
    }

    #manualReviewerFilter .form-check-label {
        font-size: 0.85rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                        <h4 class="mb-0">
                            <i class="fas fa-file-alt text-primary me-2"></i>
                            Meus Trabalhos
                        </h4>
                        <div class="d-flex flex-wrap align-items-center gap-2">
                            <div class="btn-group" role="group" aria-label="Exportar trabalhos">
                                <button type="button"
                                        class="btn btn-outline-secondary"
                                        id="exportXlsxBtn"
                                        data-export-url="{{ url_for('trabalho_routes.exportar_trabalhos_xlsx') }}">
                                    <i class="bi bi-file-earmark-excel me-1"></i> Exportar XLSX
                                </button>
                                <button type="button"
                                        class="btn btn-outline-secondary"
                                        id="exportPdfBtn"
                                        data-export-url="{{ url_for('trabalho_routes.exportar_trabalhos_pdf') }}">
                                    <i class="bi bi-file-earmark-pdf me-1"></i> Exportar PDF
                                </button>
                            </div>
                            <a href="{{ url_for('trabalho_routes.novo_trabalho') }}" class="btn btn-primary">
                                <i class="fas fa-plus me-1"></i>
                                Adicionar Trabalho
                            </a>
                        </div>
                    </div>
                    
                    <!-- Distribution Controls -->
                    <div class="distribution-controls" id="distributionControls" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center p-3 bg-light rounded">
                            <div class="d-flex align-items-center">
                                <span class="me-3">
                                    <strong id="selectedCount">0</strong> trabalho(s) selecionado(s)
                                </span>
                                <button type="button" class="btn btn-sm btn-outline-secondary me-2" id="selectAllBtn">
                                    <i class="fas fa-check-square me-1"></i>
                                    Selecionar Todos
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="clearSelectionBtn">
                                    <i class="fas fa-square me-1"></i>
                                    Limpar Seleção
                                </button>
                            </div>
                            <div class="d-flex flex-wrap gap-2">
                                <button type="button" class="btn btn-success" id="manualDistributionBtn" disabled>
                                    <i class="fas fa-user-edit me-1"></i>
                                    Distribuição Manual
                                </button>
                                <button type="button" class="btn btn-warning" id="reEvaluationBtn" disabled>
                                    <i class="fas fa-undo me-1"></i>
                                    Solicitar Reavaliação
                                </button>
                                <button type="button" class="btn btn-info" id="automaticDistributionBtn" disabled>
                                    <i class="fas fa-magic me-1"></i>
                                    Distribuição Automática
                                </button>
                                <button type="button" class="btn btn-outline-danger" id="undoAllDistributionsBtn" onclick="confirmarDesfazerTodasDistribuicoes()">
                                    <i class="fas fa-undo-alt me-1"></i>
                                    Desfazer Todas as Distribuições
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for category, message in messages %}
                                <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                                    {{ message }}
                                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                </div>
                            {% endfor %}
                        {% endif %}
                    {% endwith %}

                    <div class="card border-0 shadow-sm mb-4" id="workFilterCard">
                        <div class="card-header bg-light d-flex justify-content-between align-items-center">
                            <h5 class="mb-0 d-flex align-items-center gap-2">
                                <i class="bi bi-funnel-fill text-primary"></i>
                                Filtros dos Trabalhos
                            </h5>
                            <small class="text-muted">Use as respostas do formulário para refinar a lista</small>
                        </div>
                        <div class="card-body" id="workFilterConfig" data-options='{{ trabalho_filter_options | tojson | safe }}'>
                            {% if trabalho_filter_options %}
                            <div class="row g-3 align-items-end">
                                <div class="col-md-4">
                                    <label for="workFilterQuestion" class="form-label fw-medium">Pergunta</label>
                                    <select class="form-select" id="workFilterQuestion">
                                        <option value="">Selecione uma pergunta...</option>
                                        {% for item in trabalho_filter_options %}
                                        <option value="{{ item.question }}">{{ item.question }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-8">
                                    <label class="form-label fw-medium">Respostas</label>
                                    <div id="workFilterValueContainer" class="d-flex flex-wrap gap-2 align-items-center border rounded p-3 bg-light">
                                        <span class="text-muted">Escolha uma pergunta para visualizar as respostas disponíveis.</span>
                                    </div>
                                </div>
                            </div>
                            <div class="d-flex flex-wrap gap-2 mt-3">
                                <button type="button" class="btn btn-primary" id="workAddFilter" disabled>
                                    <i class="bi bi-plus-circle me-1"></i> Adicionar filtro
                                </button>
                                <button type="button" class="btn btn-outline-secondary" id="workClearFilters" disabled>
                                    <i class="bi bi-x-circle me-1"></i> Limpar filtros
                                </button>
                            </div>
                            <div class="mt-3">
                                <h6 class="fw-semibold mb-2">Filtros aplicados</h6>
                                <div id="workActiveFilters" class="d-flex flex-wrap gap-2">
                                    <span class="text-muted">Nenhum filtro aplicado.</span>
                                </div>
                            </div>
                            <div class="mt-2">
                                <small id="workFilterStats" class="text-muted"></small>
                            </div>
                            {% else %}
                            <div class="alert alert-info mb-0">
                                <i class="bi bi-info-circle me-2"></i>
                                Ainda não há respostas suficientes para configurar filtros dinâmicos.
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    {% if reviewers_without_assignments %}
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-header bg-white d-flex align-items-center gap-2">
                            <i class="bi bi-people text-primary"></i>
                            <span class="fw-semibold">Revisores sem trabalhos atribuídos</span>
                        </div>
                        <div class="card-body">
                            <p class="text-muted small mb-3">Atribua trabalhos para aproveitar melhor estes revisores disponíveis.</p>
                            <ul class="list-unstyled mb-0">
                                {% for reviewer in reviewers_without_assignments %}
                                <li class="d-flex align-items-center gap-2 mb-2">
                                    <i class="bi bi-person-circle text-primary"></i>
                                    <span>{{ reviewer.nome }}</span>
                                    {% if reviewer.email %}
                                    <small class="text-muted">{{ reviewer.email }}</small>
                                    {% endif %}
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                    {% endif %}

                    {% if trabalhos %}
                        <div class="mb-3">
                            <p class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Total de trabalhos: {{ trabalhos|length }}
                            </p>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="trabalhosTable">
                                <thead class="table-dark">
                                    <tr>
                                        <th width="50">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="selectAllCheckbox">
                                                <label class="form-check-label" for="selectAllCheckbox">
                                                    <span class="visually-hidden">Selecionar todos</span>
                                                </label>
                                            </div>
                                        </th>
                                        <th>Título</th>
                                        <th>Categoria</th>
                                        <th>Rede de Ensino</th>
                                        <th>Etapa de Ensino</th>
                                        <th>Data de Cadastro</th>
                                        <th class="text-center">Status Distribuição</th>
                                        <th class="text-center">Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for trabalho in trabalhos %}
                                        <tr class="work-row" data-respostas='{{ (trabalho.respostas or {}) | tojson | safe }}'>
                                            <td>
                                                <div class="form-check">
                                                    <input class="form-check-input work-checkbox" 
                                                           type="checkbox" 
                                                           name="trabalho_ids"
                                                           value="{{ trabalho.id }}" 
                                                           id="work_{{ trabalho.id }}">
                                                    <label class="form-check-label" for="work_{{ trabalho.id }}">
                                                        <span class="visually-hidden">Selecionar trabalho</span>
                                                    </label>
                                                </div>
                                            </td>
                                            <td>
                                                <strong>{{ trabalho.título or 'Sem título' }}</strong>
                                            </td>
                                            <td>
                                                <span class="badge bg-info">{{ trabalho.categoria or 'Não informado' }}</span>
                                            </td>
                                            <td>{{ trabalho.rede_de_ensino or 'Não informado' }}</td>
                                            <td>{{ trabalho.etapa_de_ensino or 'Não informado' }}</td>
                                            <td>
                                                <small class="text-muted">
                                                    {{ trabalho.data_submissao.strftime('%d/%m/%Y às %H:%M') if trabalho.data_submissao else 'Não informado' }}
                                                </small>
                                            </td>
                                            <td class="text-center">
                                                {% if trabalho.distribution_status == 'Distribuído' %}
                                                    <span class="badge bg-success" id="distributionStatus_{{ trabalho.id }}" 
                                                          title="Revisores: {{ trabalho.reviewer_names|join(', ') }}">
                                                        <i class="fas fa-check me-1"></i>
                                                        Distribuído ({{ trabalho.assignment_count }}): 
                                                        {% if trabalho.reviewer_names|length <= 2 %}
                                                            {{ trabalho.reviewer_names|join(', ') }}
                                                        {% else %}
                                                            {{ trabalho.reviewer_names[:2]|join(', ') }} e mais {{ trabalho.reviewer_names|length - 2 }}
                                                        {% endif %}
                                                    </span>
                                                {% else %}
                                                    <span class="badge bg-secondary" id="distributionStatus_{{ trabalho.id }}">
                                                        <i class="fas fa-clock me-1"></i>
                                                        Não Distribuído
                                                    </span>
                                                {% endif %}
                                            </td>
                                            <td class="text-center">
                                                <div class="btn-group" role="group">
                                                    <a href="{{ url_for('trabalho_routes.visualizar_trabalho', trabalho_id=trabalho.id) }}" 
                                                       class="btn btn-sm btn-outline-info" 
                                                       title="Visualizar">
                                                        <i class="fas fa-eye"></i>
                                                    </a>
                                                    <a href="{{ url_for('trabalho_routes.editar_trabalho', trabalho_id=trabalho.id) }}" 
                                                       class="btn btn-sm btn-outline-warning" 
                                                       title="Editar">
                                                        <i class="fas fa-edit"></i>
                                                    </a>
                                                    {% if trabalho.distribution_status and trabalho.distribution_status.startswith('Distribuído') %}
                                                    <button type="button" 
                                                            class="btn btn-sm btn-outline-secondary" 
                                                            title="Desfazer Distribuição"
                                                            onclick="confirmarDesfazerDistribuicao({{ trabalho.id }})">
                                                        <i class="fas fa-undo"></i>
                                                    </button>
                                                    {% endif %}
                                                    <button type="button" 
                                                            class="btn btn-sm btn-outline-danger" 
                                                            title="Excluir"
                                                            onclick="confirmarExclusao({{ trabalho.id }}, '{{ trabalho.título or 'este trabalho' }}')">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-file-alt fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">Nenhum trabalho cadastrado</h5>
                            <p class="text-muted mb-4">Você ainda não cadastrou nenhum trabalho.</p>
                            <a href="{{ url_for('trabalho_routes.novo_trabalho') }}" class="btn btn-primary">
                                <i class="fas fa-plus me-1"></i>
                                Cadastrar Primeiro Trabalho
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Manual Distribution Modal -->
<div class="modal fade" id="manualDistributionModal" tabindex="-1" aria-labelledby="manualDistributionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="manualDistributionModalLabel">
                    <i class="fas fa-user-edit me-2"></i>
                    Distribuição Manual de Trabalhos
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="manualDistributionAlert" class="alert alert-warning d-none"></div>
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-file-alt me-2"></i>Trabalhos Selecionados</h6>
                        <div id="selectedWorksList" class="border rounded p-3 mb-3" style="max-height: 300px; overflow-y: auto;">
                            <!-- Selected works will be populated here -->
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-users me-2"></i>Revisores Disponíveis</h6>
                        <div class="mb-3">
                            <input type="text" class="form-control" id="reviewerSearch" placeholder="Buscar revisor...">
                        </div>
                        <div id="manualReviewerFilter" class="manual-filter-card border rounded p-3 mb-3" data-options='{{ reviewer_filter_options | tojson | safe }}'>
                            {% if reviewer_filter_options %}
                            <div class="row g-2 align-items-end">
                                <div class="col-sm-5">
                                    <label class="form-label" for="manualReviewerFilterQuestion">Pergunta</label>
                                    <select class="form-select form-select-sm" id="manualReviewerFilterQuestion">
                                        <option value="">Selecione...</option>
                                        {% for item in reviewer_filter_options %}
                                        <option value="{{ item.question }}">{{ item.question }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-sm-7">
                                    <label class="form-label">Respostas</label>
                                    <div id="manualReviewerFilterValueContainer" class="border rounded bg-white p-2" style="max-height: 140px; overflow-y: auto;">
                                        <span class="text-muted small">Escolha uma pergunta para listar respostas.</span>
                                    </div>
                                </div>
                            </div>
                            <div class="d-flex flex-wrap gap-2 mt-3">
                                <button type="button" class="btn btn-sm btn-primary" id="manualReviewerAddFilter" disabled>
                                    <i class="bi bi-plus-circle me-1"></i>Adicionar filtro
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="manualReviewerClearFilters" disabled>
                                    <i class="bi bi-x-circle me-1"></i>Limpar
                                </button>
                            </div>
                            <div class="mt-3">
                                <h6 class="fw-semibold mb-2" style="font-size:0.9rem;">Filtros aplicados</h6>
                                <div id="manualReviewerActiveFilters" class="d-flex flex-wrap gap-2">
                                    <span class="text-muted small">Nenhum filtro aplicado.</span>
                                </div>
                            </div>
                            {% else %}
                            <p class="text-muted small mb-0">Nenhum filtro adicional disponível para revisores.</p>
                            {% endif %}
                        </div>
                        <div id="reviewersList" class="border rounded p-3" style="max-height: 300px; overflow-y: auto;">
                            <!-- Reviewers will be populated here -->
                        </div>
                    </div>
                </div>
                
                <div class="mt-3">
                    <h6><i class="fas fa-clipboard-list me-2"></i>Atribuições</h6>
                    <div id="assignmentsList" class="border rounded p-3" style="max-height: 200px; overflow-y: auto;">
                        <p class="text-muted text-center mb-0">Nenhuma atribuição criada ainda</p>
                    </div>
                </div>
                
                <div class="mt-3">
                    <div class="row">
                        <div class="col-md-6">
                            <label for="manualDeadline" class="form-label">Prazo para Revisão</label>
                            <input type="date" class="form-control" id="manualDeadline" required>
                        </div>
                        <div class="col-md-6">
                            <label for="manualNotes" class="form-label">Observações</label>
                            <textarea class="form-control" id="manualNotes" rows="2" placeholder="Observações sobre a distribuição..."></textarea>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>
                    Cancelar
                </button>
                <button type="button" class="btn btn-success" id="executeManualDistribution" disabled>
                    <i class="fas fa-check me-1"></i>
                    Executar Distribuição
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Automatic Distribution Modal -->
<div class="modal fade" id="automaticDistributionModal" tabindex="-1" aria-labelledby="automaticDistributionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="automaticDistributionModalLabel">
                    <i class="fas fa-magic me-2"></i>
                    Distribuição Automática de Trabalhos
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-file-alt me-2"></i>Trabalhos Selecionados</h6>
                        <div id="autoSelectedWorksList" class="border rounded p-3 mb-3" style="max-height: 200px; overflow-y: auto;">
                            <!-- Selected works will be populated here -->
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-cog me-2"></i>Configurações</h6>
                        <div class="mb-3">
                            <label for="reviewersPerWork" class="form-label">Revisores por Trabalho</label>
                            <input type="number" class="form-control" id="reviewersPerWork" min="1" max="5" value="2">
                            <small class="form-text text-muted">Número de revisores que avaliarão cada trabalho</small>
                        </div>
                        <div class="mb-3">
                            <label for="maxAssignmentsPerReviewer" class="form-label">Máximo de Trabalhos por Revisor</label>
                            <input type="number" class="form-control" id="maxAssignmentsPerReviewer" min="1" value="5">
                            <small class="form-text text-muted">Limite de trabalhos que cada revisor pode receber</small>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <label for="autoDeadline" class="form-label">Prazo para Revisão</label>
                        <input type="date" class="form-control" id="autoDeadline" required>
                    </div>
                    <div class="col-md-6">
                        <label for="autoNotes" class="form-label">Observações</label>
                        <textarea class="form-control" id="autoNotes" rows="2" placeholder="Observações sobre a distribuição..."></textarea>
                    </div>
                </div>
                
                <div class="mt-3">
                    <h6><i class="fas fa-filter me-2"></i>Filtros de Revisores</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="excludeAuthors" checked>
                                <label class="form-check-label" for="excludeAuthors">
                                    Excluir autores dos próprios trabalhos
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="balanceWorkload" checked>
                                <label class="form-check-label" for="balanceWorkload">
                                    Balancear carga de trabalho
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-3">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Prévia da Distribuição:</strong>
                        <div id="distributionPreview" class="mt-2">
                            <span class="text-muted">Configure os parâmetros acima para ver a prévia</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>
                    Cancelar
                </button>
                <button type="button" class="btn btn-outline-info" id="previewDistribution">
                    <i class="fas fa-eye me-1"></i>
                    Prévia
                </button>
                <button type="button" class="btn btn-info" id="executeAutoDistribution">
                    <i class="fas fa-magic me-1"></i>
                    Executar Distribuição
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmação de Exclusão -->
<div class="modal fade" id="modalExclusao" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                    Confirmar Exclusão
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja excluir o trabalho <strong id="nomeTrabalho"></strong>?</p>
                <p class="text-muted">Esta ação não pode ser desfeita.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>
                    Cancelar
                </button>
                <form id="formExclusao" method="POST" style="display: inline;" action="">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash me-1"></i>
                        Excluir
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// CSRF token function removed - not needed for distribution endpoints

function confirmarExclusao(trabalhoId, nomeTrabalho) {
    document.getElementById('nomeTrabalho').textContent = nomeTrabalho;
    document.getElementById('formExclusao').action = 
        "{{ url_for('trabalho_routes.excluir_trabalho', trabalho_id=0) }}".replace('0', trabalhoId);
    
    var modal = new bootstrap.Modal(document.getElementById('modalExclusao'));
    modal.show();
}

// Distribution functionality
document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, initializing distribution interface...');
        
        // Get DOM elements
        const workCheckboxes = document.querySelectorAll('.work-checkbox');
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        const selectAllBtn = document.getElementById('selectAllBtn');
        const clearSelectionBtn = document.getElementById('clearSelectionBtn');
        const distributionControls = document.getElementById('distributionControls');
        const selectedCount = document.getElementById('selectedCount');
        const manualDistributionBtn = document.getElementById('manualDistributionBtn');
        const reEvaluationBtn = document.getElementById('reEvaluationBtn');
        const automaticDistributionBtn = document.getElementById('automaticDistributionBtn');
        
        console.log('Found elements:', {
            workCheckboxes: workCheckboxes.length,
            selectAllCheckbox: !!selectAllCheckbox,
            distributionControls: !!distributionControls,
            selectedCount: !!selectedCount,
            reEvaluationBtn: !!reEvaluationBtn
        });

    initializeManualReviewerFilters();
    
    function isRowVisible(checkbox) {
        const row = checkbox.closest('tr');
        return !row || row.style.display !== 'none';
    }

    function updateSelectionCount() {
        const visibleCheckedBoxes = Array.from(
            document.querySelectorAll('input[name="trabalho_ids"]:checked')
        ).filter(isRowVisible);
        const count = visibleCheckedBoxes.length;

        selectedCount.textContent = count;

        if (count > 0) {
            distributionControls.style.display = 'block';
            manualDistributionBtn.disabled = false;
            automaticDistributionBtn.disabled = false;
            if (reEvaluationBtn) {
                reEvaluationBtn.disabled = false;
            }
        } else {
            distributionControls.style.display = 'none';
            manualDistributionBtn.disabled = true;
            automaticDistributionBtn.disabled = true;
            if (reEvaluationBtn) {
                reEvaluationBtn.disabled = true;
            }
        }
        
        // Update select all checkbox state
        const visibleCheckboxes = Array.from(workCheckboxes).filter(isRowVisible);
        const totalCheckboxes = visibleCheckboxes.length;
        if (count === 0) {
            selectAllCheckbox.indeterminate = false;
            selectAllCheckbox.checked = false;
        } else if (count === totalCheckboxes && totalCheckboxes > 0) {
            selectAllCheckbox.indeterminate = false;
            selectAllCheckbox.checked = true;
        } else {
            selectAllCheckbox.indeterminate = true;
        }
    }

    window.workSelectionUpdater = updateSelectionCount;

    // Individual checkbox change
    workCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectionCount);
    });

    // Select all checkbox
    selectAllCheckbox.addEventListener('change', function() {
        workCheckboxes.forEach(checkbox => {
            if (isRowVisible(checkbox)) {
                checkbox.checked = this.checked;
            }
        });
        updateSelectionCount();
    });

    // Select all button
    selectAllBtn.addEventListener('click', function() {
        workCheckboxes.forEach(checkbox => {
            if (isRowVisible(checkbox)) {
                checkbox.checked = true;
            }
        });
        updateSelectionCount();
    });

    // Clear selection button
    clearSelectionBtn.addEventListener('click', function() {
        workCheckboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
        updateSelectionCount();
    });
    
    // Distribution buttons
    manualDistributionBtn.addEventListener('click', function() {
        manualDistributionMode = 'assign';
        const selectedWorks = Array.from(document.querySelectorAll('.work-checkbox:checked'))
            .filter(isRowVisible)
            .map(cb => cb.value);
        openManualDistributionModal(selectedWorks);
    });

    if (reEvaluationBtn) {
        reEvaluationBtn.addEventListener('click', function() {
            manualDistributionMode = 'reevaluation';
            const selectedWorks = Array.from(document.querySelectorAll('.work-checkbox:checked'))
                .filter(isRowVisible)
                .map(cb => cb.value);
            openManualDistributionModal(selectedWorks);
        });
    }
    
    automaticDistributionBtn.addEventListener('click', function() {
        const selectedWorks = Array.from(document.querySelectorAll('.work-checkbox:checked'))
            .filter(isRowVisible)
            .map(cb => cb.value);
        openAutomaticDistributionModal(selectedWorks);
    });

    // Initialize
    updateSelectionCount();

    const manualDistributionModalElement = document.getElementById('manualDistributionModal');
    if (manualDistributionModalElement) {
        manualDistributionModalElement.addEventListener('hidden.bs.modal', function() {
            manualDistributionMode = 'assign';
            const alertBox = document.getElementById('manualDistributionAlert');
            if (alertBox) {
                alertBox.classList.add('d-none');
                alertBox.textContent = '';
            }
        });
    }
});

// Modal functions
function openManualDistributionModal(workIds) {
    const modalElement = document.getElementById('manualDistributionModal');
    const modal = new bootstrap.Modal(modalElement);
    const modalTitle = document.getElementById('manualDistributionModalLabel');
    const alertBox = document.getElementById('manualDistributionAlert');
    const executeBtn = document.getElementById('executeManualDistribution');
    const notesInput = document.getElementById('manualNotes');

    if (manualDistributionMode === 'reevaluation') {
        modalTitle.innerHTML = '<i class="fas fa-undo me-2"></i>Solicitar Reavaliação';
        if (alertBox) {
            alertBox.classList.remove('d-none');
            alertBox.textContent = 'Selecione novos revisores para reavaliar os trabalhos escolhidos. As novas avaliações substituirão ou complementarão as existentes nos relatórios.';
        }
        if (executeBtn) {
            executeBtn.innerHTML = '<i class="fas fa-check me-1"></i>Solicitar Reavaliação';
            executeBtn.classList.remove('btn-success');
            executeBtn.classList.add('btn-warning');
        }
        if (notesInput && !notesInput.value) {
            notesInput.placeholder = 'Justifique o pedido de reavaliação (opcional)';
        }
    } else {
        modalTitle.innerHTML = '<i class="fas fa-user-edit me-2"></i>Distribuição Manual de Trabalhos';
        if (alertBox) {
            alertBox.classList.add('d-none');
            alertBox.textContent = '';
        }
        if (executeBtn) {
            executeBtn.innerHTML = '<i class="fas fa-check me-1"></i>Executar Distribuição';
            executeBtn.classList.add('btn-success');
            executeBtn.classList.remove('btn-warning');
        }
        if (notesInput && !notesInput.value) {
            notesInput.placeholder = 'Observações sobre a distribuição...';
        }
    }

    if (executeBtn) {
        executeBtn.disabled = true;
    }

    // Populate selected works
    populateSelectedWorks('selectedWorksList', workIds);

    // Load available reviewers
    loadAvailableReviewers();

    // Set default deadline (7 days from now)
    const deadline = new Date();
    deadline.setDate(deadline.getDate() + 7);
    document.getElementById('manualDeadline').value = deadline.toISOString().split('T')[0];

    // Clear previous assignments
    manualAssignments = [];
    document.getElementById('assignmentsList').innerHTML = '<p class="text-muted text-center mb-0">Nenhuma atribuição criada ainda</p>';

    modal.show();
}

function openAutomaticDistributionModal(workIds) {
    const modal = new bootstrap.Modal(document.getElementById('automaticDistributionModal'));
    
    // Populate selected works
    populateSelectedWorks('autoSelectedWorksList', workIds);
    
    // Set default deadline (7 days from now)
    const deadline = new Date();
    deadline.setDate(deadline.getDate() + 7);
    document.getElementById('autoDeadline').value = deadline.toISOString().split('T')[0];
    
    // Clear preview
    document.getElementById('distributionPreview').innerHTML = '<span class="text-muted">Configure os parâmetros acima para ver a prévia</span>';
    
    modal.show();
}

document.addEventListener('DOMContentLoaded', initializeWorkFilters);
document.addEventListener('DOMContentLoaded', attachExportHandlers);

function initializeWorkFilters() {
    const configContainer = document.getElementById('workFilterConfig');
    if (!configContainer) {
        return;
    }

    let metadata = [];
    try {
        metadata = JSON.parse(configContainer.dataset.options || '[]');
    } catch (error) {
        metadata = [];
    }

    const questionSelect = document.getElementById('workFilterQuestion');
    const valueContainer = document.getElementById('workFilterValueContainer');
    const addButton = document.getElementById('workAddFilter');
    const clearButton = document.getElementById('workClearFilters');
    const activeFiltersContainer = document.getElementById('workActiveFilters');
    const statsElement = document.getElementById('workFilterStats');
    const table = document.getElementById('trabalhosTable');

    if (
        !questionSelect ||
        !valueContainer ||
        !addButton ||
        !clearButton ||
        !activeFiltersContainer ||
        !table
    ) {
        return;
    }

    const questionOptionsMap = {};

    function escapeHtml(value) {
        if (value === null || value === undefined) {
            return '';
        }
        return value
            .toString()
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }
    metadata.forEach((item) => {
        if (item && item.question) {
            questionOptionsMap[item.question] = Array.isArray(item.options)
                ? item.options
                : [];
        }
    });

    const filterState = { activeFilters: [] };
    configContainer._filterState = filterState;

    function normalizeValue(value) {
        if (value === null || value === undefined) {
            return '__EMPTY__';
        }
        if (Array.isArray(value) || typeof value === 'object') {
            try {
                return JSON.stringify(value);
            } catch (error) {
                return String(value);
            }
        }
        const text = value.toString().trim();
        return text === '' ? '__EMPTY__' : text;
    }

    function renderValueOptions(question) {
        const options = questionOptionsMap[question] || [];
        valueContainer.innerHTML = '';

        if (!options.length) {
            valueContainer.innerHTML = '<span class="text-muted">Nenhuma resposta encontrada para esta pergunta.</span>';
            addButton.disabled = true;
            return;
        }

        options.forEach((option, index) => {
            const optionId = `workFilterValue_${index}`;
            const wrapper = document.createElement('div');
            wrapper.className = 'form-check form-check-inline';
            wrapper.innerHTML = `
                <input class="form-check-input" type="checkbox" id="${optionId}" value="${escapeHtml(option.value)}">
                <label class="form-check-label" for="${optionId}">${escapeHtml(option.label)}</label>
            `;
            valueContainer.appendChild(wrapper);
        });

        addButton.disabled = true;
    }

    function getSelectedValues() {
        return Array.from(
            valueContainer.querySelectorAll('input[type="checkbox"]:checked')
        ).map((input) => input.value);
    }

    function renderActiveFilters() {
        const activeFilters = filterState.activeFilters;
        if (!activeFilters.length) {
            activeFiltersContainer.innerHTML = '<span class="text-muted">Nenhum filtro aplicado.</span>';
            clearButton.disabled = true;
            return;
        }

        activeFiltersContainer.innerHTML = '';
        clearButton.disabled = false;

        activeFilters.forEach((filter, index) => {
            const labels = filter.values
                .map((value) => {
                    const option = (questionOptionsMap[filter.question] || []).find(
                        (candidate) => candidate.value === value
                    );
                    return option ? option.label : value;
                })
                .join(', ');

            const badge = document.createElement('span');
            badge.className = 'badge bg-primary d-flex align-items-center gap-2';
            badge.innerHTML = `
                <span>${escapeHtml(filter.question)}: ${escapeHtml(labels)}</span>
                <button type="button" class="btn-close btn-close-white" aria-label="Remover filtro" data-filter-index="${index}"></button>
            `;
            activeFiltersContainer.appendChild(badge);
        });
    }

    function applyFilters() {
        const rows = Array.from(table.querySelectorAll('tbody tr.work-row'));
        let visibleCount = 0;

        rows.forEach((row) => {
            if (!filterState.activeFilters.length) {
                row.style.display = '';
                visibleCount += 1;
                return;
            }

            let rowMatches = true;
            const rawDataset = row.getAttribute('data-respostas');
            let respostas = {};
            if (rawDataset) {
                try {
                    respostas = JSON.parse(rawDataset);
                } catch (error) {
                    respostas = {};
                }
            }

            for (const filter of filterState.activeFilters) {
                const resposta = respostas && Object.prototype.hasOwnProperty.call(respostas, filter.question)
                    ? respostas[filter.question]
                    : null;

                const valoresResposta = Array.isArray(resposta)
                    ? resposta
                    : [resposta];

                const respostasNormalizadas = valoresResposta.map((valor) => normalizeValue(valor));

                const match = filter.values.some((value) => respostasNormalizadas.includes(value));
                if (!match) {
                    rowMatches = false;
                    break;
                }
            }

            row.style.display = rowMatches ? '' : 'none';
            if (rowMatches) {
                visibleCount += 1;
            } else {
                const checkbox = row.querySelector('.work-checkbox');
                if (checkbox && checkbox.checked) {
                    checkbox.checked = false;
                }
            }
        });

        if (typeof window.workSelectionUpdater === 'function') {
            window.workSelectionUpdater();
        }

        if (statsElement) {
            const totalRows = rows.length;
            if (!filterState.activeFilters.length) {
                statsElement.textContent = '';
            } else {
                statsElement.textContent = `Mostrando ${visibleCount} de ${totalRows} trabalho(s).`;
            }
        }
    }

    questionSelect.addEventListener('change', (event) => {
        const question = event.target.value;
        if (question) {
            renderValueOptions(question);
        } else {
            valueContainer.innerHTML = '<span class="text-muted">Escolha uma pergunta para visualizar as respostas disponíveis.</span>';
            addButton.disabled = true;
        }
    });

    valueContainer.addEventListener('change', () => {
        addButton.disabled = getSelectedValues().length === 0;
    });

    addButton.addEventListener('click', () => {
        const question = questionSelect.value;
        const values = getSelectedValues();
        if (!question || !values.length) {
            return;
        }

        const uniqueValues = Array.from(new Set(values));
        const existingIndex = filterState.activeFilters.findIndex(
            (filter) => filter.question === question
        );

        if (existingIndex >= 0) {
            filterState.activeFilters[existingIndex].values = uniqueValues;
        } else {
            filterState.activeFilters.push({ question, values: uniqueValues });
        }

        valueContainer
            .querySelectorAll('input[type="checkbox"]')
            .forEach((input) => {
                input.checked = false;
            });
        addButton.disabled = true;

        renderActiveFilters();
        applyFilters();
    });

    activeFiltersContainer.addEventListener('click', (event) => {
        const target = event.target;
        if (
            target instanceof HTMLElement &&
            target.matches('button[data-filter-index]')
        ) {
            const index = Number(target.getAttribute('data-filter-index'));
            if (!Number.isNaN(index)) {
                filterState.activeFilters.splice(index, 1);
                renderActiveFilters();
                applyFilters();
            }
        }
    });

    clearButton.addEventListener('click', () => {
        filterState.activeFilters.splice(0, filterState.activeFilters.length);
        renderActiveFilters();
        applyFilters();
        questionSelect.value = '';
        valueContainer.innerHTML = '<span class="text-muted">Escolha uma pergunta para visualizar as respostas disponíveis.</span>';
        addButton.disabled = true;
        clearButton.disabled = true;
    });

    renderActiveFilters();
    applyFilters();
}

function getActiveWorkFilters() {
    const configContainer = document.getElementById('workFilterConfig');
    if (
        configContainer &&
        configContainer._filterState &&
        Array.isArray(configContainer._filterState.activeFilters)
    ) {
        return configContainer._filterState.activeFilters;
    }
    return [];
}

function attachExportHandlers() {
    const xlsxBtn = document.getElementById('exportXlsxBtn');
    const pdfBtn = document.getElementById('exportPdfBtn');

    if (xlsxBtn) {
        xlsxBtn.addEventListener('click', () => {
            openWorkExport(xlsxBtn.dataset.exportUrl);
        });
    }

    if (pdfBtn) {
        pdfBtn.addEventListener('click', () => {
            openWorkExport(pdfBtn.dataset.exportUrl);
        });
    }
}

function openWorkExport(baseUrl) {
    if (!baseUrl) {
        return;
    }
    const filters = getActiveWorkFilters();
    const hasFilters = Array.isArray(filters) && filters.length > 0;
    const query = hasFilters
        ? `?filters=${encodeURIComponent(JSON.stringify(filters))}`
        : '';
    window.open(`${baseUrl}${query}`, '_blank', 'noopener');
}


function populateSelectedWorks(containerId, workIds) {
    const container = document.getElementById(containerId);
    let html = '';
    
    workIds.forEach(workId => {
        const workRow = document.querySelector(`#work_${workId}`).closest('tr');
        const title = workRow.querySelector('td:nth-child(2) strong').textContent;
        const category = workRow.querySelector('td:nth-child(3)').textContent.trim();
        
        html += `
            <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
                <div>
                    <strong>${title}</strong><br>
                    <small class="text-muted">${category}</small>
                </div>
                <span class="badge bg-primary">${workId}</span>
            </div>
        `;
    });
    
    container.innerHTML = html || '<p class="text-muted text-center mb-0">Nenhum trabalho selecionado</p>';
}

function loadAvailableReviewers() {
    fetch('/api/reviewers', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json'
        }
    })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                allManualReviewers = Array.isArray(data.reviewers) ? data.reviewers : [];
                applyManualReviewerFilters();
            } else {
                console.error('Error loading reviewers:', data.message);
            }
        })
        .catch(error => {
            console.error('Error loading reviewers:', error);
        });
}

function populateReviewersList(reviewers) {
    const container = document.getElementById('reviewersList');
    if (!container) {
        return;
    }

    if (!Array.isArray(reviewers) || reviewers.length === 0) {
        container.innerHTML = '<p class="text-muted text-center mb-0">Nenhum revisor disponível</p>';
        return;
    }

    let html = '';
    reviewers.forEach(reviewer => {
        const safeName = escapeHtml(reviewer.nome || 'Sem nome');
        const safeEmail = escapeHtml(reviewer.email || 'Sem e-mail');
        const assignmentsInfo = reviewer.current_assignments || 0;
        const reviewerNameParam = JSON.stringify(reviewer.nome || '');

        html += `
            <div class="reviewer-item" data-reviewer-id="${reviewer.id}">
                <div class="flex-grow-1">
                    <div class="reviewer-name">${safeName}</div>
                    <div class="reviewer-meta">${safeEmail}</div>
                </div>
                <div class="text-end">
                    <span class="badge bg-info mb-1">${assignmentsInfo} em andamento</span><br>
                    <button class="btn btn-sm btn-outline-primary" onclick="addReviewerAssignment(${reviewer.id}, ${reviewerNameParam})">
                        <i class="fas fa-plus"></i> Adicionar
                    </button>
                </div>
            </div>
        `;
    });

    container.innerHTML = html;
}

function renderManualReviewerValueOptions(question) {
    const container = manualReviewerFilterElements.valueContainer;
    if (!container) {
        return;
    }

    container.innerHTML = '';
    if (!question) {
        container.innerHTML = '<span class="text-muted small">Escolha uma pergunta para listar respostas.</span>';
        if (manualReviewerFilterElements.addButton) {
            manualReviewerFilterElements.addButton.disabled = true;
        }
        return;
    }

    const item = manualReviewerFilterOptions.find(option => option.question === question);
    if (!item || !Array.isArray(item.options) || item.options.length === 0) {
        container.innerHTML = '<span class="text-muted small">Nenhuma resposta disponível para esta pergunta.</span>';
        if (manualReviewerFilterElements.addButton) {
            manualReviewerFilterElements.addButton.disabled = true;
        }
        return;
    }

    item.options.forEach((option, index) => {
        const optionId = `manualReviewerFilterValue_${index}`;
        const wrapper = document.createElement('div');
        wrapper.className = 'form-check form-check-inline';
        wrapper.innerHTML = `
            <input class="form-check-input" type="checkbox" id="${optionId}" value="${escapeHtml(option.value)}">
            <label class="form-check-label" for="${optionId}">${escapeHtml(option.label)}</label>
        `;
        container.appendChild(wrapper);
    });

    if (manualReviewerFilterElements.addButton) {
        manualReviewerFilterElements.addButton.disabled = true;
    }
}

function renderManualReviewerActiveFilters() {
    const container = manualReviewerFilterElements.activeContainer;
    const clearButton = manualReviewerFilterElements.clearButton;
    if (!container) {
        return;
    }

    if (!manualReviewerActiveFilters.length) {
        container.innerHTML = '<span class="text-muted small">Nenhum filtro aplicado.</span>';
        if (clearButton) {
            clearButton.disabled = true;
        }
        return;
    }

    container.innerHTML = '';
    manualReviewerActiveFilters.forEach((filter, index) => {
        const optionConfig = manualReviewerFilterOptions.find(item => item.question === filter.question);
        const labels = filter.values.map(value => {
            if (!optionConfig) {
                return value;
            }
            const optionMatch = optionConfig.options.find(option => option.value === value);
            return optionMatch ? optionMatch.label : value;
        }).join(', ');

        const badge = document.createElement('span');
        badge.className = 'badge bg-primary d-flex align-items-center gap-2';
        badge.innerHTML = `
            <span>${escapeHtml(filter.question)}: ${escapeHtml(labels)}</span>
            <button type="button" class="btn-close btn-close-white" data-filter-index="${index}"></button>
        `;
        container.appendChild(badge);
    });

    if (clearButton) {
        clearButton.disabled = false;
    }
}

function applyManualReviewerFilters() {
    let reviewers = Array.isArray(allManualReviewers) ? [...allManualReviewers] : [];

    if (reviewerSearchTerm) {
        reviewers = reviewers.filter(reviewer => {
            const name = (reviewer.nome || '').toLowerCase();
            const email = (reviewer.email || '').toLowerCase();
            return name.includes(reviewerSearchTerm) || email.includes(reviewerSearchTerm);
        });
    }

    reviewers = reviewers.filter(reviewerMatchesFilters);

    filteredManualReviewers = reviewers;
    populateReviewersList(filteredManualReviewers);
}

function initializeManualReviewerFilters() {
    const container = document.getElementById('manualReviewerFilter');
    if (!container) {
        return;
    }

    try {
        manualReviewerFilterOptions = JSON.parse(container.dataset.options || '[]');
    } catch (error) {
        manualReviewerFilterOptions = [];
    }

    manualReviewerActiveFilters = [];

    manualReviewerFilterElements.questionSelect = document.getElementById('manualReviewerFilterQuestion');
    manualReviewerFilterElements.valueContainer = document.getElementById('manualReviewerFilterValueContainer');
    manualReviewerFilterElements.addButton = document.getElementById('manualReviewerAddFilter');
    manualReviewerFilterElements.clearButton = document.getElementById('manualReviewerClearFilters');
    manualReviewerFilterElements.activeContainer = document.getElementById('manualReviewerActiveFilters');

    const { questionSelect, valueContainer, addButton, clearButton, activeContainer } = manualReviewerFilterElements;

    if (!manualReviewerFilterOptions.length) {
        if (addButton) {
            addButton.disabled = true;
        }
        if (clearButton) {
            clearButton.disabled = true;
        }
        return;
    }

    if (questionSelect) {
        questionSelect.addEventListener('change', event => {
            renderManualReviewerValueOptions(event.target.value);
        });
    }

    if (valueContainer) {
        valueContainer.addEventListener('change', () => {
            if (addButton) {
                const hasSelection = valueContainer.querySelectorAll('input[type="checkbox"]:checked').length > 0;
                addButton.disabled = !hasSelection;
            }
        });
    }

    if (addButton) {
        addButton.addEventListener('click', () => {
            const question = questionSelect ? questionSelect.value : '';
            if (!question) {
                return;
            }
            const selectedInputs = valueContainer ? Array.from(valueContainer.querySelectorAll('input[type="checkbox"]:checked')) : [];
            if (!selectedInputs.length) {
                return;
            }
            const values = selectedInputs.map(input => input.value);
            const existingIndex = manualReviewerActiveFilters.findIndex(filter => filter.question === question);
            if (existingIndex >= 0) {
                manualReviewerActiveFilters[existingIndex].values = values;
            } else {
                manualReviewerActiveFilters.push({ question, values });
            }

            selectedInputs.forEach(input => {
                input.checked = false;
            });
            addButton.disabled = true;
            renderManualReviewerActiveFilters();
            applyManualReviewerFilters();
        });
    }

    if (clearButton) {
        clearButton.addEventListener('click', () => {
            manualReviewerActiveFilters = [];
            renderManualReviewerActiveFilters();
            renderManualReviewerValueOptions('');
            if (questionSelect) {
                questionSelect.value = '';
            }
            applyManualReviewerFilters();
        });
    }

    if (activeContainer) {
        activeContainer.addEventListener('click', event => {
            const target = event.target;
            if (target instanceof HTMLElement && target.matches('button[data-filter-index]')) {
                const index = Number(target.getAttribute('data-filter-index'));
                if (!Number.isNaN(index)) {
                    manualReviewerActiveFilters.splice(index, 1);
                    renderManualReviewerActiveFilters();
                    applyManualReviewerFilters();
                }
            }
        });
    }

    // Initialize default view
    renderManualReviewerValueOptions('');
    renderManualReviewerActiveFilters();
}

let manualAssignments = [];
let manualDistributionMode = 'assign';
let manualReviewerFilterOptions = [];
let manualReviewerActiveFilters = [];
let allManualReviewers = [];
let filteredManualReviewers = [];
let reviewerSearchTerm = '';

const manualReviewerFilterElements = {
    questionSelect: null,
    valueContainer: null,
    addButton: null,
    clearButton: null,
    activeContainer: null,
};

function normalizeManualReviewerValue(value) {
    if (value === null || value === undefined) {
        return '__EMPTY__';
    }
    if (Array.isArray(value) || typeof value === 'object') {
        try {
            return JSON.stringify(value);
        } catch (error) {
            return String(value);
        }
    }
    const text = value.toString().trim();
    return text === '' ? '__EMPTY__' : text;
}

function reviewerMatchesFilters(reviewer) {
    if (!manualReviewerActiveFilters.length) {
        return true;
    }
    const respostas = reviewer.respostas || {};
    return manualReviewerActiveFilters.every(filter => {
        const resposta = Object.prototype.hasOwnProperty.call(respostas, filter.question)
            ? respostas[filter.question]
            : null;
        const valoresResposta = Array.isArray(resposta) ? resposta : [resposta];
        const respostaNormalizada = valoresResposta.map(normalizeManualReviewerValue);
        return filter.values.some(value => respostaNormalizada.includes(value));
    });
}

function addReviewerAssignment(reviewerId, reviewerName) {
    const selectedWorks = Array.from(document.querySelectorAll('.work-checkbox:checked')).map(cb => cb.value);
    
    selectedWorks.forEach(workId => {
        const workRow = document.querySelector(`#work_${workId}`).closest('tr');
        const workTitle = workRow.querySelector('td:nth-child(2) strong').textContent;
        
        // Check if assignment already exists
        const existingAssignment = manualAssignments.find(a => a.workId === workId && a.reviewerId === reviewerId);
        if (!existingAssignment) {
            manualAssignments.push({
                workId: workId,
                workTitle: workTitle,
                reviewerId: reviewerId,
                reviewerName: reviewerName,
                reEvaluation: manualDistributionMode === 'reevaluation'
            });
        }
    });
    
    updateAssignmentsList();
}

function updateAssignmentsList() {
    const container = document.getElementById('assignmentsList');
    if (!container) {
        return;
    }

    if (!manualAssignments.length) {
        container.innerHTML = '<p class="text-muted text-center mb-0">Nenhuma atribuição criada ainda</p>';
    } else {
        let html = '';
        manualAssignments.forEach((assignment, index) => {
            const reEvalBadge = assignment.reEvaluation ? '<span class="badge bg-warning text-dark ms-2">Reavaliação</span>' : '';
            html += `
                <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
                    <div>
                        <strong>${escapeHtml(assignment.workTitle)}</strong>
                        <span class="text-muted">→</span>
                        <strong>${escapeHtml(assignment.reviewerName)}</strong>
                        ${reEvalBadge}
                    </div>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeAssignment(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
        });
        container.innerHTML = html;
    }

    const executeButton = document.getElementById('executeManualDistribution');
    if (executeButton) {
        executeButton.disabled = manualAssignments.length === 0;
    }
}

function removeAssignment(index) {
    manualAssignments.splice(index, 1);
    updateAssignmentsList();
}

// Reviewer search functionality
document.addEventListener('DOMContentLoaded', function() {
    const reviewerSearch = document.getElementById('reviewerSearch');
    if (reviewerSearch) {
        reviewerSearch.addEventListener('input', function() {
            reviewerSearchTerm = this.value.toLowerCase();
            applyManualReviewerFilters();
        });
    }
    
    // Execute manual distribution
    const executeManualBtn = document.getElementById('executeManualDistribution');
    if (executeManualBtn) {
        executeManualBtn.addEventListener('click', function() {
            executeManualDistribution();
        });
    }
    
    // Execute automatic distribution
    const executeAutoBtn = document.getElementById('executeAutoDistribution');
    if (executeAutoBtn) {
        executeAutoBtn.addEventListener('click', function() {
            executeAutomaticDistribution();
        });
    }
    
    // Preview automatic distribution
    const previewBtn = document.getElementById('previewDistribution');
    if (previewBtn) {
        previewBtn.addEventListener('click', function() {
            previewAutomaticDistribution();
        });
    }
});

function executeManualDistribution() {
    const deadline = document.getElementById('manualDeadline').value;
    const notes = document.getElementById('manualNotes').value;
    const isReevaluation = manualDistributionMode === 'reevaluation';
    
    if (!deadline) {
        alert('Por favor, defina um prazo para a revisão.');
        return;
    }
    
    if (manualAssignments.length === 0) {
        alert('Por favor, crie pelo menos uma atribuição.');
        return;
    }
    
    // Extract work_ids from assignments
    const work_ids = [...new Set(manualAssignments.map(assignment => assignment.workId))];
    
    const payloadAssignments = manualAssignments.map(assignment => ({
        workId: assignment.workId,
        reviewerId: assignment.reviewerId,
        workTitle: assignment.workTitle,
        reviewerName: assignment.reviewerName,
        re_evaluation: assignment.reEvaluation
    }));

    const data = {
        work_ids: work_ids,
        assignments: payloadAssignments,
        deadline: deadline,
        notes: notes,
        re_evaluation: isReevaluation
    };

    fetch('/api/distribution/manual', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const successMessage = isReevaluation ? 'Reavaliação solicitada com sucesso!' : 'Distribuição manual executada com sucesso!';
            alert(successMessage);
            const modal = document.getElementById('manualDistributionModal');
            if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                bootstrap.Modal.getInstance(modal).hide();
            } else {
                // Fallback para fechar modal sem Bootstrap
                modal.style.display = 'none';
                document.body.classList.remove('modal-open');
                const backdrop = document.querySelector('.modal-backdrop');
                if (backdrop) backdrop.remove();
            }
            manualDistributionMode = 'assign';
            location.reload(); // Refresh to show updated status
        } else {
            alert('Erro na distribuição: ' + (data.error || data.message || 'Erro desconhecido'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Erro ao executar distribuição manual.');
    });
}

function executeAutomaticDistribution() {
    const selectedWorks = Array.from(document.querySelectorAll('.work-checkbox:checked')).map(cb => cb.value);
    const reviewersPerWork = document.getElementById('reviewersPerWork').value;
    const maxAssignments = document.getElementById('maxAssignmentsPerReviewer').value;
    const deadline = document.getElementById('autoDeadline').value;
    const notes = document.getElementById('autoNotes').value;
    const excludeAuthors = document.getElementById('excludeAuthors').checked;
    const balanceWorkload = document.getElementById('balanceWorkload').checked;
    
    if (!deadline) {
        alert('Por favor, defina um prazo para a revisão.');
        return;
    }
    
    const data = {
        work_ids: selectedWorks,
        reviewers_per_work: parseInt(reviewersPerWork),
        max_assignments_per_reviewer: parseInt(maxAssignments),
        deadline: deadline,
        notes: notes,
        exclude_authors: excludeAuthors,
        balance_workload: balanceWorkload
    };
    
    fetch('/api/distribution/automatic', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Distribuição automática executada com sucesso! ${data.assignments_created} atribuições criadas.`);
            const modal = document.getElementById('automaticDistributionModal');
            if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                bootstrap.Modal.getInstance(modal).hide();
            } else {
                // Fallback para fechar modal sem Bootstrap
                modal.style.display = 'none';
                document.body.classList.remove('modal-open');
                const backdrop = document.querySelector('.modal-backdrop');
                if (backdrop) backdrop.remove();
            }
            location.reload(); // Refresh to show updated status
        } else {
            alert('Erro na distribuição: ' + (data.error || data.message || 'Erro desconhecido'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Erro ao executar distribuição automática.');
    });
}

function previewAutomaticDistribution() {
    const selectedWorks = Array.from(document.querySelectorAll('.work-checkbox:checked')).map(cb => cb.value);
    const reviewersPerWork = document.getElementById('reviewersPerWork').value;
    const maxAssignments = document.getElementById('maxAssignmentsPerReviewer').value;
    
    // Simple preview calculation
    const totalAssignments = selectedWorks.length * parseInt(reviewersPerWork);
    const estimatedReviewers = Math.ceil(totalAssignments / parseInt(maxAssignments));
    
    const previewHtml = `
        <div class="row text-center">
            <div class="col-md-3">
                <strong>${selectedWorks.length}</strong><br>
                <small>Trabalhos</small>
            </div>
            <div class="col-md-3">
                <strong>${reviewersPerWork}</strong><br>
                <small>Revisores/Trabalho</small>
            </div>
            <div class="col-md-3">
                <strong>${totalAssignments}</strong><br>
                <small>Total Atribuições</small>
            </div>
            <div class="col-md-3">
                <strong>~${estimatedReviewers}</strong><br>
                <small>Revisores Necessários</small>
            </div>
        </div>
    `;
    
    document.getElementById('distributionPreview').innerHTML = previewHtml;
}

// Undo distribution functions
function confirmarDesfazerDistribuicao(workId) {
    if (confirm('Tem certeza que deseja desfazer a distribuição deste trabalho? Esta ação não pode ser desfeita.')) {
        desfazerDistribuicao(workId);
    }
}

function confirmarDesfazerTodasDistribuicoes() {
    if (confirm('Tem certeza que deseja desfazer TODAS as distribuições? Esta ação não pode ser desfeita e afetará todos os trabalhos distribuídos.')) {
        desfazerTodasDistribuicoes();
    }
}

function desfazerDistribuicao(workId) {
    fetch(`/api/distribution/undo/${workId}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Distribuição desfeita com sucesso! ${data.assignments_deleted} atribuições removidas.`);
            location.reload(); // Refresh to show updated status
        } else {
            alert('Erro ao desfazer distribuição: ' + (data.error || data.message || 'Erro desconhecido'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Erro ao desfazer distribuição.');
    });
}

function desfazerTodasDistribuicoes() {
    fetch('/api/distribution/undo-all', {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Todas as distribuições foram desfeitas com sucesso! ${data.total_assignments} atribuições removidas de ${data.works_affected} trabalhos.`);
            location.reload(); // Refresh to show updated status
        } else {
            alert('Erro ao desfazer todas as distribuições: ' + (data.error || data.message || 'Erro desconhecido'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Erro ao desfazer todas as distribuições.');
    });
}
</script>
{% endblock %}
