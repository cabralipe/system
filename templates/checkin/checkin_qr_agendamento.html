{% extends "base.html" %}

{% block title %}Check-in via QR Code{% endblock %}

{% block content %}
<div class="container d-flex flex-column justify-content-center align-items-center" style="min-height: 80vh;">
    <h2 class="mb-4"><i class="bi bi-qrcode"></i> Check-in via QR Code</h2>

    <div id="qr-video" class="position-relative" style="width: 100%; max-width: 500px; aspect-ratio: 1/1;"></div>
    <div id="scan-status" class="mt-3 text-muted">Inicializando...</div>
    <div id="scan-result" class="mt-3"></div>

    <a href="{{ url_for('dashboard_routes.dashboard_cliente') }}" class="btn btn-secondary mt-3">
        <i class="bi bi-arrow-left"></i> Voltar
    </a>
</div>
{% endblock %}

{% block scripts %}

<script src="{{ url_for('static', filename='js/lib/html5-qrcode.min.js') }}"></script>
<script type="module">
import { initScanner, stopScanner } from "{{ url_for('static', filename='js/qr_scanner.js') }}";


document.addEventListener('DOMContentLoaded', async () => {
    const statusElement = document.getElementById('scan-status');
    const scanResult = document.getElementById('scan-result');

    const scannedList = document.getElementById('scanned-list');
    let scanner;

    if (window.Html5Qrcode) {
        try {
            scanner = new Html5Qrcode('qr-video');
            const cameras = await Html5Qrcode.getCameras();
            const cameraId = cameras.find(cam => cam.label.toLowerCase().includes('back'))?.id || cameras[0].id;

            await scanner.start(
                cameraId,
                { fps: 10, qrbox: 250 },
                onScanSuccess,
                onScanError
            );

            statusElement.textContent = '✅ Câmera ativa. Aponte para o QR Code!';
        } catch (error) {
            statusElement.innerHTML = `<span class="text-danger">Erro ao iniciar câmera: ${error.message}</span>`;
        }
    } else {
        statusElement.innerHTML = '<span class="text-danger">Biblioteca de QR Code não carregada.</span>';
        return;
    }


    async function handleScan(decodedText) {
        scanResult.innerHTML = `<div class="alert alert-success">QR Lido: ${decodedText}</div>`;

        let token;
        try {
            const url = new URL(decodedText);
            token = url.searchParams.get('token');
        } catch {
            token = decodedText;
        }

        try {
            const response = await fetch('/processar_qrcode_agendamento', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ token })
            });

            if (response.ok) {
                const data = await response.json();
                if (data.redirect) {
                    window.location.href = '/confirmar_checkin_agendamento';
                }
            }
        } catch (error) {
            console.error('Erro ao processar QR Code:', error);
        }
    }

    try {
        await initScanner('qr-video', handleScan);
        statusElement.textContent = '✅ Câmera ativa. Aponte para o QR Code!';
    } catch (err) {
        statusElement.innerHTML = `<span class="text-danger">${err.message || err}</span>`;
    }


    window.addEventListener('beforeunload', stopScanner);

});
</script>
{% endblock %}
