<!-- Template: listar_horarios_agendamento.html -->
{% extends 'base.html' %}

{% block title %}Horários de Visitação - {{ evento.nome }}{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="row">
    <div class="col-lg-12">
      <h2 class="mb-4"><i class="bi bi-clock"></i> Horários de Visitação - {{ evento.nome }}</h2>
      
      <div class="alert alert-info mb-4">
        <div class="d-flex">
          <div class="me-3">
            <i class="bi bi-info-circle fs-4"></i>
          </div>
          <div>
            <p class="mb-0">Esta página exibe todos os horários de visitação disponíveis para o evento. Você pode gerenciar os horários existentes ou gerar novos horários.</p>
          </div>
        </div>
      </div>
      
      <div class="d-flex justify-content-end mb-4">
        <a href="{{ url_for('agendamento_routes.adicionar_horario_agendamento', evento_id=evento.id) }}" class="btn btn-primary me-2">
          <i class="bi bi-plus-circle"></i> Adicionar Horário
        </a>
        <a href="{{ url_for('agendamento_routes.gerar_horarios_agendamento', evento_id=evento.id) }}" class="btn btn-success me-2">
          <i class="bi bi-calendar-plus"></i> Gerar Novos Horários
        </a>
        <a href="{{ url_for('agendamento_routes.salas_visitacao', evento_id=evento.id) }}" class="btn btn-info me-2">
          <i class="bi bi-door-open"></i> Gerenciar Salas
        </a>
        <a href="{{ url_for('agendamento_routes.configurar_agendamentos', evento_id=evento.id) }}" class="btn btn-warning">
          <i class="bi bi-gear"></i> Configurações
        </a>
        <form
          method="POST"
          action="{{ url_for(
            'agendamento_routes.excluir_todos_horarios_agendamento',
            evento_id=evento.id
          ) }}"
          class="d-inline ms-2"
          onsubmit="return confirm('Confirma excluir todos os horários?');"
        >
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button type="submit" class="btn btn-danger">
            <i class="bi bi-trash"></i> Excluir Todos Horários
          </button>
        </form>
      </div>
      
      <div class="card mb-4">
        <div class="card-header bg-primary text-white">
          <i class="bi bi-calendar-week"></i> Horários Disponíveis
        </div>
        <div class="card-body">
          {% if horarios_por_data %}
            {% for data_str, horarios in horarios_por_data.items() %}
              {% set data = horarios[0].data %}
              <div class="mb-4">
                <h4>
                  <i class="bi bi-calendar-day"></i> {{ data.strftime('%d/%m/%Y') }} ({{ data|dia_semana|capitalize }})
                </h4>
                
                <div class="table-responsive">
                  <table class="table table-striped table-hover">
                    <thead>
                      <tr>
                        <th>Horário</th>
                        <th class="text-center">Capacidade Total</th>
                        <th class="text-center">Vagas Disponíveis</th>
                        <th class="text-center">Ocupação</th>
                        <th class="text-center">Ações</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for horario in horarios %}
                        <tr>
                          <td>{{ horario.horario_inicio.strftime('%H:%M') }}</td>
                          <td class="text-center">{{ horario.capacidade_total }}</td>
                          <td class="text-center">{{ horario.vagas_disponiveis }}</td>
                          <td class="text-center">
                            {% set ocupacao = ((horario.capacidade_total - horario.vagas_disponiveis) / horario.capacidade_total) * 100 %}
                            <div class="progress" style="height: 20px;">
                              <div class="progress-bar {% if ocupacao < 50 %}bg-success{% elif ocupacao < 80 %}bg-warning{% else %}bg-danger{% endif %}" 
                                   role="progressbar" style="width: {{ ocupacao }}%;" 
                                   aria-valuenow="{{ ocupacao }}" aria-valuemin="0" aria-valuemax="100">
                                {{ ocupacao|round(1) }}%
                              </div>
                            </div>
                          </td>
                          <td class="text-center">
                            <button class="btn btn-sm btn-primary" data-bs-toggle="tooltip" title="Editar"
                                    onclick="editarHorario({{ horario.id }}, '{{ horario.horario_inicio.strftime('%H:%M') }}', '{{ horario.horario_fim.strftime('%H:%M') }}', {{ horario.capacidade_total }}, {{ horario.vagas_disponiveis }})">
                              <i class="bi bi-pencil"></i>
                            </button>

                            <form method="POST" action="{{ url_for('agendamento_routes.excluir_horario_agendamento') }}"
                                  class="d-inline" onsubmit="return confirm('Tem certeza que deseja excluir o horário de {{ horario.data.strftime('%d/%m/%Y') }} às {{ horario.horario_inicio.strftime('%H:%M') }}?');">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <input type="hidden" name="horario_id" value="{{ horario.id }}">
                                <button type="submit" class="btn btn-sm btn-danger" data-bs-toggle="tooltip" title="Excluir">
                                  <i class="bi bi-trash"></i>
                                </button>
                              </form>
                          </td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            {% endfor %}
          {% else %}
            <div class="alert alert-warning">
              <i class="bi bi-exclamation-triangle"></i> Nenhum horário de visitação disponível para este evento.
            </div>
          {% endif %}
        </div>
      </div>
      
      <div class="mt-4">
        <a href="{{ url_for('agendamento_routes.eventos_agendamento') }}" class="btn btn-secondary">
          <i class="bi bi-arrow-left"></i> Voltar
        </a>
      </div>
    </div>
  </div>
</div>

<form id="editarHorarioForm" method="POST" action="{{ url_for('agendamento_routes.editar_horario_agendamento') }}" class="d-none">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
  <input type="hidden" id="editarHorarioId" name="horario_id">
  <input type="hidden" id="editarHorarioInicio" name="horario_inicio">
  <input type="hidden" id="editarHorarioFim" name="horario_fim">
  <input type="hidden" id="editarCapacidade" name="capacidade_total">
  <input type="hidden" id="editarVagas" name="vagas_disponiveis">
</form>

{% block scripts %}
<script>
  function editarHorario(id, inicio, fim, capacidade, vagas) {
    const novoInicio = prompt('Horário de Início:', inicio);
    if (novoInicio === null) return;
    const novoFim = prompt('Horário de Fim:', fim);
    if (novoFim === null) return;
    const novaCapacidade = prompt('Capacidade Total:', capacidade);
    if (novaCapacidade === null) return;
    const novasVagas = prompt('Vagas Disponíveis:', vagas);
    if (novasVagas === null) return;

    document.getElementById('editarHorarioId').value = id;
    document.getElementById('editarHorarioInicio').value = novoInicio;
    document.getElementById('editarHorarioFim').value = novoFim;
    document.getElementById('editarCapacidade').value = novaCapacidade;
    document.getElementById('editarVagas').value = novasVagas;
    document.getElementById('editarHorarioForm').submit();
  }

  document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function(el) {
      return new bootstrap.Tooltip(el);
    });
  });
</script>
{% endblock %}
{% endblock %}
