{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2>Agendar Visita</h2>
    <p class="text-muted">
        Você está agendando como
        {{ 'Professor' if current_user.tipo == 'professor' else 'Cliente' }}.
    </p>
    <p><strong>Data:</strong> {{ horario.data }}</p>
    <p><strong>Horário:</strong> {{ horario.horario_inicio }} - {{ horario.horario_fim }}</p>
    <p><strong>Vagas Disponíveis:</strong> {{ horario.vagas_disponiveis }}</p>

    <form method="POST">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        {% if current_user.tipo == 'professor' %}
        <input type="hidden" name="professor_id" value="{{ current_user.id }}">
        {% elif current_user.tipo == 'cliente' %}
        <input type="hidden" name="cliente_id" value="{{ current_user.id }}">
        {% endif %}
        <div class="mb-3">
            <label class="form-label">Nome da Escola</label>
            <input type="text" name="escola_nome" class="form-control" required>
        </div>
        <div class="mb-3">
            <label class="form-label">Turma</label>
            <input type="text" name="turma" class="form-control" required>
        </div>
        <div class="mb-3">
            <label class="form-label" for="estado">Estado</label>
            <select id="estado" name="estados[]" class="form-select" required
                    onchange="loadCities(this, 'cidade')">
                <option value="">Selecione o estado</option>
            </select>
        </div>
        <div class="mb-3">
            <label class="form-label" for="cidade">Cidade</label>
            <select id="cidade" name="cidades[]" class="form-select" required>
                <option value="">Selecione o estado primeiro</option>
            </select>
        </div>
        <div class="mb-3">
            <label class="form-label">Quantidade de Alunos</label>
            <input type="number" name="quantidade_alunos" class="form-control" required>
        </div>
        <button type="submit" class="btn btn-success">Confirmar Agendamento</button>
    </form>
</div>

<div id="chat-ajuda" class="border rounded p-3 bg-light" style="display:none; position:fixed; bottom:20px; right:20px; max-width:300px; z-index:1000;">
    <strong>Precisa de ajuda?</strong>
    <p class="mb-0">Após concluir o agendamento, acesse <strong>Meus Agendamentos</strong> para inserir nome e CPF dos alunos e baixar o comprovante.</p>
</div>
{% endblock %}

{% block scripts %}
    {{ super() }}
    <script src="{{ url_for('static', filename='js/agendamento_chat.js') }}"></script>
    <script>
    const estadosBrasil = {{ estados|tojson }};

    function loadBrazilianStates(select) {
        select.innerHTML = '<option value="">Selecione o estado</option>';
        estadosBrasil.forEach(function (estado) {
            const opt = document.createElement('option');
            opt.value = estado[0];
            opt.textContent = estado[1];
            select.appendChild(opt);
        });
    }

    async function loadCities(stateSelect, citySelectId) {
        const citySelect = document.getElementById(citySelectId);
        const state = stateSelect.value;
        if (!state) {
            citySelect.innerHTML = '<option value="">Selecione o estado primeiro</option>';
            citySelect.disabled = true;
            return;
        }
        citySelect.disabled = true;
        citySelect.innerHTML = '<option value="">Carregando cidades...</option>';
        try {
            // Usa o endpoint local /get_cidades/<estado_sigla>
            const response = await fetch(`/get_cidades/${state}`);
            const cidades = await response.json();
            citySelect.innerHTML = '<option value="">Selecione a cidade</option>';
            cidades.forEach(function (cidade) {
                const opt = document.createElement('option');
                opt.value = cidade;
                opt.textContent = cidade;
                citySelect.appendChild(opt);
            });
            citySelect.disabled = false;
        } catch (error) {
            console.error('Erro ao carregar cidades:', error);
            citySelect.innerHTML = '<option value="">Erro ao carregar cidades</option>';
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        const estadoSelect = document.getElementById('estado');
        loadBrazilianStates(estadoSelect);
    });
    </script>
{% endblock %}
