{% extends "base.html" %}
{% block title %}Dashboard - Administrador{% endblock %}

{% block content %}
<div class="container-fluid px-4">
  <!-- Header Section -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h2 fw-bold text-primary">
      <i class="bi bi-speedometer2 me-2"></i>Painel Administrativo
    </h1>
    <a href="{{ url_for('routes.cadastrar_cliente') }}" class="btn btn-success">
      <i class="bi bi-plus-circle me-2"></i>Novo Cliente
    </a>
  </div>

  <!-- Statistics Cards -->
  <div class="row g-4 mb-4">
    <div class="col-12 col-md-6 col-xl-3">
      <div class="card stat-card bg-primary-gradient text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h5 class="card-subtitle mb-2">Oficinas Ativas</h5>
              <h2 class="card-title mb-0">{{ total_oficinas }}</h2>
            </div>
            <i class="bi bi-journal-bookmark fs-1 opacity-25"></i>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-12 col-md-6 col-xl-3">
      <div class="card stat-card bg-info-gradient text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h5 class="card-subtitle mb-2">Vagas Preenchidas</h5>
              <h2 class="card-title mb-0">{{ total_inscricoes }}</h2>
            </div>
            <i class="bi bi-people fs-1 opacity-25"></i>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-md-6 col-xl-3">
      <div class="card stat-card bg-warning-gradient text-dark">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h5 class="card-subtitle mb-2">Taxa de Adesão</h5>
              <h2 class="card-title mb-0">{{ "%.2f"|format(percentual_adesao) }}%</h2>
            </div>
            <i class="bi bi-graph-up fs-1 opacity-25"></i>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-md-6 col-xl-3">
      <div class="card stat-card bg-danger-gradient text-white">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h5 class="card-subtitle mb-2">Clientes Ativos</h5>
              <h2 class="card-title mb-0">{{ clientes|length }}</h2>
            </div>
            <i class="bi bi-building fs-1 opacity-25"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content Tabs -->
  <div class="row">
    <div class="col-12">
      <div class="card shadow">
        <div class="card-body p-0">
          <ul class="nav nav-tabs nav-justified" id="dashboardTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="oficinas-tab" data-bs-toggle="tab" 
                      data-bs-target="#oficinas" type="button">Oficinas</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="clientes-tab" data-bs-toggle="tab" 
                      data-bs-target="#clientes" type="button">Clientes</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="ferramentas-tab" data-bs-toggle="tab" 
                      data-bs-target="#ferramentas" type="button">Ferramentas</button>
            </li>
          </ul>

          <div class="tab-content p-4">
            <!-- Oficinas Tab -->
            <div class="tab-pane fade show active" id="oficinas">
              <div class="row">
                <div class="col-12 mb-4">
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="mb-0">Detalhes das Oficinas</h4>
                    <a href="{{ url_for('routes.criar_oficina') }}" class="btn btn-primary">
                      <i class="bi bi-plus-lg me-2"></i>Nova Oficina
                    </a>
                  </div>
                  <!-- Filtro de Cliente (Somente para Administradores) -->

                  <form method="GET" action="{{ url_for('routes.dashboard') }}" class="mb-3">
                    <div class="row">
                      <div class="col-md-4">
                        <label for="clienteSelect" class="form-label">Filtrar por Cliente</label>
                        <select id="clienteSelect" name="cliente_id" class="form-select">
                          <option value="">Todos os Clientes</option>
                          {% for cliente in clientes %}
                            <option value="{{ cliente.id }}" {% if cliente.id|string == cliente_filter %}selected{% endif %}>
                              {{ cliente.nome }}
                            </option>
                          {% endfor %}
                        </select>
                      </div>
                      <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary">Filtrar</button>
                      </div>
                    </div>
                  </form>

                  <div class="table-responsive">
                    <table class="table table-hover align-middle">
                      <thead class="table-light">
                        <tr>
                          <th>Título</th>
                          <th class="text-center">Vagas</th>
                          <th class="text-center">Inscrições</th>
                          <th class="text-center">Ocupação</th>
                          <th>Ações</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for ofst in oficinas_estatisticas %}
                        <tr>
                          <td>{{ ofst.titulo }}</td>
                          <td class="text-center">{{ ofst.vagas }}</td>
                          <td class="text-center">{{ ofst.inscritos }}</td>
                          <td class="text-center">
                            <div class="progress" style="height: 20px;">
                              <div class="progress-bar bg-success" 
                                   style="width: {{ ofst.ocupacao }}%">
                                {{ "%.2f"|format(ofst.ocupacao) }}%
                              </div>
                            </div>
                          </td>
                          <td>
                            <div class="d-flex gap-2">
                              <a href="{{ url_for('routes.editar_oficina', oficina_id=ofst.id) }}" 
                                 class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-pencil"></i>
                              </a>
                              <form action="{{ url_for('routes.excluir_oficina', oficina_id=ofst.id) }}" 
                                    method="post" class="d-inline">
                                <button type="submit" class="btn btn-sm btn-outline-danger">
                                  <i class="bi bi-trash"></i>
                                </button>
                              </form>
                            </div>
                          </td>
                        </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>

            <!-- Clientes Tab -->
            <div class="tab-pane fade" id="clientes">
              <div class="row">
                <div class="col-12">
                  <h4 class="mb-3">Gestão de Clientes</h4>
                  <div class="table-responsive">
                    <table class="table table-hover align-middle">
                      <thead class="table-light">
                        <tr>
                          <th>Nome</th>
                          <th>E-mail</th>
                          <th class="text-center">Status</th>
                          <th>Ações</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for cliente in clientes %}
                        <tr>
                          <td>{{ cliente.nome }}</td>
                          <td>{{ cliente.email }}</td>
                          <td class="text-center">
                            <span class="badge bg-{{ 'success' if cliente.ativo else 'secondary' }}">
                              {{ "Ativo" if cliente.ativo else "Inativo" }}
                            </span>
                          </td>
                          <td>
                            <div class="d-flex gap-2">
                              <button class="btn btn-sm btn-outline-warning"
                                      data-bs-toggle="modal"
                                      data-bs-target="#modalEditarCliente"
                                      data-id="{{ cliente.id }}"
                                      data-nome="{{ cliente.nome }}"
                                      data-email="{{ cliente.email }}">
                                <i class="bi bi-pencil"></i>
                              </button>
                              <a href="{{ url_for('routes.toggle_cliente', cliente_id=cliente.id) }}" 
                                 class="btn btn-sm btn-outline-{{ 'secondary' if cliente.ativo else 'success' }}">
                                {{ "Restringir" if cliente.ativo else "Ativar" }}
                              </a>
                            </div>
                          </td>
                        </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>

            <!-- Ferramentas Tab -->
            <div class="tab-pane fade" id="ferramentas">
              <div class="row g-4">
                <!-- Import Section -->
                <div class="col-12 col-lg-6">
                  <div class="card h-100">
                    <div class="card-header bg-primary text-white">
                      <i class="bi bi-upload me-2"></i>Importação de Dados
                    </div>
                    <div class="card-body">
                      <div class="mb-4">
                        <h5 class="mb-3">Importar Oficinas</h5>
                        <form action="{{ url_for('routes.importar_oficinas') }}" method="POST" 
                              enctype="multipart/form-data" class="mb-4">
                          <div class="input-group">
                            <input type="file" name="arquivo" accept=".xlsx" 
                                   class="form-control" required>
                            <button type="submit" class="btn btn-success">
                              <i class="bi bi-upload me-2"></i>Importar
                            </button>
                          </div>
                          <small class="text-muted mt-2 d-block">
                            <a href="{{ url_for('static', filename='modelo_oficinas.xlsx') }}" 
                               class="text-decoration-none">
                              <i class="bi bi-download me-1"></i>Baixar modelo
                            </a>
                          </small>
                        </form>
                      </div>

                      <div>
                        <h5 class="mb-3">Importar Usuários</h5>
                        <form action="{{ url_for('routes.importar_usuarios') }}" method="POST" 
                              enctype="multipart/form-data">
                          <div class="input-group">
                            <input type="file" name="arquivo" accept=".xlsx" 
                                   class="form-control" required>
                            <button type="submit" class="btn btn-success">
                              <i class="bi bi-upload me-2"></i>Importar
                            </button>
                          </div>
                          <small class="text-muted mt-2 d-block">
                            <a href="{{ url_for('static', filename='modelo_usuarios.xlsx') }}" 
                               class="text-decoration-none">
                              <i class="bi bi-download me-1"></i>Baixar modelo
                            </a>
                          </small>
                        </form>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Actions Section -->
                <div class="col-12 col-lg-6">
                  <div class="card h-100">
                    <div class="card-header bg-primary text-white">
                      <i class="bi bi-tools me-2"></i>Ações Rápidas
                    </div>
                    <div class="card-body">
                      <div class="d-grid gap-3">
                        <a href="{{ url_for('routes.admin_scan') }}" 
                           class="btn btn-dark btn-lg">
                          <i class="bi bi-qr-code-scan me-2"></i>Escanear QR Code
                        </a>

                        <button type="button" class="btn btn-info btn-lg"
                                data-bs-toggle="modal" data-bs-target="#modalRelatorioMensagem">
                          <i class="bi bi-chat-text me-2"></i>Relatório de Mensagem
                        </button>

                        <a href="{{ url_for('routes.listar_formularios') }}" 
                           class="btn btn-primary btn-lg">
                          <i class="bi bi-ui-checks me-2"></i>Gerenciar Formulários
                        </a>

                        <!-- Botão para abrir o modal de mover inscrições -->
<button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#modalMoverInscricoes">
  <i class="bi bi-arrow-left-right"></i> Mover Inscrições
</button>

<!-- Modal para Mover Inscrições -->
<div class="modal fade" id="modalMoverInscricoes" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-warning text-dark">
        <h5 class="modal-title">Mover Inscrições em Lote</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form method="POST" action="{{ url_for('routes.mover_inscricoes_lote') }}">
          <div class="mb-3">
            <label class="form-label">Selecionar Inscrições:</label>
            {% for inscricao in inscricoes %}
              <div class="form-check">
                <input class="form-check-input" type="checkbox" 
                       name="inscricao_ids" value="{{ inscricao.id }}">
                <label class="form-check-label">
                  {{ inscricao.usuario.nome }} ({{ inscricao.oficina.titulo }})
                </label>
              </div>
            {% endfor %}
          </div>
          <div class="mb-3">
            <label class="form-label">Oficina de Destino:</label>
            <select class="form-select" name="oficina_destino" required>
              <option value="">-- Selecione a Oficina --</option>
              {% for oficina in oficinas %}
                <option value="{{ oficina.id }}">{{ oficina.titulo }}</option>
              {% endfor %}
            </select>
          </div>
          <button type="submit" class="btn btn-success w-100">
            Confirmar
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Botão para abrir o modal de inscrição em lote -->
<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalInscricaoLote">
  <i class="bi bi-person-plus"></i> Inscrição em Lote
</button>

<!-- Modal Inscrição em Lote -->
<div class="modal fade" id="modalInscricaoLote" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">Inscrever Participantes em Lote</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form method="POST" action="{{ url_for('routes.inscrever_participantes_lote') }}">
          <div class="mb-3">
            <label class="form-label">Selecionar Participantes:</label>
            <div class="form-check">
              {% for usuario in participantes %}
                <input class="form-check-input" type="checkbox" name="usuario_ids" value="{{ usuario.id }}" id="usuario{{ usuario.id }}">
                <label class="form-check-label" for="usuario{{ usuario.id }}">
                  {{ usuario.nome }} ({{ usuario.email }})
                </label><br>
              {% endfor %}
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Selecionar Oficina:</label>
            <select class="form-select" name="oficina_id" required>
              <option value="">-- Escolha a oficina --</option>
              {% for oficina in oficinas %}
                <option value="{{ oficina.id }}">{{ oficina.titulo }}</option>
              {% endfor %}
            </select>
          </div>

          <button type="submit" class="btn btn-success w-100">
            Confirmar Inscrição
          </button>
        </form>
      </div>
    </div>
  </div>
</div>


                        <form action="{{ url_for('routes.excluir_todas_oficinas') }}" method="post"
                              onsubmit="return confirm('Tem certeza que deseja excluir TODAS as oficinas?')">
                          <button type="submit" class="btn btn-danger btn-lg w-100">
                            <i class="bi bi-trash me-2"></i>Excluir Todas Oficinas
                          </button>
                        </form>
                      </div>
                    </div>
                  </div>
                </div>
              </div><!-- row g-4 -->

              <!-- Bloco para Cadastro de Ministrante DENTRO da aba Ferramentas -->
  <div class="row g-4 mt-4">
    <div class="col-12 col-lg-6">
      <div class="card h-100">
        <div class="card-header bg-primary text-white">
          <i class="bi bi-person-plus me-2"></i>Gerenciamento de Ministrante
        </div>
        <div class="card-body">
          <div class="d-grid gap-3">
            <!-- Botão: Cadastrar Ministrante -->
            <a href="{{ url_for('routes.cadastro_ministrante') }}" class="btn btn-primary btn-lg">
              <i class="bi bi-person-plus"></i> Cadastrar Ministrante
            </a>
            
            <!-- Botão: Gerenciar Ministrantes -->
            </button>
            <a href="{{ url_for('routes.gerenciar_ministrantes') }}" class="btn btn-success btn-lg">
              <i class="bi bi-people"></i> Gerenciar Ministrantes
            </a>
            

            <!-- Botão: Relatório Formador -->
            <button type="button" class="btn btn-info btn-lg"
                    data-bs-toggle="modal" 
                    data-bs-target="#modalRelatorios">
              <i class="bi bi-file-earmark-text"></i> Relatório Formador
            </button>

            <!-- Botão: Gerenciar Participantes -->
            <button type="button" class="btn btn-warning btn-lg"
                    data-bs-toggle="modal" 
                    data-bs-target="#modalGerenciarParticipantes">
              <i class="bi bi-people"></i> Gerenciar Participantes
            </button>
          </div>
        </div><!-- /card-body -->
      </div><!-- /card -->
    </div><!-- /col -->
  </div><!-- /row mt-4 -->
  <!-- /Bloco para Cadastro de Ministrante -->

            </div> <!-- /Ferramentas Tab -->
          </div><!-- /tab-content -->
        </div><!-- /card-body -->
      </div><!-- /card -->
    </div><!-- /col-12 -->
  </div><!-- /row -->
</div><!-- /container-fluid -->


<!-- Modal de confirmação de exclusão -->
<!-- Modal de confirmação de exclusão -->
<div class="modal fade" id="modalExcluirCliente" tabindex="-1" aria-labelledby="modalExcluirClienteLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form action="{{ url_for('routes.excluir_cliente', cliente_id=0) }}" method="POST" id="formExcluirCliente">
        <div class="modal-header">
          <h5 class="modal-title" id="modalExcluirClienteLabel">Confirmar Exclusão</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <p>Tem certeza que deseja excluir este cliente?</p>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-danger">Sim, Excluir</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal Gerenciar Inscrições -->
<div class="modal fade" id="modalGerenciarInscricoes" tabindex="-1" aria-labelledby="modalGerenciarInscricoesLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">

      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="modalGerenciarInscricoesLabel">Gerenciar Inscrições</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>

      <div class="modal-body">
        <!-- Tabela de inscrições -->
        <form id="formGerenciarInscricoes" method="POST" action="">
          <div class="table-responsive">
            <table class="table table-striped table-bordered align-middle">
              <thead class="table-dark">
                <tr>
                  <th></th>  <!-- Coluna dos checkboxes -->
                  <th>ID</th>
                  <th>Participante</th>
                  <th>Oficina</th>
                  <th>Ações</th>
                </tr>
              </thead>
              <tbody>
                {% for insc in inscricoes %}
                  <tr>
                    <td>
                      <!-- Checkbox para seleção múltipla -->
                      <input type="checkbox" name="inscricao_ids" value="{{ insc.id }}">
                    </td>
                    <td>{{ insc.id }}</td>
                    <td>{{ insc.usuario.nome }}</td>
                    <td>{{ insc.oficina.titulo }}</td>
                    <td>
                      <!-- Ação individual (opcional) -->
                      <a href="{{ url_for('routes.cancelar_inscricao', inscricao_id=insc.id) }}" class="btn btn-danger btn-sm">
                        Cancelar
                      </a>
                      <!-- ou mover individual -->
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <!-- Seletor de oficina destino (usado ao mover) -->
          <div class="mb-3">
            <label for="oficinaDestino" class="form-label">Mover para Oficina:</label>
            <select id="oficinaDestino" name="oficina_destino" class="form-select">
              <option value="">Selecione</option>
              {% for of in oficinas %}
                <option value="{{ of.id }}">{{ of.titulo }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- Botões de Ações em lote -->
          <button type="submit" formaction="{{ url_for('routes.cancelar_inscricoes_lote') }}" class="btn btn-danger">
            Cancelar Selecionadas
          </button>
          <button type="submit" formaction="{{ url_for('routes.mover_inscricoes_lote') }}" class="btn btn-warning">
            Mover Selecionadas
          </button>
        </form>
      </div>

    </div>
  </div>
</div>

<!-- Modal do Relatório de Mensagem -->
<div class="modal fade" id="modalRelatorioMensagem" tabindex="-1"
     aria-labelledby="modalRelatorioMensagemLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">

      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="modalRelatorioMensagemLabel">
          Relatório - Mensagem de Texto
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                aria-label="Fechar"></button>
      </div>

      <div class="modal-body">
        <!-- Campo de texto (textarea) para exibir e editar a mensagem -->
        <textarea id="textoRelatorio" class="form-control" rows="8">{{ msg_relatorio }}</textarea>
      </div>

      <div class="modal-footer">
        <!-- Botão para copiar o texto -->
        <button type="button" class="btn btn-primary fw-bold" onclick="copiarMensagem()">
          <i class="bi bi-clipboard"></i> Copiar Mensagem
        </button>
        <!-- Novo botão para enviar por WhatsApp -->
        <button type="button" class="btn btn-success fw-bold" onclick="enviarWhatsAppRelatorio()">
          <i class="bi bi-whatsapp"></i> Enviar por WhatsApp
        </button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Fechar
        </button>
      </div>

    </div>
  </div>
</div>



  <!-- Modal de Check-ins via QR -->
  <div class="modal fade" id="modalCheckinsQR" tabindex="-1" aria-labelledby="modalCheckinsQRLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalCheckinsQRLabel">Check-ins via QR Code</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          {% if checkins_via_qr and checkins_via_qr|length > 0 %}
            <div class="table-responsive">
              <table class="table table-striped table-bordered">
                <thead>
                  <tr>
                    <th>Nome</th>
                    <th>Oficina</th>
                    <th>Data/Hora</th>
                  </tr>
                </thead>
                <tbody>
                  {% for ck in checkins_via_qr %}
                    <tr>
                      <td>{{ ck.usuario.nome }}</td>
                      <td>{{ ck.oficina.titulo }}</td>
                      <td>
                        {% if ck.data_hora %}
                          {{ ck.data_hora.strftime('%d/%m/%Y %H:%M:%S') }}
                        {% else %}
                          N/A
                        {% endif %}
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>

             <!-- Botão para gerar PDF dos checkins via QR -->
            <div class="d-flex justify-content-end">
              <a href="{{ url_for('routes.gerar_pdf_checkins_qr') }}"
                class="btn btn-outline-primary fw-bold">
                <i class="bi bi-file-earmark-arrow-down"></i> Baixar PDF
              </a>
            </div>


          {% else %}
            <p>Nenhum check-in via QR Code encontrado até o momento.</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Relatórios Formadores -->
<div class="modal fade" id="modalRelatorios" tabindex="-1" aria-labelledby="modalRelatoriosLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title" id="modalRelatoriosLabel">Relatórios Formadores</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        {% if relatorios and relatorios|length > 0 %}
          <div class="table-responsive">
            <table class="table table-bordered table-striped">
              <thead class="table-dark">
                <tr>
                  <th>ID</th>
                  <th>Oficina</th>
                  <th>Ministrante</th>
                  <th>Metodologia</th>
                  <th>Resultados</th>
                  <th>Enviado Em</th>
                  <th>Anexo</th>
                </tr>
              </thead>
              <tbody>
                {% for rel in relatorios %}
                  <tr>
                    <td>{{ rel.id }}</td>
                    <td>{{ rel.oficina.titulo }}</td>
                    <td>{{ rel.ministrante.nome }}</td>
                    <td>{{ rel.metodologia }}</td>
                    <td>{{ rel.resultados }}</td>
                    <td>{{ rel.enviado_em.strftime('%d/%m/%Y %H:%M') }}</td>
                    <td>
                      {% if rel.fotos_videos_path %}
                      {% set nome_arquivo = rel.fotos_videos_path.split('/')[-1] %}
                          <a href="{{ url_for('routes.get_relatorio_file', filename=nome_arquivo) }}">
                            Visualizar
                          </a>                    
                      {% else %}
                        N/A
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p>Nenhum relatório encontrado.</p>
        {% endif %}
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
      </div>
    </div>
  </div>
</div>



<!-- Modal de Gerenciamento de Participantes -->
<div class="modal fade" id="modalGerenciarParticipantes" tabindex="-1" 
     aria-labelledby="modalGerenciarParticipantesLabel" 
     aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header bg-secondary text-white">
        <h5 class="modal-title" id="modalGerenciarParticipantesLabel">
          Gerenciar Participantes
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" 
                aria-label="Fechar"></button>
      </div>
      <div class="modal-body">

        <div class="table-responsive">
          <table class="table table-striped table-bordered">
            <thead class="table-dark">
              <tr>
                <th>ID</th>
                <th>Nome</th>
                <th>CPF</th>
                <th>E-mail</th>
                <th>Formação</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody>
              {% for p in participantes %}
              <tr>
                <td>{{ p.id }}</td>
                <td>{{ p.nome }}</td>
                <td>{{ p.cpf }}</td>
                <td>{{ p.email }}</td>
                <td>{{ p.formacao }}</td>
                <td>
                  <!-- Botão Editar (abre outro modal para edição, ou faz redirect) -->
                  <button type="button" class="btn btn-warning btn-sm"
                          data-bs-toggle="modal"
                          data-bs-target="#modalEditarParticipante"
                          data-id="{{ p.id }}"
                          data-nome="{{ p.nome }}"
                          data-cpf="{{ p.cpf }}"
                          data-email="{{ p.email }}"
                          data-formacao="{{ p.formacao }}">
                    Editar
                  </button>
                  <!-- Botão Excluir (formulário POST, ou AJAX) -->
                  <form action="{{ url_for('routes.excluir_participante', participante_id=p.id) }}"
                        method="POST" style="display:inline-block;"
                        onsubmit="return confirm('Tem certeza que deseja excluir este participante?');">
                    <button type="submit" class="btn btn-danger btn-sm">Excluir</button>
                  </form>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Fechar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Edição de Participante -->
<div class="modal fade" id="modalEditarParticipante" tabindex="-1" aria-labelledby="modalEditarParticipanteLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="formEditarParticipante" method="POST" action="">
        <div class="modal-header bg-warning text-white">
          <h5 class="modal-title" id="modalEditarParticipanteLabel">Editar Participante</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <!-- Campos para edição -->
          <div class="mb-3">
            <label for="nome" class="form-label">Nome</label>
            <input type="text" id="nome" name="nome" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="cpf" class="form-label">CPF</label>
            <input type="text" id="cpf" name="cpf" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="email" class="form-label">E-mail</label>
            <input type="email" id="email" name="email" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="formacao" class="form-label">Formação</label>
            <input type="text" id="formacao" name="formacao" class="form-control">
          </div>
          <div class="mb-3">
            <label for="senha" class="form-label">Nova Senha (deixe vazio para não alterar)</label>
            <input type="password" id="senha" name="senha" class="form-control">
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Salvar Alterações</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        </div>
      </form>
    </div>
  </div>
</div>


  <!-- Gerenciamento de Oficinas -->
  <h3 class="text-center text-dark mt-5">Gerenciamento de Oficinas</h3>
  <br>
<!-- Filtro de Estado, Cidade e Cliente -->
<form method="GET" action="{{ url_for('routes.dashboard') }}">
  <div class="row mb-4">
    <div class="col-md-3">
      <label for="clienteSelect" class="form-label">Filtrar por Cliente</label>
      <select id="clienteSelect" name="cliente_id" class="form-select">
        <option value="">Todos os Clientes</option>
        {% for cliente in clientes %}
          <option value="{{ cliente.id }}" {% if cliente.id|string == cliente_filter %}selected{% endif %}>
            {{ cliente.nome }}
          </option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3">
      <label for="estadoSelect" class="form-label">Filtrar por Estado</label>
      <select id="estadoSelect" name="estado" class="form-select">
        <option value="">Todos os Estados</option>
      </select>
    </div>
    <div class="col-md-3">
      <label for="cidadeSelect" class="form-label">Filtrar por Cidade</label>
      <select id="cidadeSelect" name="cidade" class="form-select">
        <option value="">Todas as Cidades</option>
      </select>
    </div>
    <div class="col-md-3 d-flex align-items-end">
      <button type="submit" class="btn btn-primary w-100">Filtrar</button>
    </div>
  </div>
</form>

  
  <div class="row mt-4">
    {% for oficina in oficinas %}
      <div class="col-md-6 col-lg-4 mb-4">
        <div class="card shadow-lg h-100">
          <div class="card-header bg-primary text-white text-center fw-bold">
            {{ oficina.titulo }}
          </div>
          <div class="card-body text-center d-flex flex-column justify-content-between">
            <div>
              <p class="info m-0"><strong>Ministrante:</strong> {{ oficina.ministrante }}</p>
              <p><strong>Datas e Horários:</strong></p>
              <ul class="list-unstyled">
                {% for dia in oficina.dias %}
                  <li>📅 {{ dia.data.strftime('%d/%m/%Y') }} - 🕒 {{ dia.horario_inicio }} às {{ dia.horario_fim }}</li>
                {% endfor %}
              </ul>
              
              <p class="info m-0"><strong>Vagas disponíveis:</strong> {{ oficina.vagas }}</p>
              <p class="info"><strong>Total de inscritos:</strong> {{ oficina.inscritos | length }}</p>
            </div>
            <div class="mt-3 d-flex justify-content-center gap-2 flex-wrap">
              <a href="{{ url_for('routes.editar_oficina', oficina_id=oficina.id) }}" class="btn btn-warning btn-sm fw-bold">
                <i class="bi bi-pencil-square"></i> Editar
              </a>
              <form action="{{ url_for('routes.excluir_oficina', oficina_id=oficina.id) }}" method="post"
                    onsubmit="return confirm('Tem certeza que deseja excluir esta oficina?');">
                <button type="submit" class="btn btn-danger btn-sm fw-bold">
                  <i class="bi bi-trash-fill"></i> Excluir
                </button>
              </form>
              <a href="{{ url_for('routes.lista_checkins', oficina_id=oficina.id) }}" class="btn btn-primary btn-sm fw-bold">
                <i class="bi bi-card-checklist"></i> Check-ins
              </a>
            </div>

            <button type="button" class="btn btn-info btn-sm fw-bold mt-3" data-bs-toggle="modal"
                    data-bs-target="#modalOficina{{ oficina.id }}">
              <i class="bi bi-eye-fill"></i> Ver Inscritos
            </button>
          </div>
        </div>
      </div>

      <!-- Modal para gerar certificado individual para uma oficina -->
      <div class="modal fade" id="modalCertificadoIndividual{{ oficina.id }}"
      tabindex="-1" aria-labelledby="modalCertificadoIndividualLabel{{ oficina.id }}"
      aria-hidden="true">
      <div class="modal-dialog">
      <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title fw-bold" id="modalCertificadoIndividualLabel{{ oficina.id }}">
          Certificado Individual - {{ oficina.titulo }}
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <form action="{{ url_for('routes.gerar_certificado_individual_admin') }}" method="POST">
          <!-- Envia o ID da oficina -->
          <input type="hidden" name="oficina_id" value="{{ oficina.id }}">
          <div class="mb-3">
            <label for="usuarioSelect{{ oficina.id }}" class="form-label">Selecione o participante</label>
            <select name="usuario_id" id="usuarioSelect{{ oficina.id }}" class="form-select" required>
              <option value="">-- Selecione --</option>
              {% for inscricao in oficina.inscritos %}
                <!-- Aqui assumimos que cada inscrição possui os dados do usuário, ex: inscricao.usuario -->
                <option value="{{ inscricao.id }}">{{ inscricao.nome }} - {{ inscricao.email }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="d-grid">
            <button type="submit" class="btn btn-primary fw-bold">
              <i class="bi bi-award-fill"></i> Gerar Certificado
            </button>
          </div>
        </form>
      </div>
      </div>
      </div>
      </div>


      <!-- Modal para mostrar inscritos da oficina -->
      <div class="modal fade" id="modalOficina{{ oficina.id }}" tabindex="-1" aria-labelledby="modalLabel{{ oficina.id }}"
           aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header bg-primary text-white">
              <h5 class="modal-title fw-bold" id="modalLabel{{ oficina.id }}">
                <i class="bi bi-people"></i> Inscritos - {{ oficina.titulo }}
              </h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
              {% if oficina.inscritos | length > 0 %}
                <div class="table-responsive">
                  <table class="table table-striped table-hover align-middle">
                    <thead class="table-dark">
                      <tr>
                        <th>Nome</th>
                        <th>CPF</th>
                        <th>E-mail</th>
                        <th>Formação</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for inscricao in oficina.inscritos %}
                        <tr>
                          <td>{{ inscricao.nome }}</td>
                          <td>{{ inscricao.cpf }}</td>
                          <td>{{ inscricao.email }}</td>
                          <td>{{ inscricao.formacao }}</td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              {% else %}
                <p class="text-center text-danger fs-5">Nenhum inscrito ainda.</p>
              {% endif %}
            </div>
            <div class="modal-footer d-flex justify-content-center gap-2 flex-wrap">
              <a href="{{ url_for('routes.gerar_pdf_inscritos_pdf', oficina_id=oficina.id) }}" class="btn btn-outline-primary">
                <i class="bi bi-file-earmark-text"></i> Baixar Lista de Inscritos
              </a>
              <a href="{{ url_for('routes.gerar_lista_frequencia', oficina_id=oficina.id) }}" class="btn btn-outline-secondary">
                <i class="bi bi-file-earmark-spreadsheet"></i> Lista de Frequência
              </a>
              <a href="{{ url_for('routes.gerar_certificados', oficina_id=oficina.id) }}" class="btn btn-outline-success">
                <i class="bi bi-award-fill"></i> Gerar Certificados
              </a>
              <!-- Botão para abrir a modal de certificado individual -->
              <a href="#" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#modalCertificadoIndividual{{ oficina.id }}">
                <i class="bi bi-award-fill"></i> Certificado Individual
              </a>
              <a href="{{ url_for('routes.feedback_oficina', oficina_id=oficina.id) }}" class="btn btn-outline-info">
                <i class="bi bi-alphabet"></i> Gerar Feedback
              </a>
            </div>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>
</div>

<!-- Modal de edição de cliente -->
<!-- Modal de edição de cliente -->
<div class="modal fade" id="modalEditarCliente" tabindex="-1" aria-labelledby="modalEditarClienteLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form action="{{ url_for('routes.editar_cliente', cliente_id=0) }}" method="POST" id="formEditarCliente">
        <div class="modal-header">
          <h5 class="modal-title" id="modalEditarClienteLabel">Editar Cliente</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="clienteNome" class="form-label">Nome</label>
            <input type="text" class="form-control" name="nome" id="clienteNome" required>
          </div>
          <div class="mb-3">
            <label for="clienteEmail" class="form-label">E-mail</label>
            <input type="email" class="form-control" name="email" id="clienteEmail" required>
          </div>
          <div class="mb-3">
            <label for="clienteSenha" class="form-label">Nova Senha (opcional)</label>
            <input type="password" class="form-control" name="senha" id="clienteSenha" placeholder="Deixe em branco para manter a senha atual">
            <small class="form-text text-muted">A senha só será alterada se você preencher este campo.</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Salvar Alterações</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  document.querySelectorAll('[id^="modalCertificadoIndividual"]').forEach(function(modalElement) {
    modalElement.addEventListener("hidden.bs.modal", function () {
      var backdrop = document.querySelector(".modal-backdrop");
      if (backdrop) {
        backdrop.parentNode.removeChild(backdrop);
      }
      document.body.classList.remove("modal-open");
    });
  });
</script>
<script>
  // Define a URL base em uma variável JavaScript
  var editarClienteBaseUrl = "{{ url_for('routes.editar_cliente', cliente_id=0) }}".replace('/0', '');

  var modalEditarCliente = document.getElementById('modalEditarCliente');
modalEditarCliente.addEventListener('show.bs.modal', function (event) {
    var button = event.relatedTarget;
    var clienteId = button.getAttribute('data-id');
    var nome = button.getAttribute('data-nome');
    var email = button.getAttribute('data-email');
    
    var form = modalEditarCliente.querySelector('#formEditarCliente');
    form.querySelector('#clienteNome').value = nome;
    form.querySelector('#clienteEmail').value = email;
    form.querySelector('#clienteSenha').value = ''; // Mantém em branco
    
    form.action = editarClienteBaseUrl + '/' + clienteId;
});
</script>


<!-- Script para buscar estados e cidades via API do IBGE -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const estadoSelect = document.getElementById('estadoSelect');
    const cidadeSelect = document.getElementById('cidadeSelect');
    const estadoFilter = "{{ estado_filter|default('') }}";
    const cidadeFilter = "{{ cidade_filter|default('') }}";

    fetch('https://servicodados.ibge.gov.br/api/v1/localidades/estados')
      .then(response => response.json())
      .then(data => {
        data.sort((a, b) => a.nome.localeCompare(b.nome));
        data.forEach(estado => {
          const option = document.createElement('option');
          option.value = estado.sigla;
          option.text = estado.nome;
          if (estado.sigla === estadoFilter) {
            option.selected = true;
          }
          estadoSelect.add(option);
        });
        if (estadoSelect.value) {
          estadoSelect.dispatchEvent(new Event('change'));
        }
      })
      .catch(error => console.error('Erro ao buscar estados:', error));

    estadoSelect.addEventListener('change', function() {
      const uf = this.value;
      cidadeSelect.innerHTML = '<option value="">Todas as Cidades</option>';
      if (uf) {
        fetch('https://servicodados.ibge.gov.br/api/v1/localidades/estados/' + uf + '/municipios')
          .then(response => response.json())
          .then(data => {
            data.sort((a, b) => a.nome.localeCompare(b.nome));
            data.forEach(cidade => {
              const option = document.createElement('option');
              option.value = cidade.nome;
              option.text = cidade.nome;
              if (cidade.nome === cidadeFilter) {
                option.selected = true;
              }
              cidadeSelect.add(option);
            });
          })
          .catch(error => console.error('Erro ao buscar cidades:', error));
      }
    });
  });
</script>

<style>
  .stat-card {
    border: none;
    border-radius: 1rem;
    transition: transform 0.3s ease;
  }

  .stat-card:hover {
    transform: translateY(-5px);
  }

  .bg-primary-gradient {
    background: linear-gradient(135deg, #0094c3 0%, #4cd175 100%);
  }

  .bg-info-gradient {
    background: linear-gradient(135deg, #00b4d8 0%, #48cae4 100%);
  }

  .bg-warning-gradient {
    background: linear-gradient(135deg, #ffd60a 0%, #ffc300 100%);
  }

  .bg-danger-gradient {
    background: linear-gradient(135deg, #d00000 0%, #dc2f02 100%);
  }

  .nav-tabs .nav-link {
    font-weight: 500;
    border: none;
    color: #6c757d;
    padding: 1rem 2rem;
  }

  .nav-tabs .nav-link.active {
    color: #0094c3;
    border-bottom: 3px solid #0094c3;
    background: transparent;
  }

  .table-hover tbody tr:hover {
    background-color: rgba(0, 148, 195, 0.05);
  }
</style>


<script>
  // Aguarda o carregamento da página
  document.addEventListener("DOMContentLoaded", function () {
    // Seleciona todos os alertas flash
    let alerts = document.querySelectorAll(".alert");

    alerts.forEach(function (alert) {
      // Define um tempo (5000ms = 5 segundos) para remover o alerta
      setTimeout(function () {
        alert.classList.add("fade");
        setTimeout(() => alert.remove(), 500); // Remove o alerta após a transição
      }, 5000);
    });
  });
</script>

<script>
  var modalEditarParticipante = document.getElementById('modalEditarParticipante');
  modalEditarParticipante.addEventListener('show.bs.modal', function (event) {
    // Botão que acionou
    var button = event.relatedTarget;

    // Extrai dados do data-*
    var id = button.getAttribute('data-id');
    var nome = button.getAttribute('data-nome');
    var cpf = button.getAttribute('data-cpf');
    var email = button.getAttribute('data-email');
    var formacao = button.getAttribute('data-formacao');

    // Preenche os campos
    modalEditarParticipante.querySelector('#nome').value = nome;
    modalEditarParticipante.querySelector('#cpf').value = cpf;
    modalEditarParticipante.querySelector('#email').value = email;
    modalEditarParticipante.querySelector('#formacao').value = formacao;
    // Senha é opcional, deixamos em branco

    // Ajusta action do form
    var form = modalEditarParticipante.querySelector('#formEditarParticipante');
    var baseUrl = "{{ url_for('routes.editar_participante_admin', participante_id=0) }}";
    form.action = baseUrl.replace('0', id);
  });

  var modalExcluirCliente = document.getElementById('modalExcluirCliente');
  modalExcluirCliente.addEventListener('show.bs.modal', function (event) {
    var button = event.relatedTarget;
    var clienteId = button.getAttribute('data-id');
    
    // Atualiza o action do formulário com o cliente_id correto
    var form = document.getElementById('formExcluirCliente');
    var baseUrl = "{{ url_for('routes.excluir_cliente', cliente_id=0) }}";
    form.action = baseUrl.replace('0', clienteId);
    
    // Preenche o campo hidden (opcional, mas mantemos para consistência)
    modalExcluirCliente.querySelector('#excluirClienteId').value = clienteId;
  });
</script>


<script>
  function copiarMensagem() {
    let texto = document.getElementById("textoRelatorio").value;
    navigator.clipboard.writeText(texto).then(() => {
      alert("Mensagem copiada com sucesso!");
    }).catch(err => {
      alert("Falha ao copiar: " + err);
    });
  }
  
</script>

{% block scripts_extra %}
<script>
  function enviarWhatsAppRelatorio() {
    // Obtém o texto do relatório
    let mensagem = document.getElementById("textoRelatorio").value;
    // Cria a URL do WhatsApp com o texto codificado
    let url = "https://api.whatsapp.com/send?text=" + encodeURIComponent(mensagem);
    // Abre a URL em uma nova aba
    window.open(url, "_blank");
  }
</script>
{% endblock %}




{% endblock %}
