<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Modal de Mapeamento</title>
    <meta name="csrf-token" content="test-token">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h3>Debug Modal de Mapeamento de Colunas</h3>
        
        <!-- Formulário de teste -->
        <form id="formImportarTrabalhos" data-context="submission-control">
            <div class="input-group mb-3">
                <input class="form-control" type="file" name="arquivo" accept=".xls,.xlsx">
                <button class="btn btn-primary" type="submit">Importar (Debug)</button>
            </div>
        </form>
        
        <!-- Input hidden para evento_id -->
        <input type="hidden" name="evento_id" value="123">
        <input type="hidden" name="csrf_token" value="test-token">
        
        <!-- Container para o modal -->
        <div id="mapearColunasModal"></div>
        
        <!-- Template do modal -->
        <script type="text/template" id="mapearColunasTemplate">
            <div class="modal fade" id="mapearColunasModalInner" tabindex="-1" aria-labelledby="mapearColunasLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="mapearColunasLabel">Mapear colunas da planilha</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                        </div>
                        <div class="modal-body">
                            <form id="formMapearColunas">
                                <div id="mapearCampos"></div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="button" class="btn btn-success" id="confirmarMapeamento">Importar</button>
                        </div>
                    </div>
                </div>
            </div>
        </script>
        
        <!-- Log de debug -->
        <div class="mt-4">
            <h5>Log de Debug:</h5>
            <div id="debugLog" class="border p-3" style="height: 300px; overflow-y: auto; background-color: #f8f9fa;"></div>
        </div>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Script de debug -->
    <script>
        function log(message) {
            const debugLog = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            debugLog.innerHTML += `[${timestamp}] ${message}<br>`;
            debugLog.scrollTop = debugLog.scrollHeight;
            console.log(message);
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            log('DOM carregado');
            
            // Verificar se Bootstrap está carregado
            if (typeof bootstrap !== 'undefined') {
                log('Bootstrap carregado com sucesso');
            } else {
                log('ERRO: Bootstrap não foi carregado!');
            }
            
            const formImportarTrabalhos = document.getElementById('formImportarTrabalhos');
            log('Formulário encontrado: ' + (formImportarTrabalhos ? 'SIM' : 'NÃO'));
            
            if (formImportarTrabalhos && formImportarTrabalhos.dataset.context === 'submission-control') {
                log('Context correto: submission-control');
                
                formImportarTrabalhos.addEventListener('submit', function(e) {
                    e.preventDefault();
                    log('Submit interceptado');
                    
                    // Simular resposta do servidor com dados de teste
                    const mockData = {
                        success: true,
                        temp_id: 'test-123',
                        columns: ['Título', 'Categoria', 'Autor', 'Email'],
                        preview: [
                            ['Trabalho 1', 'Categoria A', 'João', 'joao@email.com'],
                            ['Trabalho 2', 'Categoria B', 'Maria', 'maria@email.com']
                        ]
                    };
                    
                    log('Simulando resposta do servidor...');
                    mostrarModalMapeamento(mockData.temp_id, mockData.columns, mockData.preview, '123');
                });
            }
            
            function mostrarModalMapeamento(tempId, columns, preview, eventoId) {
                log('Iniciando mostrarModalMapeamento');
                log('tempId: ' + tempId);
                log('columns: ' + JSON.stringify(columns));
                log('eventoId: ' + eventoId);
                
                // Verificar se o template existe
                const template = document.getElementById('mapearColunasTemplate');
                if (!template) {
                    log('ERRO: Template mapearColunasTemplate não encontrado!');
                    return;
                }
                log('Template encontrado');
                
                // Verificar se o container existe
                const modalContainer = document.getElementById('mapearColunasModal');
                if (!modalContainer) {
                    log('ERRO: Container mapearColunasModal não encontrado!');
                    return;
                }
                log('Container encontrado');
                
                // Inserir o template no container
                modalContainer.innerHTML = template.innerHTML;
                log('Template inserido no container');
                
                // Verificar se o modal foi criado
                const modalElement = document.getElementById('mapearColunasModalInner');
                if (!modalElement) {
                    log('ERRO: Modal mapearColunasModalInner não foi criado!');
                    return;
                }
                log('Modal element encontrado');
                
                // Criar instância do modal Bootstrap
                try {
                    const modal = new bootstrap.Modal(modalElement);
                    log('Instância do modal Bootstrap criada');
                    
                    // Preencher campos de mapeamento
                    const mapearCampos = document.getElementById('mapearCampos');
                    if (!mapearCampos) {
                        log('ERRO: mapearCampos não encontrado!');
                        return;
                    }
                    
                    const campos = [
                        { id: 'titulo', label: 'Título do trabalho', required: true },
                        { id: 'categoria', label: 'Categoria', required: false },
                        { id: 'rede_ensino', label: 'Rede de ensino', required: false },
                        { id: 'etapa_ensino', label: 'Etapa de ensino', required: false },
                        { id: 'pdf_url', label: 'URL do PDF', required: false }
                    ];
                    
                    mapearCampos.innerHTML = '';
                    campos.forEach(campo => {
                        const div = document.createElement('div');
                        div.className = 'mb-3';
                        
                        const label = document.createElement('label');
                        label.className = 'form-label';
                        label.textContent = campo.label + (campo.required ? ' *' : '');
                        
                        const select = document.createElement('select');
                        select.className = 'form-select';
                        select.name = campo.id;
                        
                        // Opção vazia
                        const emptyOption = document.createElement('option');
                        emptyOption.value = '';
                        emptyOption.textContent = 'Selecione uma coluna';
                        select.appendChild(emptyOption);
                        
                        // Adicionar colunas disponíveis
                        columns.forEach(column => {
                            const option = document.createElement('option');
                            option.value = column;
                            option.textContent = column;
                            select.appendChild(option);
                        });
                        
                        div.appendChild(label);
                        div.appendChild(select);
                        mapearCampos.appendChild(div);
                    });
                    
                    log('Campos de mapeamento preenchidos');
                    
                    // Configurar botão de confirmação
                    const confirmarBtn = document.getElementById('confirmarMapeamento');
                    if (confirmarBtn) {
                        confirmarBtn.onclick = function() {
                            log('Botão confirmar clicado');
                            modal.hide();
                            alert('Teste concluído! Modal funcionando corretamente.');
                        };
                        log('Botão confirmar configurado');
                    } else {
                        log('ERRO: Botão confirmarMapeamento não encontrado!');
                    }
                    
                    // Mostrar o modal
                    modal.show();
                    log('Modal exibido com sucesso!');
                    
                } catch (error) {
                    log('ERRO ao criar modal Bootstrap: ' + error.message);
                }
            }
        });
    </script>
</body>
</html>