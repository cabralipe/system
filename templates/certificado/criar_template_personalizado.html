{% extends 'base.html' %}
{% block title %}Criar Template Personalizado{% endblock %}

{% block extra_css %}
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<style>
  .editor-container {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 8px;
  }
  
  .ql-editor {
    min-height: 300px;
    font-family: 'Times New Roman', serif;
    font-size: 14px;
    line-height: 1.6;
  }
  
  .variable-selector {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    max-height: 400px;
    overflow-y: auto;
  }
  
  .variable-item {
    padding: 0.75rem;
    border-bottom: 1px solid #e9ecef;
    cursor: pointer;
    transition: background-color 0.2s;
  }
  
  .variable-item:hover {
    background-color: #e3f2fd;
  }
  
  .variable-item.selected {
    background-color: #bbdefb;
    border-left: 4px solid #1976d2;
  }
  
  .variable-item:last-child {
    border-bottom: none;
  }
  
  .variable-placeholder {
    background: #e3f2fd;
    color: #1976d2;
    border: 1px solid #bbdefb;
    border-radius: 4px;
    padding: 0.25rem 0.5rem;
    font-family: 'Courier New', monospace;
    font-size: 0.875rem;
    cursor: pointer;
  }
  
  .variable-type-badge {
    font-size: 0.7rem;
    padding: 0.2rem 0.4rem;
  }
  
  .layout-option {
    border: 2px solid #dee2e6;
    border-radius: 8px;
    padding: 1rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
  }
  
  .layout-option:hover {
    border-color: #007bff;
    background-color: #f8f9fa;
  }
  
  .layout-option.selected {
    border-color: #007bff;
    background-color: #e3f2fd;
  }
  
  .layout-preview {
    width: 60px;
    height: 40px;
    background: #dee2e6;
    border-radius: 4px;
    margin: 0 auto 0.5rem;
    position: relative;
  }
  
  .layout-preview.landscape {
    width: 60px;
    height: 40px;
  }
  
  .layout-preview.portrait {
    width: 40px;
    height: 60px;
  }
  
  .layout-preview::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 80%;
    height: 60%;
    background: white;
    border-radius: 2px;
  }
  
  .step-indicator {
    display: flex;
    justify-content: center;
    margin-bottom: 2rem;
  }
  
  .step {
    display: flex;
    align-items: center;
    padding: 0.5rem 1rem;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    color: #6c757d;
  }
  
  .step.active {
    background: #007bff;
    color: white;
    border-color: #007bff;
  }
  
  .step.completed {
    background: #28a745;
    color: white;
    border-color: #28a745;
  }
  
  .step:first-child {
    border-radius: 8px 0 0 8px;
  }
  
  .step:last-child {
    border-radius: 0 8px 8px 0;
  }
  
  .step:not(:last-child) {
    border-right: none;
  }
  
  .preview-area {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 2rem;
    min-height: 400px;
    font-family: 'Times New Roman', serif;
    line-height: 1.6;
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="fw-bold text-success mb-1">
        <i class="bi bi-plus-circle me-2"></i>Criar Template Personalizado
      </h2>
      <p class="text-muted mb-0">Crie um template com variáveis dinâmicas para certificados personalizados</p>
    </div>
    <a href="{{ url_for('certificado_routes.templates_personalizaveis') }}" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left me-2"></i>Voltar
    </a>
  </div>

  <!-- Indicador de Passos -->
  <div class="step-indicator">
    <div class="step active" id="step1">
      <i class="bi bi-1-circle me-2"></i>Informações Básicas
    </div>
    <div class="step" id="step2">
      <i class="bi bi-2-circle me-2"></i>Conteúdo
    </div>
    <div class="step" id="step3">
      <i class="bi bi-3-circle me-2"></i>Variáveis
    </div>
    <div class="step" id="step4">
      <i class="bi bi-4-circle me-2"></i>Layout
    </div>
    <div class="step" id="step5">
      <i class="bi bi-5-circle me-2"></i>Preview
    </div>
  </div>

  <form id="formTemplate">
    <!-- Passo 1: Informações Básicas -->
    <div class="step-content" id="content-step1">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Informações Básicas</h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-8">
              <div class="form-floating">
                <input type="text" class="form-control" id="titulo" name="titulo" required>
                <label for="titulo">Título do Template</label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-floating">
                <select class="form-select" id="categoria" name="categoria">
                  <option value="certificado">Certificado</option>
                  <option value="declaracao">Declaração</option>
                  <option value="diploma">Diploma</option>
                  <option value="outro">Outro</option>
                </select>
                <label for="categoria">Categoria</label>
              </div>
            </div>
            <div class="col-12">
              <div class="form-floating">
                <textarea class="form-control" id="descricao" name="descricao" style="height: 100px"></textarea>
                <label for="descricao">Descrição (opcional)</label>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Passo 2: Conteúdo -->
    <div class="step-content d-none" id="content-step2">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="bi bi-file-text me-2"></i>Conteúdo do Template</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-8">
              <label class="form-label fw-bold">Editor de Conteúdo</label>
              <div class="editor-container">
                <div id="editor"></div>
              </div>
              <input type="hidden" id="conteudo" name="conteudo">
            </div>
            <div class="col-md-4">
              <label class="form-label fw-bold">Variáveis Disponíveis</label>
              <div class="variable-selector">
                {% if variaveis %}
                  {% for variavel in variaveis %}
                  <div class="variable-item" data-variavel="{{ variavel.nome }}">
                    <div class="d-flex justify-content-between align-items-start">
                      <div>
                        <div class="variable-placeholder">{{'{'}}{{ variavel.nome }}{{'}'}}}</div>
                        <small class="text-muted d-block mt-1">{{ variavel.descricao or 'Sem descrição' }}</small>
                      </div>
                      <span class="badge variable-type-badge bg-{{ 'primary' if variavel.tipo == 'texto' else 'success' if variavel.tipo == 'data' else 'warning' if variavel.tipo == 'numero' else 'info' }}">
                        {{ variavel.tipo.title() }}
                      </span>
                    </div>
                  </div>
                  {% endfor %}
                {% else %}
                <div class="text-center p-3 text-muted">
                  <i class="bi bi-info-circle mb-2 d-block"></i>
                  <small>Nenhuma variável disponível</small>
                  <br>
                  <a href="{{ url_for('certificado_routes.variaveis_dinamicas') }}" class="btn btn-sm btn-outline-primary mt-2">
                    Criar Variáveis
                  </a>
                </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Passo 3: Seleção de Variáveis -->
    <div class="step-content d-none" id="content-step3">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="bi bi-braces me-2"></i>Variáveis do Template</h5>
        </div>
        <div class="card-body">
          <p class="text-muted mb-4">Selecione as variáveis que serão utilizadas neste template:</p>
          
          <div class="row">
            {% if variaveis %}
              {% for variavel in variaveis %}
              <div class="col-md-6 col-lg-4 mb-3">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="var_{{ variavel.id }}" 
                         name="variaveis_selecionadas" value="{{ variavel.id }}">
                  <label class="form-check-label" for="var_{{ variavel.id }}">
                    <div class="d-flex align-items-center">
                      <span class="variable-placeholder me-2">{{'{'}}{{ variavel.nome }}{{'}'}}}</span>
                      <span class="badge variable-type-badge bg-{{ 'primary' if variavel.tipo == 'texto' else 'success' if variavel.tipo == 'data' else 'warning' if variavel.tipo == 'numero' else 'info' }}">
                        {{ variavel.tipo.title() }}
                      </span>
                    </div>
                    <small class="text-muted d-block">{{ variavel.descricao or 'Sem descrição' }}</small>
                  </label>
                </div>
              </div>
              {% endfor %}
            {% else %}
            <div class="col-12 text-center">
              <div class="alert alert-info">
                <i class="bi bi-info-circle me-2"></i>
                Nenhuma variável disponível. 
                <a href="{{ url_for('certificado_routes.variaveis_dinamicas') }}" class="alert-link">Criar variáveis</a>
              </div>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- Passo 4: Configurações de Layout -->
    <div class="step-content d-none" id="content-step4">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="bi bi-layout-text-window me-2"></i>Configurações de Layout</h5>
        </div>
        <div class="card-body">
          <div class="row g-4">
            <!-- Orientação -->
            <div class="col-md-6">
              <label class="form-label fw-bold">Orientação da Página</label>
              <div class="row g-2">
                <div class="col-6">
                  <div class="layout-option" data-orientacao="landscape">
                    <div class="layout-preview landscape"></div>
                    <small>Paisagem</small>
                  </div>
                  <input type="radio" name="orientacao" value="landscape" class="d-none" checked>
                </div>
                <div class="col-6">
                  <div class="layout-option" data-orientacao="portrait">
                    <div class="layout-preview portrait"></div>
                    <small>Retrato</small>
                  </div>
                  <input type="radio" name="orientacao" value="portrait" class="d-none">
                </div>
              </div>
            </div>
            
            <!-- Tamanho da Página -->
            <div class="col-md-6">
              <div class="form-floating">
                <select class="form-select" id="tamanho_pagina" name="tamanho_pagina">
                  <option value="A4" selected>A4 (210 x 297 mm)</option>
                  <option value="A3">A3 (297 x 420 mm)</option>
                  <option value="A5">A5 (148 x 210 mm)</option>
                  <option value="Letter">Letter (216 x 279 mm)</option>
                  <option value="Legal">Legal (216 x 356 mm)</option>
                </select>
                <label for="tamanho_pagina">Tamanho da Página</label>
              </div>
            </div>
            
            <!-- Margens -->
            <div class="col-12">
              <label class="form-label fw-bold">Margens (em mm)</label>
              <div class="row g-2">
                <div class="col-3">
                  <div class="form-floating">
                    <input type="number" class="form-control" id="margem_top" name="margem_top" value="20" min="0" max="50">
                    <label for="margem_top">Superior</label>
                  </div>
                </div>
                <div class="col-3">
                  <div class="form-floating">
                    <input type="number" class="form-control" id="margem_right" name="margem_right" value="20" min="0" max="50">
                    <label for="margem_right">Direita</label>
                  </div>
                </div>
                <div class="col-3">
                  <div class="form-floating">
                    <input type="number" class="form-control" id="margem_bottom" name="margem_bottom" value="20" min="0" max="50">
                    <label for="margem_bottom">Inferior</label>
                  </div>
                </div>
                <div class="col-3">
                  <div class="form-floating">
                    <input type="number" class="form-control" id="margem_left" name="margem_left" value="20" min="0" max="50">
                    <label for="margem_left">Esquerda</label>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Passo 5: Preview -->
    <div class="step-content d-none" id="content-step5">
      <div class="card shadow-sm">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0"><i class="bi bi-eye me-2"></i>Preview do Template</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-8">
              <div class="preview-area" id="previewArea">
                <!-- Preview será gerado aqui -->
              </div>
            </div>
            <div class="col-md-4">
              <div class="card">
                <div class="card-header">
                  <h6 class="mb-0">Resumo do Template</h6>
                </div>
                <div class="card-body">
                  <div id="resumoTemplate">
                    <!-- Resumo será gerado aqui -->
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Botões de Navegação -->
    <div class="d-flex justify-content-between mt-4">
      <button type="button" class="btn btn-outline-secondary" id="btnAnterior" disabled>
        <i class="bi bi-arrow-left me-2"></i>Anterior
      </button>
      
      <div>
        <button type="button" class="btn btn-outline-primary me-2" id="btnSalvarRascunho">
          <i class="bi bi-save me-2"></i>Salvar Rascunho
        </button>
        <button type="button" class="btn btn-primary" id="btnProximo">
          Próximo<i class="bi bi-arrow-right ms-2"></i>
        </button>
        <button type="submit" class="btn btn-success d-none" id="btnFinalizar">
          <i class="bi bi-check-circle me-2"></i>Criar Template
        </button>
      </div>
    </div>
  </form>
</div>
{% endblock %}

{% block scripts_extra %}
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<script>
// Variáveis globais
let currentStep = 1;
let totalSteps = 5;
let quill;
let variaveis = {{ variaveis | tojson | safe }};

// Inicialização
$(document).ready(function() {
  initializeEditor();
  setupEventListeners();
  updateStepIndicator();
});

function initializeEditor() {
  quill = new Quill('#editor', {
    theme: 'snow',
    modules: {
      toolbar: [
        [{ 'header': [1, 2, 3, false] }],
        ['bold', 'italic', 'underline'],
        [{ 'align': [] }],
        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
        ['link'],
        ['clean']
      ]
    },
    placeholder: 'Digite o conteúdo do seu template aqui...'
  });
  
  // Atualizar campo hidden quando o conteúdo mudar
  quill.on('text-change', function() {
    $('#conteudo').val(quill.root.innerHTML);
    updatePreview();
  });
}

function setupEventListeners() {
  // Navegação entre passos
  $('#btnProximo').on('click', nextStep);
  $('#btnAnterior').on('click', prevStep);
  $('#btnFinalizar').on('click', function(e) {
    e.preventDefault();
    submitForm();
  });
  
  // Inserir variáveis no editor
  $('.variable-item').on('click', function() {
    const variavel = $(this).data('variavel');
    const range = quill.getSelection();
    if (range) {
      quill.insertText(range.index, `{${variavel}}`);
    } else {
      quill.insertText(quill.getLength(), `{${variavel}}`);
    }
  });
  
  // Seleção de layout
  $('.layout-option').on('click', function() {
    const orientacao = $(this).data('orientacao');
    $('.layout-option').removeClass('selected');
    $(this).addClass('selected');
    $(`input[name="orientacao"][value="${orientacao}"]`).prop('checked', true);
    updatePreview();
  });
  
  // Atualizar preview quando campos mudarem
  $('#titulo, #categoria, #tamanho_pagina').on('input change', updatePreview);
  $('#margem_top, #margem_right, #margem_bottom, #margem_left').on('input', updatePreview);
  
  // Seleção de variáveis
  $('input[name="variaveis_selecionadas"]').on('change', updatePreview);
  
  // Inicializar layout padrão
  $('.layout-option[data-orientacao="landscape"]').addClass('selected');
}

function nextStep() {
  if (validateCurrentStep()) {
    if (currentStep < totalSteps) {
      currentStep++;
      showStep(currentStep);
      updateStepIndicator();
      updateNavigationButtons();
      
      if (currentStep === 5) {
        generatePreview();
      }
    }
  }
}

function prevStep() {
  if (currentStep > 1) {
    currentStep--;
    showStep(currentStep);
    updateStepIndicator();
    updateNavigationButtons();
  }
}

function showStep(step) {
  $('.step-content').addClass('d-none');
  $(`#content-step${step}`).removeClass('d-none');
}

function updateStepIndicator() {
  $('.step').removeClass('active completed');
  
  for (let i = 1; i <= totalSteps; i++) {
    if (i < currentStep) {
      $(`#step${i}`).addClass('completed');
    } else if (i === currentStep) {
      $(`#step${i}`).addClass('active');
    }
  }
}

function updateNavigationButtons() {
  $('#btnAnterior').prop('disabled', currentStep === 1);
  
  if (currentStep === totalSteps) {
    $('#btnProximo').addClass('d-none');
    $('#btnFinalizar').removeClass('d-none');
  } else {
    $('#btnProximo').removeClass('d-none');
    $('#btnFinalizar').addClass('d-none');
  }
}

function validateCurrentStep() {
  switch (currentStep) {
    case 1:
      if (!$('#titulo').val().trim()) {
        showToast('Por favor, informe o título do template', 'error');
        $('#titulo').focus();
        return false;
      }
      break;
    case 2:
      if (!quill.getText().trim()) {
        showToast('Por favor, adicione conteúdo ao template', 'error');
        quill.focus();
        return false;
      }
      break;
  }
  return true;
}

function updatePreview() {
  if (currentStep === 5) {
    generatePreview();
  }
}

function generatePreview() {
  const titulo = $('#titulo').val();
  const conteudo = quill.root.innerHTML;
  const orientacao = $('input[name="orientacao"]:checked').val();
  const tamanho = $('#tamanho_pagina').val();
  
  // Atualizar preview
  $('#previewArea').html(conteudo);
  
  // Gerar resumo
  const variaveisSelecionadas = $('input[name="variaveis_selecionadas"]:checked').length;
  const resumo = `
    <div class="mb-2">
      <strong>Título:</strong><br>
      <small class="text-muted">${titulo}</small>
    </div>
    <div class="mb-2">
      <strong>Orientação:</strong><br>
      <small class="text-muted">${orientacao === 'landscape' ? 'Paisagem' : 'Retrato'}</small>
    </div>
    <div class="mb-2">
      <strong>Tamanho:</strong><br>
      <small class="text-muted">${tamanho}</small>
    </div>
    <div class="mb-2">
      <strong>Variáveis:</strong><br>
      <small class="text-muted">${variaveisSelecionadas} selecionadas</small>
    </div>
    <div class="mb-2">
      <strong>Margens:</strong><br>
      <small class="text-muted">
        ${$('#margem_top').val()}mm (superior)<br>
        ${$('#margem_right').val()}mm (direita)<br>
        ${$('#margem_bottom').val()}mm (inferior)<br>
        ${$('#margem_left').val()}mm (esquerda)
      </small>
    </div>
  `;
  
  $('#resumoTemplate').html(resumo);
}

function submitForm() {
  if (!validateCurrentStep()) return;
  
  const formData = {
    titulo: $('#titulo').val(),
    categoria: $('#categoria').val(),
    descricao: $('#descricao').val(),
    conteudo: quill.root.innerHTML,
    variaveis_selecionadas: $('input[name="variaveis_selecionadas"]:checked').map(function() {
      return parseInt(this.value);
    }).get(),
    orientacao: $('input[name="orientacao"]:checked').val(),
    tamanho_pagina: $('#tamanho_pagina').val(),
    margem_config: {
      top: parseInt($('#margem_top').val()),
      right: parseInt($('#margem_right').val()),
      bottom: parseInt($('#margem_bottom').val()),
      left: parseInt($('#margem_left').val())
    }
  };
  
  $.ajax({
    url: '{{ url_for("certificado_routes.criar_template_personalizado") }}',
    method: 'POST',
    contentType: 'application/json',
    data: JSON.stringify(formData),
    success: function(response) {
      if (response.success) {
        showToast('Template criado com sucesso!', 'success');
        setTimeout(() => {
          window.location.href = '{{ url_for("certificado_routes.templates_personalizaveis") }}';
        }, 1500);
      } else {
        showToast(response.message, 'error');
      }
    },
    error: function() {
      showToast('Erro ao criar template', 'error');
    }
  });
}

function showToast(message, type = 'info') {
  const bgClass = type === 'success' ? 'bg-success' : type === 'error' ? 'bg-danger' : 'bg-info';
  const toast = `
    <div class="toast align-items-center text-white ${bgClass} border-0" role="alert">
      <div class="d-flex">
        <div class="toast-body">${message}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  `;
  
  if (!$('#toastContainer').length) {
    $('body').append('<div id="toastContainer" class="toast-container position-fixed top-0 end-0 p-3"></div>');
  }
  
  const $toast = $(toast);
  $('#toastContainer').append($toast);
  new bootstrap.Toast($toast[0]).show();
}
</script>
{% endblock %}