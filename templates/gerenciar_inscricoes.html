{% extends "base.html" %}
{% block title %}Gerenciar Inscri√ß√µes{% endblock %}

{% block content %}
<div class="container mt-5">
  <h2 class="text-center mb-4">Gerenciar Inscri√ß√µes</h2>
  <br>
  <div>
    <div class="row mb-4">
      <!-- Filtro de Participante -->
      <div class="col-md-4 mb-3">
        <label for="filtroParticipante" class="form-label">Filtrar por Participante:</label>
        <input type="text" class="form-control" id="filtroParticipante" placeholder="Digite o nome do participante">
      </div>
      <!-- Filtro de Oficinas -->
      <div class="col-md-4 mb-3">
        <label for="filtroOficina" class="form-label">Filtrar por Oficina:</label>
        <select class="form-select" id="filtroOficina">
          <option value="">Todas as Oficinas</option>
          {% for oficina in oficinas %}
          <option value="{{ oficina.id }}">{{ oficina.titulo }}</option>
          {% endfor %}
        </select>
      </div>
      <!-- A√ß√µes em Lote -->
      <div class="col-md-4 mb-3 d-flex align-items-end">
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#moverInscricoesModal" id="btnMoverInscricoes" disabled>
          <i class="bi bi-arrow-right-circle"></i> Mover Selecionados
        </button>
      </div>
    </div>

    <form id="formGerenciarInscricoes" method="POST">
      <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
          <thead class="table-dark">
            <tr>
              <th>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="selecionarTodos">
                </div>
              </th>
              <th>ID</th>
              <th>Participante</th>
              <th>Oficina</th>
              <th>A√ß√µes</th>
            </tr>
          </thead>
          <tbody id="tabelaInscricoes">
            {% for insc in inscritos %}
            <tr data-oficina-id="{{ insc.oficina.id }}" data-event-id="{{ insc.oficina.evento_id }}" data-participante-nome="{{ insc.usuario.nome | lower }}">
              <td>
                <div class="form-check">
                  <input class="form-check-input selecao-inscricao" type="checkbox" name="inscricao_ids" value="{{ insc.id }}" data-oficina-id="{{ insc.oficina.id }}">
                </div>
              </td>
              <td>{{ insc.id }}</td>
              <td>{{ insc.usuario.nome }}</td>
              <td>{{ insc.oficina.titulo }}</td>
              <td>
                <form action="{{ url_for('routes.cancelar_inscricao', inscricao_id=insc.id) }}" method="POST" style="display:inline;" onsubmit="return confirm('Tem certeza que deseja cancelar esta inscri√ß√£o?')">
                  <button type="submit" class="btn btn-danger btn-sm">
                    <i class="bi bi-x-circle"></i> Cancelar
                  </button>
                </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </form>

  </div>

  <!-- Modal para Mover Inscri√ß√µes -->
  <div class="modal fade" id="moverInscricoesModal" tabindex="-1" aria-labelledby="moverInscricoesModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="moverInscricoesModalLabel">Mover Inscri√ß√µes</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <form id="formMoverInscricoes" action="{{ url_for('routes.mover_inscricoes_lote') }}" method="POST">
            <div class="mb-3">
              <label for="oficina_destino" class="form-label">Selecione a Oficina de Destino:</label>
              <select class="form-select" id="oficina_destino" name="oficina_destino" required>
                <option value="">-- Selecione uma Oficina --</option>
              </select>
            </div>
            <div id="inscricoes_selecionadas_container" class="d-none">
              <!-- Aqui ser√£o inseridos os inputs hidden com os IDs das inscri√ß√µes selecionadas -->
            </div>
            <div class="alert alert-info">
              <span id="num_selecionados">0</span> participante(s) selecionado(s) para transfer√™ncia.
            </div>
            <div id="alerta_vagas" class="alert alert-danger d-none">
              N√£o h√° vagas suficientes na oficina selecionada.
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" form="formMoverInscricoes" class="btn btn-primary" id="btnConfirmarMover" disabled>Confirmar Transfer√™ncia</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    function debugFiltroParticipante() {
      const filtro = document.getElementById('filtroParticipante').value;
      console.log(`üìå [DEBUG] Filtro de Participante digitado: ${filtro}`);
    }
  
    function debugFiltroOficina() {
      const filtro = document.getElementById('filtroOficina').value;
      console.log(`üìå [DEBUG] Oficina selecionada no filtro: ${filtro}`);
    }
  
    function debugCancelarInscricao(inscricaoId) {
      console.log(`‚ùå [DEBUG] Tentando cancelar inscri√ß√£o com ID: ${inscricaoId}`);
    }

    // Fun√ß√£o para atualizar o bot√£o de mover inscri√ß√µes
    function atualizarBotaoMover() {
      const checkboxes = document.querySelectorAll('.selecao-inscricao:checked');
      const btnMover = document.getElementById('btnMoverInscricoes');
      btnMover.disabled = checkboxes.length === 0;
      
      // Atualiza o contador no modal
      document.getElementById('num_selecionados').textContent = checkboxes.length;
    }

    // Fun√ß√£o para verificar disponibilidade de vagas
    function verificarVagas() {
      const oficinaDestino = document.getElementById('oficina_destino');
      const checkboxes = document.querySelectorAll('.selecao-inscricao:checked');
      const btnConfirmar = document.getElementById('btnConfirmarMover');
      const alertaVagas = document.getElementById('alerta_vagas');
      
      if (oficinaDestino.value === '') {
        btnConfirmar.disabled = true;
        alertaVagas.classList.add('d-none');
        return;
      }
      
      const vagasDisponiveis = parseInt(oficinaDestino.options[oficinaDestino.selectedIndex].dataset.vagas);
      const numSelecionados = checkboxes.length;
      
      // Verifica se h√° vagas suficientes
      if (vagasDisponiveis < numSelecionados) {
        btnConfirmar.disabled = true;
        alertaVagas.textContent = `N√£o h√° vagas suficientes. Dispon√≠veis: ${vagasDisponiveis}, Necess√°rias: ${numSelecionados}`;
        alertaVagas.classList.remove('d-none');
      } else {
        btnConfirmar.disabled = false;
        alertaVagas.classList.add('d-none');
      }
    }

    // Fun√ß√£o para preparar o formul√°rio antes do envio
    function prepararFormulario() {
      const checkboxes = document.querySelectorAll('.selecao-inscricao:checked');
      const container = document.getElementById('inscricoes_selecionadas_container');
      
      // Limpa o container
      container.innerHTML = '';
      
      // Adiciona inputs hidden para cada inscri√ß√£o selecionada
      checkboxes.forEach(checkbox => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'inscricao_ids';
        input.value = checkbox.value;
        container.appendChild(input);
      });
    }

    // Event Listeners
    document.addEventListener('DOMContentLoaded', function() {
      // Selecionar/Deselecionar todos
      const selecionarTodos = document.getElementById('selecionarTodos');
      selecionarTodos.addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('.selecao-inscricao');
        checkboxes.forEach(checkbox => {
          checkbox.checked = selecionarTodos.checked;
        });
        atualizarBotaoMover();
      });
      
      // Atualizar bot√£o quando uma inscri√ß√£o √© selecionada/deseleccionada
      document.querySelectorAll('.selecao-inscricao').forEach(checkbox => {
        checkbox.addEventListener('change', atualizarBotaoMover);
      });
      
      // Verificar vagas quando a oficina de destino √© alterada
      document.getElementById('oficina_destino').addEventListener('change', verificarVagas);
      
      // Preparar formul√°rio antes do envio
      document.getElementById('formMoverInscricoes').addEventListener('submit', function(e) {
        prepararFormulario();
      });
      
      // Quando o modal √© aberto
      const moverModal = document.getElementById('moverInscricoesModal');
      moverModal.addEventListener('show.bs.modal', function() {
        // Resetar o select de oficina
        document.getElementById('oficina_destino').value = '';
        // Atualizar contador
        atualizarBotaoMover();
        // Desabilitar bot√£o de confirmar
        document.getElementById('btnConfirmarMover').disabled = true;
        // Esconder alerta de vagas
        document.getElementById('alerta_vagas').classList.add('d-none');
      });
    });

    // Quando o modal √© aberto, buscar oficinas do mesmo evento
    document.getElementById('moverInscricoesModal').addEventListener('show.bs.modal', function () {
      const checkboxes = document.querySelectorAll('.selecao-inscricao:checked');
      if (checkboxes.length === 0) return;

      // Pega o atributo data-event-id da primeira inscri√ß√£o selecionada
      const firstRow = checkboxes[0].closest('tr');
      const oficinaId = firstRow.getAttribute('data-oficina-id');

      // Buscar oficinas do mesmo evento via fetch
      fetch(`/api/oficinas_mesmo_evento/${oficinaId}`)
        .then(response => response.json())
        .then(data => {
          const select = document.getElementById('oficina_destino');
          select.innerHTML = '<option value="">-- Selecione uma Oficina --</option>';
          data.oficinas.forEach(oficina => {
            const option = document.createElement('option');
            option.value = oficina.id;
            option.dataset.vagas = oficina.vagas;
            option.textContent = `${oficina.titulo} (${oficina.vagas} vagas)`;
            select.appendChild(option);
          });
        })
        .catch(error => console.error('Erro ao buscar oficinas:', error));

      // Resetar bot√£o de confirmar e alertas
      document.getElementById('btnConfirmarMover').disabled = true;
      document.getElementById('alerta_vagas').classList.add('d-none');
      atualizarBotaoMover();
    });
  </script>
  
  <!-- Script para filtrar as inscri√ß√µes por participante e oficina -->
  <script>
    document.getElementById('filtroParticipante').addEventListener('input', function() {
      filtrarInscricoes();
    });
  
    document.getElementById('filtroOficina').addEventListener('change', function() {
      filtrarInscricoes();
    });
  
    function filtrarInscricoes() {
      var filtroParticipante = document.getElementById('filtroParticipante').value.toLowerCase();
      var filtroOficina = document.getElementById('filtroOficina').value;
      var rows = document.querySelectorAll('#tabelaInscricoes tr');
  
      rows.forEach(function(row) {
        var participanteNome = row.getAttribute('data-participante-nome');
        var oficinaId = row.getAttribute('data-oficina-id');
  
        var correspondeParticipante = participanteNome.includes(filtroParticipante);
        var correspondeOficina = filtroOficina === "" || oficinaId === filtroOficina;
  
        if (correspondeParticipante && correspondeOficina) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      });
    }
  </script>

{% endblock %}