{% extends 'base.html' %}
{% block title %}Controle de Submissões{% endblock %}
{% block content %}
<div class="container mt-5" id="configSubmissao" 
     data-url-config-cliente-atual="{{ url_for('config_cliente_routes.configuracao_cliente_atual') }}"
     data-min-rev="{{ config.num_revisores_min if config else 1 }}"
     data-max-rev="{{ config.num_revisores_max if config else 2 }}">
  
  <!-- Cabeçalho Principal -->
  <div class="row mb-5">
    <div class="col-12">
      <h2 class="text-center mb-3">Controle de Submissões</h2>
      <p class="text-center text-muted">Gerencie o processo completo de submissões: desde a importação até a atribuição de revisores</p>
    </div>
  </div>

  <!-- Alertas e Mensagens -->
  <div id="alertContainer"></div>

  <!-- Indicador de Progresso -->
  <div class="row mb-5">
    <div class="col-12">
      <div class="progress-steps">
        <div class="step-container">
          <div class="step active" id="step-1" data-step="1">
            <div class="step-number">1</div>
            <div class="step-title">Importar</div>
            <div class="step-description">Upload do arquivo Excel</div>
          </div>
          <div class="step-line"></div>
          <div class="step" id="step-2" data-step="2">
            <div class="step-number">2</div>
            <div class="step-title">Mapear</div>
            <div class="step-description">Configurar colunas</div>
          </div>
          <div class="step-line"></div>
          <div class="step" id="step-3" data-step="3">
            <div class="step-number">3</div>
            <div class="step-title">Visualizar</div>
            <div class="step-description">Revisar dados</div>
          </div>
          <div class="step-line"></div>
          <div class="step" id="step-4" data-step="4">
            <div class="step-number">4</div>
            <div class="step-title">Atribuir</div>
            <div class="step-description">Designar revisores</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ETAPA 1: Importação de Trabalhos -->
  <div class="card mb-5" id="step-import">
    <div class="card-header bg-primary text-white">
      <h4 class="mb-0">
        <i class="fas fa-upload me-2"></i>
        Etapa 1: Importar Trabalhos Submetidos
      </h4>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-8">
          <h5>Instruções para Importação</h5>
          <ul class="list-unstyled">
            <li><i class="fas fa-check text-success me-2"></i>Selecione um arquivo Excel (.xls ou .xlsx)</li>
            <li><i class="fas fa-check text-success me-2"></i>Certifique-se de que o arquivo contém as colunas: Título, Categoria, Rede de Ensino, Etapa de Ensino</li>
            <li><i class="fas fa-check text-success me-2"></i>A primeira linha deve conter os cabeçalhos das colunas</li>
          </ul>
          
          <form id="formImportarTrabalhos"
                class="mt-4"
                method="post"
                enctype="multipart/form-data"
                action="{{ url_for('config_cliente_routes.importar_trabalhos') }}"
                data-context="submission-control">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            
            <div class="mb-3">
              <label for="evento_id" class="form-label fw-bold">
                <i class="fas fa-calendar me-2"></i>Selecionar Evento
              </label>
              <select class="form-select form-select-lg" id="evento_id" name="evento_id" required>
                <option value="">Selecione um evento...</option>
              </select>
              <div class="form-text">
                Os trabalhos serão associados ao evento selecionado
              </div>
            </div>
            
            <div class="mb-3">
              <label for="arquivo" class="form-label fw-bold">
                <i class="fas fa-file-excel me-2"></i>Arquivo Excel
              </label>
              <input type="file" class="form-control form-control-lg" id="arquivo" name="arquivo" 
                     accept=".xlsx,.xls" required disabled>
              <div class="form-text">
                Formatos aceitos: .xlsx, .xls (máximo 10MB). Primeiro selecione um evento.
              </div>
            </div>
            
            <div class="d-flex gap-2">
              <button type="submit" class="btn btn-primary btn-lg">
                <i class="fas fa-upload me-2"></i>Importar Arquivo
              </button>
              <button type="button" class="btn btn-outline-secondary" onclick="downloadTemplate()">
                <i class="fas fa-download me-2"></i>Baixar Modelo
              </button>
            </div>
          </form>
        </div>
        <div class="col-md-4">
          <div class="alert alert-info">
            <h6><i class="fas fa-lightbulb me-2"></i>Dicas:</h6>
            <ul class="mb-0 small">
              <li>Certifique-se de que a primeira linha contém os cabeçalhos</li>
              <li>Evite células mescladas</li>
              <li>Use formatos de data padrão</li>
              <li>Mantenha URLs completas para PDFs</li>
            </ul>
          </div>
          
          <!-- Progresso do upload -->
          <div id="uploadProgress" class="mt-3" style="display: none;">
            <div class="progress">
              <div class="progress-bar progress-bar-striped progress-bar-animated" 
                   role="progressbar" style="width: 0%"></div>
            </div>
            <small class="text-muted mt-1 d-block">Processando arquivo...</small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ETAPA 2: Mapeamento de Colunas -->
  <div class="card mb-5" id="step-mapping" style="display: none;">
    <div class="card-header bg-info text-white">
      <h4 class="mb-0">
        <i class="fas fa-columns me-2"></i>
        Etapa 2: Mapear Colunas do Arquivo
      </h4>
    </div>
    <div class="card-body">
      <div class="alert alert-info">
        <h6><i class="fas fa-info-circle me-2"></i>Instruções de Mapeamento</h6>
        <p class="mb-0">Configure como as colunas do seu arquivo Excel devem ser interpretadas pelo sistema. Esta etapa aparecerá automaticamente após o upload do arquivo.</p>
      </div>
      
      <div class="row">
        <div class="col-md-6">
          <h6>Colunas Detectadas no Arquivo:</h6>
          <div id="detected-columns" class="list-group">
            <!-- Será preenchido dinamicamente pelo JavaScript -->
          </div>
        </div>
        <div class="col-md-6">
          <h6>Campos do Sistema:</h6>
          <div class="list-group">
            <div class="list-group-item">
              <strong>Título:</strong> Nome/título do trabalho submetido
            </div>
            <div class="list-group-item">
              <strong>Categoria:</strong> Categoria ou tipo do trabalho
            </div>
            <div class="list-group-item">
              <strong>Rede de Ensino:</strong> Rede educacional (pública, privada, etc.)
            </div>
            <div class="list-group-item">
              <strong>Etapa de Ensino:</strong> Nível educacional (fundamental, médio, superior, etc.)
            </div>
            <div class="list-group-item">
              <strong>PDF URL:</strong> Link para o arquivo do trabalho (opcional)
            </div>
          </div>
        </div>
      </div>
      
      <!-- Formulário de mapeamento será inserido dinamicamente aqui -->
      <div id="mappingFormContainer"></div>
      
      <div class="text-center mt-4">
        <button class="btn btn-secondary me-2" onclick="cancelMapping()">
          <i class="fas fa-times me-2"></i>Cancelar
        </button>
        <button class="btn btn-success" onclick="confirmMapping()">
          <i class="fas fa-check me-2"></i>Confirmar Mapeamento
        </button>
      </div>
    </div>
  </div>

  <!-- ETAPA 3: Visualização dos Dados Importados -->
  <div class="card mb-5" id="step-view">
    <div class="card-header bg-success text-white">
      <h4 class="mb-0">
        <i class="fas fa-table me-2"></i>
        Etapa 3: Trabalhos Importados
      </h4>
    </div>
    <div class="card-body">
      {% if submissions %}
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="mb-0">Total de trabalhos: <span class="badge bg-primary">{{ submissions|length }}</span></h5>
          <div>
            <button id="btnAtualizar" class="btn btn-outline-secondary btn-sm me-2">
              <i class="fas fa-sync me-1"></i>Atualizar
            </button>
            <button class="btn btn-outline-danger btn-sm" id="btnDescartarTodos" data-bs-toggle="modal" data-bs-target="#modalConfirmarDescarte">
              <i class="fas fa-trash me-1"></i>Descartar Todos
            </button>
          </div>
        </div>
        
        <div class="table-responsive">
          <table class="table table-striped table-hover">
            <thead class="table-dark">
              <tr>
                <th>Título</th>
                <th>Categoria</th>
                <th>Rede de Ensino</th>
                <th>Etapa de Ensino</th>
                <th>Status da Revisão</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody>
              {% for submission_tuple in submissions %}
                        {% set sub = submission_tuple[0] %}
                        {% set work_metadata = submission_tuple[1] %}
              <tr>
                <td>
                  <strong>{{ sub.title }}</strong>
                  <br><small class="text-muted">ID: {{ sub.locator }}</small>
                </td>
                <td>
                  <span class="badge bg-info">{{ work_metadata.categoria if work_metadata else 'N/A' }}</span>
                </td>
                <td>{{ work_metadata.rede_ensino if work_metadata else 'N/A' }}</td>
                <td>{{ work_metadata.etapa_ensino if work_metadata else 'N/A' }}</td>
                <td>
                  {% if sub.reviews %}
                    <div class="mb-2">
                      {% for rev in sub.reviews %}
                        <div class="d-flex justify-content-between align-items-center mb-1">
                          <span class="badge bg-success">{{ rev.reviewer.nome if rev.reviewer else 'N/A' }}</span>
                          <small class="text-muted">{{ rev.access_code }}</small>
                        </div>
                      {% endfor %}
                    </div>
                  {% else %}
                    <span class="badge bg-warning">Aguardando atribuição</span>
                  {% endif %}
                </td>
                <td>
                  <button class="btn btn-sm btn-outline-primary gerar-codigos" data-locator="{{ sub.locator }}" title="Gerar códigos de acesso">
                    <i class="fas fa-key"></i>
                  </button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        
        <!-- Botão para avançar para próxima etapa -->
        <div class="text-center mt-4">
          <button class="btn btn-success btn-lg" id="btnAvancarEtapa4" onclick="avancarParaEtapa4()">
            <i class="fas fa-arrow-right me-2"></i>Avançar para Etapa 4 - Atribuir Revisores
          </button>
        </div>
      {% else %}
        <div class="text-center py-5">
          <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
          <h5 class="text-muted">Nenhum trabalho importado</h5>
          <p class="text-muted">Comece importando um arquivo Excel na Etapa 1</p>
        </div>
      {% endif %}
    </div>
  </div>

  <!-- ETAPA 4: Atribuição de Revisores -->
  <div class="card mb-5" id="step-assign">
    <div class="card-header bg-warning text-dark">
      <h4 class="mb-0">
        <i class="fas fa-user-check me-2"></i>
        Etapa 4: Atribuir Revisores
      </h4>
    </div>
    <div class="card-body">
      {% if submissions %}
        <!-- Painel de Controle Principal -->
        <div class="row mb-4">
          <div class="col-12">
            <div class="card border-info">
              <div class="card-header bg-info text-white">
                <h6 class="mb-0">
                  <i class="fas fa-tachometer-alt me-2"></i>Painel de Controle
                </h6>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-2">
                    <div class="text-center">
                      <div class="h4 text-primary mb-1">{{ submissions|length }}</div>
                      <small class="text-muted">Total de Trabalhos</small>
                    </div>
                  </div>
                  <div class="col-md-2">
                    <div class="text-center">
                      <div class="h4 text-success mb-1">{{ reviewers|length }}</div>
                      <small class="text-muted">Revisores Disponíveis</small>
                    </div>
                  </div>
                  <div class="col-md-2">
                    <div class="text-center">
                      <div class="h4 text-warning mb-1">{{ config.num_revisores_min if config else 1 }}-{{ config.num_revisores_max if config else 2 }}</div>
                      <small class="text-muted">Revisores por Trabalho</small>
                    </div>
                  </div>
                  <div class="col-md-2">
                    <div class="text-center">
                      <div class="h4 text-info mb-1">{{ config.max_trabalhos_por_revisor if config else 5 }}</div>
                      <small class="text-muted">Máx. Trabalhos por Revisor</small>
                    </div>
                  </div>
                  <div class="col-md-2">
                    <div class="text-center">
                      <div class="h4 text-success mb-1" id="completeWorksCount">0</div>
                      <small class="text-muted">Trabalhos Completos</small>
                    </div>
                  </div>
                  <div class="col-md-2">
                    <div class="text-center">
                      <div class="h4 text-danger mb-1" id="totalAssignmentsCount">0</div>
                      <small class="text-muted">Total Atribuições</small>
                    </div>
                  </div>
                </div>
                
                <!-- Barra de Progresso -->
                <div class="row mt-3">
                  <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                      <small class="text-muted">Progresso das Atribuições</small>
                      <small class="text-muted" id="progressText">0% completo</small>
                    </div>
                    <div class="progress" style="height: 8px;">
                      <div class="progress-bar bg-success" role="progressbar" style="width: 0%" id="progressBar"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Seção de Filtros e Seleção -->
        <div class="row mb-4">
          <!-- Filtros de Trabalhos -->
          <div class="col-md-6">
            <div class="card h-100">
              <div class="card-header bg-light">
                <h6 class="mb-0">
                  <i class="fas fa-filter me-2"></i>Filtrar Trabalhos
                </h6>
              </div>
              <div class="card-body">
                <div class="mb-3">
                  <label for="filterWorkCategory" class="form-label">Categoria:</label>
                  <select class="form-select" id="filterWorkCategory">
                    <option value="">Todas as categorias</option>
                    {% set unique_categories = [] %}
                    {% for submission_tuple in submissions %}
                    {% set sub = submission_tuple[0] %}
                    {% set work_metadata = submission_tuple[1] %}
                    {% if work_metadata and work_metadata.categoria and work_metadata.categoria not in unique_categories %}
                    {% set _ = unique_categories.append(work_metadata.categoria) %}
                    <option value="{{ work_metadata.categoria }}">{{ work_metadata.categoria }}</option>
                    {% endif %}
                    {% endfor %}
                  </select>
                </div>
                
                <div class="mb-3">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <label class="form-label mb-0">Trabalhos Selecionados: <span id="selectedWorksCount" class="badge bg-primary">0</span></label>
                    <button type="button" class="btn btn-outline-primary btn-sm" id="selectAllWorks">
                      <i class="fas fa-check-square me-1"></i>Selecionar Todos
                    </button>
                  </div>
                  <div class="border rounded p-2" style="height: 200px; overflow-y: auto;">
                    <div id="worksList">
                      {% for submission_tuple in submissions %}
                      {% set sub = submission_tuple[0] %}
                      {% set work_metadata = submission_tuple[1] %}
                        <div class="form-check work-item" data-category="{{ work_metadata.categoria if work_metadata else 'N/A' }}" data-id="{{ sub.id }}">
                          <input class="form-check-input work-checkbox" type="checkbox" value="{{ sub.id }}" id="work_{{ sub.id }}">
                          <label class="form-check-label" for="work_{{ sub.id }}">
                            <div class="d-flex justify-content-between align-items-start">
                              <div>
                                <strong>{{ sub.title }}</strong>
                                <br><small class="text-muted">{{ work_metadata.categoria if work_metadata else 'N/A' }}</small>
                              </div>
                              <span class="badge bg-secondary" id="reviewers_count_{{ sub.id }}">0/{{ config.num_revisores_max if config else 2 }}</span>
                            </div>
                          </label>
                        </div>
                      {% endfor %}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Lista de Revisores -->
          <div class="col-md-6">
            <div class="card h-100">
              <div class="card-header bg-light">
                <h6 class="mb-0">
                  <i class="fas fa-users me-2"></i>Selecionar Revisores
                </h6>
              </div>
              <div class="card-body">
                <!-- Seletor de Formulário/Processo -->
                <div class="mb-3">
                  <label for="filterProcesso" class="form-label fw-bold">
                    <i class="fas fa-filter me-2"></i>Filtrar por Formulário/Processo
                  </label>
                  <select class="form-select" id="filterProcesso">
                    <option value="">Todos os processos seletivos</option>
                    {% for processo, formulario in processos_seletivos %}
                      <option value="{{ processo.id }}">
                        {{ processo.nome or (formulario.nome if formulario.nome else 'Processo ' + processo.id|string) }}
                        {% if processo.status %}- {{ processo.status }}{% endif %}
                        {% if processo.evento_id %}
                          - {{ processo.evento.nome if processo.evento else 'Evento ' + processo.evento_id|string }}
                        {% endif %}
                      </option>
                    {% endfor %}
                  </select>
                  <div class="form-text">
                    Mostra apenas revisores que responderam ao formulário selecionado
                  </div>
                </div>
                
                <!-- Filtros de Revisores -->
                <div class="row mb-3">
                  <div class="col-md-3">
                    <input type="text" class="form-control form-control-sm" id="filterReviewerName" placeholder="Nome">
                  </div>
                  <div class="col-md-4">
                    <select class="form-select form-select-sm" id="dynamicFieldSelect">
                      <option value="">Selecione um campo para filtrar</option>
                      {% for process_id, fields in form_fields.items() %}
                        {% for field_data in fields %}
                          <option value="{{ field_data.nome }}" data-process-id="{{ process_id }}">{{ field_data.nome }}</option>
                        {% endfor %}
                      {% endfor %}
                    </select>
                  </div>
                  <div class="col-md-5">
                    <select class="form-select form-select-sm" id="dynamicValueSelect" disabled>
                      <option value="">Selecione um campo primeiro</option>
                    </select>
                  </div>
                </div>
                
                <div class="mb-3">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <label class="form-label">Revisores Selecionados: <span id="selectedReviewersCount" class="badge bg-success">0</span></label>
                    <button type="button" class="btn btn-outline-primary btn-sm" id="selectAllReviewers">
                      <i class="fas fa-check-square me-1"></i>Selecionar Todos
                    </button>
                  </div>
                  <div class="border rounded p-2" style="height: 200px; overflow-y: auto;">
                    <div id="reviewersList">
                      {% for r in reviewers %}
                        <div class="form-check reviewer-item" data-id="{{ r.id }}" data-process-id="{{ r.process_id }}" data-formacao="{{ r.formacao|lower if r.formacao else '' }}" data-instituicao="{{ r.instituicao|lower if r.instituicao else '' }}" data-area="{{ r.area_atuacao|lower if r.area_atuacao else '' }}" data-titulacao="{{ r.titulacao|lower if r.titulacao else '' }}" data-reviewer-data='{{ r.respostas|tojson|safe if r.respostas else "{}" }}'>
                          <input class="form-check-input reviewer-checkbox" type="checkbox" value="{{ r.id }}" id="reviewer_{{ r.id }}">
                          <label class="form-check-label" for="reviewer_{{ r.id }}">
                            <div class="d-flex justify-content-between align-items-start">
                              <div>
                                <strong>{{ r.nome if r.nome else 'N/A' }}</strong>
                                {% if r.titulacao %}
                                  <span class="badge bg-primary ms-2">{{ r.titulacao }}</span>
                                {% endif %}
                                <br><small class="text-muted">{{ r.formacao if r.formacao else 'N/A' }}</small>
                                {% if r.instituicao %}
                                  <br><small class="text-info">{{ r.instituicao }}</small>
                                {% endif %}
                                {% if r.area_atuacao %}
                                  <br><small class="text-success"><i class="fas fa-tag me-1"></i>{{ r.area_atuacao }}</small>
                                {% endif %}
                                {% if r.experiencia %}
                                  <br><small class="text-secondary"><i class="fas fa-clock me-1"></i>{{ r.experiencia }}</small>
                                {% endif %}
                              </div>
                              <span class="badge bg-warning" id="works_count_{{ r.id }}">0/{{ config.max_trabalhos_por_revisor if config else 5 }}</span>
                            </div>
                          </label>
                        </div>
                      {% else %}
                        <div class="text-muted text-center p-3">Nenhum revisor aprovado</div>
                      {% endfor %}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Ações de Atribuição -->
        <div class="row mb-4">
          <div class="col-12">
            <div class="card">
              <div class="card-header bg-success text-white">
                <h6 class="mb-0">
                  <i class="fas fa-cogs me-2"></i>Ações de Atribuição
                </h6>
              </div>
              <div class="card-body">
                <div class="row">
                  <!-- Atribuição Manual -->
                  <div class="col-md-4">
                    <div class="text-center mb-3">
                      <h6>Atribuição Manual</h6>
                      <button type="button" class="btn btn-success btn-lg w-100" id="assignManual" disabled>
                        <i class="fas fa-hand-pointer me-2"></i>Atribuir Selecionados
                      </button>
                      <small class="text-muted d-block mt-2">Selecione trabalhos e revisores</small>
                    </div>
                  </div>
                  
                  <!-- Sorteio Inteligente -->
                  <div class="col-md-4">
                    <div class="text-center mb-3">
                      <h6>Sorteio Inteligente</h6>
                      <div class="mb-2">
                        <div class="form-check form-check-inline">
                          <input class="form-check-input" type="checkbox" id="smartByFormacao" checked>
                          <label class="form-check-label" for="smartByFormacao">Formação</label>
                        </div>
                        <div class="form-check form-check-inline">
                          <input class="form-check-input" type="checkbox" id="smartByInstituicao">
                          <label class="form-check-label" for="smartByInstituicao">Instituição</label>
                        </div>
                      </div>
                      <button type="button" class="btn btn-warning btn-lg w-100" id="assignSmart" disabled>
                        <i class="fas fa-magic me-2"></i>Sortear Revisores
                      </button>
                      <small class="text-muted d-block mt-2">Selecione trabalhos primeiro</small>
                    </div>
                  </div>
                  
                  <!-- Ações em Lote -->
                  <div class="col-md-4">
                    <div class="text-center mb-3">
                      <h6>Ações em Lote</h6>
                      <div class="d-grid gap-2">
                        <button type="button" class="btn btn-info" id="assignByCategory">
                  <i class="fas fa-layer-group me-2"></i>Sortear por Categoria
                </button>
                <button type="button" class="btn btn-success" id="smartBulkAssign">
                  <i class="fas fa-magic me-2"></i>Atribuição Inteligente em Lote
                </button>
                <button type="button" class="btn btn-outline-danger" id="clearAllAssignments">
                  <i class="fas fa-trash me-2"></i>Limpar Atribuições
                </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Relatório de Atribuições -->
        <div class="row">
          <div class="col-12">
            <div class="card">
              <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                  <i class="fas fa-chart-bar me-2"></i>Relatório de Atribuições
                </h6>
                <button type="button" class="btn btn-outline-light btn-sm" id="exportReport">
                  <i class="fas fa-download me-2"></i>Exportar
                </button>
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-sm table-hover" id="assignmentsTable">
                    <thead class="table-dark">
                      <tr>
                        <th>Trabalho</th>
                        <th>Categoria</th>
                        <th>Revisores Atribuídos</th>
                        <th>Status</th>
                        <th>Ações</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for submission_tuple in submissions %}
                      {% set sub = submission_tuple[0] %}
                      {% set work_metadata = submission_tuple[1] %}
                        <tr id="assignment_row_{{ sub.id }}">
                          <td>
                            <strong>{{ sub.title }}</strong>
                          </td>
                          <td>
                            <span class="badge bg-secondary">{{ work_metadata.categoria if work_metadata else 'N/A' }}</span>
                          </td>
                          <td id="assigned_reviewers_{{ sub.id }}">
                            <span class="text-muted">Nenhum revisor atribuído</span>
                          </td>
                          <td id="assignment_status_{{ sub.id }}">
                            <span class="badge bg-warning">Pendente</span>
                          </td>
                          <td>
                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeAssignment({{ sub.id }})">
                              <i class="fas fa-times"></i>
                            </button>
                          </td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      {% else %}
        <div class="text-center py-5">
          <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
          <h5 class="text-muted">Nenhum trabalho disponível</h5>
          <p class="text-muted">Importe trabalhos primeiro para poder atribuir revisores</p>
          <a href="#step-import" class="btn btn-primary">
            <i class="fas fa-arrow-up me-2"></i>Ir para Importação
          </a>
        </div>
      {% endif %}
    </div>
  </div>

  <!-- Modal de mapeamento de colunas -->
  <div id="mapearColunasModal"></div>

  <!-- Template para o modal de mapeamento -->
  <script type="text/template" id="mapearColunasTemplate">
    {% include 'trabalho/selecionar_colunas_trabalho.html' %}
  </script>

  <!-- Modal de Confirmação para Descartar Todos os Trabalhos -->
  <div class="modal fade" id="modalConfirmarDescarte" tabindex="-1" aria-labelledby="modalConfirmarDescarteLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title" id="modalConfirmarDescarteLabel">
            <i class="fas fa-exclamation-triangle me-2"></i>
            Confirmar Exclusão
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="text-center mb-4">
            <i class="fas fa-trash-alt fa-4x text-danger mb-3"></i>
            <h5 class="text-danger">Atenção: Esta ação não pode ser desfeita!</h5>
          </div>
          <div class="alert alert-warning" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Você está prestes a excluir TODOS os trabalhos importados.</strong>
          </div>
          <p class="mb-3">Esta ação irá:</p>
          <ul class="list-unstyled">
            <li><i class="fas fa-times text-danger me-2"></i>Remover todos os trabalhos submetidos</li>
            <li><i class="fas fa-times text-danger me-2"></i>Excluir todas as atribuições de revisores</li>
            <li><i class="fas fa-times text-danger me-2"></i>Apagar todos os metadados associados</li>
          </ul>
          <div class="form-check mt-4">
            <input class="form-check-input" type="checkbox" id="confirmarExclusao">
            <label class="form-check-label text-danger fw-bold" for="confirmarExclusao">
              Eu entendo que esta ação é irreversível
            </label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times me-2"></i>Cancelar
          </button>
          <button type="button" class="btn btn-danger" id="btnConfirmarDescarte" disabled>
            <i class="fas fa-trash me-2"></i>Sim, Descartar Todos
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/submission_control.css') }}">
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/config_revisao.js') }}"></script>
<script src="{{ url_for('static', filename='js/submission_import.js') }}"></script>
<script>
$(document).ready(function() {
    
    // Event listener para o botão Atualizar
    $('#btnAtualizar').on('click', function() {
        window.location.reload();
    });
    
    // Variáveis globais para controle de estado
    let selectedWorks = new Set();
    let selectedReviewers = new Set();
    let assignmentsData = new Map(); // workId -> [reviewerIds]
    let reviewerWorkCounts = new Map(); // reviewerId -> count
    
    // Configurações dos limites
    const limits = {
      minReviewersPerWork: {{ config.num_revisores_min if config else 1 }},
      maxReviewersPerWork: {{ config.num_revisores_max if config else 2 }},
      maxWorksPerReviewer: {{ config.max_trabalhos_por_revisor if config else 5 }}
    };

    // Inicializar contadores
    function initializeCounts() {
      {% for r in reviewers %}
        reviewerWorkCounts.set('{{ r.id }}', 0);
      {% endfor %}
    }

    // Atualizar contadores visuais
    function updateCounters() {
      // Atualizar contadores de TODOS os trabalhos
      $('.work-item').each(function() {
        const workId = $(this).data('id').toString();
        const assignedReviewers = assignmentsData.get(workId) || [];
        const countElement = $(`#reviewers_count_${workId}`);
        const statusElement = $(`#assignment_status_${workId}`);
        
        // Atualizar contador de revisores
        countElement.text(`${assignedReviewers.length}/${limits.maxReviewersPerWork}`);
        
        // Atualizar cor do badge baseado no status
        if (assignedReviewers.length >= limits.maxReviewersPerWork) {
          countElement.removeClass('bg-secondary bg-warning').addClass('bg-danger');
        } else if (assignedReviewers.length >= limits.minReviewersPerWork) {
          countElement.removeClass('bg-secondary bg-danger').addClass('bg-success');
        } else if (assignedReviewers.length > 0) {
          countElement.removeClass('bg-secondary bg-success bg-danger').addClass('bg-warning');
        } else {
          countElement.removeClass('bg-warning bg-success bg-danger').addClass('bg-secondary');
        }
        
        // Atualizar status visual no relatório
        if (statusElement.length) {
          if (assignedReviewers.length >= limits.minReviewersPerWork) {
            statusElement.html('<span class="badge bg-success">Completo</span>');
          } else if (assignedReviewers.length > 0) {
            statusElement.html('<span class="badge bg-warning">Parcial</span>');
          } else {
            statusElement.html('<span class="badge bg-secondary">Pendente</span>');
          }
        }
        
        // Desabilitar trabalho se atingiu o limite máximo
        const workCheckbox = $(`#work_${workId}`);
        if (assignedReviewers.length >= limits.maxReviewersPerWork) {
          $(this).addClass('border-danger');
        } else {
          $(this).removeClass('border-danger');
        }
      });
      
      // Atualizar contadores de TODOS os revisores
      $('.reviewer-item').each(function() {
        const reviewerId = $(this).data('id').toString();
        const count = reviewerWorkCounts.get(reviewerId) || 0;
        const countElement = $(`#works_count_${reviewerId}`);
        const checkbox = $(`#reviewer_${reviewerId}`);
        
        // Atualizar contador de trabalhos
        countElement.text(`${count}/${limits.maxWorksPerReviewer}`);
        
        // Atualizar cor do badge baseado na carga
        if (count >= limits.maxWorksPerReviewer) {
          countElement.removeClass('bg-warning bg-success').addClass('bg-danger');
          checkbox.prop('disabled', true);
          $(this).addClass('text-muted border-danger');
        } else if (count >= Math.floor(limits.maxWorksPerReviewer * 0.8)) {
          countElement.removeClass('bg-warning bg-danger').addClass('bg-warning');
          checkbox.prop('disabled', false);
          $(this).removeClass('text-muted border-danger').addClass('border-warning');
        } else {
          countElement.removeClass('bg-danger bg-warning').addClass('bg-success');
          checkbox.prop('disabled', false);
          $(this).removeClass('text-muted border-danger border-warning');
        }
      });
      
      // Atualizar estatísticas do painel de controle
      const totalAssignments = Array.from(assignmentsData.values()).reduce((sum, reviewers) => sum + reviewers.length, 0);
      const worksWithReviewers = Array.from(assignmentsData.values()).filter(reviewers => reviewers.length > 0).length;
      const completeWorks = Array.from(assignmentsData.values()).filter(reviewers => reviewers.length >= limits.minReviewersPerWork).length;
      const totalWorks = $('.work-item').length;
      
      // Atualizar contadores no painel
      $('#completeWorksCount').text(completeWorks);
      $('#totalAssignmentsCount').text(totalAssignments);
      
      // Calcular e atualizar progresso
      const progressPercentage = totalWorks > 0 ? Math.round((completeWorks / totalWorks) * 100) : 0;
      $('#progressText').text(`${progressPercentage}% completo`);
      $('#progressBar').css('width', `${progressPercentage}%`);
      
      // Atualizar cor da barra de progresso
      const progressBar = $('#progressBar');
      progressBar.removeClass('bg-success bg-warning bg-danger');
      if (progressPercentage >= 80) {
        progressBar.addClass('bg-success');
      } else if (progressPercentage >= 40) {
        progressBar.addClass('bg-warning');
      } else {
        progressBar.addClass('bg-danger');
      }
      
      // Atualizar relatório de atribuições
      updateAssignmentsReport();
    }

    // Filtro de trabalhos por categoria
    $('#filterWorkCategory').on('change', function() {
      const selectedCategory = $(this).val();
      
      $('.work-item').each(function() {
        const category = $(this).data('category');
        if (!selectedCategory || category === selectedCategory) {
          $(this).show();
        } else {
          $(this).hide();
          // Desmarcar se estiver oculto
          $(this).find('.work-checkbox').prop('checked', false);
        }
      });
      
      updateSelections();
      
      // Atualizar o texto do botão "Selecionar Todos" para revisores
      const $buttonReviewers = $('#selectAllReviewers');
      const $checkboxesReviewers = $('.reviewer-checkbox:visible');
      const checkedCountReviewers = $checkboxesReviewers.filter(':checked').length;
      
      if (checkedCountReviewers === 0) {
        $buttonReviewers.html('<i class="fas fa-check-square me-1"></i>Selecionar Todos');
        $buttonReviewers.removeClass('btn-outline-danger').addClass('btn-outline-primary');
      } else if (checkedCountReviewers === $checkboxesReviewers.length) {
        $buttonReviewers.html('<i class="fas fa-square me-1"></i>Desmarcar Todos');
        $buttonReviewers.removeClass('btn-outline-primary').addClass('btn-outline-danger');
      } else {
        $buttonReviewers.html('<i class="fas fa-minus-square me-1"></i>Selecionar Todos');
        $buttonReviewers.removeClass('btn-outline-danger').addClass('btn-outline-primary');
      }
    });

    // Dados dos campos dinâmicos
    const fieldOptions = {{ field_options|tojson|safe }};
    console.log('=== INICIALIZAÇÃO DO FILTRO DINÂMICO ===');
    console.log('DEBUG: fieldOptions carregados:', fieldOptions);
    console.log('DEBUG: Estrutura dos fieldOptions:', Object.keys(fieldOptions));
    console.log('DEBUG: Tipo de fieldOptions:', typeof fieldOptions);
    console.log('DEBUG: fieldOptions é array?', Array.isArray(fieldOptions));
    
    // Verificar cada processo
    Object.keys(fieldOptions).forEach(processId => {
        console.log(`DEBUG: Processo ${processId}:`, fieldOptions[processId]);
        if (fieldOptions[processId]) {
            console.log(`DEBUG: Campos disponíveis para processo ${processId}:`, Object.keys(fieldOptions[processId]));
        }
    });
    
    // Filtros de revisores
    function filterReviewers() {
      const nameFilter = $('#filterReviewerName').val().toLowerCase();
      const dynamicField = $('#dynamicFieldSelect').val();
      const dynamicValue = $('#dynamicValueSelect').val();
      const processFilter = $('#filterProcesso').val();
      
      $('.reviewer-item').each(function() {
        const item = $(this);
        const name = item.find('strong').text().toLowerCase();
        const processId = item.data('process-id') || '';
        
        const matchesName = !nameFilter || name.includes(nameFilter);
        const matchesProcess = !processFilter || processId.toString() === processFilter;
        
        // Verificar filtro dinâmico
        let matchesDynamic = true;
        if (dynamicField && dynamicValue) {
          const reviewerData = item.data('reviewer-data') || {};
          const fieldValue = reviewerData[dynamicField] || '';
          matchesDynamic = fieldValue.toString().toLowerCase() === dynamicValue.toLowerCase();
        }
        
        if (matchesName && matchesProcess && matchesDynamic) {
          item.show();
        } else {
          item.hide();
          // Desmarcar se estiver oculto
          item.find('.reviewer-checkbox').prop('checked', false);
        }
      });
      
      updateSelections();
    }
    
    // Armazenar todas as opções de campo originalmente carregadas
    const allFieldOptions = $('#dynamicFieldSelect option[data-process-id]').clone();
    console.log('DEBUG: allFieldOptions carregadas:', allFieldOptions.length, 'opções');
    console.log('DEBUG: Conteúdo das opções:', allFieldOptions.map(function() { return {text: $(this).text(), value: $(this).val(), processId: $(this).data('process-id')}; }).get());
    
    // Atualizar opções do filtro de campos quando o processo for selecionado
    $('#filterProcesso').on('change', function() {
      const selectedProcessId = $(this).val();
      console.log('=== EVENTO CHANGE DO PROCESSO ===');
      console.log('DEBUG: Processo selecionado:', selectedProcessId);
      console.log('DEBUG: Tipo do processo selecionado:', typeof selectedProcessId);
      
      const $fieldSelect = $('#dynamicFieldSelect');
      const $valueSelect = $('#dynamicValueSelect');
      
      console.log('DEBUG: Elemento fieldSelect encontrado:', $fieldSelect.length > 0);
      console.log('DEBUG: Elemento valueSelect encontrado:', $valueSelect.length > 0);
      
      // Limpar seletores
      $fieldSelect.empty().append('<option value="">Selecione um campo para filtrar</option>');
      $valueSelect.empty().append('<option value="">Selecione um campo primeiro</option>').prop('disabled', true);
      console.log('DEBUG: Seletores limpos');
      
      if (selectedProcessId) {
        console.log('DEBUG: Verificando fieldOptions para processo:', selectedProcessId);
        console.log('DEBUG: fieldOptions[selectedProcessId] existe?', !!fieldOptions[selectedProcessId]);
        console.log('DEBUG: Conteúdo de fieldOptions[selectedProcessId]:', fieldOptions[selectedProcessId]);
        
        // Adicionar apenas campos do processo selecionado
        let addedFields = 0;
        allFieldOptions.each(function() {
          const optionProcessId = $(this).data('process-id');
          console.log('DEBUG: Comparando processId da opção:', optionProcessId, 'com selecionado:', selectedProcessId);
          if (optionProcessId && optionProcessId.toString() === selectedProcessId) {
            const clonedOption = $(this).clone();
            console.log('DEBUG: Adicionando opção:', clonedOption.text(), 'valor:', clonedOption.val());
            $fieldSelect.append(clonedOption);
            addedFields++;
          }
        });
        console.log('DEBUG: Total de campos adicionados para processo', selectedProcessId, ':', addedFields);
        
        if (addedFields === 0) {
          console.log('AVISO: Nenhum campo foi adicionado! Verificando allFieldOptions...');
          console.log('DEBUG: Total de allFieldOptions:', allFieldOptions.length);
          allFieldOptions.each(function(index) {
            console.log(`DEBUG: Opção ${index}:`, {
              text: $(this).text(),
              value: $(this).val(),
              processId: $(this).data('process-id')
            });
          });
        }
      } else {
        // Mostrar todos os campos se nenhum processo estiver selecionado
        allFieldOptions.each(function() {
          $fieldSelect.append($(this).clone());
        });
        console.log('DEBUG: Todos os campos adicionados (', allFieldOptions.length, 'campos)');
      }
      
      console.log('DEBUG: Opções finais no fieldSelect:', $fieldSelect.find('option').length);
      
      // Reexecutar filtro
      console.log('DEBUG: Executando filterReviewers...');
      filterReviewers();
    });
    
    // Atualizar opções do filtro dinâmico quando o campo for selecionado
    $('#dynamicFieldSelect').on('change', function() {
      const selectedField = $(this).val();
      const selectedProcessId = $('#filterProcesso').val() || $(this).find('option:selected').data('process-id');
      console.log('=== EVENTO CHANGE DO CAMPO ===');
      console.log('DEBUG: Campo selecionado:', selectedField);
      console.log('DEBUG: Processo para campo:', selectedProcessId);
      console.log('DEBUG: Tipo do campo:', typeof selectedField);
      console.log('DEBUG: Tipo do processo:', typeof selectedProcessId);
      
      const $valueSelect = $('#dynamicValueSelect');
      console.log('DEBUG: Elemento valueSelect encontrado:', $valueSelect.length > 0);
      
      $valueSelect.empty().append('<option value="">Selecione uma opção</option>');
      
      console.log('DEBUG: Verificando fieldOptions[' + selectedProcessId + '][' + selectedField + ']');
      console.log('DEBUG: fieldOptions para processo:', fieldOptions[selectedProcessId]);
      console.log('DEBUG: fieldOptions[selectedProcessId] existe?', !!fieldOptions[selectedProcessId]);
      
      if (fieldOptions[selectedProcessId]) {
        console.log('DEBUG: Campos disponíveis no processo:', Object.keys(fieldOptions[selectedProcessId]));
        console.log('DEBUG: fieldOptions[selectedProcessId][selectedField]:', fieldOptions[selectedProcessId][selectedField]);
      }
      
      if (selectedField && selectedProcessId && fieldOptions[selectedProcessId] && fieldOptions[selectedProcessId][selectedField]) {
        $valueSelect.prop('disabled', false);
        const options = fieldOptions[selectedProcessId][selectedField];
        console.log('DEBUG: Opções encontradas para campo:', options);
        console.log('DEBUG: Tipo das opções:', typeof options, 'É array?', Array.isArray(options));
        
        // Adicionar opções disponíveis para o campo selecionado
        if (Array.isArray(options)) {
          options.forEach(function(option, index) {
            console.log(`DEBUG: Adicionando opção ${index}:`, option);
            $valueSelect.append(`<option value="${option}">${option}</option>`);
          });
          console.log('DEBUG: Total de opções adicionadas:', options.length);
        } else {
          console.log('ERRO: options não é um array:', options);
        }
      } else {
        $valueSelect.prop('disabled', true);
        console.log('DEBUG: Condições não atendidas:');
        console.log('  - selectedField:', !!selectedField);
        console.log('  - selectedProcessId:', !!selectedProcessId);
        console.log('  - fieldOptions[selectedProcessId]:', !!fieldOptions[selectedProcessId]);
        console.log('  - fieldOptions[selectedProcessId][selectedField]:', !!(fieldOptions[selectedProcessId] && fieldOptions[selectedProcessId][selectedField]));
      }
      
      console.log('DEBUG: Opções finais no valueSelect:', $valueSelect.find('option').length);
      
      // Limpar filtro e reexecutar
      console.log('DEBUG: Executando filterReviewers...');
      filterReviewers();
    });

    $('#filterReviewerName, #dynamicFieldSelect, #dynamicValueSelect, #filterProcesso').on('input change', filterReviewers);

    // Gerenciar seleções de trabalhos com validação em tempo real
    $(document).on('change', '.work-checkbox', function() {
      const workId = $(this).val();
      const isChecked = $(this).is(':checked');
      
      if (isChecked) {
        // Verificar se o trabalho já atingiu o limite máximo
        const currentReviewers = assignmentsData.get(workId) || [];
        if (currentReviewers.length >= limits.maxReviewersPerWork) {
          $(this).prop('checked', false);
          showAlert(`Este trabalho já possui o máximo de revisores (${limits.maxReviewersPerWork}).`, 'warning');
          return;
        }
      }
      
      // Atualizar o texto do botão "Selecionar Todos"
      const $button = $('#selectAllWorks');
      const $checkboxes = $('.work-checkbox:visible');
      const checkedCount = $checkboxes.filter(':checked').length;
      
      if (checkedCount === 0) {
        $button.html('<i class="fas fa-check-square me-1"></i>Selecionar Todos');
        $button.removeClass('btn-outline-danger').addClass('btn-outline-primary');
      } else if (checkedCount === $checkboxes.length) {
        $button.html('<i class="fas fa-square me-1"></i>Desmarcar Todos');
        $button.removeClass('btn-outline-primary').addClass('btn-outline-danger');
      } else {
        $button.html('<i class="fas fa-minus-square me-1"></i>Selecionar Todos');
        $button.removeClass('btn-outline-danger').addClass('btn-outline-primary');
      }
      
      updateSelections();
    });

    // Gerenciar seleções de revisores com validação em tempo real
    $(document).on('change', '.reviewer-checkbox', function() {
      const reviewerId = $(this).val();
      const isChecked = $(this).is(':checked');
      
      if (isChecked) {
        // Verificar se o revisor já atingiu o limite máximo
        const currentCount = reviewerWorkCounts.get(reviewerId) || 0;
        if (currentCount >= limits.maxWorksPerReviewer) {
          $(this).prop('checked', false);
          showAlert(`Este revisor já possui o máximo de trabalhos (${limits.maxWorksPerReviewer}).`, 'warning');
          return;
        }
        
        // Verificar compatibilidade se houver trabalhos selecionados
        if (selectedWorks.size > 0) {
          let hasIncompatibleWork = false;
          selectedWorks.forEach(workId => {
            const currentReviewers = assignmentsData.get(workId) || [];
            if (currentReviewers.includes(reviewerId)) {
              hasIncompatibleWork = true;
            }
          });
          
          if (hasIncompatibleWork) {
            showAlert('Este revisor já está atribuído a um dos trabalhos selecionados.', 'info');
          }
        }
      }
      
      updateSelections();
    });

    // Atualizar seleções e habilitar/desabilitar botões
    function updateSelections() {
      // Atualizar conjunto de trabalhos selecionados
      selectedWorks.clear();
      $('.work-checkbox:checked').each(function() {
        selectedWorks.add($(this).val());
      });
      
      // Atualizar conjunto de revisores selecionados
      selectedReviewers.clear();
      $('.reviewer-checkbox:checked').each(function() {
        selectedReviewers.add($(this).val());
      });
      
      // Atualizar contadores visuais
      $('#selectedWorksCount').text(selectedWorks.size);
      $('#selectedReviewersCount').text(selectedReviewers.size);
      
      // Habilitar/desabilitar botões
      const hasWorks = selectedWorks.size > 0;
      const hasReviewers = selectedReviewers.size > 0;
      
      $('#assignManual').prop('disabled', !(hasWorks && hasReviewers));
      $('#assignSmart').prop('disabled', !hasWorks);
    }

    // Funcionalidade do botão "Selecionar Todos" para trabalhos
    $('#selectAllWorks').on('click', function() {
      const $button = $(this);
      const $icon = $button.find('i');
      const $checkboxes = $('.work-checkbox:visible');
      
      // Verificar se todos os checkboxes visíveis estão marcados
      const allChecked = $checkboxes.length > 0 && $checkboxes.filter(':checked').length === $checkboxes.length;
      
      if (allChecked) {
        // Desmarcar todos
        $checkboxes.prop('checked', false);
        $button.html('<i class="fas fa-check-square me-1"></i>Selecionar Todos');
        $button.removeClass('btn-outline-danger').addClass('btn-outline-primary');
      } else {
        // Marcar todos os visíveis
        $checkboxes.prop('checked', true);
        $button.html('<i class="fas fa-square me-1"></i>Desmarcar Todos');
        $button.removeClass('btn-outline-primary').addClass('btn-outline-danger');
      }
      
      // Atualizar seleções
      updateSelections();
    });

    // Funcionalidade do botão "Selecionar Todos" para revisores
    $('#selectAllReviewers').on('click', function() {
      const $button = $(this);
      const $icon = $button.find('i');
      const $checkboxes = $('.reviewer-checkbox:visible');
      
      // Verificar se todos os checkboxes visíveis estão marcados
      const allChecked = $checkboxes.length > 0 && $checkboxes.filter(':checked').length === $checkboxes.length;
      
      if (allChecked) {
        // Desmarcar todos
        $checkboxes.prop('checked', false);
        $button.html('<i class="fas fa-check-square me-1"></i>Selecionar Todos');
        $button.removeClass('btn-outline-danger').addClass('btn-outline-primary');
      } else {
        // Marcar todos os visíveis
        $checkboxes.prop('checked', true);
        $button.html('<i class="fas fa-square me-1"></i>Desmarcar Todos');
        $button.removeClass('btn-outline-primary').addClass('btn-outline-danger');
      }
      
      // Atualizar seleções
      updateSelections();
    });



    // Atribuição manual
    $('#assignManual').on('click', function() {
      if (selectedWorks.size === 0 || selectedReviewers.size === 0) {
        showAlert('Selecione pelo menos um trabalho e um revisor.', 'warning');
        return;
      }
      
      let assignmentsCount = 0;
      let errors = [];
      
      selectedWorks.forEach(workId => {
        const currentReviewers = assignmentsData.get(workId) || [];
        
        selectedReviewers.forEach(reviewerId => {
          // Verificar se já está atribuído
          if (currentReviewers.includes(reviewerId)) {
            return;
          }
          
          // Verificar limites
          if (currentReviewers.length >= limits.maxReviewersPerWork) {
            errors.push(`Trabalho já possui o máximo de revisores (${limits.maxReviewersPerWork})`);
            return;
          }
          
          const reviewerCount = reviewerWorkCounts.get(reviewerId) || 0;
          if (reviewerCount >= limits.maxWorksPerReviewer) {
            errors.push(`Revisor já possui o máximo de trabalhos (${limits.maxWorksPerReviewer})`);
            return;
          }
          
          // Fazer atribuição
          currentReviewers.push(reviewerId);
          assignmentsData.set(workId, currentReviewers);
          reviewerWorkCounts.set(reviewerId, reviewerCount + 1);
          assignmentsCount++;
        });
      });
      
      if (assignmentsCount > 0) {
        showAlert(`${assignmentsCount} atribuição(ões) realizada(s) com sucesso!`, 'success');
        clearSelections();
        updateCounters();
      }
      
      if (errors.length > 0) {
        showAlert(`Alguns problemas encontrados: ${errors.slice(0, 3).join(', ')}`, 'warning');
      }
    });

    // Validação da atribuição automática por área
    $('#autoArea').on('click', function(e) {
        const eventoId = $('#eventoId').val();
        if (!eventoId) {
            e.preventDefault();
            showAlert('Por favor, informe o ID do evento.', 'warning');
            return;
        }
    });

    // Tooltips
    $('[data-bs-toggle="tooltip"]').tooltip();

    // Validação do arquivo
    $('#arquivo').on('change', function() {
        const file = this.files[0];
        if (file) {
            const allowedTypes = ['.xls', '.xlsx'];
            const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
            if (!allowedTypes.includes(fileExtension)) {
                showAlert('Por favor, selecione um arquivo .xls ou .xlsx válido.', 'danger');
                $(this).val('');
                return;
            }
            if (file.size > 10 * 1024 * 1024) {
                showAlert('O arquivo deve ter no máximo 10MB.', 'danger');
                $(this).val('');
                return;
            }
        }
    });

    // Sorteio inteligente
    $('#assignSmart').on('click', function() {
      if (selectedWorks.size === 0) {
        showAlert('Selecione pelo menos um trabalho.', 'warning');
        return;
      }
      
      const considerFormacao = $('#smartByFormacao').is(':checked');
      const considerInstituicao = $('#smartByInstituicao').is(':checked');
      
      const button = $(this);
      button.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Sorteando...');
      
      setTimeout(() => {
        let assignmentsCount = 0;
        let compatibilityWarnings = [];
        
        selectedWorks.forEach(workId => {
          const currentReviewers = assignmentsData.get(workId) || [];
          const needed = limits.minReviewersPerWork - currentReviewers.length;
          
          if (needed <= 0) return;
          
          // Obter dados do trabalho
          const workItem = $(`.work-item[data-id="${workId}"]`);
          const workCategory = workItem.data('category') || '';
          const workTitle = workItem.find('strong').text();
          
          // Obter revisores disponíveis com pontuação de compatibilidade
          const availableReviewers = [];
          $('.reviewer-item:visible').each(function() {
            const reviewerId = $(this).data('id').toString();
            const reviewerCount = reviewerWorkCounts.get(reviewerId) || 0;
            
            if (!currentReviewers.includes(reviewerId) && reviewerCount < limits.maxWorksPerReviewer) {
              const reviewer = {
                id: reviewerId,
                nome: $(this).find('strong').text(),
                formacao: $(this).data('formacao') || '',
                instituicao: $(this).data('instituicao') || '',
                score: 0
              };
              
              // Calcular pontuação de compatibilidade
              if (considerFormacao && workCategory && reviewer.formacao) {
                // Verificar se a formação é compatível com a categoria
                const formacaoLower = reviewer.formacao.toLowerCase();
                const categoryLower = workCategory.toLowerCase();
                
                if (formacaoLower.includes(categoryLower) || 
                    categoryLower.includes(formacaoLower) ||
                    areRelatedFields(formacaoLower, categoryLower)) {
                  reviewer.score += 10;
                }
              }
              
              if (considerInstituicao && reviewer.instituicao) {
                // Dar pontos por ter instituição definida
                reviewer.score += 5;
                
                // Evitar concentração na mesma instituição
                const sameInstitutionCount = currentReviewers.filter(rId => {
                  const rItem = $(`.reviewer-item[data-id="${rId}"]`);
                  return rItem.data('instituicao') === reviewer.instituicao;
                }).length;
                
                if (sameInstitutionCount === 0) {
                  reviewer.score += 3; // Bonus por diversidade
                }
              }
              
              // Bonus por menor carga de trabalho
              const workload = reviewerWorkCounts.get(reviewerId) || 0;
              reviewer.score += (limits.maxWorksPerReviewer - workload);
              
              availableReviewers.push(reviewer);
            }
          });
          
          if (availableReviewers.length === 0) {
            compatibilityWarnings.push(`Nenhum revisor disponível para "${workTitle}"`);
            return;
          }
          
          // Ordenar por pontuação (maior primeiro) e depois sortear entre os melhores
          availableReviewers.sort((a, b) => b.score - a.score);
          
          // Pegar os top 30% ou pelo menos 3 revisores para sortear
          const topCount = Math.max(3, Math.ceil(availableReviewers.length * 0.3));
          const topReviewers = availableReviewers.slice(0, topCount);
          
          // Sortear entre os melhores
          const shuffled = topReviewers.sort(() => 0.5 - Math.random());
          const selected = shuffled.slice(0, Math.min(needed, limits.maxReviewersPerWork - currentReviewers.length));
          
          selected.forEach(reviewer => {
            currentReviewers.push(reviewer.id);
            const count = reviewerWorkCounts.get(reviewer.id) || 0;
            reviewerWorkCounts.set(reviewer.id, count + 1);
            assignmentsCount++;
          });
          
          assignmentsData.set(workId, currentReviewers);
        });
        
        let message = `Sorteio inteligente concluído! ${assignmentsCount} atribuição(ões) realizada(s).`;
        if (compatibilityWarnings.length > 0) {
          message += ` Avisos: ${compatibilityWarnings.slice(0, 2).join(', ')}`;
        }
        
        showAlert(message, assignmentsCount > 0 ? 'success' : 'warning');
        clearSelections();
        updateCounters();
        
        button.prop('disabled', false).html('<i class="fas fa-magic me-2"></i>Sortear Revisores');
      }, 1500);
    });
    
    // Função auxiliar para verificar campos relacionados
    function areRelatedFields(formacao, categoria) {
      const relatedFields = {
        'computacao': ['informatica', 'tecnologia', 'sistemas', 'software', 'programacao'],
        'informatica': ['computacao', 'tecnologia', 'sistemas', 'software'],
        'engenharia': ['tecnologia', 'sistemas', 'industrial', 'producao'],
        'administracao': ['gestao', 'negocios', 'economia', 'financas'],
        'educacao': ['pedagogia', 'ensino', 'didatica', 'aprendizagem'],
        'saude': ['medicina', 'enfermagem', 'fisioterapia', 'nutricao'],
        'direito': ['juridico', 'legal', 'advocacia', 'justica']
      };
      
      for (const [field, related] of Object.entries(relatedFields)) {
        if (formacao.includes(field) && related.some(r => categoria.includes(r))) {
          return true;
        }
        if (categoria.includes(field) && related.some(r => formacao.includes(r))) {
          return true;
        }
      }
      
      return false;
    }
    
    // Sortear por categoria
    $('#assignByCategory').on('click', function() {
      const category = $('#filterWorkCategory').val();
      
      if (!category) {
        showAlert('Selecione uma categoria primeiro.', 'warning');
        return;
      }
      
      const button = $(this);
      button.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Sorteando...');
      
      setTimeout(() => {
        let assignmentsCount = 0;
        
        // Obter trabalhos da categoria
        $(`.work-item[data-category="${category}"]`).each(function() {
          const workId = $(this).data('id').toString();
          const currentReviewers = assignmentsData.get(workId) || [];
          const needed = limits.minReviewersPerWork - currentReviewers.length;
          
          if (needed <= 0) return;
          
          // Obter revisores disponíveis
          const availableReviewers = [];
          $('.reviewer-item').each(function() {
            const reviewerId = $(this).data('id').toString();
            const reviewerCount = reviewerWorkCounts.get(reviewerId) || 0;
            
            if (!currentReviewers.includes(reviewerId) && reviewerCount < limits.maxWorksPerReviewer) {
              availableReviewers.push(reviewerId);
            }
          });
          
          // Sortear revisores
          const shuffled = availableReviewers.sort(() => 0.5 - Math.random());
          const selected = shuffled.slice(0, Math.min(needed, limits.maxReviewersPerWork - currentReviewers.length));
          
          selected.forEach(reviewerId => {
            currentReviewers.push(reviewerId);
            const count = reviewerWorkCounts.get(reviewerId) || 0;
            reviewerWorkCounts.set(reviewerId, count + 1);
            assignmentsCount++;
          });
          
          assignmentsData.set(workId, currentReviewers);
        });
        
        showAlert(`Sorteio por categoria "${category}" concluído! ${assignmentsCount} atribuição(ões) realizada(s).`, 'success');
        updateCounters();
        
        button.prop('disabled', false).html('<i class="fas fa-layer-group me-2"></i>Sortear por Categoria');
      }, 2000);
    });
    
    // Atribuição inteligente em lote
    $('#smartBulkAssign').on('click', function() {
      const button = $(this);
      button.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Processando...');
      
      setTimeout(() => {
        let assignmentsCount = 0;
        let processedWorks = 0;
        
        // Processar todos os trabalhos que precisam de revisores
        $('.work-item').each(function() {
          const workId = $(this).data('id').toString();
          const workCategory = $(this).data('category');
          const workTitle = $(this).find('strong').text();
          const currentReviewers = assignmentsData.get(workId) || [];
          const needed = limits.minReviewersPerWork - currentReviewers.length;
          
          if (needed <= 0) return;
          
          processedWorks++;
          
          // Obter revisores disponíveis com pontuação de compatibilidade
          const availableReviewers = [];
          $('.reviewer-item').each(function() {
            const reviewerId = $(this).data('id').toString();
            const reviewerCount = reviewerWorkCounts.get(reviewerId) || 0;
            const reviewerFormacao = $(this).data('formacao') || '';
            const reviewerInstituicao = $(this).data('instituicao') || '';
            
            if (!currentReviewers.includes(reviewerId) && reviewerCount < limits.maxWorksPerReviewer) {
              let score = 0;
              
              // Pontuação por formação compatível
              if (reviewerFormacao.toLowerCase().includes(workCategory.toLowerCase()) || 
                  workCategory.toLowerCase().includes(reviewerFormacao.toLowerCase()) ||
                  areRelatedFields(reviewerFormacao.toLowerCase(), workCategory.toLowerCase())) {
                score += 10;
              }
              
              // Pontuação por menor carga de trabalho
              score += (limits.maxWorksPerReviewer - reviewerCount) * 2;
              
              // Pontuação por diversidade de instituição
              const institutionCount = currentReviewers.filter(rId => {
                const rInst = $(`.reviewer-item[data-id="${rId}"]`).data('instituicao') || '';
                return rInst === reviewerInstituicao;
              }).length;
              
              if (institutionCount === 0 && reviewerInstituicao) {
                score += 5; // Bônus por diversidade
              }
              
              availableReviewers.push({ id: reviewerId, score });
            }
          });
          
          // Ordenar por pontuação e selecionar os melhores
          availableReviewers.sort((a, b) => b.score - a.score);
          const topReviewers = availableReviewers.slice(0, Math.min(needed, limits.maxReviewersPerWork - currentReviewers.length));
          
          // Fazer atribuições
          topReviewers.forEach(reviewer => {
            currentReviewers.push(reviewer.id);
            const count = reviewerWorkCounts.get(reviewer.id) || 0;
            reviewerWorkCounts.set(reviewer.id, count + 1);
            assignmentsCount++;
          });
          
          assignmentsData.set(workId, currentReviewers);
        });
        
        showAlert(`Atribuição inteligente em lote concluída! ${assignmentsCount} atribuição(ões) realizadas em ${processedWorks} trabalho(s).`, 'success');
        updateCounters();
        
        button.prop('disabled', false).html('<i class="fas fa-magic me-2"></i>Atribuição Inteligente em Lote');
      }, 3000);
    });
    
    // Limpar todas as atribuições
    $('#clearAllAssignments').on('click', function() {
      if (confirm('Tem certeza que deseja limpar todas as atribuições?')) {
        assignmentsData.clear();
        initializeCounts();
        clearSelections();
        updateCounters();
        showAlert('Todas as atribuições foram removidas.', 'info');
      }
    });

    // Limpar seleções
    function clearSelections() {
      $('.work-checkbox, .reviewer-checkbox').prop('checked', false);
      selectedWorks.clear();
      selectedReviewers.clear();
      updateSelections();
    }

    // Atualizar relatório de atribuições
    function updateAssignmentsReport() {
      assignmentsData.forEach((reviewerIds, workId) => {
        const reviewerNames = reviewerIds.map(id => {
          const reviewerItem = $(`.reviewer-item[data-id="${id}"]`);
          return reviewerItem.find('strong').text();
        });
        
        const reviewersHtml = reviewerNames.length > 0 
          ? reviewerNames.map(name => `<span class="badge bg-primary me-1">${name}</span>`).join('')
          : '<span class="text-muted">Nenhum revisor atribuído</span>';
        
        $(`#assigned_reviewers_${workId}`).html(reviewersHtml);
      });
    }

    // Remover atribuição específica
    window.removeAssignment = function(workId) {
      if (confirm('Remover todas as atribuições deste trabalho?')) {
        const reviewerIds = assignmentsData.get(workId.toString()) || [];
        
        // Decrementar contadores dos revisores
        reviewerIds.forEach(reviewerId => {
          const count = reviewerWorkCounts.get(reviewerId) || 0;
          reviewerWorkCounts.set(reviewerId, Math.max(0, count - 1));
        });
        
        // Remover atribuição
        assignmentsData.delete(workId.toString());
        updateCounters();
        showAlert('Atribuições removidas com sucesso.', 'info');
      }
    };

    // Exportar relatório
    $('#exportReport').on('click', function() {
      const reportData = [];
      
      assignmentsData.forEach((reviewerIds, workId) => {
        const workTitle = $(`.work-item[data-id="${workId}"] strong`).text();
        const workCategory = $(`.work-item[data-id="${workId}"]`).data('category');
        
        const reviewerNames = reviewerIds.map(id => {
          return $(`.reviewer-item[data-id="${id}"] strong`).text();
        });
        
        reportData.push({
          trabalho: workTitle,
          categoria: workCategory,
          revisores: reviewerNames.join(', ')
        });
      });
      
      if (reportData.length === 0) {
        showAlert('Nenhuma atribuição para exportar.', 'warning');
        return;
      }
      
      // Implementação real de exportação CSV
      try {
        // Criar cabeçalho CSV
        const csvHeaders = ['Trabalho', 'Categoria', 'Revisores'];
        
        // Converter dados para formato CSV
        const csvRows = reportData.map(row => {
          return [
            `"${row.trabalho.replace(/"/g, '""')}"`, // Escapar aspas duplas
            `"${row.categoria || 'N/A'}"`,
            `"${row.revisores.replace(/"/g, '""')}"`
          ].join(',');
        });
        
        // Combinar cabeçalho e dados
        const csvContent = [csvHeaders.join(','), ...csvRows].join('\n');
        
        // Criar blob e fazer download
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        
        if (link.download !== undefined) {
          // Gerar nome do arquivo com timestamp
          const timestamp = new Date().toISOString().slice(0, 19).replace(/[T:]/g, '-');
          const filename = `relatorio-atribuicoes-${timestamp}.csv`;
          
          const url = URL.createObjectURL(blob);
          link.setAttribute('href', url);
          link.setAttribute('download', filename);
          link.style.visibility = 'hidden';
          
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          
          showAlert(`Relatório com ${reportData.length} atribuição(ões) exportado com sucesso!`, 'success');
        } else {
          throw new Error('Download não suportado pelo navegador');
        }
      } catch (error) {
        console.error('Erro ao exportar relatório:', error);
        showAlert('Erro ao exportar relatório. Tente novamente.', 'danger');
      }
    });

    // Inicializar
    initializeCounts();
    updateSelections();
    updateCounters();
    
    // Botões com estado de processamento (exceto o formulário de importação)
    $('#assignManual, #assignAutomatic, #autoArea, #assignByCategory, #smartBulkAssign').on('click', function() {
        const $btn = $(this);
        const originalText = $btn.html();
        $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Processando...');
        setTimeout(() => {
            $btn.prop('disabled', false).html(originalText);
        }, 3000);
    });
    
    // Botões de submit específicos (exceto formulário de importação)
    $('button[type="submit"]').not('#formImportarTrabalhos button[type="submit"]').on('click', function() {
        const $btn = $(this);
        const originalText = $btn.html();
        $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Processando...');
        setTimeout(() => {
            $btn.prop('disabled', false).html(originalText);
        }, 3000);
    });

    // Função de sorteio inteligente
    function performSmartAssignment(submissionId, criteria) {
        // Obter dados do trabalho selecionado
        const selectedWork = $('#submissionSelect option:selected');
        const workCategory = selectedWork.data('category');
        
        // Filtrar revisores compatíveis
        const compatibleReviewers = [];
        $('#reviewerSelect option').each(function() {
            if ($(this).val() === '') return;
            
            const reviewer = {
                id: $(this).val(),
                name: $(this).text(),
                nome: $(this).data('nome') || '',
                formacao: $(this).data('formacao') || '',
                instituicao: $(this).data('instituicao') || ''
            };
            
            let isCompatible = true;
            
            // Verificar compatibilidade por formação
            if (criteria.formacao && workCategory) {
                isCompatible = isCompatible && reviewer.formacao.toLowerCase().includes(workCategory.toLowerCase());
            }
            
            // Verificar compatibilidade por instituição
            if (criteria.instituicao && reviewer.instituicao) {
                // Lógica adicional para instituição pode ser implementada aqui
                isCompatible = isCompatible && reviewer.instituicao.length > 0;
            }
            
            if (isCompatible) {
                compatibleReviewers.push(reviewer);
            }
        });
        
        if (compatibleReviewers.length === 0) {
            showAlert('Nenhum revisor compatível encontrado com os critérios selecionados.', 'warning');
            return;
        }
        
        // Sortear revisores
        const minReviewers = parseInt($('#reviewerSelect').data('min')) || 1;
        const maxReviewers = parseInt($('#reviewerSelect').data('max')) || 2;
        const numToSelect = Math.min(maxReviewers, compatibleReviewers.length);
        
        const selectedReviewers = [];
        const shuffled = compatibleReviewers.sort(() => 0.5 - Math.random());
        
        for (let i = 0; i < numToSelect; i++) {
            selectedReviewers.push(shuffled[i].id);
        }
        
        // Atualizar seleção
        $('#reviewerSelect').val(selectedReviewers);
        
        showAlert(`Sorteio realizado! ${selectedReviewers.length} revisor(es) selecionado(s) automaticamente.`, 'success');
    }
    
    // Função de atribuição inteligente em lote
    function performBulkSmartAssignment(category, criteria) {
        showAlert(`Iniciando atribuição inteligente em lote para categoria: ${category}`, 'info');
        
        // Aqui seria implementada a lógica de atribuição em lote
        // Por enquanto, apenas uma simulação
        setTimeout(() => {
            showAlert('Atribuição inteligente em lote concluída com sucesso!', 'success');
        }, 2000);
    }
    
    // Função de distribuição por categoria
    function performCategoryDistribution(category) {
        showAlert(`Iniciando distribuição por categoria: ${category}`, 'info');
        
        // Aqui seria implementada a lógica de distribuição
        // Por enquanto, apenas uma simulação
        setTimeout(() => {
            showAlert('Distribuição por categoria concluída com sucesso!', 'success');
        }, 2000);
    }
    
    // Função de alerta centralizada no container correto
    function showAlert(message, type = 'info') {
        const icon = type === 'danger' ? 'exclamation-triangle'
                   : type === 'warning' ? 'exclamation-circle'
                   : type === 'success' ? 'check-circle'
                   : 'info-circle';
        const alertHtml = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                <i class="fas fa-${icon} me-2"></i>${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>`;
        $('#alertContainer').html(alertHtml);
        setTimeout(() => {
            $('#alertContainer .alert').fadeOut();
        }, 5000);
    }

    // Carregar eventos do cliente para seleção
    function carregarEventos() {
        console.log('Iniciando carregamento de eventos...');
        $.ajax({
            url: '{{ url_for("config_cliente_routes.get_eventos_cliente") }}',
            method: 'GET',
            success: function(response) {
                console.log('Resposta recebida:', response);
                if (response.success) {
                    // Carregar eventos em ambos os seletores
                    const $selectEventoId = $('#evento_id');
                    const $selectEventoIdCamelCase = $('#eventoId');
                    
                    // Limpar e adicionar opção padrão para ambos os seletores
                    [$selectEventoId, $selectEventoIdCamelCase].forEach(function($select) {
                        if ($select.length > 0) {
                            $select.empty().append('<option value="">Selecione um evento...</option>');
                        }
                    });
                    
                    if (response.eventos.length === 0) {
                        [$selectEventoId, $selectEventoIdCamelCase].forEach(function($select) {
                            if ($select.length > 0) {
                                $select.append('<option value="" disabled>Nenhum evento encontrado</option>');
                            }
                        });
                        showAlert('Nenhum evento encontrado. Crie um evento antes de importar trabalhos.', 'warning');
                    } else {
                        response.eventos.forEach(function(evento) {
                            [$selectEventoId, $selectEventoIdCamelCase].forEach(function($select) {
                                if ($select.length > 0) {
                                    $select.append(`<option value="${evento.id}">${evento.nome}</option>`);
                                }
                            });
                        });
                        console.log('Eventos carregados com sucesso em ambos os seletores:', response.eventos.length);
                    }
                } else {
                    console.error('Erro na resposta:', response.message);
                    showAlert('Erro ao carregar eventos: ' + response.message, 'danger');
                }
            },
            error: function(xhr, status, error) {
                console.error('Erro AJAX:', {
                    status: xhr.status,
                    statusText: xhr.statusText,
                    responseText: xhr.responseText,
                    error: error
                });
                
                if (xhr.status === 401 || xhr.status === 403) {
                    showAlert('Sessão expirada. Por favor, faça login novamente.', 'warning');
                    // Opcional: redirecionar para login
                    // window.location.href = '/login';
                } else if (xhr.status === 404) {
                    showAlert('Rota não encontrada. Verifique a configuração do sistema.', 'danger');
                } else {
                    showAlert('Erro ao carregar eventos. Tente novamente.', 'danger');
                }
            }
        });
    }

    // Controlar habilitação do campo de arquivo baseado na seleção do evento
    $('#evento_id').on('change', function() {
        const eventoSelecionado = $(this).val();
        const $arquivo = $('#arquivo');
        
        if (eventoSelecionado) {
            $arquivo.prop('disabled', false);
            $arquivo.siblings('.form-text').text('Formatos aceitos: .xlsx, .xls (máximo 10MB)');
        } else {
            $arquivo.prop('disabled', true).val('');
            $arquivo.siblings('.form-text').text('Formatos aceitos: .xlsx, .xls (máximo 10MB). Primeiro selecione um evento.');
        }
    });

    // Validação do formulário de importação
    $('#formImportarTrabalhos').on('submit', function(e) {
        const eventoId = $('#evento_id').val();
        const arquivo = $('#arquivo')[0].files[0];
        
        if (!eventoId) {
            e.preventDefault();
            showAlert('Por favor, selecione um evento antes de fazer o upload.', 'warning');
            $('#evento_id').focus();
            return false;
        }
        
        if (!arquivo) {
            e.preventDefault();
            showAlert('Por favor, selecione um arquivo Excel para importar.', 'warning');
            $('#arquivo').focus();
            return false;
        }
        
        // Mostrar indicador de progresso
        const $btn = $(this).find('button[type="submit"]');
        const originalText = $btn.html();
        $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Importando...');
        
        // Mostrar barra de progresso
        $('#uploadProgress').show();
        
        // Restaurar botão em caso de erro (será sobrescrito se sucesso)
        setTimeout(() => {
            $btn.prop('disabled', false).html(originalText);
            $('#uploadProgress').hide();
        }, 30000); // 30 segundos timeout
    });

    // Carregar eventos ao inicializar a página
    carregarEventos();
});
</script>

<style>
.avatar-sm {
    width: 32px;
    height: 32px;
    font-size: 14px;
    font-weight: bold;
}

.bg-gradient-primary {
    background: linear-gradient(45deg, #007bff, #0056b3);
}

.bg-gradient-success {
    background: linear-gradient(45deg, #28a745, #1e7e34);
}

.table-active {
    background-color: rgba(0, 123, 255, 0.1) !important;
}

.reviewer-list {
    max-height: 100px;
    overflow-y: auto;
}

.card {
    transition: all 0.3s ease;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1) !important;
}

.btn {
    transition: all 0.2s ease;
}

.btn:hover {
    transform: translateY(-1px);
}

.form-control:focus, .form-select:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

.badge {
    font-size: 0.75em;
}

@media (max-width: 768px) {
    .container-fluid {
        padding: 0 15px;
    }
    
    .d-flex.gap-2 {
        flex-direction: column;
        gap: 0.5rem !important;
    }
    
    .table-responsive {
        font-size: 0.875rem;
    }
}
</style>
{% endblock %}

{% block scripts_extra %}
{% endblock %}
