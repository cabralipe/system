{% extends "base.html" %}

{% block title %}Nova Configuração de Relatório - Cliente{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3">Nova Configuração de Relatório</h1>
                <a href="{{ url_for('formador_relatorio_routes.configuracoes') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Voltar
                </a>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Configuração do Relatório</h5>
                </div>
                <div class="card-body">
                    <form id="configuracaoForm" method="POST" class="needs-validation" novalidate>
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="nome" class="form-label">Nome da Configuração *</label>
                                    <input type="text" class="form-control" id="nome" name="nome" required>
                                    <div class="invalid-feedback">
                                        Por favor, informe o nome da configuração.
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="tipo_periodo" class="form-label">Tipo de Período *</label>
                                    <select class="form-select" id="tipo_periodo" name="tipo_periodo" required>
                                        <option value="">Selecione...</option>
                                        <option value="diario">Diário</option>
                                        <option value="semanal">Semanal</option>
                                        <option value="mensal">Mensal</option>
                                        <option value="personalizado">Personalizado</option>
                                    </select>
                                    <div class="invalid-feedback">
                                        Por favor, selecione o tipo de período.
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="descricao" class="form-label">Descrição</label>
                            <textarea class="form-control" id="descricao" name="descricao" rows="3" placeholder="Descreva o propósito desta configuração de relatório..."></textarea>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="obrigatorio" name="obrigatorio">
                                        <label class="form-check-label" for="obrigatorio">
                                            Relatório Obrigatório
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6" id="frequenciaGroup" style="display: none;">
                                <div class="form-group">
                                    <label for="frequencia_dias">Frequência (dias)</label>
                                    <input type="number" class="form-control" id="frequencia_dias" name="frequencia_dias" min="1" placeholder="Ex: 30 para mensal">
                                    <small class="form-text text-muted">Intervalo em dias para relatórios periódicos</small>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Campos do Relatório -->
            <div class="card mt-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Campos do Relatório</h5>
                    <button type="button" class="btn btn-primary btn-sm" onclick="adicionarCampo()">
                        <i class="fas fa-plus"></i> Adicionar Campo
                    </button>
                </div>
                <div class="card-body">
                    <div id="camposContainer">
                        <p class="text-muted">Nenhum campo adicionado. Clique em "Adicionar Campo" para começar.</p>
                    </div>
                </div>
            </div>

            <!-- Botões de Ação -->
            <div class="mt-4">
                <button type="button" class="btn btn-success" onclick="salvarConfiguracao()">
                    <i class="fas fa-save"></i> Salvar Configuração
                </button>
                <a href="{{ url_for('cliente_formador_routes.listar_configuracoes_relatorio') }}" class="btn btn-secondary ml-2">
                    <i class="fas fa-times"></i> Cancelar
                </a>
            </div>
        </div>

        <!-- Painel de Ajuda -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">Tipos de Campo Disponíveis</h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <strong>Texto:</strong> Campo de texto simples
                    </div>
                    <div class="mb-3">
                        <strong>Texto Longo:</strong> Área de texto para respostas extensas
                    </div>
                    <div class="mb-3">
                        <strong>Número:</strong> Campo numérico
                    </div>
                    <div class="mb-3">
                        <strong>Data:</strong> Seletor de data
                    </div>
                    <div class="mb-3">
                        <strong>Seleção:</strong> Lista suspensa com opções
                    </div>
                    <div class="mb-3">
                        <strong>Múltipla Escolha:</strong> Checkboxes para múltiplas seleções
                    </div>
                    <div class="mb-3">
                        <strong>Arquivo:</strong> Upload de arquivo
                    </div>
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-header">
                    <h6 class="mb-0">Dicas</h6>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled mb-0">
                        <li class="mb-2">
                            <i class="fas fa-lightbulb text-warning"></i>
                            <small>Use nomes descritivos para os campos</small>
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-lightbulb text-warning"></i>
                            <small>Marque como obrigatório apenas campos essenciais</small>
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-lightbulb text-warning"></i>
                            <small>Ordene os campos logicamente</small>
                        </li>
                        <li>
                            <i class="fas fa-lightbulb text-warning"></i>
                            <small>Use placeholders para orientar o preenchimento</small>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Adicionar Campo -->
<div class="modal fade" id="campoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Adicionar Campo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="campoForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="campo_nome">Nome do Campo *</label>
                                <input type="text" class="form-control" id="campo_nome" required>
                                <small class="form-text text-muted">Nome técnico (sem espaços ou caracteres especiais)</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="campo_label">Rótulo *</label>
                                <input type="text" class="form-control" id="campo_label" required>
                                <small class="form-text text-muted">Texto que aparecerá para o usuário</small>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="campo_tipo">Tipo *</label>
                                <select class="form-control" id="campo_tipo" required>
                                    <option value="">Selecione o tipo</option>
                                    <option value="texto">Texto</option>
                                    <option value="texto_longo">Texto Longo</option>
                                    <option value="numero">Número</option>
                                    <option value="data">Data</option>
                                    <option value="selecao">Seleção</option>
                                    <option value="multipla_escolha">Múltipla Escolha</option>
                                    <option value="arquivo">Arquivo</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="campo_ordem">Ordem</label>
                                <input type="number" class="form-control" id="campo_ordem" min="0" value="0">
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="campo_placeholder">Placeholder</label>
                        <input type="text" class="form-control" id="campo_placeholder" placeholder="Texto de ajuda para o usuário">
                    </div>

                    <div class="form-group" id="opcoesGroup" style="display: none;">
                        <label for="campo_opcoes">Opções</label>
                        <textarea class="form-control" id="campo_opcoes" rows="3" placeholder="Uma opção por linha"></textarea>
                        <small class="form-text text-muted">Para campos de seleção, digite uma opção por linha</small>
                    </div>

                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="campo_obrigatorio">
                        <label class="form-check-label" for="campo_obrigatorio">
                            Campo Obrigatório
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="confirmarCampo()">Adicionar Campo</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
let campos = [];
let campoEditandoIndex = -1;

// Aguardar o DOM estar carregado
document.addEventListener('DOMContentLoaded', function() {
    // Mostrar/ocultar frequência baseado no tipo
    const tipoSelect = document.getElementById('tipo');
    if (tipoSelect) {
        tipoSelect.addEventListener('change', function() {
            const frequenciaGroup = document.getElementById('frequenciaGroup');
            const valor = this.value;
            
            if (valor === 'mensal' || valor === 'trimestral' || valor === 'anual') {
                frequenciaGroup.style.display = 'block';
                
                // Definir valores padrão
                const frequenciaInput = document.getElementById('frequencia_dias');
                if (valor === 'mensal') frequenciaInput.value = 30;
                else if (valor === 'trimestral') frequenciaInput.value = 90;
                else if (valor === 'anual') frequenciaInput.value = 365;
            } else {
                frequenciaGroup.style.display = 'none';
            }
        });
    }

    // Mostrar/ocultar opções baseado no tipo de campo
    const campoTipoSelect = document.getElementById('campo_tipo');
    if (campoTipoSelect) {
        campoTipoSelect.addEventListener('change', function() {
            const opcoesGroup = document.getElementById('opcoesGroup');
            const valor = this.value;
            
            if (valor === 'selecao' || valor === 'multipla_escolha') {
                opcoesGroup.style.display = 'block';
            } else {
                opcoesGroup.style.display = 'none';
            }
        });
    }
});

function adicionarCampo() {
    try {
        // Limpar formulário
        const campoForm = document.getElementById('campoForm');
        if (campoForm) {
            campoForm.reset();
        }
        campoEditandoIndex = -1;
        
        // Mostrar modal usando Bootstrap 5
        const modalElement = document.getElementById('campoModal');
        if (modalElement) {
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
        } else {
            console.error('Modal campoModal não encontrado');
            alert('Erro: Modal não encontrado. Verifique se a página foi carregada corretamente.');
        }
    } catch (error) {
        console.error('Erro ao abrir modal:', error);
        alert('Erro ao abrir o formulário de campo. Verifique o console para mais detalhes.');
    }
}

function confirmarCampo() {
    try {
        const form = document.getElementById('campoForm');
        
        if (!form || !form.checkValidity()) {
            if (form) form.reportValidity();
            return;
        }
        
        const campo = {
            nome: document.getElementById('campo_nome').value,
            label: document.getElementById('campo_label').value,
            tipo: document.getElementById('campo_tipo').value,
            ordem: parseInt(document.getElementById('campo_ordem').value) || 0,
            placeholder: document.getElementById('campo_placeholder').value,
            obrigatorio: document.getElementById('campo_obrigatorio').checked,
            opcoes: []
        };
        
        // Processar opções se necessário
        const tipoComOpcoes = ['selecao', 'multipla_escolha'];
        if (tipoComOpcoes.includes(campo.tipo)) {
            const opcoesText = document.getElementById('campo_opcoes').value;
            campo.opcoes = opcoesText.split('\n').filter(op => op.trim()).map(op => op.trim());
            
            if (campo.opcoes.length === 0) {
                alert('Por favor, adicione pelo menos uma opção.');
                return;
            }
        }
        
        if (campoEditandoIndex >= 0) {
            campos[campoEditandoIndex] = campo;
        } else {
            campos.push(campo);
        }
        
        atualizarListaCampos();
        
        // Fechar modal
        const modalElement = document.getElementById('campoModal');
        if (modalElement) {
            const modal = bootstrap.Modal.getInstance(modalElement);
            if (modal) {
                modal.hide();
            }
        }
    } catch (error) {
        console.error('Erro ao confirmar campo:', error);
        alert('Erro ao adicionar campo. Verifique o console para mais detalhes.');
    }
}

function atualizarListaCampos() {
    const container = document.getElementById('camposContainer');
    
    if (campos.length === 0) {
        container.innerHTML = '<p class="text-muted">Nenhum campo adicionado. Clique em "Adicionar Campo" para começar.</p>';
        return;
    }
    
    // Ordenar campos
    campos.sort((a, b) => a.ordem - b.ordem);
    
    let html = '<div class="table-responsive"><table class="table table-sm"><thead><tr><th>Ordem</th><th>Rótulo</th><th>Tipo</th><th>Obrigatório</th><th>Ações</th></tr></thead><tbody>';
    
    campos.forEach((campo, index) => {
        html += `
            <tr>
                <td>${campo.ordem}</td>
                <td>${campo.label}</td>
                <td>${campo.tipo.replace('_', ' ').toUpperCase()}</td>
                <td>${campo.obrigatorio ? '<i class="fas fa-check text-success"></i>' : '<i class="fas fa-times text-muted"></i>'}</td>
                <td>
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="editarCampo(${index})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-danger ml-1" onclick="removerCampo(${index})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table></div>';
    container.innerHTML = html;
}

function editarCampo(index) {
    try {
        const campo = campos[index];
        if (!campo) {
            console.error('Campo não encontrado no índice:', index);
            return;
        }
        
        campoEditandoIndex = index;
        
        // Preencher formulário
        const nomeInput = document.getElementById('campo_nome');
        const labelInput = document.getElementById('campo_label');
        const tipoSelect = document.getElementById('campo_tipo');
        const ordemInput = document.getElementById('campo_ordem');
        const placeholderInput = document.getElementById('campo_placeholder');
        const obrigatorioCheck = document.getElementById('campo_obrigatorio');
        
        if (nomeInput) nomeInput.value = campo.nome;
        if (labelInput) labelInput.value = campo.label;
        if (tipoSelect) tipoSelect.value = campo.tipo;
        if (ordemInput) ordemInput.value = campo.ordem;
        if (placeholderInput) placeholderInput.value = campo.placeholder || '';
        if (obrigatorioCheck) obrigatorioCheck.checked = campo.obrigatorio;
        
        // Mostrar opções se necessário
        const tipoComOpcoes = ['selecao', 'multipla_escolha'];
        if (tipoComOpcoes.includes(campo.tipo)) {
            const opcoesGroup = document.getElementById('opcoesGroup');
            const opcoesInput = document.getElementById('campo_opcoes');
            if (opcoesGroup) opcoesGroup.style.display = 'block';
            if (opcoesInput) opcoesInput.value = campo.opcoes.join('\n');
        }
        
        const modalElement = document.getElementById('campoModal');
        if (modalElement) {
            const modal = new bootstrap.Modal(modalElement);
            modal.show();
        }
    } catch (error) {
        console.error('Erro ao editar campo:', error);
        alert('Erro ao editar campo. Verifique o console para mais detalhes.');
    }
}

function removerCampo(index) {
    if (confirm('Tem certeza que deseja remover este campo?')) {
        campos.splice(index, 1);
        atualizarListaCampos();
    }
}

function salvarConfiguracao() {
    try {
        if (campos.length === 0) {
            alert('Adicione pelo menos um campo ao relatório.');
            return;
        }
        
        const form = document.getElementById('configuracaoForm');
        if (!form) {
            console.error('Formulário não encontrado');
            return;
        }
        
        // Validar campos obrigatórios
        const nome = document.getElementById('nome');
        const tipoPeriodo = document.getElementById('tipo_periodo');
        
        if (!nome || !nome.value.trim()) {
            alert('Por favor, informe o nome da configuração.');
            if (nome) nome.focus();
            return;
        }
        
        if (!tipoPeriodo || !tipoPeriodo.value) {
            alert('Por favor, selecione o tipo de período.');
            if (tipoPeriodo) tipoPeriodo.focus();
            return;
        }
        
        // Adicionar campos como inputs hidden ao formulário
        // Primeiro, remover campos existentes para evitar duplicação
        const existingFields = form.querySelectorAll('input[name^="campo_"]');
        existingFields.forEach(field => field.remove());
        
        // Adicionar os campos atuais
        campos.forEach((campo, index) => {
            // Nome do campo
            const nomeInput = document.createElement('input');
            nomeInput.type = 'hidden';
            nomeInput.name = 'campo_nome[]';
            nomeInput.value = campo.nome;
            form.appendChild(nomeInput);
            
            // Tipo do campo
            const tipoInput = document.createElement('input');
            tipoInput.type = 'hidden';
            tipoInput.name = 'campo_tipo[]';
            tipoInput.value = campo.tipo;
            form.appendChild(tipoInput);
            
            // Obrigatório
            if (campo.obrigatorio) {
                const obrigatorioInput = document.createElement('input');
                obrigatorioInput.type = 'hidden';
                obrigatorioInput.name = 'campo_obrigatorio[]';
                obrigatorioInput.value = index.toString();
                form.appendChild(obrigatorioInput);
            }
        });
        
        // Enviar o formulário
        form.submit();
        
    } catch (error) {
        console.error('Erro ao salvar configuração:', error);
        alert('Erro ao salvar configuração. Verifique o console para mais detalhes.');
    }
}
</script>
{% endblock %}