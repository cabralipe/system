{% extends "base.html" %}
{% block title %}Dashboard - Participante{% endblock %}

{% block content %}
<!-- CSS customizado para o Dashboard -->
<style>
  /* Cabe√ßalho do Dashboard */
  .dashboard-header {
    margin-top: 2rem;
    margin-bottom: 2rem;
  }
  .dashboard-header h2 {
    font-size: 2rem;
    font-weight: 700;
    color: #343a40;
  }
  .dashboard-header h3 {
    font-size: 1.25rem;
    color: #6c757d;
  }
  
  /* Cart√µes de oficina */
  .card {
    border: none;
    border-radius: 0.5rem;
    overflow: hidden;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  .card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0,0,0,0.1);
  }
  .card-header {
    background-color: #007bff;
    color: #fff;
    font-size: 1.25rem;
    font-weight: 600;
    text-align: center;
    padding: 0.75rem 1rem;
  }
  .card-body {
    padding: 1rem;
  }
  .card-body p {
    margin-bottom: 0.5rem;
    color: #495057;
  }
  .card-body ul {
    padding-left: 1.25rem;
    margin-bottom: 0.5rem;
  }
  .card-body li {
    margin-bottom: 0.25rem;
  }
  
  /* Bot√µes customizados */
  .btn-block {
    width: 100%;
    margin-bottom: 0.5rem;
  }
  .d-flex.flex-column.gap-2 > * {
    margin-bottom: 0.5rem;
  }
  
  /* Rodap√© */
  footer {
    background: #343a40;
    color: #fff;
    padding: 1rem 0;
    margin-top: 2rem;
  }
  footer p {
    margin: 0;
  }
</style>

<div class="container">
  <div class="dashboard-header text-center">
    <h2>Bem-vindo(a), <b>{{ usuario.nome }}</b></h2>
    <h3>Abaixo voc√™ encontra as oficinas dispon√≠veis para inscri√ß√£o</h3>
  </div>
  
  <div class="row">
    {% set inscricoes_ids = usuario.inscricoes | map(attribute='oficina_id') | list %}
    
    {% if oficinas %}
      {% for oficina in oficinas %}
      <div class="col-md-6 col-lg-4 mb-4">
        <div class="card shadow-sm" data-oficina-id="{{ oficina.id }}">
          <div class="card-header">
            {{ oficina.titulo }}
          </div>
          <div class="card-body">
            <p><strong>Descri√ß√£o:</strong> {{ oficina.descricao }}</p>
            <p><strong>Ministrante:</strong> {{ oficina.ministrante }}</p>
            <p><strong>Datas e Hor√°rios:</strong></p>
            <ul class="list-unstyled">
              {% for dia in oficina.dias %}
              <li>üìÖ {{ dia }}</li>
              {% endfor %}
            </ul>
            <p><strong>Carga Hor√°ria:</strong> {{ oficina.carga_horaria }} horas</p>
            {# Se desejar exibir vagas, descomente o bloco abaixo: #}
            {#
            <p>
              <strong>Vagas:</strong>
              <span class="info-vagas">{{ oficina.vagas }}</span>
              {% if oficina.vagas == 0 %}
                <span class="text-danger">(Esgotado)</span>
              {% endif %}
            </p>
            #}
            
            {% if permitir_checkin_global %}
              <!-- Check-in global: exibe somente o bot√£o de Check-in -->
              <a href="{{ url_for('routes.checkin', oficina_id=oficina.id) }}" class="btn btn-warning btn-block">
                Realizar Check-in
              </a>
            {% else %}
              {% if oficina.id in inscricoes_ids %}
                <!-- Usu√°rio j√° inscrito: exibe a√ß√µes de Check-in, Cancelamento e Comprovante -->
                <div class="d-flex flex-column gap-2">
                  <a href="{{ url_for('routes.checkin', oficina_id=oficina.id) }}" class="btn btn-warning btn-block">
                    Realizar Check-in
                  </a>
                  <form action="{{ url_for('routes.remover_inscricao', oficina_id=oficina.id) }}" method="post">
                    <button type="submit" class="btn btn-danger btn-block">Cancelar Inscri√ß√£o</button>
                  </form>
                  <a href="{{ url_for('routes.baixar_comprovante', oficina_id=oficina.id) }}" class="btn btn-primary btn-block">
                    üìÑ Baixar Comprovante
                  </a>
                </div>
              {% elif oficina.vagas > 0 %}
                <!-- Usu√°rio n√£o inscrito e ainda h√° vagas: exibe bot√£o de inscri√ß√£o -->
                <button onclick="inscrever('{{ oficina.id }}')" class="btn btn-success btn-block">
                  Inscrever-se
                </button>
              {% else %}
                <!-- Sem vagas -->
                <span class="text-danger d-block text-center mt-2">Vagas esgotadas</span>
              {% endif %}
            {% endif %}
          </div>
        </div>
      </div>
      {% endfor %}
    {% else %}
      <div class="col-12">
        <p class="text-center text-warning">Nenhuma oficina dispon√≠vel no momento.</p>
      </div>
    {% endif %}
  </div>
</div>

<footer class="text-center">
  <p>&copy; 2025 Sistema de Oficinas - Desenvolvido com Fiber</p>
</footer>

<!-- Script para inscri√ß√£o ass√≠ncrona -->
<script>
  function inscrever(oficinaId) {
    let oficinaCard = document.querySelector(`[data-oficina-id="${oficinaId}"]`);
    if (!oficinaCard) return;
    
    // Atualiza imediatamente o n√∫mero de vagas (se estiver sendo exibido)
    let vagasElement = oficinaCard.querySelector(".info-vagas");
    if (vagasElement) {
      let vagasAtualizadas = parseInt(vagasElement.innerText) - 1;
      vagasElement.innerText = vagasAtualizadas;
      if (vagasAtualizadas === 0) {
        vagasElement.innerHTML = '0 <span class="text-danger">(Esgotado)</span>';
      }
    }
    
    // Remove o bot√£o de inscri√ß√£o
    let botaoInscrever = oficinaCard.querySelector(".btn-success");
    if (botaoInscrever) {
      botaoInscrever.remove();
    }
    
    // Cria os bot√µes de Cancelar Inscri√ß√£o e Check-in
    let buttonContainer = oficinaCard.querySelector(".card-body");
    let div = document.createElement("div");
    div.className = "d-flex flex-column gap-2 mt-2";
    div.innerHTML = `
      <form action="/remover_inscricao/${oficinaId}" method="post">
        <button type="submit" class="btn btn-danger btn-block">Cancelar Inscri√ß√£o</button>
      </form>
      <a href="/checkin/${oficinaId}" class="btn btn-warning btn-block">Realizar Check-in</a>
    `;
    buttonContainer.appendChild(div);
    
    // Envia requisi√ß√£o ao servidor para registrar a inscri√ß√£o
    fetch(`/inscrever/${oficinaId}`, {
      method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        let comprovanteBtn = document.createElement("a");
        comprovanteBtn.setAttribute("href", data.pdf_url);
        comprovanteBtn.className = "btn btn-primary btn-block mt-2";
        comprovanteBtn.innerHTML = "üìÑ Baixar Comprovante";
        buttonContainer.appendChild(comprovanteBtn);
      } else {
        alert(data.message);
        location.reload();
      }
    })
    .catch(error => {
      console.error('Erro:', error);
      location.reload();
    });
  }
</script>
{% endblock %}
