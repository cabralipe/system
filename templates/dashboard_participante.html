{% extends "base.html" %}
{% block title %}Dashboard - Participante{% endblock %}

{% block content %}
<!-- CSS customizado para o Dashboard -->
<style>
  /* Cabe√ßalho do Dashboard */
  .dashboard-header {
    margin-top: 2rem;
    margin-bottom: 2rem;
  }
  .dashboard-header h2 {
    font-size: 2rem;
    font-weight: 700;
    color: #343a40;
  }
  .dashboard-header h3 {
    font-size: 1.25rem;
    color: #6c757d;
  }
  
  /* Cart√µes de oficina */
  .card {
    border: none;
    border-radius: 0.5rem;
    overflow: hidden;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  .card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0,0,0,0.1);
  }
  .card-header {
    background-color: #007bff;
    color: #fff;
    font-size: 1.25rem;
    font-weight: 600;
    text-align: center;
    padding: 0.75rem 1rem;
  }
  .card-body {
    padding: 1rem;
  }
  .card-body p {
    margin-bottom: 0.5rem;
    color: #495057;
  }
  .card-body ul {
    padding-left: 1.25rem;
    margin-bottom: 0.5rem;
  }
  .card-body li {
    margin-bottom: 0.25rem;
  }
  
  /* Bot√µes customizados */
  .btn-block {
    width: 100%;
    margin-bottom: 0.5rem;
  }
  .d-flex.flex-column.gap-2 > * {
    margin-bottom: 0.5rem;
  }

</style>

<div class="container">
  <div class="dashboard-header text-center">
    <h2>Bem-vindo(a), <b>{{ usuario.nome }}</b></h2>
    <h3>Abaixo voc√™ encontra as oficinas dispon√≠veis para inscri√ß√£o</h3>
  </div>

  {% if formularios_disponiveis %}
    <div class="mb-4">
        <a href="{{ url_for('routes.listar_formularios_participante') }}" class="btn btn-primary w-100 fw-bold">
            üìù Preencher Formul√°rios
        </a>
    </div>
  {% endif %}
  
  <div class="row">
    <!-- Obtem a lista de IDs das oficinas em que o usu√°rio j√° est√° inscrito -->
    {% set inscricoes_ids = usuario.inscricoes | map(attribute='oficina_id') | list %}
    
    {% if oficinas %}
      {% for oficina in oficinas %}
      <div class="col-md-6 col-lg-4 mb-4">
        <div class="card shadow-sm" data-oficina-id="{{ oficina.id }}">
          <div class="card-header">
            {{ oficina.titulo }}
          </div>
          <div class="card-body">
            <p><strong>Descri√ß√£o:</strong> {{ oficina.descricao }}</p>
            <p><strong>Ministrante:</strong> {{ oficina.ministrante }}</p>
            <p><strong>Datas e Hor√°rios:</strong></p>
            <ul class="list-unstyled">
              {% for dia in oficina.dias %}
                <li>üìÖ {{ dia.data.strftime('%d/%m/%Y') }} - üïí {{ dia.horario_inicio }} √†s {{ dia.horario_fim }}</li>
              {% endfor %}
            </ul>                               
            <p><strong>Carga Hor√°ria:</strong> {{ oficina.carga_horaria }} horas</p>
            
            <p>
              <strong>Vagas:</strong>
              <span class="info-vagas">{{ oficina.vagas }}</span>
              {% if oficina.vagas == 0 %}
                <span class="text-danger">(Esgotado)</span>
              {% endif %}
            </p>
            
            <!-- Se o participante j√° estiver inscrito nesta oficina -->
            {% if oficina.id in inscricoes_ids %}
                <div class="d-flex flex-column gap-2">
                    <!-- Check-in (s√≥ aparece se permitir_checkin_global == True) -->
                    {% if permitir_checkin_global %}
                    <a href="{{ url_for('routes.checkin', oficina_id=oficina.id) }}" class="btn btn-warning w-100">
                      Realizar Check-in
                    </a>
                    {% endif %}
                
                    <!-- Bot√£o para cancelar inscri√ß√£o -->
                    <form action="{{ url_for('routes.remover_inscricao', oficina_id=oficina.id) }}" method="post">
                        <button type="submit" class="btn btn-danger w-100">Cancelar Inscri√ß√£o</button>
                    </form>

                    <!-- Comprovante de Inscri√ß√£o -->
                    <a href="{{ url_for('routes.baixar_comprovante', oficina_id=oficina.id) }}" class="btn btn-primary w-100">
                        üìÑ Baixar Comprovante
                    </a>

                    <!-- Certificado Individual (s√≥ aparece se habilitar_certificado_individual == True) -->
                    {% if habilitar_certificado_individual %}
                    <a href="{{ url_for('routes.gerar_certificado_individual', oficina_id=oficina.id) }}"
                       class="btn btn-success w-100 mt-2">
                       üéì Baixar Certificado
                    </a>
                    {% endif %}
                  
                    <!-- Feedback (s√≥ aparece se habilitar_feedback == True) -->
                    {% if habilitar_feedback %}
                    <a href="{{ url_for('routes.feedback', oficina_id=oficina.id) }}" class="btn btn-info w-100 mt-2">
                        Enviar Feedback
                    </a>
                    {% endif %}
                </div>

            <!-- Se n√£o estiver inscrito ainda e houver vagas -->
            {% elif oficina.vagas > 0 %}
                <button onclick="inscrever('{{ oficina.id }}')" class="btn btn-success w-100">
                    Inscrever-se
                </button>

            <!-- Se n√£o houver vagas (mas se o usu√°rio j√° estiver inscrito, exibimos check-in, etc.) -->
            {% else %}
                <span class="text-danger d-block text-center mt-2">Vagas esgotadas</span>
                {% if oficina.id in inscricoes_ids %}
                    <div class="d-flex flex-column gap-2 mt-2">
                        {% if permitir_checkin_global %}
                        <a href="{{ url_for('routes.checkin', oficina_id=oficina.id) }}" class="btn btn-warning w-100">
                            Realizar Check-in
                        </a>
                        {% endif %}
                        <form action="{{ url_for('routes.remover_inscricao', oficina_id=oficina.id) }}" method="post">
                            <button type="submit" class="btn btn-danger w-100">Cancelar Inscri√ß√£o</button>
                        </form>
                        <a href="{{ url_for('routes.baixar_comprovante', oficina_id=oficina.id) }}" class="btn btn-primary w-100">
                            üìÑ Baixar Comprovante
                        </a>
                        {% if habilitar_feedback %}
                        <a href="{{ url_for('routes.feedback', oficina_id=oficina.id) }}" class="btn btn-info w-100 mt-2">
                            Enviar Feedback
                        </a>
                        {% endif %}
                    </div>
                {% endif %}
            {% endif %}

          </div> <!-- Fim card-body -->
        </div> <!-- Fim card -->
      </div> <!-- Fim col -->
      {% endfor %}
    {% else %}
      <div class="col-12">
        <p class="text-center text-warning">Nenhuma oficina dispon√≠vel no momento.</p>
      </div>
    {% endif %}
  </div> <!-- Fim row -->
</div> <!-- Fim container -->

<!-- Script para inscri√ß√£o ass√≠ncrona (se desejar manter) -->
<script>
function inscrever(oficinaId) {
    let oficinaCard = document.querySelector(`[data-oficina-id="${oficinaId}"]`);
    if (!oficinaCard) return;

    // Atualiza imediatamente o n√∫mero de vagas
    let vagasElement = oficinaCard.querySelector(".info-vagas");
    if (vagasElement) {
        let vagasAtualizadas = parseInt(vagasElement.innerText) - 1;
        vagasElement.innerText = vagasAtualizadas;
        if (vagasAtualizadas === 0) {
            vagasElement.innerHTML = '0 <span class="text-danger">(Esgotado)</span>';
        }
    }

    // Remove o bot√£o de inscri√ß√£o
    let botaoInscrever = oficinaCard.querySelector(".btn-success");
    if (botaoInscrever) {
        botaoInscrever.remove();
    }

    // Cria os bot√µes de Cancelar Inscri√ß√£o e Check-in
    let buttonContainer = oficinaCard.querySelector(".card-body");
    let div = document.createElement("div");
    div.className = "d-flex flex-column gap-2 mt-2";

    let checkinButton = `{% if permitir_checkin_global %} <a href="/checkin/${oficinaId}" class="btn btn-warning btn-block">Realizar Check-in</a> {% endif %}`;
    
    div.innerHTML = `
      <form action="/remover_inscricao/${oficinaId}" method="post">
        <button type="submit" class="btn btn-danger btn-block">Cancelar Inscri√ß√£o</button>
      </form>
      ${checkinButton}
    `;

    buttonContainer.appendChild(div);

    // Envia requisi√ß√£o ao servidor para registrar a inscri√ß√£o
    fetch(`/inscrever/${oficinaId}`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            let comprovanteBtn = document.createElement("a");
            comprovanteBtn.setAttribute("href", data.pdf_url);
            comprovanteBtn.className = "btn btn-primary btn-block mt-2";
            comprovanteBtn.innerHTML = "üìÑ Baixar Comprovante";
            buttonContainer.appendChild(comprovanteBtn);
        } else {
            alert(data.message);
            location.reload();
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        location.reload();
    });
}
</script>
{% endblock %}
