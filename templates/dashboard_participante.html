{% extends "base.html" %}
{% block title %}Dashboard - Participante{% endblock %}

{% block content %}
<div class="container mt-5">
    
    <h2 class="text-center text-dark mt-4">Bem-vindo(a), <b>{{ usuario.nome }}</b></h2>
    <h3 class="text-center text-secondary">Aqui est√£o as oficinas dispon√≠veis para inscri√ß√£o.</h3>

    <div class="row mt-4">
        {% set inscricoes_ids = usuario.inscricoes | map(attribute='oficina_id') | list %}

        {% if oficinas %}
            {% for oficina in oficinas %}
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card shadow-lg" data-oficina-id="{{ oficina.id }}">
                        <div class="card-header bg-primary text-white fw-bold text-center">
                            {{ oficina.titulo }}
                        </div>
                        <div class="card-body">
                            <p><strong>Descri√ß√£o:</strong> {{ oficina.descricao }}</p>
                            <p><strong>Ministrante:</strong> {{ oficina.ministrante }}</p>

                            <p><strong>Datas e Hor√°rios:</strong></p>
                            <ul class="list-unstyled">
                                {% for dia in oficina.dias %}
                                    <li>üìÖ {{ dia }}</li>
                                {% endfor %}
                            </ul>

                            <p><strong>Carga Hor√°ria:</strong> {{ oficina.carga_horaria }} horas</p>
                           <!-- <p><strong>Vagas:</strong> <span class="info-vagas">{{ oficina.vagas }}</span> 
                                {% if oficina.vagas == 0 %}
                                    <span class="text-danger">(Esgotado)</span>
                                {% endif %}
                            </p> -->


                            <div class="text-center">
                                {% if permitir_checkin_global or oficina.id in inscricoes_ids %}
                                    <a href="{{ url_for('routes.checkin', oficina_id=oficina.id) }}" class="btn btn-warning w-100">
                                        Realizar Check-in
                                    </a>
                                {% else %}
                                    {% if oficina.id in inscricoes_ids %}
                                        <div class="d-flex gap-2 w-100">
                                            <form action="{{ url_for('routes.remover_inscricao', oficina_id=oficina.id) }}" method="post">
                                                <button type="submit" class="btn btn-danger w-100">Cancelar Inscri√ß√£o</button>
                                            </form>
                                            {% for inscricao in usuario.inscricoes %}
                                                {% if inscricao.oficina.id == oficina.id %}
                                                    <a href="{{ url_for('routes.baixar_comprovante', oficina_id=inscricao.oficina.id) }}" class="btn btn-primary w-100">
                                                        üìÑ Baixar Comprovante
                                                    </a>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    {% elif oficina.vagas > 0 %}
                                        <button onclick="inscrever('{{ oficina.id }}')" class="btn btn-success w-100">
                                            Inscrever-se
                                        </button>
                                    {% else %}
                                        <span class="text-danger d-block text-center mt-2">Vagas esgotadas</span>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <p class="text-center text-warning mt-4">Nenhuma oficina dispon√≠vel no momento.</p>
        {% endif %}
    </div>
</div>

<!-- Rodap√© -->
<footer class="text-center text-white bg-dark p-3 mt-4">
    <p>&copy; 2025 Sistema de Oficinas - Desenvolvido com Fiber</p>
</footer>

<script>
    function inscrever(oficinaId) {
        let oficinaCard = document.querySelector(`[data-oficina-id="${oficinaId}"]`);
        
        if (!oficinaCard) return;

        // Atualizar imediatamente o n√∫mero de vagas antes da requisi√ß√£o
        let vagasElement = oficinaCard.querySelector(".info-vagas");
        if (vagasElement) {
            let vagasAtualizadas = parseInt(vagasElement.innerText) - 1;
            vagasElement.innerText = vagasAtualizadas;
            if (vagasAtualizadas === 0) {
                vagasElement.innerHTML = '0 <span class="text-danger">(Esgotado)</span>';
            }
        }

        // Remover o bot√£o de inscri√ß√£o imediatamente
        let botaoInscrever = oficinaCard.querySelector(".btn-success");
        if (botaoInscrever) {
            botaoInscrever.remove();
        }

        // Criar bot√µes de Cancelar Inscri√ß√£o e Check-in instantaneamente
        let cancelarBtn = document.createElement("form");
        cancelarBtn.setAttribute("action", `/remover_inscricao/${oficinaId}`);
        cancelarBtn.setAttribute("method", "post");
        cancelarBtn.innerHTML = `<button type="submit" class="btn btn-danger w-100">Cancelar Inscri√ß√£o</button>`;

        let checkinBtn = document.createElement("a");
        checkinBtn.setAttribute("href", `/checkin/${oficinaId}`);
        checkinBtn.setAttribute("class", "btn btn-warning mt-2 w-100");
        checkinBtn.innerHTML = "Realizar Check-in";

        // Adicionar bot√µes no card da oficina
        let buttonContainer = oficinaCard.querySelector(".text-center");
        buttonContainer.appendChild(cancelarBtn);
        buttonContainer.appendChild(checkinBtn);

        // Enviar requisi√ß√£o ao servidor
        fetch(`/inscrever/${oficinaId}`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Criar bot√£o de baixar comprovante ap√≥s sucesso da inscri√ß√£o
                let comprovanteBtn = document.createElement("a");
                comprovanteBtn.setAttribute("href", data.pdf_url);
                comprovanteBtn.setAttribute("class", "btn btn-primary w-100 mt-2");
                comprovanteBtn.innerHTML = "üìÑ Baixar Comprovante";
                
                buttonContainer.appendChild(comprovanteBtn);
            } else {
                alert(data.message);
                location.reload(); // Recarregar a p√°gina se houver erro
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            location.reload(); // Recarregar a p√°gina se houver erro
        });
    }
</script>

{% endblock %}
