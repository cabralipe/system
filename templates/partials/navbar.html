{% set current_path = request.path %}

<!-- Navbar stylesheet -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/navbar.css') }}">

<nav class="navbar navbar-expand-lg navbar-light fixed-top">
  <div class="container">
    <a class="navbar-brand" href="{{ url_for('evento_routes.home') }}">
      App<span>Fiber</span>
    </a>

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
            data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
            aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ms-auto mb-2 mb-lg-0">

        <!-- Botão modal de revisores -->
        <li class="nav-item ms-lg-3">
          <a class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#revisorModal">
            Revisores
          </a>
        </li>



        {% if not current_user.is_authenticated %}
          <!-- Ações para visitantes -->
          <li class="nav-item ms-lg-3">
            <a class="btn btn-register" data-bs-toggle="modal" data-bs-target="#criarContaModal">
              Criar Conta
            </a>
          </li>
          <li class="nav-item ms-lg-3">
            <a class="btn btn-login" href="{{ url_for('auth_routes.login') }}">Entrar</a>
          </li>
        {% else %}
          <!-- Dashboards e perfis -->
          {% if current_user.tipo == 'participante' %}
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('inscricao_routes.editar_participante') }}">
                <i class="bi bi-person-badge"></i> Perfil
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('dashboard_participante_routes.dashboard_participante') }}">
                <i class="bi bi-speedometer2"></i> Dashboard
              </a>
            </li>
          {% elif current_user.tipo == 'cliente' %}
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('dashboard_routes.dashboard_cliente') }}">
                <i class="bi bi-speedometer2"></i> Dashboard
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('evento_routes.meus_eventos') }}">
                <i class="bi bi-calendar-event"></i> Meus Eventos
              </a>
            </li>
          {% elif current_user.tipo == 'ministrante' %}
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('formador_routes.dashboard_formador') }}">
                <i class="bi bi-speedometer2"></i> Dashboard
              </a>
            </li>
          {% elif current_user.tipo == 'admin' %}
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('dashboard_routes.dashboard') }}">
                <i class="bi bi-speedometer2"></i> Dashboard
              </a>
            </li>
          {% endif %}

          <!-- Impersonação -->
          {% if session.get('impersonator_id') %}
            <li class="nav-item">
              <a class="nav-link text-warning" href="{{ url_for('dashboard_routes.encerrar_impersonacao') }}">
                <i class="bi bi-x-circle"></i>
                {% if session.get('user_type') == 'cliente' %}
                  Sair do modo cliente
                {% else %}
                  Sair do modo usuário
                {% endif %}
              </a>
            </li>
          {% endif %}

          <!-- Logout -->
          <li class="nav-item">
            <a class="nav-link text-danger" href="{{ url_for('auth_routes.logout') }}">
              <i class="bi bi-box-arrow-right"></i> Sair
            </a>
          </li>
        {% endif %}
      </ul>
    </div>
  </div>
</nav>

<!-- ======================= MODAL REVISOR ======================= -->
<div class="modal fade" id="revisorModal" tabindex="-1" aria-labelledby="revisorModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="revisorModalLabel">Acesso dos Revisores</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <!-- Acesso para revisores já cadastrados -->
        <p>Para acessar suas tarefas de revisão, insira abaixo o código da candidatura.</p>
        <form method="get" action="{{ url_for('revisor_routes.progress_query') }}">
          <div class="mb-3">
            <label for="codigoAcomp" class="form-label">Código da Candidatura</label>
            <input type="text" class="form-control" id="codigoAcomp" name="codigo">
          </div>
          <button type="submit" class="btn btn-secondary">Acompanhar</button>
        </form>

        <!-- Candidatura ou acompanhamento -->
        <hr class="my-4">
        <h6 class="fw-bold text-primary text-center mb-2">Novo cadastro</h6>
        <a class="btn btn-outline-success w-100 mb-2"
           href="{{ url_for('revisor_routes.select_event') }}">
          Quero ser revisor
        </a>
      </div>
    </div>
  </div>
</div>

<!-- ======================= MODAL CRIAR CONTA ======================= -->
<div class="modal fade" id="criarContaModal" tabindex="-1" aria-labelledby="criarContaModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="criarContaModalLabel">
          <i class="bi bi-info-circle text-primary me-2"></i>
          Informação Importante
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <div class="text-center mb-4">
          <i class="bi bi-building text-primary" style="font-size: 3rem;"></i>
        </div>
        
        <div class="alert alert-info" role="alert">
          <h6 class="alert-heading">
            <i class="bi bi-exclamation-triangle me-2"></i>
            Atenção!
          </h6>
          <p class="mb-0">
            A opção <strong>"Criar Conta"</strong> é destinada a <strong>pessoas que gerenciam eventos</strong> 
            (organizadores, empresas, instituições).
          </p>
        </div>

        <div class="alert alert-success" role="alert">
          <h6 class="alert-heading">
            <i class="bi bi-calendar-check me-2"></i>
            Quer se inscrever em um evento?
          </h6>
          <p class="mb-0">
            Se você deseja <strong>participar de um evento</strong>, role a página para baixo 
            e procure o evento desejado. Lá você encontrará a opção para se inscrever.
          </p>
        </div>

        <div class="d-grid gap-2">
          <button type="button" class="btn btn-outline-primary" onclick="scrollToEvents()">
            <i class="bi bi-arrow-down-circle me-2"></i>
            Procurar Eventos
          </button>
          <button type="button" class="btn btn-primary" onclick="proceedToCreateAccount()">
            <i class="bi bi-building me-2"></i>
            Sou Organizador - Criar Conta
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- =================== JS: ACTIVE LINKS & SCROLL EFFECT =================== -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const currentPath = window.location.pathname;
    const currentHash = window.location.hash;

    const isHomePage = currentPath === '/' ||
                       currentPath === '/index' ||
                       currentPath === '/index.html';

    const navLinks = document.querySelectorAll('.navbar .nav-link');

    // Helpers
    const clearActive = () => navLinks.forEach(link => link.classList.remove('active'));
    const setActive   = selector => document.querySelector(selector)?.classList.add('active');

    // Estado inicial
    clearActive();
    if (isHomePage) {
      if (currentHash) {
        setActive(`.navbar .${currentHash.substring(1)}-link`);
      } else {
        setActive('.navbar .home-link');
      }
    }

    // Scroll spy simples (apenas na home)
    if (isHomePage) {
      window.addEventListener('scroll', () => {
        const scrollY = window.scrollY;

        const homeSection     = document.querySelector('#home');
        const eventosSection  = document.querySelector('#eventos');
        const recursosSection = document.querySelector('#recursos');
        const contatoSection  = document.querySelector('#contato');

        clearActive();

        if (homeSection && scrollY < (eventosSection?.offsetTop || 0) - 100) {
          setActive('.navbar .home-link');
        } else if (eventosSection && scrollY < (recursosSection?.offsetTop || 0) - 100) {
          setActive('.navbar .eventos-link');
        } else if (recursosSection && scrollY < (contatoSection?.offsetTop || 0) - 100) {
          setActive('.navbar .recursos-link');
        } else {
          setActive('.navbar .contato-link');
        }
      });
    }

    // Altera o background da navbar ao rolar
    const toggleScrolledClass = () => {
      document.querySelector('.navbar').classList.toggle('scrolled', window.scrollY > 50);
    };

    window.addEventListener('scroll', toggleScrolledClass);
    toggleScrolledClass(); // executa uma vez no load
  });

  // Função para rolar até a seção de eventos
  function scrollToEvents() {
    // Fecha o modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('criarContaModal'));
    if (modal) {
      modal.hide();
    }
    
    // Procura pela seção de eventos na página
    const eventosSection = document.querySelector('#eventos') || 
                          document.querySelector('.eventos') || 
                          document.querySelector('[class*="evento"]');
    
    if (eventosSection) {
      eventosSection.scrollIntoView({ 
        behavior: 'smooth',
        block: 'start'
      });
    } else {
      // Se não encontrar seção específica, rola para baixo
      window.scrollTo({
        top: window.innerHeight,
        behavior: 'smooth'
      });
    }
  }

  // Função para prosseguir com criação de conta
  function proceedToCreateAccount() {
    // Fecha o modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('criarContaModal'));
    if (modal) {
      modal.hide();
    }
    
    // Redireciona para a página de cadastro
    window.location.href = "{{ url_for('auth_routes.cadastrar_cliente_publico') }}";
  }
</script>
