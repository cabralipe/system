{% extends "base.html" %}

{% block title %}Categorias de Submissão - {{ evento.nome }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-tags"></i>
                        Categorias de Submissão
                    </h3>
                    <div class="card-tools">
                        <span class="badge badge-info">{{ evento.nome }}</span>
                        <button type="button" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#addCategoryModal">
                            <i class="fas fa-plus"></i> Nova Categoria
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-2">
                            <a href="{{ url_for('submission_distribution.distribution_dashboard', evento_id=evento.id) }}" class="btn btn-secondary btn-block">
                                <i class="fas fa-arrow-left"></i> Voltar
                            </a>
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-success btn-block" id="import-btn">
                                <i class="fas fa-file-import"></i> Importar
                            </button>
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-info btn-block" id="export-btn">
                                <i class="fas fa-file-export"></i> Exportar
                            </button>
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-warning btn-block" id="normalize-btn">
                                <i class="fas fa-magic"></i> Normalizar
                            </button>
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-outline-primary btn-block" id="stats-btn">
                                <i class="fas fa-chart-pie"></i> Estatísticas
                            </button>
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-outline-secondary btn-block" id="refresh-btn">
                                <i class="fas fa-sync"></i> Atualizar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Estatísticas -->
    <div class="row mb-3">
        <div class="col-md-3">
            <div class="info-box">
                <span class="info-box-icon bg-primary"><i class="fas fa-tags"></i></span>
                <div class="info-box-content">
                    <span class="info-box-text">Total de Categorias</span>
                    <span class="info-box-number">{{ categories|length }}</span>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="info-box">
                <span class="info-box-icon bg-success"><i class="fas fa-check-circle"></i></span>
                <div class="info-box-content">
                    <span class="info-box-text">Ativas</span>
                    <span class="info-box-number">{{ categories|selectattr('active')|list|length }}</span>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="info-box">
                <span class="info-box-icon bg-info"><i class="fas fa-file-alt"></i></span>
                <div class="info-box-content">
                    <span class="info-box-text">Com Submissões</span>
                    <span class="info-box-number">{{ categories|selectattr('submission_count')|selectattr('submission_count', '>', 0)|list|length }}</span>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="info-box">
                <span class="info-box-icon bg-warning"><i class="fas fa-users"></i></span>
                <div class="info-box-content">
                    <span class="info-box-text">Com Revisores</span>
                    <span class="info-box-number">{{ categories|selectattr('reviewer_count')|selectattr('reviewer_count', '>', 0)|list|length }}</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Lista de Categorias -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Lista de Categorias</h3>
                    <div class="card-tools">
                        <div class="input-group input-group-sm" style="width: 250px;">
                            <input type="text" name="table_search" class="form-control float-right" placeholder="Buscar categoria..." id="search-input">
                            <div class="input-group-append">
                                <button type="submit" class="btn btn-default">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body table-responsive p-0">
                    <table class="table table-hover text-nowrap" id="categories-table">
                        <thead>
                            <tr>
                                <th>Categoria</th>
                                <th>Descrição</th>
                                <th>Submissões</th>
                                <th>Revisores</th>
                                <th>Afinidade Média</th>
                                <th>Status</th>
                                <th>Criada em</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for category in categories %}
                            <tr data-category-id="{{ category.id }}">
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="category-color mr-2" 
                                             style="width: 20px; height: 20px; background-color: {{ category.color or '#6c757d' }}; border-radius: 3px;"></div>
                                        <div>
                                            <strong>{{ category.name }}</strong>
                                            {% if category.keywords %}
                                            <br><small class="text-muted">{{ category.keywords[:50] }}...</small>
                                            {% endif %}
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span title="{{ category.description or 'Sem descrição' }}">
                                        {{ (category.description or 'Sem descrição')[:60] }}{% if category.description and category.description|length > 60 %}...{% endif %}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge badge-info">{{ category.submission_count or 0 }}</span>
                                    {% if category.submission_count > 0 %}
                                    <button type="button" class="btn btn-xs btn-outline-info ml-1" 
                                            onclick="viewSubmissions({{ category.id }})" title="Ver submissões">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge badge-success">{{ category.reviewer_count or 0 }}</span>
                                    {% if category.reviewer_count > 0 %}
                                    <button type="button" class="btn btn-xs btn-outline-success ml-1" 
                                            onclick="viewReviewers({{ category.id }})" title="Ver revisores">
                                        <i class="fas fa-users"></i>
                                    </button>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if category.avg_affinity %}
                                    <div class="progress progress-sm">
                                        <div class="progress-bar bg-{{ 'success' if category.avg_affinity >= 2.5 else 'warning' if category.avg_affinity >= 1.5 else 'danger' }}" 
                                             style="width: {{ (category.avg_affinity / 3 * 100)|round }}%"></div>
                                    </div>
                                    <small>{{ "%.1f"|format(category.avg_affinity) }}/3.0</small>
                                    {% else %}
                                    <span class="text-muted">N/A</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge badge-{{ 'success' if category.active else 'secondary' }}">
                                        {{ 'Ativa' if category.active else 'Inativa' }}
                                    </span>
                                </td>
                                <td>
                                    <small>{{ category.created_at.strftime('%d/%m/%Y') if category.created_at else 'N/A' }}</small>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button type="button" class="btn btn-info" 
                                                onclick="viewCategory({{ category.id }})" title="Visualizar">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button type="button" class="btn btn-warning" 
                                                onclick="editCategory({{ category.id }})" title="Editar">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button type="button" class="btn btn-secondary" 
                                                onclick="manageKeywords({{ category.id }})" title="Palavras-chave">
                                            <i class="fas fa-key"></i>
                                        </button>
                                        <button type="button" class="btn btn-{{ 'danger' if category.active else 'success' }}" 
                                                onclick="toggleStatus({{ category.id }})" 
                                                title="{{ 'Desativar' if category.active else 'Ativar' }}">
                                            <i class="fas fa-{{ 'times' if category.active else 'check' }}"></i>
                                        </button>
                                        {% if not category.submission_count %}
                                        <button type="button" class="btn btn-danger" 
                                                onclick="deleteCategory({{ category.id }})" title="Excluir">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    
                    {% if not categories %}
                    <div class="text-center py-5">
                        <i class="fas fa-tags fa-3x text-muted mb-3"></i>
                        <h4>Nenhuma categoria cadastrada</h4>
                        <p class="text-muted">Crie categorias para organizar as submissões.</p>
                        <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#addCategoryModal">
                            <i class="fas fa-plus"></i> Criar Primeira Categoria
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Adicionar Categoria -->
<div class="modal fade" id="addCategoryModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Nova Categoria</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <form method="POST" action="{{ url_for('submission_distribution.add_category', evento_id=evento.id) }}">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="form-group">
                                <label for="name">Nome da Categoria *</label>
                                <input type="text" class="form-control" id="name" name="name" 
                                       placeholder="Ex: Matemática" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="color">Cor</label>
                                <input type="color" class="form-control" id="color" name="color" value="#007bff">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="description">Descrição</label>
                        <textarea class="form-control" id="description" name="description" rows="3" 
                                  placeholder="Descreva o escopo e características desta categoria..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="keywords">Palavras-chave</label>
                        <input type="text" class="form-control" id="keywords" name="keywords" 
                               placeholder="matemática, álgebra, geometria, cálculo">
                        <small class="form-text text-muted">Separe as palavras-chave por vírgula. Usado para normalização automática.</small>
                    </div>
                    
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="active" name="active" checked>
                        <label class="form-check-label" for="active">
                            Categoria ativa
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Criar Categoria</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Editar Categoria -->
<div class="modal fade" id="editCategoryModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Editar Categoria</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <form id="edit-category-form">
                <div class="modal-body">
                    <div id="edit-category-content">
                        <!-- Preenchido via JavaScript -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Visualizar Categoria -->
<div class="modal fade" id="viewCategoryModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalhes da Categoria</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="category-details">
                    <!-- Preenchido via JavaScript -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Normalização -->
<div class="modal fade" id="normalizeModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-xl" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Normalização de Categorias</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="normalize-content">
                    <!-- Preenchido via JavaScript -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="apply-normalization-btn">Aplicar Normalização</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentCategoryId = null;

$(document).ready(function() {
    // Inicializar DataTable
    $('#categories-table').DataTable({
        "pageLength": 25,
        "order": [[ 0, "asc" ]],
        "columnDefs": [
            { "orderable": false, "targets": [7] }
        ],
        "language": {
            "url": "//cdn.datatables.net/plug-ins/1.10.24/i18n/Portuguese-Brasil.json"
        }
    });
    
    // Botões de ação
    $('#refresh-btn').on('click', function() {
        location.reload();
    });
    
    $('#normalize-btn').on('click', function() {
        showNormalizationModal();
    });
    
    $('#stats-btn').on('click', function() {
        showCategoryStats();
    });
    
    $('#export-btn').on('click', function() {
        exportCategories();
    });
    
    $('#import-btn').on('click', function() {
        alert('Funcionalidade de importação será implementada.');
    });
    
    // Form de edição
    $('#edit-category-form').on('submit', function(e) {
        e.preventDefault();
        saveCategory();
    });
    
    // Aplicar normalização
    $('#apply-normalization-btn').on('click', function() {
        applyNormalization();
    });
});

function viewCategory(categoryId) {
    $.get(`/api/categories/${categoryId}`, function(data) {
        const html = `
            <div class="row">
                <div class="col-md-12">
                    <div class="d-flex align-items-center mb-3">
                        <div class="category-color mr-3" 
                             style="width: 40px; height: 40px; background-color: ${data.color || '#6c757d'}; border-radius: 5px;"></div>
                        <div>
                            <h4 class="mb-0">${data.name}</h4>
                            <span class="badge badge-${data.active ? 'success' : 'secondary'}">${data.active ? 'Ativa' : 'Inativa'}</span>
                        </div>
                    </div>
                    
                    <table class="table table-borderless">
                        <tr>
                            <th width="150">Descrição:</th>
                            <td>${data.description || 'Sem descrição'}</td>
                        </tr>
                        <tr>
                            <th>Palavras-chave:</th>
                            <td>${data.keywords || 'Nenhuma palavra-chave definida'}</td>
                        </tr>
                        <tr>
                            <th>Submissões:</th>
                            <td>${data.submission_count || 0} trabalho(s)</td>
                        </tr>
                        <tr>
                            <th>Revisores:</th>
                            <td>${data.reviewer_count || 0} revisor(es) com preferência</td>
                        </tr>
                        <tr>
                            <th>Afinidade Média:</th>
                            <td>${data.avg_affinity ? data.avg_affinity.toFixed(1) + '/3.0' : 'N/A'}</td>
                        </tr>
                        <tr>
                            <th>Criada em:</th>
                            <td>${new Date(data.created_at).toLocaleDateString('pt-BR')}</td>
                        </tr>
                    </table>
                </div>
            </div>
        `;
        
        $('#category-details').html(html);
        $('#viewCategoryModal').modal('show');
    }).fail(function() {
        alert('Erro ao carregar detalhes da categoria.');
    });
}

function editCategory(categoryId) {
    currentCategoryId = categoryId;
    
    $.get(`/api/categories/${categoryId}`, function(data) {
        const html = `
            <div class="row">
                <div class="col-md-8">
                    <div class="form-group">
                        <label for="edit_name">Nome da Categoria *</label>
                        <input type="text" class="form-control" id="edit_name" name="name" 
                               value="${data.name}" required>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="edit_color">Cor</label>
                        <input type="color" class="form-control" id="edit_color" name="color" 
                               value="${data.color || '#007bff'}">
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="edit_description">Descrição</label>
                <textarea class="form-control" id="edit_description" name="description" rows="3">${data.description || ''}</textarea>
            </div>
            
            <div class="form-group">
                <label for="edit_keywords">Palavras-chave</label>
                <input type="text" class="form-control" id="edit_keywords" name="keywords" 
                       value="${data.keywords || ''}">
                <small class="form-text text-muted">Separe as palavras-chave por vírgula.</small>
            </div>
            
            <div class="form-check">
                <input type="checkbox" class="form-check-input" id="edit_active" name="active" ${data.active ? 'checked' : ''}>
                <label class="form-check-label" for="edit_active">
                    Categoria ativa
                </label>
            </div>
        `;
        
        $('#edit-category-content').html(html);
        $('#editCategoryModal').modal('show');
    }).fail(function() {
        alert('Erro ao carregar dados da categoria.');
    });
}

function saveCategory() {
    if (!currentCategoryId) return;
    
    const formData = {
        name: $('#edit_name').val(),
        description: $('#edit_description').val(),
        keywords: $('#edit_keywords').val(),
        color: $('#edit_color').val(),
        active: $('#edit_active').is(':checked')
    };
    
    $.ajax({
        url: `/api/categories/${currentCategoryId}`,
        method: 'PUT',
        contentType: 'application/json',
        data: JSON.stringify(formData),
        success: function(response) {
            if (response.success) {
                alert('Categoria atualizada com sucesso!');
                $('#editCategoryModal').modal('hide');
                location.reload();
            } else {
                alert('Erro ao atualizar categoria: ' + response.error);
            }
        },
        error: function() {
            alert('Erro na comunicação com o servidor.');
        }
    });
}

function toggleStatus(categoryId) {
    if (!confirm('Confirma a alteração de status desta categoria?')) {
        return;
    }
    
    $.ajax({
        url: `/api/categories/${categoryId}/toggle-status`,
        method: 'POST',
        success: function(response) {
            if (response.success) {
                location.reload();
            } else {
                alert('Erro ao alterar status: ' + response.error);
            }
        },
        error: function() {
            alert('Erro na comunicação com o servidor.');
        }
    });
}

function deleteCategory(categoryId) {
    if (!confirm('Tem certeza que deseja excluir esta categoria? Esta ação não pode ser desfeita.')) {
        return;
    }
    
    $.ajax({
        url: `/api/categories/${categoryId}`,
        method: 'DELETE',
        success: function(response) {
            if (response.success) {
                alert('Categoria excluída com sucesso!');
                location.reload();
            } else {
                alert('Erro ao excluir categoria: ' + response.error);
            }
        },
        error: function() {
            alert('Erro na comunicação com o servidor.');
        }
    });
}

function manageKeywords(categoryId) {
    alert('Funcionalidade de gestão de palavras-chave será implementada.');
}

function viewSubmissions(categoryId) {
    window.open(`/submissions?category_id=${categoryId}`, '_blank');
}

function viewReviewers(categoryId) {
    window.open(`/reviewers?category_id=${categoryId}`, '_blank');
}

function showNormalizationModal() {
    $.get(`/api/categories/{{ evento.id }}/normalization-suggestions`, function(data) {
        if (data.suggestions.length === 0) {
            alert('Nenhuma sugestão de normalização encontrada.');
            return;
        }
        
        const html = `
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                <strong>Normalização Automática</strong><br>
                O sistema identificou possíveis duplicatas ou variações de categorias. Revise as sugestões abaixo:
            </div>
            
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Categoria Principal</th>
                            <th>Variações Encontradas</th>
                            <th>Ação</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.suggestions.map(suggestion => `
                            <tr>
                                <td>
                                    <strong>${suggestion.main_category}</strong>
                                    <br><small class="text-muted">${suggestion.submissions_count} submissões</small>
                                </td>
                                <td>
                                    ${suggestion.variations.map(variation => `
                                        <span class="badge badge-secondary mr-1">${variation.name} (${variation.count})</span>
                                    `).join('')}
                                </td>
                                <td>
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input normalization-check" 
                                               data-suggestion='${JSON.stringify(suggestion)}' checked>
                                        <label class="form-check-label">Aplicar</label>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
        
        $('#normalize-content').html(html);
        $('#normalizeModal').modal('show');
    }).fail(function() {
        alert('Erro ao carregar sugestões de normalização.');
    });
}

function applyNormalization() {
    const suggestions = [];
    $('.normalization-check:checked').each(function() {
        suggestions.push(JSON.parse($(this).data('suggestion')));
    });
    
    if (suggestions.length === 0) {
        alert('Selecione pelo menos uma sugestão para aplicar.');
        return;
    }
    
    if (!confirm(`Confirma a aplicação de ${suggestions.length} normalização(ões)?`)) {
        return;
    }
    
    $.ajax({
        url: `/api/categories/{{ evento.id }}/apply-normalization`,
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ suggestions: suggestions }),
        success: function(response) {
            if (response.success) {
                alert(`Normalização aplicada com sucesso! ${response.merged_count} categoria(s) mesclada(s).`);
                $('#normalizeModal').modal('hide');
                location.reload();
            } else {
                alert('Erro ao aplicar normalização: ' + response.error);
            }
        },
        error: function() {
            alert('Erro na comunicação com o servidor.');
        }
    });
}

function showCategoryStats() {
    alert('Funcionalidade de estatísticas detalhadas será implementada.');
}

function exportCategories() {
    window.open(`/api/categories/{{ evento.id }}/export`, '_blank');
}
</script>
{% endblock %}