{% extends "base.html" %}

{% block title %}Gestão de Revisores - {{ evento.nome }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-users"></i>
                        Gestão de Revisores
                    </h3>
                    <div class="card-tools">
                        <span class="badge badge-info">{{ evento.nome }}</span>
                        <button type="button" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#addReviewerModal">
                            <i class="fas fa-plus"></i> Adicionar Revisor
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-2">
                            <a href="{{ url_for('submission_distribution.distribution_dashboard', evento_id=evento.id) }}" class="btn btn-secondary btn-block">
                                <i class="fas fa-arrow-left"></i> Voltar
                            </a>
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-success btn-block" id="bulk-import-btn">
                                <i class="fas fa-file-import"></i> Importar
                            </button>
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-info btn-block" id="export-btn">
                                <i class="fas fa-file-export"></i> Exportar
                            </button>
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-warning btn-block" id="preferences-btn">
                                <i class="fas fa-heart"></i> Preferências
                            </button>
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-outline-primary btn-block" id="stats-btn">
                                <i class="fas fa-chart-bar"></i> Estatísticas
                            </button>
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-outline-secondary btn-block" id="refresh-btn">
                                <i class="fas fa-sync"></i> Atualizar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Estatísticas -->
    <div class="row mb-3">
        <div class="col-md-3">
            <div class="info-box">
                <span class="info-box-icon bg-info"><i class="fas fa-users"></i></span>
                <div class="info-box-content">
                    <span class="info-box-text">Total de Revisores</span>
                    <span class="info-box-number">{{ reviewers|length }}</span>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="info-box">
                <span class="info-box-icon bg-success"><i class="fas fa-check-circle"></i></span>
                <div class="info-box-content">
                    <span class="info-box-text">Disponíveis</span>
                    <span class="info-box-number">{{ reviewers|selectattr('available')|list|length }}</span>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="info-box">
                <span class="info-box-icon bg-warning"><i class="fas fa-tasks"></i></span>
                <div class="info-box-content">
                    <span class="info-box-text">Carga Média</span>
                    <span class="info-box-number">{{ "%.1f"|format(reviewers|map(attribute='current_load')|sum / reviewers|length if reviewers else 0) }}</span>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="info-box">
                <span class="info-box-icon bg-danger"><i class="fas fa-heart"></i></span>
                <div class="info-box-content">
                    <span class="info-box-text">Com Preferências</span>
                    <span class="info-box-number">{{ reviewers|selectattr('preferences')|list|length }}</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Lista de Revisores -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Lista de Revisores</h3>
                    <div class="card-tools">
                        <div class="input-group input-group-sm" style="width: 250px;">
                            <input type="text" name="table_search" class="form-control float-right" placeholder="Buscar revisor..." id="search-input">
                            <div class="input-group-append">
                                <button type="submit" class="btn btn-default">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body table-responsive p-0">
                    <table class="table table-hover text-nowrap" id="reviewers-table">
                        <thead>
                            <tr>
                                <th>Revisor</th>
                                <th>E-mail</th>
                                <th>Instituição</th>
                                <th>Capacidade</th>
                                <th>Carga Atual</th>
                                <th>Disponibilidade</th>
                                <th>Preferências</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for reviewer in reviewers %}
                            <tr data-reviewer-id="{{ reviewer.id }}">
                                <td>
                                    <div class="user-panel d-flex">
                                        <div class="image">
                                            <img src="{{ reviewer.usuario.avatar_url if reviewer.usuario and reviewer.usuario.avatar_url else '/static/img/default-avatar.png' }}" 
                                                 class="img-circle elevation-2" alt="Avatar" style="width: 32px; height: 32px;">
                                        </div>
                                        <div class="info">
                                            <strong>{{ reviewer.usuario.nome if reviewer.usuario else 'N/A' }}</strong>
                                            {% if reviewer.expertise_areas %}
                                            <br><small class="text-muted">{{ reviewer.expertise_areas[:50] }}...</small>
                                            {% endif %}
                                        </div>
                                    </div>
                                </td>
                                <td>{{ reviewer.usuario.email if reviewer.usuario else 'N/A' }}</td>
                                <td>{{ reviewer.institution or 'Não informada' }}</td>
                                <td>
                                    <span class="badge badge-info">{{ reviewer.max_assignments }}</span>
                                </td>
                                <td>
                                    <div class="progress progress-sm">
                                        <div class="progress-bar bg-{{ 'danger' if reviewer.availability_percentage < 20 else 'warning' if reviewer.availability_percentage < 50 else 'success' }}" 
                                             style="width: {{ reviewer.availability_percentage }}%"></div>
                                    </div>
                                    <small>{{ reviewer.current_load }}/{{ reviewer.max_assignments }}</small>
                                </td>
                                <td>
                                    <span class="badge badge-{{ 'success' if reviewer.availability_percentage > 50 else 'warning' if reviewer.availability_percentage > 20 else 'danger' }}">
                                        {{ "%.0f"|format(reviewer.availability_percentage) }}%
                                    </span>
                                </td>
                                <td>
                                    {% if reviewer.preferences %}
                                    <button type="button" class="btn btn-sm btn-outline-info" 
                                            onclick="showPreferences({{ reviewer.id }})">
                                        <i class="fas fa-heart"></i> {{ reviewer.preferences|length }}
                                    </button>
                                    {% else %}
                                    <button type="button" class="btn btn-sm btn-outline-secondary" 
                                            onclick="editPreferences({{ reviewer.id }})">
                                        <i class="fas fa-plus"></i> Definir
                                    </button>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if reviewer.available %}
                                    <span class="badge badge-success">Disponível</span>
                                    {% else %}
                                    <span class="badge badge-danger">Indisponível</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button type="button" class="btn btn-info" 
                                                onclick="viewReviewer({{ reviewer.id }})" title="Visualizar">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button type="button" class="btn btn-warning" 
                                                onclick="editReviewer({{ reviewer.id }})" title="Editar">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button type="button" class="btn btn-secondary" 
                                                onclick="editPreferences({{ reviewer.id }})" title="Preferências">
                                            <i class="fas fa-heart"></i>
                                        </button>
                                        <button type="button" class="btn btn-{{ 'danger' if reviewer.available else 'success' }}" 
                                                onclick="toggleAvailability({{ reviewer.id }})" 
                                                title="{{ 'Desativar' if reviewer.available else 'Ativar' }}">
                                            <i class="fas fa-{{ 'times' if reviewer.available else 'check' }}"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    
                    {% if not reviewers %}
                    <div class="text-center py-5">
                        <i class="fas fa-users fa-3x text-muted mb-3"></i>
                        <h4>Nenhum revisor cadastrado</h4>
                        <p class="text-muted">Adicione revisores para começar a distribuir trabalhos.</p>
                        <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#addReviewerModal">
                            <i class="fas fa-plus"></i> Adicionar Primeiro Revisor
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Adicionar Revisor -->
<div class="modal fade" id="addReviewerModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Adicionar Revisor</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <form method="POST" action="{{ url_for('submission_distribution.add_reviewer', evento_id=evento.id) }}">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="usuario_id">Usuário *</label>
                                <select class="form-control select2" id="usuario_id" name="usuario_id" required>
                                    <option value="">Selecione um usuário...</option>
                                    <!-- Preenchido via AJAX -->
                                </select>
                                <small class="form-text text-muted">Busque por nome ou e-mail</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="max_assignments">Capacidade Máxima *</label>
                                <input type="number" class="form-control" id="max_assignments" name="max_assignments" 
                                       value="15" min="1" max="50" required>
                                <small class="form-text text-muted">Número máximo de trabalhos</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="institution">Instituição</label>
                        <input type="text" class="form-control" id="institution" name="institution" 
                               placeholder="Ex: Universidade Federal do ABC">
                    </div>
                    
                    <div class="form-group">
                        <label for="expertise_areas">Áreas de Expertise</label>
                        <textarea class="form-control" id="expertise_areas" name="expertise_areas" rows="3" 
                                  placeholder="Ex: Matemática, Física, Engenharia..."></textarea>
                        <small class="form-text text-muted">Separe as áreas por vírgula</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Adicionar Revisor</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Editar Preferências -->
<div class="modal fade" id="preferencesModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Preferências do Revisor</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="preferences-content">
                    <!-- Preenchido via JavaScript -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="save-preferences-btn">Salvar Preferências</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Visualizar Revisor -->
<div class="modal fade" id="viewReviewerModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalhes do Revisor</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="reviewer-details">
                    <!-- Preenchido via JavaScript -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentReviewerId = null;

$(document).ready(function() {
    // Inicializar DataTable
    $('#reviewers-table').DataTable({
        "pageLength": 25,
        "order": [[ 0, "asc" ]],
        "columnDefs": [
            { "orderable": false, "targets": [8] }
        ],
        "language": {
            "url": "//cdn.datatables.net/plug-ins/1.10.24/i18n/Portuguese-Brasil.json"
        }
    });
    
    // Inicializar Select2 para usuários
    $('#usuario_id').select2({
        ajax: {
            url: '/api/users/search',
            dataType: 'json',
            delay: 250,
            data: function (params) {
                return {
                    q: params.term,
                    page: params.page
                };
            },
            processResults: function (data, params) {
                params.page = params.page || 1;
                return {
                    results: data.results.map(user => ({
                        id: user.id,
                        text: `${user.nome} (${user.email})`
                    })),
                    pagination: {
                        more: (params.page * 30) < data.total_count
                    }
                };
            },
            cache: true
        },
        placeholder: 'Busque por nome ou e-mail',
        minimumInputLength: 2
    });
    
    // Botões de ação
    $('#refresh-btn').on('click', function() {
        location.reload();
    });
    
    $('#preferences-btn').on('click', function() {
        alert('Funcionalidade de preferências em lote será implementada.');
    });
    
    $('#stats-btn').on('click', function() {
        showReviewerStats();
    });
    
    $('#export-btn').on('click', function() {
        exportReviewers();
    });
    
    $('#bulk-import-btn').on('click', function() {
        alert('Funcionalidade de importação em lote será implementada.');
    });
    
    // Salvar preferências
    $('#save-preferences-btn').on('click', function() {
        savePreferences();
    });
});

function viewReviewer(reviewerId) {
    // Carregar detalhes do revisor
    $.get(`/api/reviewers/${reviewerId}`, function(data) {
        const html = `
            <div class="row">
                <div class="col-md-4">
                    <div class="text-center">
                        <img src="${data.usuario.avatar_url || '/static/img/default-avatar.png'}" 
                             class="img-circle elevation-2" style="width: 100px; height: 100px;">
                        <h4 class="mt-2">${data.usuario.nome}</h4>
                        <p class="text-muted">${data.usuario.email}</p>
                    </div>
                </div>
                <div class="col-md-8">
                    <table class="table table-borderless">
                        <tr>
                            <th>Instituição:</th>
                            <td>${data.institution || 'Não informada'}</td>
                        </tr>
                        <tr>
                            <th>Capacidade Máxima:</th>
                            <td>${data.max_assignments} trabalhos</td>
                        </tr>
                        <tr>
                            <th>Carga Atual:</th>
                            <td>${data.current_load} trabalhos (${data.availability_percentage.toFixed(1)}% disponível)</td>
                        </tr>
                        <tr>
                            <th>Status:</th>
                            <td><span class="badge badge-${data.available ? 'success' : 'danger'}">${data.available ? 'Disponível' : 'Indisponível'}</span></td>
                        </tr>
                        <tr>
                            <th>Áreas de Expertise:</th>
                            <td>${data.expertise_areas || 'Não informadas'}</td>
                        </tr>
                        <tr>
                            <th>Preferências:</th>
                            <td>${data.preferences.length} categoria(s) definida(s)</td>
                        </tr>
                    </table>
                </div>
            </div>
        `;
        
        $('#reviewer-details').html(html);
        $('#viewReviewerModal').modal('show');
    }).fail(function() {
        alert('Erro ao carregar detalhes do revisor.');
    });
}

function editReviewer(reviewerId) {
    // Implementar edição de revisor
    alert('Funcionalidade de edição será implementada.');
}

function editPreferences(reviewerId) {
    currentReviewerId = reviewerId;
    
    // Carregar categorias e preferências atuais
    Promise.all([
        $.get(`/api/categories/{{ evento.id }}`),
        $.get(`/api/reviewers/${reviewerId}/preferences`)
    ]).then(([categories, preferences]) => {
        const preferencesMap = {};
        preferences.forEach(pref => {
            preferencesMap[pref.category_id] = pref.affinity_level;
        });
        
        const html = `
            <p class="text-muted mb-3">Defina o nível de afinidade do revisor com cada categoria (0 = Nenhuma, 3 = Alta):</p>
            <div class="row">
                ${categories.map(category => `
                    <div class="col-md-6 mb-3">
                        <div class="card card-outline card-secondary">
                            <div class="card-body p-3">
                                <h6 class="card-title">${category.name}</h6>
                                <p class="card-text small text-muted">${category.description || 'Sem descrição'}</p>
                                <div class="form-group mb-0">
                                    <label class="form-label small">Nível de Afinidade:</label>
                                    <div class="btn-group btn-group-toggle d-flex" data-toggle="buttons">
                                        ${[0, 1, 2, 3].map(level => `
                                            <label class="btn btn-outline-${level === 0 ? 'secondary' : level === 1 ? 'info' : level === 2 ? 'warning' : 'success'} flex-fill ${
                                                (preferencesMap[category.id] || 0) === level ? 'active' : ''
                                            }">
                                                <input type="radio" name="category_${category.id}" value="${level}" ${
                                                    (preferencesMap[category.id] || 0) === level ? 'checked' : ''
                                                }> ${level}
                                            </label>
                                        `).join('')}
                                    </div>
                                    <small class="form-text text-muted">
                                        ${level === 0 ? 'Nenhuma' : level === 1 ? 'Baixa' : level === 2 ? 'Média' : 'Alta'}
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
        
        $('#preferences-content').html(html);
        $('#preferencesModal').modal('show');
    }).catch(() => {
        alert('Erro ao carregar dados para preferências.');
    });
}

function showPreferences(reviewerId) {
    // Mostrar preferências em modo somente leitura
    editPreferences(reviewerId);
    $('#save-preferences-btn').hide();
}

function savePreferences() {
    if (!currentReviewerId) return;
    
    const preferences = {};
    $('#preferences-content input[type="radio"]:checked').each(function() {
        const name = $(this).attr('name');
        const categoryId = name.replace('category_', '');
        const affinityLevel = parseInt($(this).val());
        
        if (affinityLevel > 0) {
            preferences[categoryId] = affinityLevel;
        }
    });
    
    $.ajax({
        url: `/reviewers/${currentReviewerId}/preferences`,
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(preferences),
        success: function(response) {
            if (response.success) {
                alert('Preferências salvas com sucesso!');
                $('#preferencesModal').modal('hide');
                location.reload();
            } else {
                alert('Erro ao salvar preferências: ' + response.error);
            }
        },
        error: function() {
            alert('Erro na comunicação com o servidor.');
        }
    });
}

function toggleAvailability(reviewerId) {
    if (!confirm('Confirma a alteração de disponibilidade deste revisor?')) {
        return;
    }
    
    $.ajax({
        url: `/api/reviewers/${reviewerId}/toggle-availability`,
        method: 'POST',
        success: function(response) {
            if (response.success) {
                location.reload();
            } else {
                alert('Erro ao alterar disponibilidade: ' + response.error);
            }
        },
        error: function() {
            alert('Erro na comunicação com o servidor.');
        }
    });
}

function showReviewerStats() {
    // Implementar estatísticas detalhadas
    alert('Funcionalidade de estatísticas detalhadas será implementada.');
}

function exportReviewers() {
    // Implementar exportação
    window.open(`/api/reviewers/{{ evento.id }}/export`, '_blank');
}
</script>
{% endblock %}