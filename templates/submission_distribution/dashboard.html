{% extends "base.html" %}

{% block title %}Dashboard de Distribuição - {{ evento.nome }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-tachometer-alt"></i>
                        Dashboard de Distribuição Automática
                    </h3>
                    <div class="card-tools">
                        <span class="badge badge-info">{{ evento.nome }}</span>
                        <button type="button" class="btn btn-tool" data-card-widget="collapse">
                            <i class="fas fa-minus"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-2">
                            <a href="{{ url_for('submission_distribution.distribution_config', evento_id=evento.id) }}" class="btn btn-primary btn-block">
                                <i class="fas fa-cogs"></i> Configurar
                            </a>
                        </div>
                        <div class="col-md-2">
                            <a href="{{ url_for('submission_distribution.import_spreadsheet', evento_id=evento.id) }}" class="btn btn-success btn-block">
                                <i class="fas fa-file-import"></i> Importar
                            </a>
                        </div>
                        <div class="col-md-2">
                            <a href="{{ url_for('submission_distribution.manage_reviewers', evento_id=evento.id) }}" class="btn btn-info btn-block">
                                <i class="fas fa-users"></i> Revisores
                            </a>
                        </div>
                        <div class="col-md-2">
                            <a href="{{ url_for('submission_distribution.manage_categories', evento_id=evento.id) }}" class="btn btn-warning btn-block">
                    <i class="fas fa-tags"></i> Gerenciar Categorias
                </a>
            </div>
            <div class="col-md-6 mb-3">
                <a href="{{ url_for('submission_distribution.metrics_dashboard', evento_id=evento.id) }}" class="btn btn-secondary btn-block">
                    <i class="fas fa-chart-line"></i> Dashboard de Métricas
                </a>
                        </div>
                        <div class="col-md-2">
                            <button id="btn-distribute" class="btn btn-danger btn-block">
                                <i class="fas fa-random"></i> Distribuir
                            </button>
                        </div>
                        <div class="col-md-2">
                            <button id="btn-refresh" class="btn btn-secondary btn-block">
                                <i class="fas fa-sync"></i> Atualizar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Estatísticas -->
    <div class="row mb-3">
        <div class="col-md-3">
            <div class="info-box">
                <span class="info-box-icon bg-info"><i class="fas fa-file-alt"></i></span>
                <div class="info-box-content">
                    <span class="info-box-text">Total de Submissões</span>
                    <span class="info-box-number" id="total-submissions">{{ stats.total_submissions or 0 }}</span>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="info-box">
                <span class="info-box-icon bg-success"><i class="fas fa-check"></i></span>
                <div class="info-box-content">
                    <span class="info-box-text">Distribuídas</span>
                    <span class="info-box-number" id="distributed-submissions">{{ stats.distributed_submissions or 0 }}</span>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="info-box">
                <span class="info-box-icon bg-warning"><i class="fas fa-clock"></i></span>
                <div class="info-box-content">
                    <span class="info-box-text">Pendentes</span>
                    <span class="info-box-number" id="pending-submissions">{{ stats.pending_submissions or 0 }}</span>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="info-box">
                <span class="info-box-icon bg-danger"><i class="fas fa-users"></i></span>
                <div class="info-box-content">
                    <span class="info-box-text">Revisores Ativos</span>
                    <span class="info-box-number" id="active-reviewers">{{ stats.active_reviewers or 0 }}</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Gráficos e Métricas -->
    <div class="row mb-3">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Distribuição por Categoria</h3>
                </div>
                <div class="card-body">
                    <canvas id="categoryChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Carga de Trabalho dos Revisores</h3>
                </div>
                <div class="card-body">
                    <canvas id="workloadChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Submissões Pendentes -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-list"></i>
                        Submissões Pendentes de Distribuição
                    </h3>
                    <div class="card-tools">
                        <span class="badge badge-warning">{{ pending_submissions|length }} pendentes</span>
                    </div>
                </div>
                <div class="card-body">
                    {% if pending_submissions %}
                    <form id="distribution-form">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="submissions-table">
                                <thead>
                                    <tr>
                                        <th>
                                            <div class="custom-control custom-checkbox">
                                                <input type="checkbox" class="custom-control-input" id="select-all">
                                                <label class="custom-control-label" for="select-all"></label>
                                            </div>
                                        </th>
                                        <th>Título</th>
                                        <th>Autor</th>
                                        <th>Categoria</th>
                                        <th>Status</th>
                                        <th>Data</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for submission in pending_submissions %}
                                    <tr>
                                        <td>
                                            <div class="custom-control custom-checkbox">
                                                <input type="checkbox" class="custom-control-input submission-checkbox" 
                                                       id="submission-{{ submission.id }}" name="submission_ids" value="{{ submission.id }}">
                                                <label class="custom-control-label" for="submission-{{ submission.id }}"></label>
                                            </div>
                                        </td>
                                        <td>
                                            <strong>{{ submission.title }}</strong>
                                            {% if submission.abstract %}
                                            <br><small class="text-muted">{{ submission.abstract[:100] }}...</small>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {{ submission.author.nome if submission.author else 'N/A' }}
                                            {% if submission.author and submission.author.email %}
                                            <br><small class="text-muted">{{ submission.author.email }}</small>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if submission.attributes and submission.attributes.get('category') %}
                                            <span class="badge badge-info">{{ submission.attributes.category }}</span>
                                            {% else %}
                                            <span class="badge badge-secondary">Sem categoria</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="badge badge-{{ 'success' if submission.status == 'approved' else 'warning' if submission.status == 'pending' else 'danger' }}">
                                                {{ submission.status|title }}
                                            </span>
                                        </td>
                                        <td>
                                            {{ submission.created_at.strftime('%d/%m/%Y') if submission.created_at else 'N/A' }}
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <button type="button" class="btn btn-info btn-sm" 
                                                        onclick="viewSubmission({{ submission.id }})" title="Visualizar">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button type="button" class="btn btn-warning btn-sm" 
                                                        onclick="editSubmission({{ submission.id }})" title="Editar">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="distribution-seed">Seed para Reprodutibilidade (opcional)</label>
                                    <input type="text" class="form-control" id="distribution-seed" name="seed" 
                                           placeholder="Ex: 12345 (deixe vazio para aleatório)">
                                    <small class="form-text text-muted">Use o mesmo seed para reproduzir a mesma distribuição</small>
                                </div>
                            </div>
                            <div class="col-md-6 d-flex align-items-end">
                                <button type="submit" class="btn btn-danger btn-lg" id="execute-distribution">
                                    <i class="fas fa-random"></i> Executar Distribuição
                                </button>
                            </div>
                        </div>
                    </form>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                        <h4>Todas as submissões foram distribuídas!</h4>
                        <p class="text-muted">Não há submissões pendentes de distribuição no momento.</p>
                        <a href="{{ url_for('submission_distribution.import_spreadsheet', evento_id=evento.id) }}" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Importar Mais Submissões
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Progresso -->
<div class="modal fade" id="progressModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Executando Distribuição</h5>
            </div>
            <div class="modal-body text-center">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="sr-only">Carregando...</span>
                </div>
                <p id="progress-message">Iniciando distribuição automática...</p>
                <div class="progress">
                    <div class="progress-bar" role="progressbar" style="width: 0%" id="progress-bar"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
$(document).ready(function() {
    // Inicializar DataTable
    $('#submissions-table').DataTable({
        "pageLength": 25,
        "order": [[ 5, "desc" ]],
        "columnDefs": [
            { "orderable": false, "targets": [0, 6] }
        ],
        "language": {
            "url": "//cdn.datatables.net/plug-ins/1.10.24/i18n/Portuguese-Brasil.json"
        }
    });
    
    // Select All checkbox
    $('#select-all').on('change', function() {
        $('.submission-checkbox').prop('checked', this.checked);
    });
    
    // Individual checkboxes
    $('.submission-checkbox').on('change', function() {
        const totalCheckboxes = $('.submission-checkbox').length;
        const checkedCheckboxes = $('.submission-checkbox:checked').length;
        $('#select-all').prop('checked', totalCheckboxes === checkedCheckboxes);
    });
    
    // Formulário de distribuição
    $('#distribution-form').on('submit', function(e) {
        e.preventDefault();
        
        const selectedSubmissions = $('.submission-checkbox:checked').length;
        if (selectedSubmissions === 0) {
            alert('Selecione pelo menos uma submissão para distribuir.');
            return;
        }
        
        if (!confirm(`Confirma a distribuição de ${selectedSubmissions} submissão(ões)?`)) {
            return;
        }
        
        executeDistribution();
    });
    
    // Botão de distribuir (header)
    $('#btn-distribute').on('click', function() {
        $('.submission-checkbox').prop('checked', true);
        $('#select-all').prop('checked', true);
        $('#distribution-form').submit();
    });
    
    // Botão de atualizar
    $('#btn-refresh').on('click', function() {
        location.reload();
    });
    
    // Carregar gráficos
    loadCharts();
});

function executeDistribution() {
    const formData = new FormData($('#distribution-form')[0]);
    
    // Mostrar modal de progresso
    $('#progressModal').modal({
        backdrop: 'static',
        keyboard: false
    });
    
    // Simular progresso
    let progress = 0;
    const progressInterval = setInterval(() => {
        progress += Math.random() * 20;
        if (progress > 90) progress = 90;
        
        $('#progress-bar').css('width', progress + '%');
        
        if (progress < 30) {
            $('#progress-message').text('Analisando submissões e revisores...');
        } else if (progress < 60) {
            $('#progress-message').text('Calculando afinidades e conflitos...');
        } else if (progress < 90) {
            $('#progress-message').text('Executando algoritmo de distribuição...');
        }
    }, 500);
    
    // Executar distribuição
    $.ajax({
        url: '{{ url_for("submission_distribution.execute_distribution", evento_id=evento.id) }}',
        method: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
            clearInterval(progressInterval);
            $('#progress-bar').css('width', '100%');
            $('#progress-message').text('Distribuição concluída!');
            
            setTimeout(() => {
                $('#progressModal').modal('hide');
                
                if (response.success) {
                    alert(`Distribuição concluída com sucesso!\n\n` +
                          `Atribuições criadas: ${response.total_assignments}\n` +
                          `Submissões processadas: ${response.processed_submissions}\n` +
                          `Conflitos detectados: ${response.conflicts_detected || 0}`);
                    
                    location.reload();
                } else {
                    alert('Erro na distribuição: ' + (response.error || 'Erro desconhecido'));
                }
            }, 1000);
        },
        error: function(xhr, status, error) {
            clearInterval(progressInterval);
            $('#progressModal').modal('hide');
            alert('Erro na comunicação: ' + error);
        }
    });
}

function loadCharts() {
    // Gráfico de distribuição por categoria
    const categoryCtx = document.getElementById('categoryChart').getContext('2d');
    new Chart(categoryCtx, {
        type: 'doughnut',
        data: {
            labels: {{ stats.category_distribution.keys()|list|tojson if stats.category_distribution else '[]'|safe }},
            datasets: [{
                data: {{ stats.category_distribution.values()|list|tojson if stats.category_distribution else '[]'|safe }},
                backgroundColor: [
                    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                    '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            legend: {
                position: 'bottom'
            }
        }
    });
    
    // Gráfico de carga de trabalho
    const workloadCtx = document.getElementById('workloadChart').getContext('2d');
    new Chart(workloadCtx, {
        type: 'bar',
        data: {
            labels: {{ stats.reviewer_workload.keys()|list|tojson if stats.reviewer_workload else '[]'|safe }},
            datasets: [{
                label: 'Trabalhos Atribuídos',
                data: {{ stats.reviewer_workload.values()|list|tojson if stats.reviewer_workload else '[]'|safe }},
                backgroundColor: '#36A2EB',
                borderColor: '#36A2EB',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            },
            legend: {
                display: false
            }
        }
    });
}

function viewSubmission(submissionId) {
    // Implementar visualização de submissão
    window.open(`/submission/${submissionId}`, '_blank');
}

function editSubmission(submissionId) {
    // Implementar edição de submissão
    window.location.href = `/submission/${submissionId}/edit`;
}
</script>
{% endblock %}