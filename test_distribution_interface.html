
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Interface de Distribuição</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2>Teste da Interface de Distribuição</h2>
        
        <div class="alert alert-info">
            <strong>Instruções:</strong>
            <ol>
                <li>Marque um ou mais checkboxes na tabela</li>
                <li>Os controles de distribuição devem aparecer</li>
                <li>Os botões devem ser habilitados</li>
                <li>Clique nos botões para testar os modais</li>
            </ol>
        </div>
        
        <!-- Controles de Distribuição -->
        <div class="distribution-controls" id="distributionControls" style="display: none;">
<div class="d-flex justify-content-between align-items-center p-3 bg-light rounded">
<div class="d-flex align-items-center">
<span class="me-3">
<strong id="selectedCount">0</strong> trabalho(s) selecionado(s)
                                </span>
<button class="btn btn-sm btn-outline-secondary me-2" id="selectAllBtn" type="button">
<i class="fas fa-check-square me-1"></i>
                                    Selecionar Todos
                                </button>
<button class="btn btn-sm btn-outline-secondary" id="clearSelectionBtn" type="button">
<i class="fas fa-square me-1"></i>
                                    Limpar Seleção
                                </button>
</div>
<div>
<button class="btn btn-success me-2" disabled="" id="manualDistributionBtn" type="button">
<i class="fas fa-user-edit me-1"></i>
                                    Distribuição Manual
                                </button>
<button class="btn btn-info" disabled="" id="automaticDistributionBtn" type="button">
<i class="fas fa-magic me-1"></i>
                                    Distribuição Automática
                                </button>
</div>
</div>
</div>
        
        <!-- Tabela de Trabalhos -->
        <div class="table-responsive">
            <table class="table table-striped table-hover">
<thead class="table-dark">
<tr>
<th width="50">
<div class="form-check">
<input class="form-check-input" id="selectAllCheckbox" type="checkbox"/>
<label class="form-check-label" for="selectAllCheckbox">
<span class="visually-hidden">Selecionar todos</span>
</label>
</div>
</th>
<th>Título</th>
<th>Categoria</th>
<th>Rede de Ensino</th>
<th>Etapa de Ensino</th>
<th>Data de Cadastro</th>
<th class="text-center">Status Distribuição</th>
<th class="text-center">Ações</th>
</tr>
</thead>
<tbody>
<tr>
<td>
<div class="form-check">
<input class="form-check-input work-checkbox" id="work_9" name="trabalho_ids" type="checkbox" value="9"/>
<label class="form-check-label" for="work_9">
<span class="visually-hidden">Selecionar trabalho</span>
</label>
</div>
</td>
<td>
<strong>Redescobrindo minha comunidade: Um novo olhar dentro de um contexto histórico em relação a comunidade de Canafístula de Frei Damião </strong>
</td>
<td>
<span class="badge bg-info">Pesquisa Inovadora</span>
</td>
<td>Municipal</td>
<td>Ensino Fundamental</td>
<td>
<small class="text-muted">
                                                    02/09/2025 às 02:24
                                                </small>
</td>
<td class="text-center">
<span class="badge bg-secondary" id="distributionStatus_9">
<i class="fas fa-clock me-1"></i>
                                                    Não Distribuído
                                                </span>
</td>
<td class="text-center">
<div class="btn-group" role="group">
<a class="btn btn-sm btn-outline-info" href="/trabalhos/9/visualizar" title="Visualizar">
<i class="fas fa-eye"></i>
</a>
<a class="btn btn-sm btn-outline-warning" href="/trabalhos/9/editar" title="Editar">
<i class="fas fa-edit"></i>
</a>
<button class="btn btn-sm btn-outline-danger" onclick="confirmarExclusao(9, 'Redescobrindo minha comunidade: Um novo olhar dentro de um contexto histórico em relação a comunidade de Canafístula de Frei Damião ')" title="Excluir" type="button">
<i class="fas fa-trash"></i>
</button>
</div>
</td>
</tr>
<tr>
<td>
<div class="form-check">
<input class="form-check-input work-checkbox" id="work_8" name="trabalho_ids" type="checkbox" value="8"/>
<label class="form-check-label" for="work_8">
<span class="visually-hidden">Selecionar trabalho</span>
</label>
</div>
</td>
<td>
<strong>Brasil em Cores</strong>
</td>
<td>
<span class="badge bg-info">Prática Educacional</span>
</td>
<td>Municipal</td>
<td>Ensino Fundamental</td>
<td>
<small class="text-muted">
                                                    02/09/2025 às 02:12
                                                </small>
</td>
<td class="text-center">
<span class="badge bg-secondary" id="distributionStatus_8">
<i class="fas fa-clock me-1"></i>
                                                    Não Distribuído
                                                </span>
</td>
<td class="text-center">
<div class="btn-group" role="group">
<a class="btn btn-sm btn-outline-info" href="/trabalhos/8/visualizar" title="Visualizar">
<i class="fas fa-eye"></i>
</a>
<a class="btn btn-sm btn-outline-warning" href="/trabalhos/8/editar" title="Editar">
<i class="fas fa-edit"></i>
</a>
<button class="btn btn-sm btn-outline-danger" onclick="confirmarExclusao(8, 'Brasil em Cores')" title="Excluir" type="button">
<i class="fas fa-trash"></i>
</button>
</div>
</td>
</tr>
</tbody>
</table>
        </div>
        
        <!-- Modais -->
        <div aria-hidden="true" aria-labelledby="revisorModalLabel" class="modal fade" id="revisorModal" tabindex="-1">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title" id="revisorModalLabel">Acesso dos Revisores</h5>
<button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
</div>
<div class="modal-body">
<!-- Acesso para revisores já cadastrados -->
<h6 class="fw-bold text-primary text-center mb-2">Acesso de revisores existentes</h6>
<p>Insira abaixo o localizador e o código fornecidos para acessar suas tarefas de revisão.</p>
<form action="/peer-review/reviewer" method="post">
<div class="mb-3">
<label class="form-label" for="locatorInput">Localizador</label>
<input class="form-control" id="locatorInput" name="locator" type="text"/>
</div>
<div class="mb-3">
<label class="form-label" for="codeInput">Código de Acesso</label>
<input class="form-control" id="codeInput" name="code" type="password"/>
</div>
<button class="btn btn-primary" type="submit">Entrar</button>
</form>
<!-- Candidatura ou acompanhamento -->
<hr class="my-4"/>
<h6 class="fw-bold text-primary text-center mb-2">Novo cadastro</h6>
<a class="btn btn-outline-success w-100 mb-2" href="/processo_seletivo">
          Quero ser revisor
        </a>
<form action="/revisor/progress" method="get">
<div class="mb-3">
<label class="form-label" for="codigoAcomp">Código da Candidatura</label>
<input class="form-control" id="codigoAcomp" name="codigo" type="text"/>
</div>
<button class="btn btn-secondary" type="submit">Acompanhar</button>
</form>
</div>
</div>
</div>
</div><div aria-hidden="true" aria-labelledby="manualDistributionModalLabel" class="modal fade" id="manualDistributionModal" tabindex="-1">
<div class="modal-dialog modal-lg">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title" id="manualDistributionModalLabel">
<i class="fas fa-user-edit me-2"></i>
                    Distribuição Manual de Trabalhos
                </h5>
<button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
</div>
<div class="modal-body">
<div class="row">
<div class="col-md-6">
<h6><i class="fas fa-file-alt me-2"></i>Trabalhos Selecionados</h6>
<div class="border rounded p-3 mb-3" id="selectedWorksList" style="max-height: 300px; overflow-y: auto;">
<!-- Selected works will be populated here -->
</div>
</div>
<div class="col-md-6">
<h6><i class="fas fa-users me-2"></i>Revisores Disponíveis</h6>
<div class="mb-3">
<input class="form-control" id="reviewerSearch" placeholder="Buscar revisor..." type="text"/>
</div>
<div class="border rounded p-3" id="reviewersList" style="max-height: 300px; overflow-y: auto;">
<!-- Reviewers will be populated here -->
</div>
</div>
</div>
<div class="mt-3">
<h6><i class="fas fa-clipboard-list me-2"></i>Atribuições</h6>
<div class="border rounded p-3" id="assignmentsList" style="max-height: 200px; overflow-y: auto;">
<p class="text-muted text-center mb-0">Nenhuma atribuição criada ainda</p>
</div>
</div>
<div class="mt-3">
<div class="row">
<div class="col-md-6">
<label class="form-label" for="manualDeadline">Prazo para Revisão</label>
<input class="form-control" id="manualDeadline" required="" type="date"/>
</div>
<div class="col-md-6">
<label class="form-label" for="manualNotes">Observações</label>
<textarea class="form-control" id="manualNotes" placeholder="Observações sobre a distribuição..." rows="2"></textarea>
</div>
</div>
</div>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" data-bs-dismiss="modal" type="button">
<i class="fas fa-times me-1"></i>
                    Cancelar
                </button>
<button class="btn btn-success" disabled="" id="executeManualDistribution" type="button">
<i class="fas fa-check me-1"></i>
                    Executar Distribuição
                </button>
</div>
</div>
</div>
</div><div aria-hidden="true" aria-labelledby="automaticDistributionModalLabel" class="modal fade" id="automaticDistributionModal" tabindex="-1">
<div class="modal-dialog modal-lg">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title" id="automaticDistributionModalLabel">
<i class="fas fa-magic me-2"></i>
                    Distribuição Automática de Trabalhos
                </h5>
<button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
</div>
<div class="modal-body">
<div class="row">
<div class="col-md-6">
<h6><i class="fas fa-file-alt me-2"></i>Trabalhos Selecionados</h6>
<div class="border rounded p-3 mb-3" id="autoSelectedWorksList" style="max-height: 200px; overflow-y: auto;">
<!-- Selected works will be populated here -->
</div>
</div>
<div class="col-md-6">
<h6><i class="fas fa-cog me-2"></i>Configurações</h6>
<div class="mb-3">
<label class="form-label" for="reviewersPerWork">Revisores por Trabalho</label>
<input class="form-control" id="reviewersPerWork" max="5" min="1" type="number" value="2"/>
<small class="form-text text-muted">Número de revisores que avaliarão cada trabalho</small>
</div>
<div class="mb-3">
<label class="form-label" for="maxAssignmentsPerReviewer">Máximo de Trabalhos por Revisor</label>
<input class="form-control" id="maxAssignmentsPerReviewer" min="1" type="number" value="5"/>
<small class="form-text text-muted">Limite de trabalhos que cada revisor pode receber</small>
</div>
</div>
</div>
<div class="row">
<div class="col-md-6">
<label class="form-label" for="autoDeadline">Prazo para Revisão</label>
<input class="form-control" id="autoDeadline" required="" type="date"/>
</div>
<div class="col-md-6">
<label class="form-label" for="autoNotes">Observações</label>
<textarea class="form-control" id="autoNotes" placeholder="Observações sobre a distribuição..." rows="2"></textarea>
</div>
</div>
<div class="mt-3">
<h6><i class="fas fa-filter me-2"></i>Filtros de Revisores</h6>
<div class="row">
<div class="col-md-6">
<div class="form-check">
<input checked="" class="form-check-input" id="excludeAuthors" type="checkbox"/>
<label class="form-check-label" for="excludeAuthors">
                                    Excluir autores dos próprios trabalhos
                                </label>
</div>
</div>
<div class="col-md-6">
<div class="form-check">
<input checked="" class="form-check-input" id="balanceWorkload" type="checkbox"/>
<label class="form-check-label" for="balanceWorkload">
                                    Balancear carga de trabalho
                                </label>
</div>
</div>
</div>
</div>
<div class="mt-3">
<div class="alert alert-info">
<i class="fas fa-info-circle me-2"></i>
<strong>Prévia da Distribuição:</strong>
<div class="mt-2" id="distributionPreview">
<span class="text-muted">Configure os parâmetros acima para ver a prévia</span>
</div>
</div>
</div>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" data-bs-dismiss="modal" type="button">
<i class="fas fa-times me-1"></i>
                    Cancelar
                </button>
<button class="btn btn-outline-info" id="previewDistribution" type="button">
<i class="fas fa-eye me-1"></i>
                    Prévia
                </button>
<button class="btn btn-info" id="executeAutoDistribution" type="button">
<i class="fas fa-magic me-1"></i>
                    Executar Distribuição
                </button>
</div>
</div>
</div>
</div><div class="modal fade" id="modalExclusao" tabindex="-1">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title">
<i class="fas fa-exclamation-triangle text-warning me-2"></i>
                    Confirmar Exclusão
                </h5>
<button class="btn-close" data-bs-dismiss="modal" type="button"></button>
</div>
<div class="modal-body">
<p>Tem certeza que deseja excluir o trabalho <strong id="nomeTrabalho"></strong>?</p>
<p class="text-muted">Esta ação não pode ser desfeita.</p>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" data-bs-dismiss="modal" type="button">
<i class="fas fa-times me-1"></i>
                    Cancelar
                </button>
<form id="formExclusao" method="POST" style="display: inline;">
                    IjhiODc0NWQxMmNlNzZmNDU0YzZjYTI2NjAxNjQwNTI5OGY5MTgyNGIi.aLZykw.gevDKCm6cVQQH5swCfpWut9WTx4
                    <button class="btn btn-danger" type="submit">
<i class="fas fa-trash me-1"></i>
                        Excluir
                    </button>
</form>
</div>
</div>
</div>
</div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Console de debug
        console.log('Teste da interface de distribuição carregado');
        
        
function confirmarExclusao(trabalhoId, nomeTrabalho) {
    document.getElementById('nomeTrabalho').textContent = nomeTrabalho;
    document.getElementById('formExclusao').action = 
        "/trabalhos/0/excluir".replace('0', trabalhoId);
    
    var modal = new bootstrap.Modal(document.getElementById('modalExclusao'));
    modal.show();
}

// Distribution functionality
document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, initializing distribution interface...');
        
        // Get DOM elements
        const workCheckboxes = document.querySelectorAll('.work-checkbox');
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        const selectAllBtn = document.getElementById('selectAllBtn');
        const clearSelectionBtn = document.getElementById('clearSelectionBtn');
        const distributionControls = document.getElementById('distributionControls');
        const selectedCount = document.getElementById('selectedCount');
        const manualDistributionBtn = document.getElementById('manualDistributionBtn');
        const automaticDistributionBtn = document.getElementById('automaticDistributionBtn');
        
        console.log('Found elements:', {
            workCheckboxes: workCheckboxes.length,
            selectAllCheckbox: !!selectAllCheckbox,
            distributionControls: !!distributionControls,
            selectedCount: !!selectedCount
        });
    
    function updateSelectionCount() {
        const checkedBoxes = document.querySelectorAll('input[name="trabalho_ids"]:checked');
        const count = checkedBoxes.length;
        
        selectedCount.textContent = count;
        
        if (count > 0) {
            distributionControls.style.display = 'block';
            manualDistributionBtn.disabled = false;
            automaticDistributionBtn.disabled = false;
        } else {
            distributionControls.style.display = 'none';
            manualDistributionBtn.disabled = true;
            automaticDistributionBtn.disabled = true;
        }
        
        // Update select all checkbox state
        const totalCheckboxes = workCheckboxes.length;
        if (count === 0) {
            selectAllCheckbox.indeterminate = false;
            selectAllCheckbox.checked = false;
        } else if (count === totalCheckboxes) {
            selectAllCheckbox.indeterminate = false;
            selectAllCheckbox.checked = true;
        } else {
            selectAllCheckbox.indeterminate = true;
        }
    }
    
    // Individual checkbox change
    workCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectionCount);
    });
    
    // Select all checkbox
    selectAllCheckbox.addEventListener('change', function() {
        workCheckboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
        updateSelectionCount();
    });
    
    // Select all button
    selectAllBtn.addEventListener('click', function() {
        workCheckboxes.forEach(checkbox => {
            checkbox.checked = true;
        });
        updateSelectionCount();
    });
    
    // Clear selection button
    clearSelectionBtn.addEventListener('click', function() {
        workCheckboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
        updateSelectionCount();
    });
    
    // Distribution buttons
    manualDistributionBtn.addEventListener('click', function() {
        const selectedWorks = Array.from(document.querySelectorAll('.work-checkbox:checked'))
            .map(cb => cb.value);
        openManualDistributionModal(selectedWorks);
    });
    
    automaticDistributionBtn.addEventListener('click', function() {
        const selectedWorks = Array.from(document.querySelectorAll('.work-checkbox:checked'))
            .map(cb => cb.value);
        openAutomaticDistributionModal(selectedWorks);
    });
    
    // Initialize
    updateSelectionCount();
});

// Modal functions
function openManualDistributionModal(workIds) {
    const modal = new bootstrap.Modal(document.getElementById('manualDistributionModal'));
    
    // Populate selected works
    populateSelectedWorks('selectedWorksList', workIds);
    
    // Load available reviewers
    loadAvailableReviewers();
    
    // Set default deadline (7 days from now)
    const deadline = new Date();
    deadline.setDate(deadline.getDate() + 7);
    document.getElementById('manualDeadline').value = deadline.toISOString().split('T')[0];
    
    // Clear previous assignments
    document.getElementById('assignmentsList').innerHTML = '<p class="text-muted text-center mb-0">Nenhuma atribuição criada ainda</p>';
    
    modal.show();
}

function openAutomaticDistributionModal(workIds) {
    const modal = new bootstrap.Modal(document.getElementById('automaticDistributionModal'));
    
    // Populate selected works
    populateSelectedWorks('autoSelectedWorksList', workIds);
    
    // Set default deadline (7 days from now)
    const deadline = new Date();
    deadline.setDate(deadline.getDate() + 7);
    document.getElementById('autoDeadline').value = deadline.toISOString().split('T')[0];
    
    // Clear preview
    document.getElementById('distributionPreview').innerHTML = '<span class="text-muted">Configure os parâmetros acima para ver a prévia</span>';
    
    modal.show();
}

function populateSelectedWorks(containerId, workIds) {
    const container = document.getElementById(containerId);
    let html = '';
    
    workIds.forEach(workId => {
        const workRow = document.querySelector(`#work_${workId}`).closest('tr');
        const title = workRow.querySelector('td:nth-child(2) strong').textContent;
        const category = workRow.querySelector('td:nth-child(3)').textContent.trim();
        
        html += `
            <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
                <div>
                    <strong>${title}</strong><br>
                    <small class="text-muted">${category}</small>
                </div>
                <span class="badge bg-primary">${workId}</span>
            </div>
        `;
    });
    
    container.innerHTML = html || '<p class="text-muted text-center mb-0">Nenhum trabalho selecionado</p>';
}

function loadAvailableReviewers() {
    fetch('/api/reviewers')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                populateReviewersList(data.reviewers);
            } else {
                console.error('Error loading reviewers:', data.message);
            }
        })
        .catch(error => {
            console.error('Error loading reviewers:', error);
        });
}

function populateReviewersList(reviewers) {
    const container = document.getElementById('reviewersList');
    let html = '';
    
    reviewers.forEach(reviewer => {
        html += `
            <div class="reviewer-item d-flex justify-content-between align-items-center p-2 border-bottom" data-reviewer-id="${reviewer.id}">
                <div>
                    <strong>${reviewer.nome}</strong><br>
                    <small class="text-muted">${reviewer.email}</small>
                </div>
                <div class="text-end">
                    <span class="badge bg-info">${reviewer.current_assignments} trabalhos</span><br>
                    <button class="btn btn-sm btn-outline-primary mt-1" onclick="addReviewerAssignment(${reviewer.id}, '${reviewer.nome}')">
                        <i class="fas fa-plus"></i> Adicionar
                    </button>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html || '<p class="text-muted text-center mb-0">Nenhum revisor disponível</p>';
}

let manualAssignments = [];

function addReviewerAssignment(reviewerId, reviewerName) {
    const selectedWorks = Array.from(document.querySelectorAll('.work-checkbox:checked')).map(cb => cb.value);
    
    selectedWorks.forEach(workId => {
        const workRow = document.querySelector(`#work_${workId}`).closest('tr');
        const workTitle = workRow.querySelector('td:nth-child(2) strong').textContent;
        
        // Check if assignment already exists
        const existingAssignment = manualAssignments.find(a => a.workId === workId && a.reviewerId === reviewerId);
        if (!existingAssignment) {
            manualAssignments.push({
                workId: workId,
                workTitle: workTitle,
                reviewerId: reviewerId,
                reviewerName: reviewerName
            });
        }
    });
    
    updateAssignmentsList();
}

function updateAssignmentsList() {
    const container = document.getElementById('assignmentsList');
    let html = '';
    
    manualAssignments.forEach((assignment, index) => {
        html += `
            <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
                <div>
                    <strong>${assignment.workTitle}</strong> → <strong>${assignment.reviewerName}</strong>
                </div>
                <button class="btn btn-sm btn-outline-danger" onclick="removeAssignment(${index})">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
    });
    
    container.innerHTML = html || '<p class="text-muted text-center mb-0">Nenhuma atribuição criada ainda</p>';
    
    // Enable/disable execute button
    document.getElementById('executeManualDistribution').disabled = manualAssignments.length === 0;
}

function removeAssignment(index) {
    manualAssignments.splice(index, 1);
    updateAssignmentsList();
}

// Reviewer search functionality
document.addEventListener('DOMContentLoaded', function() {
    const reviewerSearch = document.getElementById('reviewerSearch');
    if (reviewerSearch) {
        reviewerSearch.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const reviewerItems = document.querySelectorAll('.reviewer-item');
            
            reviewerItems.forEach(item => {
                const reviewerName = item.querySelector('strong').textContent.toLowerCase();
                const reviewerEmail = item.querySelector('small').textContent.toLowerCase();
                
                if (reviewerName.includes(searchTerm) || reviewerEmail.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        });
    }
    
    // Execute manual distribution
    const executeManualBtn = document.getElementById('executeManualDistribution');
    if (executeManualBtn) {
        executeManualBtn.addEventListener('click', function() {
            executeManualDistribution();
        });
    }
    
    // Execute automatic distribution
    const executeAutoBtn = document.getElementById('executeAutoDistribution');
    if (executeAutoBtn) {
        executeAutoBtn.addEventListener('click', function() {
            executeAutomaticDistribution();
        });
    }
    
    // Preview automatic distribution
    const previewBtn = document.getElementById('previewDistribution');
    if (previewBtn) {
        previewBtn.addEventListener('click', function() {
            previewAutomaticDistribution();
        });
    }
});

function executeManualDistribution() {
    const deadline = document.getElementById('manualDeadline').value;
    const notes = document.getElementById('manualNotes').value;
    
    if (!deadline) {
        alert('Por favor, defina um prazo para a revisão.');
        return;
    }
    
    if (manualAssignments.length === 0) {
        alert('Por favor, crie pelo menos uma atribuição.');
        return;
    }
    
    const data = {
        assignments: manualAssignments,
        deadline: deadline,
        notes: notes
    };
    
    fetch('/api/distribution/manual', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Distribuição manual executada com sucesso!');
            bootstrap.Modal.getInstance(document.getElementById('manualDistributionModal')).hide();
            location.reload(); // Refresh to show updated status
        } else {
            alert('Erro na distribuição: ' + (data.error || data.message || 'Erro desconhecido'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Erro ao executar distribuição manual.');
    });
}

function executeAutomaticDistribution() {
    const selectedWorks = Array.from(document.querySelectorAll('.work-checkbox:checked')).map(cb => cb.value);
    const reviewersPerWork = document.getElementById('reviewersPerWork').value;
    const maxAssignments = document.getElementById('maxAssignmentsPerReviewer').value;
    const deadline = document.getElementById('autoDeadline').value;
    const notes = document.getElementById('autoNotes').value;
    const excludeAuthors = document.getElementById('excludeAuthors').checked;
    const balanceWorkload = document.getElementById('balanceWorkload').checked;
    
    if (!deadline) {
        alert('Por favor, defina um prazo para a revisão.');
        return;
    }
    
    const data = {
        work_ids: selectedWorks,
        reviewers_per_work: parseInt(reviewersPerWork),
        max_assignments_per_reviewer: parseInt(maxAssignments),
        deadline: deadline,
        notes: notes,
        exclude_authors: excludeAuthors,
        balance_workload: balanceWorkload
    };
    
    fetch('/api/distribution/automatic', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Distribuição automática executada com sucesso! ${data.assignments_created} atribuições criadas.`);
            bootstrap.Modal.getInstance(document.getElementById('automaticDistributionModal')).hide();
            location.reload(); // Refresh to show updated status
        } else {
            alert('Erro na distribuição: ' + (data.error || data.message || 'Erro desconhecido'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Erro ao executar distribuição automática.');
    });
}

function previewAutomaticDistribution() {
    const selectedWorks = Array.from(document.querySelectorAll('.work-checkbox:checked')).map(cb => cb.value);
    const reviewersPerWork = document.getElementById('reviewersPerWork').value;
    const maxAssignments = document.getElementById('maxAssignmentsPerReviewer').value;
    
    // Simple preview calculation
    const totalAssignments = selectedWorks.length * parseInt(reviewersPerWork);
    const estimatedReviewers = Math.ceil(totalAssignments / parseInt(maxAssignments));
    
    const previewHtml = `
        <div class="row text-center">
            <div class="col-md-3">
                <strong>${selectedWorks.length}</strong><br>
                <small>Trabalhos</small>
            </div>
            <div class="col-md-3">
                <strong>${reviewersPerWork}</strong><br>
                <small>Revisores/Trabalho</small>
            </div>
            <div class="col-md-3">
                <strong>${totalAssignments}</strong><br>
                <small>Total Atribuições</small>
            </div>
            <div class="col-md-3">
                <strong>~${estimatedReviewers}</strong><br>
                <small>Revisores Necessários</small>
            </div>
        </div>
    `;
    
    document.getElementById('distributionPreview').innerHTML = previewHtml;
}

        
        // Debug adicional
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== DEBUG DA INTERFACE ===');
            console.log('Checkboxes encontrados:', document.querySelectorAll('.work-checkbox').length);
            console.log('Controles de distribuição:', document.getElementById('distributionControls'));
            console.log('Botão manual:', document.getElementById('manualDistributionBtn'));
            console.log('Botão automático:', document.getElementById('automaticDistributionBtn'));
            
            // Adicionar listeners de debug
            const checkboxes = document.querySelectorAll('.work-checkbox');
            checkboxes.forEach((checkbox, index) => {
                checkbox.addEventListener('change', function() {
                    console.log(`Checkbox ${index} alterado: ${this.checked}`);
                });
            });
        });
    </script>
</body>
</html>
    